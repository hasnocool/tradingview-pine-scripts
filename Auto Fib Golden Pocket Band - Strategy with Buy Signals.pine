Script Name: Auto Fib Golden Pocket Band - Strategy with Buy Signals
Author: imal_max
Description: this strategy is based on the Indicator "Auto Fib Golden Pocket Band - "Autofib Moving Average"
it's the same as the indicator but with:
- the strategy tester included 
- several entry Signal filter
- Dynamic SL
PineScript code:

Pine Scriptâ„¢ strategy
Auto Fib Golden Pocket Band - Strategy with Buy Signals
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
//Â ThisÂ sourceÂ codeÂ isÂ subjectÂ toÂ theÂ termsÂ ofÂ theÂ MozillaÂ PublicÂ LicenseÂ 2.0Â atÂ https://mozilla.org/MPL/2.0/
//Â Â©Â imal_maxÂ reeee
//@version=5
strategy(title="AutoÂ FibÂ GoldenÂ PocketÂ BandÂ -Â AutofibÂ MovingÂ Average",Â shorttitle="AutoÂ FibÂ GoldenÂ PocketÂ Band",Â overlay=true,Â pyramiding=15,Â process_orders_on_close=true,Â calc_on_every_tick=true,Â initial_capital=10000,Â currencyÂ =Â currency.USD,Â default_qty_value=100,Â default_qty_type=strategy.percent_of_equity,Â commission_type=strategy.commission.percent,Â commission_value=0.05,Â slippage=2)
//indicator("AutoÂ FibÂ GoldenÂ PocketÂ BandÂ -Â AutofibÂ MovingÂ Average",Â overlay=true,Â shorttitle="AutoÂ FibÂ GoldenÂ PocketÂ Band",Â timeframe""")
//Â Fibs
//Â autoÂ fibÂ ranges
//Â fibÂ bandÂ StrongÂ TrendÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
enable_StrongBand_BullÂ =Â input.bool(title='enableÂ UpperÂ BullishÂ BandÂ .Â .Â .Â FibÂ Level',Â defval=true,Â group='â•â•â•â•â•â•Â StrongÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="0")
select_StrongBand_Fib_BullÂ =Â input.float(0.236,Â title="Â Â Â Â Â ",Â options=[-0.272,Â 0,Â 0.236,Â 0.382,Â 0.5,Â 0.618,Â 0.702,Â 0.71,Â 0.786,Â 0.83,Â 0.886,Â 1,Â 1.272],Â group='â•â•â•â•â•â•Â StrongÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="0")
enable_StrongBand_BearÂ =Â input.bool(title='enableÂ LowerÂ BearishÂ BandÂ .Â .Â .Â FibÂ Level',Â defval=false,Â group='â•â•â•â•â•â•Â StrongÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="1")
select_StrongBand_Fib_BearÂ =Â input.float(0.382,Â '',Â options=[-0.272,Â 0,Â 0.236,Â 0.382,Â 0.5,Â 0.618,Â 0.702,Â 0.71,Â 0.786,Â 0.83,Â 0.886,Â 1,Â 1.272],Â group='â•â•â•â•â•â•Â StrongÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="1")
StrongBand_LookbackÂ =Â input.int(title='PivotÂ LookÂ Back',Â minval=1,Â defval=400,Â group='â•â•â•â•â•â•Â StrongÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="2")
StrongBand_EmaLenÂ =Â input.int(title='FibÂ EMAÂ Length',Â minval=1,Â defval=120,Â group='â•â•â•â•â•â•Â StrongÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="2")
//Â fibÂ middleÂ BandÂ regularÂ Trend
enable_MiddleBand_BullÂ =Â input.bool(title='enableÂ MiddleÂ BullishÂ BandÂ .Â .Â .Â FibÂ Level',Â defval=true,Â group='â•â•â•â•â•â•Â RegularÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="0")
select_MiddleBand_Fib_BullÂ =Â input.float(0.618,Â '',Â options=[-0.272,Â 0,Â 0.236,Â 0.382,Â 0.5,Â 0.6,Â 0.618,Â 0.702,Â 0.71,Â 0.786,Â 0.83,Â 0.886,Â 1,Â 1.272],Â group='â•â•â•â•â•â•Â RegularÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="0")
enable_MiddleBand_BearÂ =Â input.bool(title='enableÂ MiddleÂ BearishÂ BandÂ .Â .Â .Â FibÂ Level',Â defval=true,Â group='â•â•â•â•â•â•Â RegularÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="1")
select_MiddleBand_Fib_BearÂ =Â input.float(0.382,Â '',Â options=[-0.272,Â 0,Â 0.236,Â 0.382,Â 0.5,Â 0.618,Â 0.702,Â 0.71,Â 0.786,Â 0.83,Â 0.886,Â 1,Â 1.272],Â group='â•â•â•â•â•â•Â RegularÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="1")
MiddleBand_LookbackÂ =Â input.int(title='PivotÂ LookÂ Back',Â minval=1,Â defval=900,Â group='â•â•â•â•â•â•Â RegularÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="2")
MiddleBand_EmaLenÂ =Â input.int(title='FibÂ EMAÂ Length',Â minval=1,Â defval=400,Â group='â•â•â•â•â•â•Â RegularÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="2")
//Â fibÂ SidewaysÂ Band
enable_SidewaysBand_BullÂ =Â input.bool(title='enableÂ LowerÂ BullishÂ BandÂ .Â .Â .Â FibÂ Level',Â defval=true,Â group='â•â•â•â•â•â•Â SidewaysÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="0")
select_SidewaysBand_Fib_BullÂ =Â input.float(0.6,Â '',Â options=[-0.272,Â 0,Â 0.236,Â 0.382,Â 0.5,Â 0.6,Â 0.618,Â 0.702,Â 0.71,Â 0.786,Â 0.83,Â 0.886,Â 1,Â 1.272],Â group='â•â•â•â•â•â•Â SidewaysÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="0")
enable_SidewaysBand_BearÂ =Â input.bool(title='enableÂ UpperÂ BearishÂ BandÂ .Â .Â .Â FibÂ Level',Â defval=true,Â group='â•â•â•â•â•â•Â SidewaysÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="1")
select_SidewaysBand_Fib_BearÂ =Â input.float(0.5,Â '',Â options=[-0.272,Â 0,Â 0.236,Â 0.382,Â 0.5,Â 0.618,Â 0.702,Â 0.71,Â 0.786,Â 0.83,Â 0.886,Â 1,Â 1.272],Â group='â•â•â•â•â•â•Â SidewaysÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="1")
SidewaysBand_LookbackÂ =Â input.int(title='PivotÂ LookÂ Back',Â minval=1,Â defval=4000,Â group='â•â•â•â•â•â•Â SidewaysÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="2")
SidewaysBand_EmaLenÂ =Â input.int(title='FibÂ EMAÂ Length',Â minval=1,Â defval=150,Â group='â•â•â•â•â•â•Â SidewaysÂ TrendÂ LevelsÂ â•â•â•â•â•â•',Â inline="2")
//Â StrongÂ Band
isBelow_StrongBand_BullÂ =Â true
isBelow_StrongBand_BearÂ =Â true
StrongBand_Price_of_LowÂ =Â float(na)
StrongBand_Price_of_HighÂ =Â float(na)
StrongBand_Bear_Fib_PriceÂ =Â float(na)
StrongBand_Bull_Fib_PriceÂ =Â float(na)
///Â MiddleÂ Band
isBelow_MiddleBand_BullÂ =Â true
isBelow_MiddleBand_BearÂ =Â true
MiddleBand_Price_of_LowÂ =Â float(na)
MiddleBand_Price_of_HighÂ =Â float(na)
MiddleBand_Bear_Fib_PriceÂ =Â float(na)
MiddleBand_Bull_Fib_PriceÂ =Â float(na)
//Â SidewaysÂ Band
isBelow_SidewaysBand_BullÂ =Â true
isBelow_SidewaysBand_BearÂ =Â true
SidewaysBand_Price_of_LowÂ =Â float(na)
SidewaysBand_Price_of_HighÂ =Â float(na)
SidewaysBand_Bear_Fib_PriceÂ =Â float(na)
SidewaysBand_Bull_Fib_PriceÂ =Â float(na)
//Â getÂ FibÂ Levels
ifÂ enable_StrongBand_Bull
Â Â Â Â StrongBand_Price_of_HighÂ :=Â ta.highest(high,Â StrongBand_Lookback)
Â Â Â Â StrongBand_Price_of_LowÂ :=Â ta.lowest(low,Â StrongBand_Lookback)
Â Â Â Â StrongBand_Bull_Fib_PriceÂ :=Â (StrongBand_Price_of_HighÂ -Â StrongBand_Price_of_Low)Â *Â (1Â -Â select_StrongBand_Fib_Bull)Â +Â StrongBand_Price_of_LowÂ //+Â fibbullHighDivi
Â Â Â Â isBelow_StrongBand_BullÂ :=Â StrongBand_Bull_Fib_PriceÂ >Â ta.lowest(low,Â 2)Â orÂ notÂ enable_StrongBand_Bull
ifÂ enable_StrongBand_Bear
Â Â Â Â StrongBand_Price_of_HighÂ :=Â ta.highest(high,Â StrongBand_Lookback)
Â Â Â Â StrongBand_Price_of_LowÂ :=Â ta.lowest(low,Â StrongBand_Lookback)
Â Â Â Â StrongBand_Bear_Fib_PriceÂ :=Â (StrongBand_Price_of_HighÂ -Â StrongBand_Price_of_Low)Â *Â (1Â -Â select_StrongBand_Fib_Bear)Â +Â StrongBand_Price_of_Low//Â +Â fibbullLowhDivi
Â Â Â Â isBelow_StrongBand_BearÂ :=Â StrongBand_Bear_Fib_PriceÂ <Â ta.highest(low,Â 2)Â orÂ notÂ enable_StrongBand_Bear
ifÂ enable_MiddleBand_Bull
Â Â Â Â MiddleBand_Price_of_HighÂ :=Â ta.highest(high,Â MiddleBand_Lookback)
Â Â Â Â MiddleBand_Price_of_LowÂ :=Â ta.lowest(low,Â MiddleBand_Lookback)
Â Â Â Â MiddleBand_Bull_Fib_PriceÂ :=Â (MiddleBand_Price_of_HighÂ -Â MiddleBand_Price_of_Low)Â *Â (1Â -Â select_MiddleBand_Fib_Bull)Â +Â MiddleBand_Price_of_LowÂ //+Â fibbullHighDivi
Â Â Â Â isBelow_MiddleBand_BullÂ :=Â MiddleBand_Bull_Fib_PriceÂ >Â ta.lowest(low,Â 2)Â orÂ notÂ enable_MiddleBand_Bull
ifÂ enable_MiddleBand_Bear
Â Â Â Â MiddleBand_Price_of_HighÂ :=Â ta.highest(high,Â MiddleBand_Lookback)
Â Â Â Â MiddleBand_Price_of_LowÂ :=Â ta.lowest(low,Â MiddleBand_Lookback)
Â Â Â Â MiddleBand_Bear_Fib_PriceÂ :=Â (MiddleBand_Price_of_HighÂ -Â MiddleBand_Price_of_Low)Â *Â (1Â -Â select_MiddleBand_Fib_Bear)Â +Â MiddleBand_Price_of_Low//Â +Â fibbullLowhDivi
Â Â Â Â isBelow_MiddleBand_BearÂ :=Â MiddleBand_Bear_Fib_PriceÂ <Â ta.highest(low,Â 2)Â orÂ notÂ enable_MiddleBand_Bear
ifÂ enable_SidewaysBand_Bull
Â Â Â Â SidewaysBand_Price_of_HighÂ :=Â ta.highest(high,Â SidewaysBand_Lookback)
Â Â Â Â SidewaysBand_Price_of_LowÂ :=Â ta.lowest(low,Â SidewaysBand_Lookback)
Â Â Â Â SidewaysBand_Bull_Fib_PriceÂ :=Â (SidewaysBand_Price_of_HighÂ -Â SidewaysBand_Price_of_Low)Â *Â (1Â -Â select_SidewaysBand_Fib_Bull)Â +Â SidewaysBand_Price_of_LowÂ //+Â fibbullHighDivi
Â Â Â Â isBelow_SidewaysBand_BullÂ :=Â SidewaysBand_Bull_Fib_PriceÂ >Â ta.lowest(low,Â 2)Â orÂ notÂ enable_SidewaysBand_Bull
ifÂ enable_SidewaysBand_Bear
Â Â Â Â SidewaysBand_Price_of_HighÂ :=Â ta.highest(high,Â SidewaysBand_Lookback)
Â Â Â Â SidewaysBand_Price_of_LowÂ :=Â ta.lowest(low,Â SidewaysBand_Lookback)
Â Â Â Â SidewaysBand_Bear_Fib_PriceÂ :=Â (SidewaysBand_Price_of_HighÂ -Â SidewaysBand_Price_of_Low)Â *Â (1Â -Â select_SidewaysBand_Fib_Bear)Â +Â SidewaysBand_Price_of_Low//Â +Â fibbullLowhDivi
Â Â Â Â isBelow_SidewaysBand_BearÂ :=Â SidewaysBand_Bear_Fib_PriceÂ <Â ta.highest(low,Â 2)Â orÂ notÂ enable_SidewaysBand_Bear
//Â FibÂ EMAs
//Â fibÂ emaÂ StrongÂ Trend
StrongBand_current_Trend_EMAÂ =Â float(na)
StrongBand_Bull_EMAÂ =Â ta.ema(StrongBand_Bull_Fib_Price,Â StrongBand_EmaLen)
StrongBand_Bear_EMAÂ =Â ta.ema(StrongBand_Bear_Fib_Price,Â StrongBand_EmaLen)
StrongBand_Ema_in_UptrendÂ =Â ta.change(StrongBand_Bull_EMA)Â >Â 0Â orÂ ta.change(StrongBand_Bear_EMA)Â >Â 0
StrongBand_Ema_SidewaysÂ =Â ta.change(StrongBand_Bull_EMA)Â ==Â 0Â orÂ ta.change(StrongBand_Bear_EMA)Â ==Â 0
StrongBand_Ema_in_DowntrendÂ =Â ta.change(StrongBand_Bull_EMA)Â <Â 0Â orÂ ta.change(StrongBand_Bear_EMA)Â <Â 0
ifÂ StrongBand_Ema_in_UptrendÂ orÂ StrongBand_Ema_Sideways
Â Â Â Â StrongBand_current_Trend_EMAÂ :=Â StrongBand_Bull_EMA
ifÂ StrongBand_Ema_in_DowntrendÂ 
Â Â Â Â StrongBand_current_Trend_EMAÂ :=Â StrongBand_Bear_EMA
//Â fibÂ emaÂ NormalÂ Trend
MiddleBand_current_Trend_EMAÂ =Â float(na)
MiddleBand_Bull_EMAÂ =Â ta.ema(MiddleBand_Bull_Fib_Price,Â MiddleBand_EmaLen)
MiddleBand_Bear_EMAÂ =Â ta.ema(MiddleBand_Bear_Fib_Price,Â MiddleBand_EmaLen)
MiddleBand_Ema_in_UptrendÂ =Â ta.change(MiddleBand_Bull_EMA)Â >Â 0Â orÂ ta.change(MiddleBand_Bear_EMA)Â >Â 0
MiddleBand_Ema_SidewaysÂ =Â ta.change(MiddleBand_Bull_EMA)Â ==Â 0Â orÂ ta.change(MiddleBand_Bear_EMA)Â ==Â 0
MiddleBand_Ema_in_DowntrendÂ =Â ta.change(MiddleBand_Bull_EMA)Â <Â 0Â orÂ ta.change(MiddleBand_Bear_EMA)Â <Â 0
ifÂ MiddleBand_Ema_in_UptrendÂ orÂ MiddleBand_Ema_Sideways
Â Â Â Â MiddleBand_current_Trend_EMAÂ :=Â MiddleBand_Bull_EMA
ifÂ MiddleBand_Ema_in_DowntrendÂ 
Â Â Â Â MiddleBand_current_Trend_EMAÂ :=Â MiddleBand_Bear_EMA
//Â fibÂ emaÂ SidewaysÂ Trend
SidewaysBand_current_Trend_EMAÂ =Â float(na)
SidewaysBand_Bull_EMAÂ =Â ta.ema(SidewaysBand_Bull_Fib_Price,Â SidewaysBand_EmaLen)
SidewaysBand_Bear_EMAÂ =Â ta.ema(SidewaysBand_Bear_Fib_Price,Â SidewaysBand_EmaLen)
SidewaysBand_Ema_in_UptrendÂ =Â ta.change(SidewaysBand_Bull_EMA)Â >Â 0Â orÂ ta.change(SidewaysBand_Bear_EMA)Â >Â 0
SidewaysBand_Ema_SidewaysÂ =Â ta.change(SidewaysBand_Bull_EMA)Â ==Â 0Â orÂ ta.change(SidewaysBand_Bear_EMA)Â ==Â 0
SidewaysBand_Ema_in_DowntrendÂ =Â ta.change(SidewaysBand_Bull_EMA)Â <Â 0Â orÂ ta.change(SidewaysBand_Bear_EMA)Â <Â 0
ifÂ SidewaysBand_Ema_in_UptrendÂ orÂ SidewaysBand_Ema_Sideways
Â Â Â Â SidewaysBand_current_Trend_EMAÂ :=Â SidewaysBand_Bull_EMA
ifÂ SidewaysBand_Ema_in_DowntrendÂ 
Â Â Â Â SidewaysBand_current_Trend_EMAÂ :=Â SidewaysBand_Bear_EMA
//Â trendÂ statesÂ andÂ colors
all_Fib_Emas_TrendingÂ =Â StrongBand_Ema_in_UptrendÂ andÂ MiddleBand_Ema_in_UptrendÂ andÂ SidewaysBand_Ema_in_Uptrend
all_Fib_Emas_DowntrendÂ =Â MiddleBand_Ema_in_DowntrendÂ andÂ StrongBand_Ema_in_DowntrendÂ andÂ SidewaysBand_Ema_in_Downtrend
all_Fib_Emas_SidewaysÂ =Â MiddleBand_Ema_SidewaysÂ andÂ StrongBand_Ema_SidewaysÂ andÂ SidewaysBand_Ema_Sideways
all_Fib_Emas_Trend_or_SidewaysÂ =Â (MiddleBand_Ema_SidewaysÂ orÂ StrongBand_Ema_SidewaysÂ orÂ SidewaysBand_Ema_Sideways)Â orÂ (StrongBand_Ema_in_UptrendÂ orÂ MiddleBand_Ema_in_UptrendÂ orÂ SidewaysBand_Ema_in_Uptrend)Â andÂ notÂ (MiddleBand_Ema_in_DowntrendÂ orÂ StrongBand_Ema_in_DowntrendÂ orÂ SidewaysBand_Ema_in_Downtrend)
allFibsUpAndDownTrendÂ =Â (MiddleBand_Ema_in_DowntrendÂ orÂ StrongBand_Ema_in_DowntrendÂ orÂ SidewaysBand_Ema_in_Downtrend)Â andÂ (MiddleBand_Ema_SidewaysÂ orÂ SidewaysBand_Ema_SidewaysÂ orÂ StrongBand_Ema_SidewaysÂ orÂ StrongBand_Ema_in_UptrendÂ orÂ MiddleBand_Ema_in_UptrendÂ orÂ SidewaysBand_Ema_in_Uptrend)
Middle_and_Sideways_Emas_TrendingÂ =Â MiddleBand_Ema_in_UptrendÂ andÂ SidewaysBand_Ema_in_Uptrend
Middle_and_Sideways_Fib_Emas_DowntrendÂ =Â MiddleBand_Ema_in_DowntrendÂ andÂ SidewaysBand_Ema_in_Downtrend
Middle_and_Sideways_Fib_Emas_SidewaysÂ =Â MiddleBand_Ema_SidewaysÂ andÂ SidewaysBand_Ema_Sideways
Middle_and_Sideways_Fib_Emas_Trend_or_SidewaysÂ =Â (MiddleBand_Ema_SidewaysÂ orÂ SidewaysBand_Ema_Sideways)Â orÂ (MiddleBand_Ema_in_UptrendÂ orÂ SidewaysBand_Ema_in_Uptrend)Â andÂ notÂ (MiddleBand_Ema_in_DowntrendÂ orÂ SidewaysBand_Ema_in_Downtrend)
Middle_and_Sideways_UpAndDownTrendÂ =Â (MiddleBand_Ema_in_DowntrendÂ orÂ SidewaysBand_Ema_in_Downtrend)Â andÂ (MiddleBand_Ema_SidewaysÂ orÂ SidewaysBand_Ema_SidewaysÂ orÂ MiddleBand_Ema_in_UptrendÂ orÂ SidewaysBand_Ema_in_Uptrend)
UpperBand_Ema_ColorÂ =Â all_Fib_Emas_Trend_or_SidewaysÂ ?Â color.limeÂ :Â all_Fib_Emas_DowntrendÂ ?Â color.redÂ :Â allFibsUpAndDownTrendÂ ?Â color.whiteÂ :Â na
MiddleBand_Ema_ColorÂ =Â Middle_and_Sideways_Fib_Emas_Trend_or_SidewaysÂ ?Â color.limeÂ :Â Middle_and_Sideways_Fib_Emas_DowntrendÂ ?Â color.redÂ :Â Middle_and_Sideways_UpAndDownTrendÂ ?Â color.whiteÂ :Â na
SidewaysBand_Ema_ColorÂ =Â SidewaysBand_Ema_in_UptrendÂ ?Â color.limeÂ :Â SidewaysBand_Ema_in_DowntrendÂ ?Â color.redÂ :Â (SidewaysBand_Ema_in_DowntrendÂ andÂ (SidewaysBand_Ema_SidewaysÂ orÂ SidewaysBand_Ema_in_Uptrend))Â ?Â color.whiteÂ :Â na
plotStrong_EmaÂ =Â plot(StrongBand_current_Trend_EMA,Â color=UpperBand_Ema_Color,Â title="StrongÂ Trend")
plotMiddle_EmaÂ =Â plot(MiddleBand_current_Trend_EMA,Â color=MiddleBand_Ema_Color,Â title="NormalÂ Trend")
plotSideways_EmaÂ =Â plot(SidewaysBand_current_Trend_EMA,Â color=SidewaysBand_Ema_Color,Â title="Sidewaysd")
Strong_Middle_fillcolorÂ =Â color.new(color.green,Â 90)
ifÂ all_Fib_Emas_Trend_or_Sideways
Â Â Â Â Strong_Middle_fillcolorÂ :=Â color.new(color.green,Â 90)
ifÂ all_Fib_Emas_Downtrend
Â Â Â Â Strong_Middle_fillcolorÂ :=Â color.new(color.red,Â 90)
Â Â Â Â 
ifÂ allFibsUpAndDownTrend
Â Â Â Â Strong_Middle_fillcolorÂ :=Â color.new(color.white,Â 90)
Middle_Sideways_fillcolorÂ =Â color.new(color.green,Â 90)
ifÂ Middle_and_Sideways_Fib_Emas_Trend_or_Sideways
Â Â Â Â Middle_Sideways_fillcolorÂ :=Â color.new(color.green,Â 90)
ifÂ Middle_and_Sideways_Fib_Emas_Downtrend
Â Â Â Â Middle_Sideways_fillcolorÂ :=Â color.new(color.red,Â 90)
Â Â Â Â 
ifÂ Middle_and_Sideways_UpAndDownTrend
Â Â Â Â Middle_Sideways_fillcolorÂ :=Â color.new(color.white,Â 90)
fill(plotStrong_Ema,Â plotMiddle_Ema,Â color=Strong_Middle_fillcolor,Â title="fibÂ bandÂ background")
fill(plotMiddle_Ema,Â plotSideways_Ema,Â color=Middle_Sideways_fillcolor,Â title="fibÂ bandÂ background")
//Â buyÂ condition
StrongBand_Price_was_below_Bull_levelÂ =Â ta.lowest(low,Â 1)Â <Â StrongBand_current_Trend_EMA
StrongBand_Price_is_above_Bull_levelÂ =Â Â closeÂ >Â StrongBand_current_Trend_EMA
StronBand_Price_Average_above_Bull_LevelÂ =Â ta.ema(low,Â 10)Â >Â StrongBand_current_Trend_EMA
StrongBand_Low_isnt_toLowÂ =Â (ta.lowest(StrongBand_current_Trend_EMA,Â 15)Â -Â ta.lowest(low,Â 15))Â <Â closeÂ *Â 0.005
StronBand_Trend_isnt_freshÂ =Â ta.barssince(StrongBand_Ema_in_Downtrend)Â >Â 50Â orÂ na(ta.barssince(StrongBand_Ema_in_Downtrend))
MiddleBand_Price_was_below_Bull_levelÂ =Â ta.lowest(low,Â 1)Â <Â MiddleBand_current_Trend_EMA
MiddleBand_Price_is_above_Bull_levelÂ =Â closeÂ >Â MiddleBand_current_Trend_EMA
MiddleBand_Price_Average_above_Bull_LevelÂ =Â ta.ema(close,Â 20)Â >Â MiddleBand_current_Trend_EMA
MiddleBand_Low_isnt_toLowÂ =Â (ta.lowest(MiddleBand_current_Trend_EMA,Â 10)Â -Â ta.lowest(low,Â 10))Â <Â closeÂ *Â 0.0065
MiddleBand_Trend_isnt_freshÂ =Â ta.barssince(MiddleBand_Ema_in_Downtrend)Â >Â 50Â orÂ na(ta.barssince(MiddleBand_Ema_in_Downtrend))
SidewaysBand_Price_was_below_Bull_levelÂ =Â ta.lowest(low,Â 1)Â <Â SidewaysBand_current_Trend_EMA
SidewaysBand_Price_is_above_Bull_levelÂ =Â Â closeÂ >Â SidewaysBand_current_Trend_EMA
SidewaysBand_Price_Average_above_Bull_LevelÂ =Â ta.ema(low,Â 80)Â >Â SidewaysBand_current_Trend_EMA
SidewaysBand_Low_isnt_toLowÂ =Â (ta.lowest(SidewaysBand_current_Trend_EMA,Â 150)Â -Â ta.lowest(low,Â 150))Â <Â closeÂ *Â 0.0065
SidewaysBand_Trend_isnt_freshÂ =Â ta.barssince(SidewaysBand_Ema_in_Downtrend)Â >Â 50Â orÂ na(ta.barssince(SidewaysBand_Ema_in_Downtrend))
StrongBand_Buy_AlertÂ =Â StronBand_Trend_isnt_freshÂ andÂ StrongBand_Low_isnt_toLowÂ andÂ StronBand_Price_Average_above_Bull_LevelÂ andÂ StrongBand_Price_was_below_Bull_levelÂ andÂ StrongBand_Price_is_above_Bull_levelÂ andÂ all_Fib_Emas_Trend_or_Sideways
MiddleBand_Buy_AlertÂ =Â MiddleBand_Trend_isnt_freshÂ andÂ MiddleBand_Low_isnt_toLowÂ andÂ MiddleBand_Price_Average_above_Bull_LevelÂ andÂ MiddleBand_Price_was_below_Bull_levelÂ andÂ MiddleBand_Price_is_above_Bull_levelÂ andÂ Middle_and_Sideways_Fib_Emas_Trend_or_Sideways
SidewaysBand_Buy_AlertÂ =Â SidewaysBand_Trend_isnt_freshÂ andÂ SidewaysBand_Low_isnt_toLowÂ andÂ SidewaysBand_Price_Average_above_Bull_LevelÂ andÂ SidewaysBand_Price_was_below_Bull_levelÂ andÂ SidewaysBand_Price_is_above_Bull_levelÂ andÂ (SidewaysBand_Ema_SidewaysÂ orÂ SidewaysBand_Ema_in_UptrendÂ andÂ (Â notÂ SidewaysBand_Ema_in_Downtrend))
//Â SellÂ condition
StrongBand_Price_was_above_Bear_levelÂ =Â ta.highest(high,Â 1)Â >Â StrongBand_current_Trend_EMA
StrongBand_Price_is_below_Bear_levelÂ =Â Â closeÂ <Â StrongBand_current_Trend_EMA
StronBand_Price_Average_below_Bear_LevelÂ =Â ta.sma(high,Â 10)Â <Â StrongBand_current_Trend_EMA
StrongBand_High_isnt_to_HighÂ =Â (ta.highest(high,Â 15)Â -Â ta.highest(StrongBand_current_Trend_EMA,Â 15))Â <Â closeÂ *Â 0.005
StrongBand_Bear_Trend_isnt_freshÂ =Â ta.barssince(StrongBand_Ema_in_Uptrend)Â >Â 50
MiddleBand_Price_was_above_Bear_levelÂ =Â ta.highest(high,Â 1)Â >Â MiddleBand_current_Trend_EMA
MiddleBand_Price_is_below_Bear_levelÂ =Â Â closeÂ <Â MiddleBand_current_Trend_EMA
MiddleBand_Price_Average_below_Bear_LevelÂ =Â ta.sma(high,Â 9)Â <Â MiddleBand_current_Trend_EMA
MiddleBand_High_isnt_to_HighÂ =Â (ta.highest(high,Â 10)Â -Â ta.highest(MiddleBand_current_Trend_EMA,Â 10))Â <Â closeÂ *Â 0.0065
MiddleBand_Bear_Trend_isnt_freshÂ =Â ta.barssince(MiddleBand_Ema_in_Uptrend)Â >Â 50
SidewaysBand_Price_was_above_Bear_levelÂ =Â ta.highest(high,Â 1)Â >Â SidewaysBand_current_Trend_EMA
SidewaysBand_Price_is_below_Bear_levelÂ =Â Â closeÂ <Â SidewaysBand_current_Trend_EMA
SidewaysBand_Price_Average_below_Bear_LevelÂ =Â ta.sma(high,Â 20)Â <Â SidewaysBand_current_Trend_EMA
SidewaysBand_High_isnt_to_HighÂ =Â (ta.highest(high,Â 20)Â -Â ta.highest(SidewaysBand_current_Trend_EMA,Â 15))Â <Â closeÂ *Â 0.0065
SidewaysBand_Bear_Trend_isnt_freshÂ =Â ta.barssince(SidewaysBand_Ema_in_Uptrend)Â >Â 50
StrongBand_Sell_AlertÂ =Â StronBand_Price_Average_below_Bear_LevelÂ andÂ StrongBand_High_isnt_to_HighÂ andÂ StrongBand_Bear_Trend_isnt_freshÂ andÂ StrongBand_Price_was_above_Bear_levelÂ andÂ StrongBand_Price_is_below_Bear_levelÂ andÂ all_Fib_Emas_DowntrendÂ andÂ notÂ all_Fib_Emas_Trend_or_Sideways
MiddleBand_Sell_AlertÂ =Â MiddleBand_Price_Average_below_Bear_LevelÂ andÂ MiddleBand_High_isnt_to_HighÂ andÂ MiddleBand_Bear_Trend_isnt_freshÂ andÂ MiddleBand_Price_was_above_Bear_levelÂ andÂ MiddleBand_Price_is_below_Bear_levelÂ andÂ Middle_and_Sideways_Fib_Emas_DowntrendÂ andÂ notÂ Middle_and_Sideways_Fib_Emas_Trend_or_Sideways
SidewaysBand_Sell_AlertÂ =Â SidewaysBand_Price_Average_below_Bear_LevelÂ andÂ SidewaysBand_High_isnt_to_HighÂ andÂ SidewaysBand_Bear_Trend_isnt_freshÂ andÂ SidewaysBand_Price_was_above_Bear_levelÂ andÂ SidewaysBand_Price_is_below_Bear_levelÂ andÂ SidewaysBand_Ema_in_DowntrendÂ andÂ notÂ (SidewaysBand_Ema_SidewaysÂ orÂ SidewaysBand_Ema_in_UptrendÂ andÂ (Â notÂ SidewaysBand_Ema_in_Downtrend))
//Â Backtester
//////////////////Â StopÂ Loss
//Â StopÂ loss
enableSLÂ =Â Â input.bool(true,Â title='enableÂ StopÂ Loss',Â group='â•â•â•â•â•â•â•â•â•â•Â StopÂ LossÂ SettingsÂ â•â•â•â•â•â•â•â•â•â•')
whichSLÂ =Â Â input.string(defval='low/highÂ asÂ SL',Â title='SLÂ basedÂ onÂ staticÂ %Â orÂ basedÂ onÂ theÂ low/high',Â options=['low/highÂ asÂ SL',Â 'staticÂ %Â asÂ SL'],Â group='â•â•â•â•â•â•â•â•â•â•Â StopÂ LossÂ SettingsÂ â•â•â•â•â•â•â•â•â•â•')
whichOffsetÂ =Â input.string(defval='%Â asÂ offset',Â title='chooseÂ offsetÂ fromÂ theÂ low/high',Â options=['$Â asÂ offset',Â '%Â asÂ offset'],Â group='StopÂ LossÂ atÂ theÂ low/high')
lowPBufferÂ =Â input.float(1.4,Â title='SLÂ OffsetÂ fromÂ theÂ Low/highÂ inÂ %',Â group='StopÂ LossÂ atÂ theÂ low/high')Â /Â 100
lowDBufferÂ =Â input.float(100,Â title='SLÂ OffsetÂ fromÂ theÂ Low/highÂ inÂ $',Â group='StopÂ LossÂ atÂ theÂ low/high')
SlLowLookbackÂ =Â input.int(title='SLÂ lookbackÂ forÂ Low/high',Â defval=5,Â minval=1,Â maxval=50,Â group='StopÂ LossÂ atÂ theÂ low/high')
longSlLowÂ =Â float(na)
shortSlLowÂ =Â float(na)
ifÂ whichOffsetÂ ==Â "%Â asÂ offset"Â andÂ whichSLÂ ==Â "low/highÂ asÂ SL"Â andÂ enableSL
Â Â Â Â longSlLowÂ :=Â ta.lowest(low,Â SlLowLookback)Â *Â (1Â -Â lowPBuffer)
Â Â Â Â shortSlLowÂ :=Â ta.highest(high,Â SlLowLookback)Â *Â (1Â +Â lowPBuffer)
ifÂ whichOffsetÂ ==Â "$Â asÂ offset"Â andÂ whichSLÂ ==Â "low/highÂ asÂ SL"Â andÂ enableSL
Â Â Â Â longSlLowÂ :=Â ta.lowest(low,Â SlLowLookback)Â -Â lowDBuffer
Â Â Â Â shortSlLowÂ :=Â ta.highest(high,Â SlLowLookback)Â +Â lowDBuffer
//plot(shortSlLow,Â title="stoploss",Â color=color.new(#00bcd4,Â 0))
//Â longÂ settingsÂ -Â ðŸ”¥Â uncommentÂ theÂ 6Â linesÂ belowÂ toÂ disableÂ theÂ alertsÂ andÂ enableÂ theÂ backtesterÂ 
longStopLossÂ =Â input.float(0.5,Â title='LongÂ StopÂ LossÂ inÂ %',Â group='staticÂ %Â StopÂ Loss',Â inline='InputÂ 1')Â /Â 100
//Â shortÂ settingsÂ -Â ðŸ”¥Â uncommentÂ theÂ 6Â linesÂ belowÂ toÂ disableÂ theÂ alertsÂ andÂ enableÂ theÂ backtesterÂ 
shortStopLossÂ =Â input.float(0.5,Â title='ShortÂ StopÂ LossÂ inÂ %',Â group='staticÂ %Â StopÂ Loss',Â inline='InputÂ 1')Â /Â 100
///////Â TakeÂ profit
longTakeProfit1Â =Â input.float(4,Â title='LongÂ TakeÂ ProfitÂ inÂ %',Â group='TakeÂ Profit',Â inline='InputÂ 1')Â /Â 100
///////Â TakeÂ profit
shortTakeProfit1Â =Â input.float(1.6,Â title='ShortÂ TakeÂ ProfitÂ inÂ %',Â group='TakeÂ Profit',Â inline='InputÂ 1')Â /Â 100
//////////////////Â SLÂ TPÂ END
///////////////////Â alertsÂ 
selectalertFreqÂ =Â input.string(defval='onceÂ perÂ barÂ close',Â title='AlertÂ Options',Â options=['onceÂ perÂ bar',Â 'onceÂ perÂ barÂ close',Â 'all'],Â group='â•â•â•â•â•â•â•â•â•â•â•Â alertÂ settingsÂ â•â•â•â•â•â•â•â•â•â•â•')
BuyAlertMessageÂ =Â input.string(defval="BullishÂ DivergenceÂ detected,Â putÂ yourÂ SLÂ @",Â title='BuyÂ AlertÂ Message',Â Â group='â•â•â•â•â•â•â•â•â•â•â•Â alertÂ settingsÂ â•â•â•â•â•â•â•â•â•â•â•')
enableSlMessageÂ =Â Â input.bool(true,Â title='enableÂ StopÂ LossÂ ValueÂ atÂ theÂ endÂ ofÂ "buyÂ AlertÂ message"',Â group='â•â•â•â•â•â•â•â•â•â•â•Â alertÂ settingsÂ â•â•â•â•â•â•â•â•â•â•â•')
AfterSLMessageÂ =Â input.string(defval="",Â title='BuyÂ AlertÂ messageÂ afterÂ SLÂ Value',Â Â group='â•â•â•â•â•â•â•â•â•â•â•Â alertÂ settingsÂ â•â•â•â•â•â•â•â•â•â•â•')
Â 
//////////////////Â BacktesterÂ 
//Â ðŸ”¥Â uncommentÂ theÂ allÂ linesÂ belowÂ forÂ theÂ backtesterÂ andÂ revertÂ forÂ alerts
shortTradingÂ =Â enable_MiddleBand_BearÂ orÂ enable_StrongBand_BearÂ orÂ enable_SidewaysBand_Bear
longTradingÂ =Â enable_StrongBand_BullÂ orÂ enable_MiddleBand_BullÂ orÂ enable_SidewaysBand_Bull
longTP1Â =Â strategy.position_sizeÂ >Â 0Â ?Â strategy.position_avg_priceÂ *Â (1Â +Â longTakeProfit1)Â :Â strategy.position_sizeÂ <Â 0Â ?Â strategy.position_avg_priceÂ *Â (1Â -Â longTakeProfit1)Â :Â na
longSLÂ =Â strategy.position_sizeÂ >Â 0Â ?Â strategy.position_avg_priceÂ *Â (1Â -Â longStopLoss)Â :Â strategy.position_sizeÂ <Â 0Â ?Â strategy.position_avg_priceÂ *Â (1Â +Â longStopLoss)Â :Â na
shortTPÂ =Â strategy.position_sizeÂ >Â 0Â ?Â strategy.position_avg_priceÂ *Â (1Â +Â shortTakeProfit1)Â :Â strategy.position_sizeÂ <Â 0Â ?Â strategy.position_avg_priceÂ *Â (1Â -Â shortTakeProfit1)Â :Â na
shortSLÂ =Â strategy.position_sizeÂ >Â 0Â ?Â strategy.position_avg_priceÂ *Â (1Â -Â shortStopLoss)Â :Â strategy.position_sizeÂ <Â 0Â ?Â strategy.position_avg_priceÂ *Â (1Â +Â shortStopLoss)Â :Â na
strategy.risk.allow_entry_in(longTradingÂ ==Â trueÂ andÂ shortTradingÂ ==Â trueÂ ?Â strategy.direction.allÂ :Â longTradingÂ ==Â trueÂ ?Â strategy.direction.longÂ :Â shortTradingÂ ==Â trueÂ ?Â strategy.direction.shortÂ :Â na)
strategy.entry('Bull',Â strategy.long,Â comment='UpperÂ BandÂ Long',Â when=StrongBand_Buy_Alert)
strategy.entry('Bull',Â strategy.long,Â comment='LowerÂ BandÂ Long',Â when=MiddleBand_Buy_Alert)
strategy.entry('Bull',Â strategy.long,Â comment='LowerÂ BandÂ Long',Â when=SidewaysBand_Buy_Alert)
strategy.entry('Bear',Â strategy.short,Â comment='UpperÂ BandÂ Short',Â when=StrongBand_Sell_Alert)
strategy.entry('Bear',Â strategy.short,Â comment='LowerÂ BandÂ Short',Â when=MiddleBand_Sell_Alert)
strategy.entry('Bear',Â strategy.short,Â comment='LowerÂ BandÂ Short',Â when=SidewaysBand_Sell_Alert)
//Â checkÂ whichÂ SLÂ toÂ use
ifÂ enableSLÂ andÂ whichSLÂ ==Â 'staticÂ %Â asÂ SL'
Â Â Â Â strategy.exit(id='longTP-SL',Â from_entry='Bull',Â limit=longTP1,Â stop=longSL)
Â Â Â Â strategy.exit(id='shortTP-SL',Â from_entry='Bear',Â limit=shortTP,Â stop=shortSL)
//Â getÂ barsÂ sinceÂ lastÂ entryÂ forÂ theÂ SLÂ atÂ lowÂ toÂ work
barsSinceLastEntry()=>
Â Â Â Â strategy.opentradesÂ >Â 0Â ?Â (bar_indexÂ -Â strategy.opentrades.entry_bar_index(strategy.opentrades-1))Â :Â na
Â Â Â Â 
ifÂ enableSLÂ andÂ whichSLÂ ==Â 'low/highÂ asÂ SL'Â andÂ ta.barssince(StrongBand_Buy_AlertÂ orÂ MiddleBand_Buy_AlertÂ orÂ SidewaysBand_Buy_Alert)Â <Â 2Â andÂ barsSinceLastEntry()Â <Â 2
Â Â Â Â strategy.exit(id='longTP-SL',Â from_entry='Bull',Â limit=longTP1,Â stop=longSlLow)
ifÂ enableSLÂ andÂ whichSLÂ ==Â 'low/highÂ asÂ SL'Â andÂ ta.barssince(StrongBand_Sell_AlertÂ orÂ MiddleBand_Sell_AlertÂ orÂ SidewaysBand_Sell_Alert)Â <Â 2Â andÂ barsSinceLastEntry()Â <Â 2
Â Â Â Â strategy.exit(id='shortTP-SL',Â from_entry='Bear',Â limit=shortTP,Â stop=shortSlLow)
ifÂ notÂ enableSL
Â Â Â Â strategy.exit(id='longTP-SL',Â from_entry='Bull',Â limit=longTP1)
Â Â Â Â strategy.exit(id='shortTP-SL',Â from_entry='Bear',Â limit=shortTP)
Expand (382 lines)