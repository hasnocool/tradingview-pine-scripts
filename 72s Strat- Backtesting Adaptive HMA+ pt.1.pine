Script Name: 72s Strat- Backtesting Adaptive HMA+ pt.1
Author: io72signals
Description: This is a follow up to my previous publication of  Adaptive HMA+  few months ago, as a mean to provide some kind of initial backtesting tools. Which can be use to explore many possible strategies, optimise its settings to better conform user's pair/tf, and hopefully able to help tweaking your general strategy.

If you haven't read the study or use the indicator,...
PineScript code:

Pine Scriptâ„¢ strategy
72s Strat: Backtesting Adaptive HMA+ pt.1
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
//Â ThisÂ sourceÂ codeÂ isÂ subjectÂ toÂ theÂ termsÂ ofÂ theÂ MozillaÂ PublicÂ LicenseÂ 2.0Â atÂ https://mozilla.org/MPL/2.0/
//Â 2020Â Â©Â io72signalsÂ /Â AntorioÂ Bergasdito
//@version=4
strategy("72sÂ Strategy:Â AdaptiveÂ HullÂ MovingÂ Average+Â pt.1",Â shorttitle="72sÂ Strat:Â AdaptiveÂ HMA+Â pt.1",Â overlay=true,Â 
Â Â Â Â Â pyramiding=1,Â initial_capital=1000,Â commission_type=strategy.commission.cash_per_order,Â commission_value=.5,Â 
Â Â Â Â Â slippage=3,Â max_bars_back=1000)
atrBaseÂ Â =Â atr(21)
srcÂ Â Â Â Â Â =Â close
adaptPctÂ =Â 0.03141
//{Â INPUTS
orderSizeÂ Â Â =Â input(0.1,Â title="OrderÂ SizeÂ (inÂ Lot)",Â step=.1,Â group="ORDERS")
minProfitÂ Â Â =Â input(1,Â step=.1,Â title="BaseÂ MinimumÂ ProfitÂ beforeÂ exitÂ (ATR)",Â group="ORDERS")Â *Â atrBase
takeProfitÂ Â =Â input(3,Â step=.1,Â title="DefaultÂ TargetÂ ProfitÂ (ATR)",Â group="ORDERS")Â *Â atrBase
useSLÂ Â Â Â Â Â Â =Â input(true,Â title="UseÂ StopLoss",Â group="ORDERS")
SLInputÂ Â Â Â Â =Â input("HalfÂ DistanceÂ Zone",Â title="BaseÂ StopLossÂ Point",Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â options=["OneÂ DistanceÂ Zone",Â "HalfÂ DistanceÂ Zone",Â "LastÂ High/Low",Â "ATRÂ Only"],Â group="ORDERS")
maxSLÂ Â Â Â Â Â Â =Â input(4.5,Â step=.1,Â title="MaximumÂ StopLossÂ (ATR)",Â group="ORDERS")Â *Â atrBase
doubleUpÂ Â Â Â =Â input(false,Â "ActivateÂ 2ndÂ orderÂ withÂ xHMA+Â exits",Â group="ORDERS")Â Â Â Â //IfÂ enable,Â setÂ pyramidingÂ toÂ atÂ least:Â 2
minLengthÂ Â Â =Â input(172,Â title="Minimum:",Â group="AdaptiveÂ HMA+Â Period",Â inline="HMA+")
maxLengthÂ Â Â =Â input(233,Â title="Maximum:",Â group="AdaptiveÂ HMA+Â Period",Â inline="HMA+")
flatÂ Â Â Â Â Â Â Â =Â input(17,Â title="FlatÂ MarketÂ whenÂ xHMA'sÂ slopeÂ below",Â group="MarketÂ Movement")
atrFastÂ Â Â Â Â =Â input(14,Â "ChargedÂ ifÂ ATR",Â group="MarketÂ Movement",Â inline="volality",Â minval=2,Â maxval=34)
atrSlowÂ Â Â Â Â =Â input(46,Â ">=Â ATR",Â group="MarketÂ Movement",Â inline="volality",Â minval=21,Â maxval=120)
showZoneÂ Â Â Â =Â input(false,Â title="ShowÂ AdaptiveÂ HMA+Â DistanceÂ Zone",Â group="DISTANCEÂ ZONE")
multÂ Â Â Â Â Â Â Â =Â input(2.7,Â title="DistanceÂ (Envelope)Â Multiplier",Â step=.1,Â group="DISTANCEÂ ZONE")Â 
minorMinÂ Â Â Â =Â input(89,Â title="Minimum:",Â group="MinorÂ AdaptiveÂ HMA+Â Period",Â inline="mHMA+")
minorMaxÂ Â Â Â =Â input(121,Â title="Maximum:",Â group="MinorÂ AdaptiveÂ HMA+Â Period",Â inline="mHMA+")
showMAÂ Â Â Â Â Â =Â input(true,Â title="ShowÂ MA?",Â group="OTHER")
useBgÂ Â Â Â Â Â Â =Â input(true,Â title="BackgroundÂ colorÂ toÂ differentiateÂ movement",Â group="OTHER")
rsiÂ Â Â Â Â Â Â Â Â =Â rsi(input(close,"RSIÂ Source",Â inline="RSI",Â group="OTHER"),Â input(14,Â "RSIÂ Length",Â inline="RSI",Â group="OTHER"))
//}...inputs
//{Â ADAPTIVEÂ HMA+
//ConditionÂ toÂ adaptÂ to:
chargedÂ =Â atr(atrFast)Â >Â atr(atrSlow)Â Â Â Â Â Â Â Â Â Â Â //<--VolatilityÂ Meter.Â ChangeÂ itÂ toÂ whateverÂ matchÂ yourÂ strat/pair/tf.
//DynamicsÂ 
varÂ floatÂ dynamicLengthÂ =Â avg(minLength,maxLength)
varÂ floatÂ minorLengthÂ Â Â =Â avg(minorMin,minorMax)
dynamicLengthÂ Â Â :=Â iff(charged,Â max(minLength,Â dynamicLengthÂ *Â (1Â -Â adaptPct)),Â min(maxLength,Â dynamicLengthÂ *Â (1Â +Â adaptPct)))
minorLengthÂ Â Â Â Â :=Â iff(charged,Â max(minorMin,Â minorLengthÂ *Â (1Â -Â adaptPct)),Â min(minorMax,Â minorLengthÂ *Â (1Â +Â adaptPct)))
//SlopeÂ calculationÂ toÂ determineÂ whetherÂ marketÂ isÂ inÂ trend,Â orÂ inÂ consolidationÂ orÂ choppy,Â orÂ mightÂ aboutÂ toÂ changeÂ currentÂ trend
piÂ =Â atan(1)Â *Â 4
highestHighÂ =Â highest(34),Â lowestLowÂ =Â lowest(34)
slope_rangeÂ =Â 25Â /Â (highestHighÂ -Â lowestLow)Â *Â lowestLow
calcslope(_ma)=>
Â Â Â Â dtÂ =Â (_ma[2]Â -Â _ma)Â /Â srcÂ *Â slope_rangeÂ Â 
Â Â Â Â cÂ =Â sqrt(1Â +Â dtÂ *Â dt)
Â Â Â Â xAngleÂ =Â round(180Â *Â acos(1Â /Â c)Â /Â pi)
Â Â Â Â maAngleÂ =Â iff(dtÂ >Â 0,Â -xAngle,Â xAngle)
Â Â Â Â maAngle
Â Â Â Â 
//MAÂ coloring+Â toÂ markÂ marketÂ dynamicsÂ 
dynColor(_ma,_col1a,_col1b,_col2a,_col2b,_col0)Â =>
Â Â Â Â slopeÂ =Â calcslope(_ma)
Â Â Â Â slopeÂ >=Â flatÂ ?Â charged?Â _col1aÂ :Â _col1bÂ :
Â Â Â Â Â slopeÂ <Â flatÂ andÂ slopeÂ >Â -flatÂ ?Â _col0Â :Â 
Â Â Â Â Â slopeÂ <=Â -flatÂ ?Â charged?Â _col2aÂ :Â _col2bÂ :Â _col0
//AdaptiveÂ HMAÂ 
xhma(_src,_length)Â =>Â _returnÂ =Â wma(2Â *Â wma(_src,Â _lengthÂ /Â 2)Â -Â wma(_src,Â _length),Â floor(sqrt(_length)))Â 
dynamicHMAÂ =Â xhma(src,int(dynamicLength))Â Â Â Â Â Â Â //<--BatmanÂ -Â OurÂ mainÂ xHMA+
minorHMAÂ =Â xhma(src,int(minorLength))Â Â Â Â Â Â Â Â Â Â Â //<--RobinÂ Â -Â FasterÂ minorÂ xHMA+Â (Optional).Â CanÂ beÂ useÂ toÂ assistÂ forÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â Â Â Â Â Â Â Â Â Â Â Â fasterÂ entry,Â slowerÂ exitÂ point,Â orÂ pullbacksÂ infoÂ too.
_slopeÂ =Â calcslope(dynamicHMA)
plotchar(_slope,Â "slopeÂ is:",Â "",Â location.top)Â //<--OutputÂ currentÂ slopeÂ toÂ DataÂ Window,Â forÂ ourÂ referenceÂ whenÂ optimizingÂ Strategy
//EnvelopeÂ theÂ mainÂ DynamicHMAÂ withÂ ATRÂ band,Â justÂ oneÂ wayÂ toÂ approximateÂ currentÂ priceÂ distanceÂ toÂ MA.Â OtherÂ usages/methodsÂ mayÂ vary.
upperTLÂ =Â dynamicHMAÂ +Â multÂ *Â atr(40)Â Â Â Â Â Â Â Â ,Â Â lowerTLÂ =Â dynamicHMAÂ -Â multÂ *Â atr(40)Â Â Â Â Â Â Â Â Â Â Â //<--HalfÂ distanceÂ zone
topTLÂ =Â dynamicHMAÂ +Â (mult*2)Â *Â atr(40)Â Â Â Â Â Â ,Â Â botTLÂ =Â dynamicHMAÂ -Â (mult*2)Â *Â atr(40)Â Â Â Â Â Â Â Â Â //<--OneÂ distanceÂ zone
stopupperTLÂ =Â dynamicHMAÂ +Â (mult/2)Â *Â atr(40),Â Â stoplowerTLÂ =Â dynamicHMAÂ -Â (mult/2)Â *Â atr(40)Â Â Â //<--HalfÂ ofÂ theÂ half.Â IfÂ needÂ ie.Â tighterÂ SLÂ orÂ trailing
//PlottingÂ DistanceÂ Zone
plot(showZone?upperTL:na,Â color=color.green,Â transp=72)
plot(showZone?lowerTL:na,Â color=color.red,Â Â Â transp=72)
plot(showZone?topTL:na,Â color=color.gray,Â transp=72)
plot(showZone?botTL:na,Â color=color.gray,Â transp=72)
sutlÂ =Â plot(showZone?stopupperTL:na,Â color=color.white,Â transp=100)
sltlÂ =Â plot(showZone?stoplowerTL:na,Â color=color.white,Â transp=100)
colZoneÂ =Â showZone?Â color.purple:color.new(color.white,100)
fill(sutl,Â sltl,Â color=colZone,Â transp=90)
plot(showMA?dynamicHMA:na,Â "AdaptiveÂ HMA+",Â dynColor(dynamicHMA,Â #6fbf73,Â #c0f5ae,Â #eb4d5c,Â #f2b1d4,Â color.yellow),Â 3)
plot(showMA?minorHMA:na,Â Â Â "minorÂ HMA+",Â Â Â Â dynColor(minorHMA,Â Â Â #6fbf73,Â #c0f5ae,Â #eb4d5c,Â #f2b1d4,Â color.yellow),Â 1)
//BackgroudÂ colorÂ toÂ differentiateÂ marketÂ condition
notgreatÂ =Â _slopeÂ <Â flatÂ andÂ _slopeÂ >Â -flat
bgcolor(useBg?Â charged?Â naÂ :Â #afb4b9Â :Â na)
//EMAÂ 200.Â (NotÂ beingÂ useÂ inÂ here.Â ButÂ sinceÂ they'veÂ beenÂ aÂ BFFÂ sinceÂ long,Â thoughtÂ I'mÂ justÂ gonnaÂ putÂ itÂ here..)
emma200Â =Â ema(close,200)Â //,Â plot(emma200)
//}...adaptiveÂ HMA+
//{Â SIGNALS
//Base;Â WhenÂ HMA+Â turnÂ toÂ aÂ darkerÂ colorÂ andÂ marketÂ isÂ outÂ fromÂ lowÂ volatility
upSigÂ =Â _slopeÂ >=Â Â flatÂ andÂ charged
dnSigÂ =Â _slopeÂ <=Â -flatÂ andÂ charged
//DefaultÂ buy/sell,Â whenÂ marketÂ switchsÂ toÂ theÂ aboveÂ baseÂ condition,Â andÂ typicalÂ priceÂ isÂ stillÂ inÂ toleratedÂ distance,Â andÂ RSIÂ isÂ onÂ theÂ rightÂ side.
buyÂ Â =Â upSigÂ andÂ notÂ upSig[1]Â andÂ close>dynamicHMAÂ andÂ low<=upperTLÂ Â andÂ (rsi>51Â Â andÂ rsi<=70)
sellÂ =Â dnSigÂ andÂ notÂ dnSig[1]Â andÂ close<dynamicHMAÂ andÂ high>=lowerTLÂ andÂ (rsi<49Â Â andÂ rsi>=30)
//AlternativeÂ buy/sell,Â whenÂ priceÂ isÂ aÂ bitÂ farÂ fromÂ MA,Â andÂ RSIÂ isÂ stillÂ onÂ theÂ sameÂ sideÂ butÂ alreadyÂ onÂ oversold/overboughtÂ (relatively).
overBuyÂ =Â upSigÂ andÂ notÂ upSig[1]Â andÂ rsi>70Â andÂ close>dynamicHMAÂ andÂ hl2>upperTLÂ andÂ minorHMA>dynamicHMA
overSell=Â dnSigÂ andÂ notÂ dnSig[1]Â andÂ rsi<30Â andÂ close<dynamicHMAÂ andÂ hl2<lowerTLÂ andÂ minorHMA<dynamicHMA
//AlternativeÂ additionalÂ buy/sellÂ withÂ differentÂ exitsÂ atÂ Robin's.
secondBuyÂ Â =Â (buyÂ Â orÂ overBuy)Â Â andÂ rsi[1]<rsi
secondSellÂ =Â (sellÂ orÂ overSell)Â andÂ rsi[1]>rsi
//PlotÂ 'emÂ up
atrPosÂ =Â 0.2Â *Â atr(5)
plotshape(buy?Â Â dynamicHMA-atrPos:na,color=color.green,Â location=location.absolute,Â style=shape.labelup,Â Â Â text="buy",Â Â textcolor=color.white,Â sizeÂ =Â size.small)
plotshape(sell?Â dynamicHMA+atrPos:na,Â Â color=color.red,Â location=location.absolute,Â style=shape.labeldown,Â text="sell",Â textcolor=color.white,Â sizeÂ =Â size.small)
plotshape(overBuy?Â dynamicHMA-atrPos:na,color=color.green,Â location=location.absolute,Â style=shape.labelup,Â Â Â text="overBuy",Â Â textcolor=color.white,Â sizeÂ =Â size.small)
plotshape(overSell?dynamicHMA+atrPos:na,Â Â color=color.red,Â location=location.absolute,Â style=shape.labeldown,Â text="overSell",Â textcolor=color.white,Â sizeÂ =Â size.small)
plotshape(doubleUpÂ andÂ secondBuy?Â dynamicHMA-atrPos*8:na,color=color.green,Â location=location.absolute,Â style=shape.labelup,Â Â Â text="+buy",Â Â textcolor=color.white,Â sizeÂ =Â size.small)
plotshape(doubleUpÂ andÂ secondSell?dynamicHMA+atrPos*8:na,Â Â color=color.red,Â location=location.absolute,Â style=shape.labeldown,Â text="+sell",Â textcolor=color.white,Â sizeÂ =Â size.small)
//AlertÂ 
ifÂ buy
Â Â Â Â alert("BuyÂ signalÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
ifÂ sell
Â Â Â Â alert("SellÂ signalÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
ifÂ overBuy
Â Â Â Â alert("OverBuyÂ signalÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
ifÂ overSell
Â Â Â Â alert("OverSellÂ signalÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
ifÂ doubleUpÂ andÂ secondBuy
Â Â Â Â alert("2ndÂ BuyÂ signalÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
ifÂ doubleUpÂ andÂ secondSell
Â Â Â Â alert("2ndÂ SellÂ signalÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
//}...signals
//{Â ORDERS
//(IÂ useÂ LotÂ justÂ becauseÂ it'sÂ howÂ IÂ usuallyÂ trade,Â matchesÂ myÂ flowÂ whenÂ thinking/planning.Â ChangeÂ theÂ "qty"Â inÂ "strategy.entry()"Â belowÂ toÂ useÂ otherÂ UOM.)
//ForexÂ pairsÂ areÂ 100,000Â unitsÂ perÂ 1Â lot.Â UnitsÂ perÂ 1Â lotÂ varyÂ onÂ non-forexÂ pairs,Â pleaseÂ checkÂ withÂ yourÂ brokerÂ andÂ changeÂ accordinglyÂ ifÂ necessary.
//(ie:Â InÂ MT4Â andÂ MT5Â rightÂ clickÂ aÂ symbolÂ andÂ thenÂ clickÂ Specification.Â TheÂ ContractÂ SizeÂ fieldÂ tellsÂ howÂ manyÂ unitsÂ areÂ inÂ oneÂ lot.)
standard1LotUnitsÂ =Â 
Â Â Â Â Â syminfo.typeÂ ==Â "forex"Â ?Â 100000Â :Â 
Â Â Â Â Â syminfo.tickerÂ ==Â "XAUUSD"Â ?Â 100Â :Â 
Â Â Â Â Â syminfo.tickerÂ ==Â "XAGUSD"Â ?Â 5000Â :Â 
Â Â Â Â Â syminfo.typeÂ ==Â "crypto"Â ?Â 1Â :Â 1000
lotSizeÂ =Â standard1LotUnitsÂ *Â orderSizeÂ 
pip()Â =>Â syminfo.mintickÂ *Â (syminfo.typeÂ ==Â "forex"Â ?Â 10Â :Â 1)
//{Â StopLoss
SLHighMaxÂ =Â highÂ +Â maxSL,Â SLLowMaxÂ =Â lowÂ -Â maxSLÂ Â Â Â Â Â Â Â //<--MaximumÂ StopLoss.Â IfÂ aÂ chosenÂ SL-pointÂ fromÂ inputÂ aboveÂ happen
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â Â Â toÂ beÂ outsideÂ thisÂ maxÂ point,Â thenÂ thisÂ oneÂ willÂ beÂ useÂ asÂ SL.
lastHighÂ =Â highest(high,Â 48)Â +Â (5Â *Â pip())Â Â Â Â Â Â Â Â Â Â Â Â Â Â //<--LastÂ High/Low.Â IfÂ useÂ asÂ SL-point,Â adjustÂ theÂ lookbackÂ lengthÂ Â 
lastLowÂ Â =Â lowest(low,Â 48)Â -Â (5Â *Â pip())Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â Â Â accordingÂ toÂ whereÂ yourÂ comfortÂ liesÂ (andÂ position-size).
//DeliveringÂ SLÂ fromÂ inputs
SLBuyÂ =Â SLInputÂ ==Â "OneÂ DistanceÂ Zone"?Â botTLÂ :Â SLInputÂ ==Â "HalfÂ DistanceÂ Zone"?Â lowerTLÂ :Â 
Â Â Â Â Â SLInputÂ ==Â "LastÂ High/Low"?Â lastLowÂ :Â SLInputÂ ==Â "ATRÂ Only"?Â SLLowMaxÂ :Â SLLowMax
SLSell=Â SLInputÂ ==Â "OneÂ DistanceÂ Zone"?Â topTLÂ :Â SLInputÂ ==Â "HalfÂ DistanceÂ Zone"?Â upperTLÂ :Â 
Â Â Â Â Â SLInputÂ ==Â "LastÂ High/Low"?Â lastHigh:Â SLInputÂ ==Â "ATRÂ Only"?Â SLHighMax:Â SLHighMax
//}---stopLoss
//
floatÂ entryPriceÂ =Â na,Â floatÂ normOrderÂ =Â 0,Â floatÂ riskOrderÂ =Â 0
floatÂ buyTPÂ =Â na,Â floatÂ sellTPÂ =Â na,Â floatÂ buySLÂ =Â na,Â floatÂ sellSLÂ =Â na
entryPriceÂ :=Â nz(entryPrice[1]),Â normOrderÂ :=Â nz(normOrder[1]),Â riskOrderÂ :=Â nz(riskOrder[1])
buyTP:=nz(buyTP[1]),Â sellTP:=nz(sellTP[1]),Â buySL:=nz(buySL[1]),Â sellSLÂ :=nz(sellSL[1])
//ThisÂ partÂ willÂ alsoÂ makeÂ yourÂ TP/SLÂ changeÂ dynamicallyÂ ifÂ there'sÂ aÂ newÂ signalÂ whileÂ youÂ haveÂ anÂ openÂ position.
//IfÂ youÂ wantÂ toÂ fireÂ thisÂ TP/SLÂ onlyÂ inÂ aÂ newÂ position,Â thenÂ addÂ "strategy.position_sizeÂ ==Â 0"Â 
ifÂ (buyÂ orÂ sellÂ orÂ overBuyÂ orÂ overSell)Â //andÂ strategy.position_sizeÂ ==Â 0
Â Â Â Â entryPriceÂ :=Â close
Â Â Â Â ifÂ buyÂ orÂ sellÂ andÂ strategy.position_sizeÂ ==Â 0
Â Â Â Â Â Â Â Â normOrderÂ :=Â 1
Â Â Â Â ifÂ overBuyÂ orÂ overSellÂ andÂ strategy.position_sizeÂ ==Â 0
Â Â Â Â Â Â Â Â riskOrderÂ :=Â 1
Â Â Â Â buyTPÂ Â Â :=Â highÂ +Â takeProfitÂ 
Â Â Â Â sellTPÂ Â :=Â lowÂ Â -Â takeProfitÂ 
Â Â Â Â ifÂ buyÂ orÂ overBuy
Â Â Â Â Â Â Â Â buySLÂ :=Â SLLowMax<SLBuy?Â SLBuy:SLLowMaxÂ 
Â Â Â Â ifÂ sellÂ orÂ overSell
Â Â Â Â Â Â Â Â sellSL:=Â SLHighMax>SLSell?Â SLSell:SLHighMaxÂ 
//TrailingÂ Minimum-Profit.Â --JustÂ aÂ simpleÂ helperÂ toÂ preventÂ prematureÂ exitÂ rule.Â OrÂ atÂ leastÂ toÂ haveÂ a
//changeÂ toÂ getÂ break-evenÂ (afterÂ commission)Â ifÂ marketÂ turnsÂ itsÂ backÂ onÂ us,Â beforeÂ headingÂ toÂ stoplossÂ area.
minBuyProfitÂ Â =Â strategy.position_avg_priceÂ Â +Â minProfitÂ 
minSellProfitÂ =Â strategy.position_avg_priceÂ Â -Â minProfitÂ 
//{Â ExitÂ Points
//TP/SLÂ Exits
stopLossBuyÂ Â =Â useSL?Â lowÂ <=buySLÂ :Â na
stopLossSellÂ =Â useSL?Â high>=sellSL:Â na
takeProfitBuyÂ Â =Â high>=Â buyTP
takeProfitSellÂ =Â lowÂ <=Â sellTPÂ 
//SimplifiedÂ RSIÂ Exits
RSIexitBuyÂ Â =Â crossunder(rsi,70)Â orÂ rsi<50
RSIexitSellÂ =Â crossover(rsi,30)Â Â orÂ rsi>50
//ExitÂ Conditions
exitBuyÂ Â =Â (Â closeÂ >=Â minBuyProfitÂ Â andÂ (RSIexitBuyÂ Â orÂ crossunder(close,dynamicHMA))Â )Â orÂ stopLossBuyÂ Â orÂ takeProfitBuyÂ Â 
exitSellÂ =Â (Â closeÂ <=Â minSellProfitÂ andÂ (RSIexitSellÂ orÂ crossover(close,dynamicHMA)Â )Â )Â orÂ stopLossSellÂ orÂ takeProfitSell
exitoverBuyÂ Â =Â (Â closeÂ >=Â minBuyProfitÂ Â andÂ (crossunder(rsi,45)Â orÂ (open<stopupperTLÂ andÂ hl2<stopupperTL))Â )Â orÂ (open<dynamicHMAÂ andÂ rsi<60)
Â Â Â Â Â orÂ stopLossBuyÂ Â orÂ takeProfitBuyÂ 
exitoverSellÂ =Â (Â closeÂ <=Â minSellProfitÂ andÂ (crossover(rsi,55)Â Â orÂ (open>stoplowerTLÂ andÂ hl2>stoplowerTL))Â )Â orÂ (open>dynamicHMAÂ andÂ rsi>40)
Â Â Â Â Â orÂ stopLossSellÂ orÂ takeProfitSellÂ 
//AlternativeÂ 2ndÂ ExitsÂ atÂ Robin'sÂ (orÂ SL)
exitSecondBuyÂ Â =Â (closeÂ >=Â minBuyProfitÂ andÂ crossunder(close,Â minorHMA))Â orÂ stopLossBuy
exitSecondSellÂ =Â (closeÂ <=Â minSellProfitÂ andÂ crossover(close,Â minorHMA))Â orÂ stopLossSell
Â Â Â Â 
//PlottingÂ andÂ AlertÂ forÂ Exits
inBuyExitÂ Â =Â strategy.position_sizeÂ >Â 0Â andÂ ((normOrderÂ ==Â 1Â andÂ exitBuy)Â Â orÂ (riskOrderÂ ==Â 1Â andÂ exitoverBuy))
inSellExitÂ =Â strategy.position_sizeÂ <Â 0Â andÂ ((normOrderÂ ==Â 1Â andÂ exitSell)Â orÂ (riskOrderÂ ==Â 1Â andÂ exitoverSell))
in2ndBuyExitÂ =Â strategy.position_sizeÂ >Â 0Â andÂ (doubleUpÂ andÂ exitSecondBuy)
in2ndSellExit=Â Â strategy.position_sizeÂ <Â 0Â andÂ (doubleUpÂ andÂ exitSecondSell)
ifÂ inBuyExitÂ orÂ inSellExit
Â Â Â Â ifÂ normOrderÂ ==Â 1Â andÂ exitBuyÂ 
Â Â Â Â Â Â Â Â normOrderÂ :=Â 0,Â alert("CloseÂ BuyÂ Position/sÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
Â Â Â Â ifÂ normOrderÂ ==Â 1Â andÂ exitSell
Â Â Â Â Â Â Â Â normOrderÂ :=Â 0,Â alert("CloseÂ SellÂ Position/sÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
Â Â Â Â ifÂ riskOrderÂ ==Â 1Â andÂ exitoverBuyÂ 
Â Â Â Â Â Â Â Â riskOrderÂ :=Â 0,Â alert("CloseÂ overBuyÂ Position/sÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
Â Â Â Â ifÂ riskOrderÂ ==Â 1Â andÂ exitoverSell
Â Â Â Â Â Â Â Â riskOrderÂ :=Â 0,Â alert("CloseÂ overSellÂ Position/sÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
ifÂ in2ndBuyExit
Â Â Â Â alert("CloseÂ 2ndÂ BuyÂ Position/sÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
ifÂ in2ndSellExit
Â Â Â Â alert("CloseÂ 2ndÂ SellÂ Position/sÂ atÂ "+tostring(close),Â alert.freq_once_per_bar_close)
Â Â Â Â 
plotchar(inBuyExit,Â color=color.green,Â location=location.abovebar,Â char="â“§",Â size=size.tiny)
plotchar(inSellExit,Â Â color=color.red,Â location=location.belowbar,Â char="â“§",Â size=size.tiny)
plotchar(in2ndBuyExit,Â color=color.teal,Â location=location.abovebar,Â char="â“§",Â size=size.tiny)
plotchar(in2ndSellExit,Â Â color=color.maroon,Â location=location.belowbar,Â char="â“§",Â size=size.tiny)
//}---exitÂ points
//{Â Actions
//ENTRIES
strategy.entry("buy",Â Â strategy.long,Â Â qty=lotSize,Â when=buyÂ )
strategy.entry("sell",Â strategy.short,Â qty=lotSize,Â when=sell)
strategy.entry("overBuy",Â Â strategy.long,Â Â qty=lotSize,Â when=overBuyÂ )
strategy.entry("overSell",Â strategy.short,Â qty=lotSize,Â when=overSell)
ifÂ doubleUp
Â Â Â Â strategy.entry("2ndBuy",Â Â strategy.long,Â Â qty=lotSize,Â when=secondBuyÂ )
Â Â Â Â strategy.entry("2ndSell",Â strategy.short,Â qty=lotSize,Â when=secondSell)Â 
//EXITS
//WeÂ useÂ justÂ "strategy.close"Â becauseÂ weÂ alreadyÂ setÂ limitÂ conditionsÂ aboveÂ forÂ SLÂ andÂ TP,Â firesÂ atÂ candleÂ close.Â IfÂ youÂ wantÂ to
//separateÂ exitÂ dataÂ orÂ exitÂ atÂ theÂ exactÂ SL/TPÂ youÂ canÂ addÂ suchÂ as:Â strategy.exit("exitbuy",Â from_entry="buy",Â stop=buySL,Â limit=buyTP)
//accordingly.Â AndÂ deleteÂ stopLossBuy,Â stopLossSell,Â takeProfitBuy,Â takeProfitSellÂ definitionsÂ fromÂ above.
strategy.close("buy",Â Â when=exitBuyÂ ,Â comment="closeÂ buy")
strategy.close("sell",Â when=exitSell,Â comment="closeÂ sell")
strategy.close("overBuy",Â Â when=exitoverBuyÂ ,Â comment="closeÂ overBuy")
strategy.close("overSell",Â when=exitoverSell,Â comment="closeÂ overSell")
ifÂ doubleUp
Â Â Â Â strategy.close("2ndBuy",Â Â when=exitSecondBuyÂ ,Â comment="closeÂ 2ndÂ Buy")
Â Â Â Â strategy.close("2ndSell",Â when=exitSecondSell,Â comment="closeÂ 2ndÂ Sell")
//}---actions
orderColÂ =Â strategy.position_size>0?Â color.greenÂ :Â strategy.position_size<0?Â color.redÂ :Â na
//Â plot(strategy.position_size>0?Â minBuyProfitÂ :Â strategy.position_size<0?Â minSellProfitÂ :Â na,Â color=orderCol,Â style=plot.style_linebr,Â linewidth=1,Â title="MinimumÂ Profit")
plot(strategy.position_sizeÂ !=Â 0?Â entryPrice:na,Â style=plot.style_cross,Â transp=50)
plot(useSLÂ andÂ strategy.position_size>0?Â buySLÂ :Â useSLÂ andÂ strategy.position_size<0?Â sellSLÂ :Â na,Â color=color.red,Â style=plot.style_cross,Â linewidth=1,Â title="StopÂ Loss",Â transp=50)
plot(strategy.position_size>0?Â buyTPÂ :Â strategy.position_size<0?Â sellTPÂ :Â na,Â color=color.green,Â style=plot.style_cross,Â linewidth=1,Â title="TakeÂ Profit",Â transp=50)
//}...orders
//{------------------------------------------------------------------------
//BelowÂ isÂ justÂ fancyÂ stuffÂ approximatingÂ gainÂ inÂ pips.Â YouÂ probablyÂ don'tÂ needÂ this.
//(AlsoÂ I'mÂ notÂ tooÂ sureÂ thisÂ isÂ theÂ rightÂ wayÂ calculatingÂ pipÂ gainÂ inÂ pine.Â IfÂ somebodyÂ knowsÂ how,Â kindlyÂ correctÂ meÂ please)
mUnitÂ =Â lotSize*pip()
ppipÂ =Â round((strategy.grossprofit-strategy.grossprofit[1])Â /Â syminfo.pointvalue/mUnit,1)
lpipÂ =Â round((strategy.grossloss-strategy.grossloss[1])Â /Â syminfo.pointvalue/mUnit,1)
pipGainÂ =Â round((strategy.grossprofit/syminfo.pointvalue)/mUnit)
pipLossÂ =Â round((strategy.grossloss/syminfo.pointvalue)/mUnit)
avg_ppipÂ =Â round((pipGain/strategy.wintrades),1)
pctProfitÂ =Â round(strategy.wintrades/strategy.closedtradesÂ *Â 100,Â 2)
maxDDÂ =Â ceil(strategy.max_drawdown/Â syminfo.pointvalue/mUnit)Â //checkÂ ifÂ ourÂ marginÂ canÂ handleÂ DD'sÂ pips*orderSize
varÂ txt2Â =Â ""
txtÂ =Â "TotalÂ trades:Â "+Â tostring(strategy.closedtrades)+"\n("+tostring(pctProfit)+"%)Â Win:Â "+tostring(strategy.wintrades)+"Â /Â Loss:Â "+tostring(strategy.losstrades)+
Â Â Â Â Â "\nAverageÂ winÂ pipsÂ perÂ trade:Â "+Â tostring(avg_ppip)Â +Â "Â pips\n\nApproximateÂ (*giveÂ nÂ take)\nTotalÂ PipÂ Gain:Â "+Â tostring(pipGain)Â +"Â pips"+
Â Â Â Â Â "\nTotalÂ PipÂ Loss:Â "+tostring(pipLoss)+Â "Â pips"+"\n\nMaxÂ DrawdownÂ soÂ far:Â "+tostring(maxDD)+"Â pips"
ifÂ strategy.wintrades>strategy.wintrades[1]
Â Â Â Â txt2Â :=Â "\n\nLastÂ closedÂ trade:Â BaggedÂ "+tostring(ppip)+"Â pipsÂ ğŸ‘»"
ifÂ strategy.losstrades>strategy.losstrades[1]
Â Â Â Â txt2Â :=Â "\n\nLastÂ closedÂ trade:Â BlewÂ "+tostring(lpip)+"Â pipsÂ ğŸ˜ª"
txtÂ +=Â txt2
labelÂ pvtLabelÂ Â Â =Â label.new(time,Â lowestLow,Â text=txt,Â 
Â Â Â Â Â color=color.new(color.white,100),Â xloc=xloc.bar_time,Â style=label.style_label_left,Â textcolor=color.gray,Â textalign=text.align_left)
label.set_x(pvtLabel,Â label.get_x(pvtLabel)Â +Â ((time-time[1])Â *Â 21))
label.delete(pvtLabel[1])
//}Â 
Expand (313 lines)