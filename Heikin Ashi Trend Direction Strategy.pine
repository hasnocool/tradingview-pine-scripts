Script Name: Heikin Ashi Trend Direction Strategy
Author: UnknownUnicorn36161431
Description: Strategy based off Heikin Ashi candles and their correlation to common Japanese candlesticks . This strategy will signal a trend change when a candlestick closes above/below the opening price of a Heikin Ashi candle of the opposite kind.
PineScript code:

Pine Scriptâ„¢ strategy
Heikin Ashi Trend Direction Strategy
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
//@version=5
strategy(titleÂ =Â "HeikinÂ AshiÂ TrendÂ DirectionÂ Strategy",Â shorttitle="HAÂ TrendÂ Direction",Â overlay=true,Â linktoseries=true,Â process_orders_on_closeÂ =Â true,Â calc_on_order_fillsÂ =Â false,Â pyramidingÂ =Â 0,Â default_qty_typeÂ =Â strategy.percent_of_equity,Â default_qty_valueÂ =Â 98,Â commission_typeÂ =Â strategy.commission.percent,Â commission_valueÂ =Â 0,Â initial_capitalÂ =Â 100000,Â max_bars_backÂ =Â 4900,Â max_boxes_countÂ =Â 500,Â max_lines_countÂ =Â 500,Â max_labels_countÂ =Â 500)
GROUP_GENERALÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â "General"
GROUP_VOLUME_OPTIONSÂ Â Â Â Â Â Â Â Â =Â "VolumeÂ PressureÂ Options"
GROUP_HA_CANDLES_OPTIONSÂ Â Â Â Â =Â "HeikinÂ AshiÂ CandlesÂ Options"
GROUP_TIME_LIMITED_BACKTESTSÂ =Â "Time-LimitÂ BackTestsÂ (0Â =Â disable)"
//Â GENERAL
i_sl_percentÂ =Â input.float(Â 0.1,Â title="StopÂ LossÂ (%)",Â minval=0,Â step=0.01,Â inlineÂ =Â "sl",Â groupÂ =Â GROUP_GENERAL)
i_sl_extend_to_full_candleÂ =Â input.bool(Â true,Â "ExtendÂ toÂ FullÂ Candle",Â tooltipÂ =Â "WhenÂ ticked,Â SLÂ willÂ beÂ extendedÂ toÂ theÂ wickÂ ofÂ theÂ candleÂ whereÂ theÂ tradeÂ started.Â ThisÂ isÂ usefulÂ whenÂ theÂ strategyÂ opensÂ aÂ tradeÂ atÂ theÂ top/bottomÂ ofÂ aÂ candleÂ andÂ theÂ nextÂ oneÂ engulfsÂ itÂ withÂ itsÂ wickÂ butÂ stillÂ managesÂ toÂ closeÂ itsÂ bodyÂ followingÂ theÂ trendÂ weÂ areÂ tradingÂ for.",Â inlineÂ =Â "sl",Â groupÂ =Â GROUP_GENERAL)
i_open_trades_on_trend_candlesÂ =Â input.bool(false,Â "OpenÂ tradesÂ onÂ trade-followingÂ candles",Â tooltipÂ =Â "IfÂ enabled,Â theÂ strategyÂ willÂ onlyÂ openÂ aÂ longÂ tradeÂ whenÂ theÂ candleÂ onÂ whichÂ itÂ wouldÂ beÂ openedÂ closedÂ asÂ bullishÂ andÂ vice-versa.",Â group=GROUP_GENERAL)
i_debugÂ =Â input.bool(false,Â "DebugÂ Mode",Â group=GROUP_GENERAL)
//i_debug_tableÂ =Â input.bool(true,Â "ShowÂ DebugÂ Table",Â group=GROUP_GENERAL)
i_debug_labelsÂ =Â input.bool(true,Â "ShowÂ DebugÂ Labels",Â group=GROUP_GENERAL)
//Â VOLUMEÂ PRESSUREÂ COMPOSITEÂ 
i_use_volume_pressure_compositeÂ =Â input.bool(false,Â "TradeÂ byÂ VolumeÂ Pressure",Â tooltipÂ =Â "ByÂ enablingÂ thisÂ option,Â tradesÂ willÂ onlyÂ beÂ madeÂ inÂ theÂ directionÂ ofÂ aÂ detectedÂ volume-weightedÂ averageÂ pressureÂ trend.",Â groupÂ =Â GROUP_VOLUME_OPTIONS)
i_close_by_volume_pressure_compositeÂ =Â input.bool(true,Â "CloseÂ byÂ VolumeÂ Pressure",Â tooltipÂ =Â "ByÂ enablingÂ thisÂ option,Â tradesÂ willÂ closeÂ onlyÂ afterÂ theÂ trendÂ ofÂ volume-weightedÂ averageÂ presureÂ changes.",Â inlineÂ =Â "vol_close",Â groupÂ =Â GROUP_VOLUME_OPTIONS)
i_close_by_volume_pressure_composite_onlyÂ =Â input.bool(false,Â "Only",Â inlineÂ =Â "vol_close",Â groupÂ =Â GROUP_VOLUME_OPTIONS)
i_trade_by_vpmaÂ =Â input.bool(false,Â "TradeÂ byÂ VPMA",Â inlineÂ =Â "vpma",Â tooltipÂ =Â "WhenÂ enabled,Â thisÂ strategyÂ willÂ utilizeÂ theÂ VolumeÂ PressureÂ CompositeÂ MovingÂ AverageÂ andÂ willÂ onlyÂ allowÂ openingÂ ofÂ shortÂ tradesÂ whenÂ aÂ candleÂ closesÂ aboveÂ VPMAÂ andÂ longÂ onesÂ whenÂ aÂ candleÂ closesÂ belowÂ VPMA.",Â groupÂ =Â GROUP_VOLUME_OPTIONS)
i_trade_by_vpma_inverseÂ =Â input.bool(false,Â "Inverse",Â inlineÂ =Â "vpma",Â groupÂ =Â GROUP_VOLUME_OPTIONS)
i_pÂ =Â input.int(30,Â "LookbackÂ Periods",Â groupÂ =Â GROUP_VOLUME_OPTIONSÂ )
i_bandsÂ =Â input.bool(false,Â "ShowÂ PressureÂ Band",Â groupÂ =Â GROUP_VOLUME_OPTIONS)
i_colbÂ =Â input.bool(false,Â "ColorÂ TrendÂ onÂ priceÂ bars",Â groupÂ =Â GROUP_VOLUME_OPTIONS)
//Â HA
i_ha_showÂ Â Â Â Â Â Â =Â input.boolÂ Â Â Â (true,Â "ShowÂ HeikinÂ AshiÂ CandlesÂ Overlay",Â group=GROUP_HA_CANDLES_OPTIONS)
candletypeÂ Â Â Â Â Â =Â input.stringÂ Â ("Candles",Â "CandleÂ Type",Â options=["Hollow",Â "Bars",Â "Candles"],Â group=GROUP_HA_CANDLES_OPTIONS,Â tooltip="CandleÂ TypeÂ toÂ beÂ dispalyed.Â UserÂ willÂ haveÂ toÂ 'Mute'Â theÂ mainÂ seriesÂ barÂ usingÂ theÂ ğŸ‘Â symbolÂ nextÂ toÂ tickerÂ id.")
BodyBullÂ Â Â Â Â Â Â Â =Â input.colorÂ Â Â (Â color.new(Â #26a69a,Â 75Â ),Â "",Â inline="a",Â group=GROUP_HA_CANDLES_OPTIONS)
BodyBearÂ Â Â Â Â Â Â Â =Â input.colorÂ Â Â (Â color.new(Â #ef5350,Â 75Â ),Â "",Â inline="a",Â group=GROUP_HA_CANDLES_OPTIONS)
BorderBullÂ Â Â Â Â Â =Â input.colorÂ Â Â (Â color.new(Â #26a69a,Â 50Â ),Â "",Â inline="b",Â group=GROUP_HA_CANDLES_OPTIONS)
BorderBearÂ Â Â Â Â Â =Â input.colorÂ Â Â (Â color.new(Â #ef5350,Â 50Â ),Â "",Â inline="b",Â group=GROUP_HA_CANDLES_OPTIONS)
WickBullÂ Â Â Â Â Â Â Â =Â input.colorÂ Â Â (Â color.new(Â #26a69a,Â 50Â ),Â "",Â inline="c",Â group=GROUP_HA_CANDLES_OPTIONS)
WickBearÂ Â Â Â Â Â Â Â =Â input.colorÂ Â Â (Â color.new(Â #ef5350,Â 50Â ),Â "",Â inline="c",Â group=GROUP_HA_CANDLES_OPTIONS)
//Â TIME-LIMITEDÂ BACKTESTING
i_use_time_limited_backtestingÂ =Â input.bool(Â false,Â "UseÂ Time-LimitedÂ Backtesting",Â groupÂ =Â GROUP_TIME_LIMITED_BACKTESTSÂ )
i_startDayÂ =Â input.int(0,Â "StartÂ Day",Â minvalÂ =Â 0,Â maxvalÂ =Â 31,Â groupÂ =Â GROUP_TIME_LIMITED_BACKTESTS)
i_startMonthÂ =Â input.int(0,Â "StartÂ Month",Â minvalÂ =Â 0,Â maxvalÂ =Â 12,Â groupÂ =Â GROUP_TIME_LIMITED_BACKTESTS)
i_startYearÂ =Â input.int(0,Â "StartÂ Year",Â minvalÂ =Â 0,Â maxvalÂ =Â 2100,Â groupÂ =Â GROUP_TIME_LIMITED_BACKTESTS)
i_endDayÂ =Â input.int(0,Â "EndÂ Day",Â minvalÂ =Â 0,Â maxvalÂ =Â 31,Â groupÂ =Â GROUP_TIME_LIMITED_BACKTESTS)
i_endMonthÂ =Â input.int(0,Â "EndÂ Month",Â minvalÂ =Â 0,Â maxvalÂ =Â 12,Â groupÂ =Â GROUP_TIME_LIMITED_BACKTESTS)
i_endYearÂ =Â input.int(0,Â "EndÂ Year",Â minvalÂ =Â 0,Â maxvalÂ =Â 2100,Â groupÂ =Â GROUP_TIME_LIMITED_BACKTESTS)
lookbackÂ =Â 4899
inDateRangeÂ =Â true
varÂ entry_priceÂ =Â 0.0
varÂ last_volume_trendÂ =Â ""
//Â VOLUMEÂ PRESSUREÂ COMPOSITE
volÂ =Â volumeÂ >Â 0Â ?Â volumeÂ :Â 1
//Â CloseÂ ConditionsÂ forÂ PressureÂ Algorithms
clÂ =Â close
opÂ =Â open
hiÂ =Â high
loÂ =Â low
//Â HA
//Â OptionalÂ MathmaticalÂ CalcualtionÂ toÂ avoidÂ theÂ securityÂ functionÂ 
//Â hkCloseÂ Â Â Â Â Â Â Â Â =Â (openÂ +Â highÂ +Â lowÂ +Â close)Â /Â 4
//Â hkOpenÂ Â Â Â Â Â Â Â Â Â =Â float(na)
//Â hkOpenÂ Â Â Â Â Â Â Â Â Â :=Â na(hkOpen[1])Â ?Â (openÂ +Â close)Â /Â 2Â :Â (nz(hkOpen[1])Â +Â nz(hkClose[1]))Â /Â 2
//Â hkHighÂ Â Â Â Â Â Â Â Â Â =Â math.max(high,Â math.max(hkOpen,Â hkClose))
//Â hkLowÂ Â Â Â Â Â Â Â Â Â Â =Â math.min(low,Â Â math.min(hkOpen,Â hkClose))
[hkOpen,Â hkHigh,Â hkLow,Â hkClose]Â =Â request.security(ticker.heikinashi(syminfo.tickerid),Â timeframe.period,Â [open,Â high,Â low,Â close])
hollowÂ Â Â Â Â Â Â Â Â Â =Â candletypeÂ ==Â "Hollow"Â 
barsÂ Â Â Â Â Â Â Â Â Â Â Â =Â candletypeÂ ==Â "Bars"
candleÂ Â Â Â Â Â Â Â Â Â =Â candletypeÂ ==Â "Candles"
//Â LookÂ ifÂ theÂ closeÂ timeÂ ofÂ theÂ currentÂ barÂ fallsÂ insideÂ theÂ dateÂ range
ifÂ i_use_time_limited_backtestingÂ andÂ i_startDayÂ !=Â 0Â andÂ i_startMonthÂ !=Â 0Â andÂ i_startYearÂ !=Â 0Â andÂ i_endDayÂ !=Â 0Â andÂ i_endMonthÂ !=Â 0Â andÂ i_endYearÂ !=Â 0
Â Â Â Â inDateRangeÂ :=Â (Â timeÂ >=Â timestamp(Â syminfo.timezone,Â i_startYear,Â i_startMonth,Â i_startDay,Â 0,Â 0Â )Â )Â andÂ (Â timeÂ <Â timestamp(Â syminfo.timezone,Â i_endYear,Â i_endMonth,Â i_endDay,Â 0,Â 0Â )Â )
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â FunctionsÂ {
//Â GENERAL
f_debug_label(Â txtÂ )Â =>
Â Â Â Â ifÂ i_debugÂ andÂ i_debug_labels
Â Â Â Â Â Â Â Â label.new(bar_index,Â high,Â txt,Â colorÂ =Â color.lime,Â textcolorÂ =Â color.black)
//Â VOLUMEÂ PRESSUREÂ COMPOSITE
vema(array,Â periods,Â K)Â =>
Â Â Â Â VolWÂ =Â volÂ *Â array
Â Â Â Â VolKÂ =Â KÂ /Â (periodsÂ +Â 1)
Â Â Â Â VMsmaÂ =Â math.sum(VolW,Â periods)Â /Â math.sum(vol,Â periods)
Â Â Â Â VMemaÂ =Â 0.
Â Â Â Â VMemaÂ :=Â na(VMema[1])Â ?Â VMsmaÂ *Â VolKÂ :Â (VolWÂ -Â VMema[1])Â *Â VolKÂ +Â VMema[1]
Â Â Â Â VMema
//Â }
//Â ===========================================================Â //
//Â ===============Â VolumeÂ PressureÂ CompositeÂ =================Â //
//Â ===========================================================Â //
//Â BullÂ AndÂ BearÂ "Power-Balance"Â byÂ VadimÂ GimelfarbÂ Algorithm's
BPÂ =Â clÂ <Â opÂ ?Â cl[1]Â <Â opÂ ?Â math.max(hiÂ -Â cl[1],Â clÂ -Â lo)Â :Â math.max(hiÂ -Â op,Â clÂ -Â lo)Â :Â clÂ >Â opÂ ?Â cl[1]Â >Â opÂ ?Â hiÂ -Â loÂ :Â math.max(opÂ -Â cl[1],Â hiÂ -Â lo)Â :Â hiÂ -Â clÂ >Â clÂ -Â loÂ ?Â cl[1]Â <Â opÂ ?Â math.max(hiÂ -Â cl[1],Â clÂ -Â lo)Â :Â hiÂ -Â opÂ :Â hiÂ -Â clÂ <Â clÂ -Â loÂ ?Â cl[1]Â >Â opÂ ?Â hiÂ -Â loÂ :Â math.max(opÂ -Â cl[1],Â hiÂ -Â lo)Â :Â cl[1]Â >Â opÂ ?Â math.max(hiÂ -Â op,Â clÂ -Â lo)Â :Â cl[1]Â <Â opÂ ?Â math.max(opÂ -Â cl[1],Â hiÂ -Â lo)Â :Â hiÂ -Â lo
SPÂ =Â clÂ <Â opÂ ?Â cl[1]Â >Â opÂ ?Â math.max(cl[1]Â -Â op,Â hiÂ -Â lo)Â :Â hiÂ -Â loÂ :Â clÂ >Â opÂ ?Â cl[1]Â >Â opÂ ?Â math.max(cl[1]Â -Â lo,Â hiÂ -Â cl)Â :Â math.max(opÂ -Â lo,Â hiÂ -Â cl)Â :Â hiÂ -Â clÂ >Â clÂ -Â loÂ ?Â cl[1]Â >Â opÂ ?Â math.max(cl[1]Â -Â op,Â hiÂ -Â lo)Â :Â hiÂ -Â loÂ :Â hiÂ -Â clÂ <Â clÂ -Â loÂ ?Â cl[1]Â >Â opÂ ?Â math.max(cl[1]Â -Â lo,Â hiÂ -Â cl)Â :Â opÂ -Â loÂ :Â cl[1]Â >Â opÂ ?Â math.max(cl[1]Â -Â op,Â hiÂ -Â lo)Â :Â cl[1]Â <Â opÂ ?Â math.max(opÂ -Â lo,Â hiÂ -Â cl)Â :Â hiÂ -Â lo
TPÂ =Â BPÂ +Â SP
//Â GENERALÂ CALCULATIONÂ VARIABLESÂ FORÂ STUDIES
BPVÂ =Â BPÂ /Â TPÂ *Â vol
SPVÂ =Â SPÂ /Â TPÂ *Â vol
TPVÂ =Â BPVÂ +Â SPV
THÂ =Â math.max(high,Â close[1])
TLÂ =Â math.min(low,Â close[1])
BPPÂ =Â (TLÂ +Â close)Â /Â 2
SPPÂ =Â (THÂ +Â close)Â /Â 2
//Â VolumeÂ PressuresÂ WeightedÂ Averages
bpMavgÂ =Â vema(BPVÂ *Â BPP,Â i_p,Â 3)Â /Â vema(TPV,Â i_p,Â 3)Â *Â 2
spMavgÂ =Â vema(SPVÂ *Â SPP,Â i_p,Â 3)Â /Â vema(TPV,Â i_p,Â 3)Â *Â 2
VPMavgÂ =Â (bpMavgÂ +Â spMavg)Â /Â 2
VPMAcÂ =Â bpMavgÂ >Â VPMavgÂ ?Â color.greenÂ :Â color.red
//Â PLOTÂ DIRECTIVES
//CloudÂ coloringÂ methodÂ byÂ @ChrisMoody
BPAboveÂ =Â bpMavgÂ >=Â spMavgÂ ?Â 1Â :Â na
SPBelowÂ =Â bpMavgÂ <=Â spMavgÂ ?Â 1Â :Â na
BPplotUÂ =Â BPAboveÂ ?Â bpMavgÂ :Â na
SPplotUÂ =Â BPAboveÂ ?Â spMavgÂ :Â na
BPplotDÂ =Â SPBelowÂ ?Â bpMavgÂ :Â na
SPplotDÂ =Â SPBelowÂ ?Â spMavgÂ :Â na
//Â StandardÂ LineÂ Coloring
CondColÂ =Â bpMavgÂ >Â spMavgÂ ?Â color.greenÂ :Â color.red
volume_pressure_trendÂ =Â bpMavgÂ >Â spMavgÂ ?Â "bullish"Â :Â "bearish"
ifÂ last_volume_trendÂ ==Â ""
Â Â Â Â last_volume_trendÂ :=Â volume_pressure_trend
//CenterÂ AvgÂ Line
plot(i_bandsÂ ?Â naÂ :Â VPMavg,Â color=CondCol,Â title='VPMA',Â style=plot.style_line,Â linewidth=2)
//CloudÂ LinesÂ PlotÂ StatementsÂ -Â ***linebrÂ toÂ createÂ rulesÂ forÂ changeÂ inÂ Shading
p1Â =Â plot(i_bandsÂ andÂ BPplotUÂ ?Â BPplotUÂ :Â na,Â title='BP/SP',Â style=plot.style_linebr,Â linewidth=1,Â color=CondCol)
p2Â =Â plot(i_bandsÂ andÂ SPplotUÂ ?Â SPplotUÂ :Â na,Â title='SP/BP',Â style=plot.style_linebr,Â linewidth=1,Â color=CondCol)
p3Â =Â plot(i_bandsÂ andÂ BPplotDÂ ?Â BPplotDÂ :Â na,Â title='BP/SP',Â style=plot.style_linebr,Â linewidth=1,Â color=CondCol)
p4Â =Â plot(i_bandsÂ andÂ SPplotDÂ ?Â SPplotDÂ :Â na,Â title='SP/BP',Â style=plot.style_linebr,Â linewidth=1,Â color=CondCol)
//FillsÂ thatÂ colorÂ cloudÂ basedÂ onÂ Trend.
fill(p1,Â p2,Â color=color.new(color.green,Â 90),Â title='Cloud')
fill(p3,Â p4,Â color=color.new(color.red,Â 90),Â title='Cloud')
plot(i_bandsÂ andÂ bpMavgÂ ?Â bpMavgÂ :Â na,Â title='BPavg',Â style=plot.style_line,Â linewidth=1,Â color=color.new(color.green,Â 0))
plot(i_bandsÂ andÂ spMavgÂ ?Â spMavgÂ :Â na,Â title='SPavg',Â style=plot.style_line,Â linewidth=1,Â color=color.new(color.red,Â 0))
barcolor(i_colbÂ ?Â CondColÂ :Â na)
//Â ============================================Â //
//Â ===============Â HAÂ CandlesÂ =================Â //
//Â ============================================Â //
plotcandle(
Â Â i_ha_showÂ ?Â hkOpenÂ :Â na,Â i_ha_showÂ ?Â hkHighÂ :Â na,Â i_ha_showÂ ?Â hkLowÂ :Â na,Â i_ha_showÂ ?Â hkCloseÂ :Â na,Â 
Â Â "HollowÂ Candles",
Â Â hollowÂ ?Â Â Â Â Â Â hkCloseÂ <Â Â Â hkOpenÂ Â ?Â Â Â BodyBearÂ :Â Â naÂ :Â Â Â Â Â Â Â Â candleÂ ?Â Â Â Â Â Â Â Â hkCloseÂ <Â hkOpenÂ ?Â Â BodyBearÂ :Â BodyBullÂ :Â na,
Â Â hollowÂ orÂ Â Â Â Â candleÂ ?Â Â Â Â hkCloseÂ <Â Â Â Â hkOpenÂ Â ?Â Â WickBearÂ :Â Â WickBullÂ :Â Â Â Â Â Â na,
Â Â bordercolorÂ =Â hollowÂ orÂ Â Â candleÂ ?Â Â Â Â hkCloseÂ Â <Â Â hkOpenÂ Â Â ?Â Â BorderBearÂ :Â Â Â Â BorderBullÂ :Â na)
plotbar(
Â Â i_ha_showÂ ?Â hkOpenÂ :Â na,Â i_ha_showÂ ?Â hkHighÂ :Â na,Â i_ha_showÂ ?Â hkLowÂ :Â na,Â i_ha_showÂ ?Â hkCloseÂ :Â na,
Â Â "Bars",
Â Â barsÂ ?Â hkCloseÂ <Â hkOpenÂ ?Â BodyBearÂ :Â BodyBullÂ :Â na)
//Â hideÂ bodiesÂ orÂ candles
barcolor(Â color.new(color.black,Â 100)Â )
//Â -------------------------Â //
//Â tradeÂ managementÂ sectionÂ //
//Â -------------------------Â //
trend_to_bearishÂ =Â (Â hkCloseÂ >Â hkOpenÂ andÂ closeÂ <Â openÂ andÂ closeÂ <Â hkOpenÂ )
trend_to_bullishÂ =Â (Â hkCloseÂ <Â hkOpenÂ andÂ closeÂ >Â openÂ andÂ closeÂ >Â hkOpenÂ )
trend_to_bearish_prevÂ =Â (Â hkClose[1]Â >Â hkOpen[1]Â andÂ close[1]Â <Â open[1]Â andÂ close[1]Â <Â hkOpen[1]Â )
trend_to_bullish_prevÂ =Â (Â hkClose[1]Â <Â hkOpen[1]Â andÂ close[1]Â >Â open[1]Â andÂ close[1]Â >Â hkOpen[1]Â )
//Â trendÂ isÂ changing,Â weÂ needÂ toÂ closeÂ anyÂ oldÂ tradesÂ here
ifÂ (Â trend_to_bearishÂ orÂ trend_to_bullishÂ )Â andÂ i_close_by_volume_pressure_composite_onlyÂ ==Â false
Â Â Â Â ifÂ strategy.opentradesÂ >Â 0
Â Â Â Â Â Â Â Â trade_typeÂ =Â strategy.opentrades.entry_id(Â strategy.opentradesÂ -Â 1Â )
Â Â Â Â Â Â Â Â ifÂ (Â trade_typeÂ ==Â "Buy"Â andÂ trend_to_bearishÂ )Â orÂ (Â trade_typeÂ ==Â "Sell"Â andÂ trend_to_bullishÂ )
Â Â Â Â Â Â Â Â Â Â Â Â strategy.close_all(Â trade_typeÂ +Â "Â exitÂ ("Â +Â (Â (Â trade_typeÂ ==Â "Buy"Â andÂ closeÂ >Â entry_priceÂ )Â orÂ (Â trade_typeÂ ==Â "Sell"Â andÂ closeÂ <Â entry_priceÂ )Â ?Â "profit"Â :Â "loss"Â )Â +Â ")"Â )
Â Â Â Â Â Â Â Â Â Â Â Â entry_priceÂ :=Â 0.0
//Â closeÂ tradeÂ byÂ volumeÂ pressureÂ trendÂ change
ifÂ i_close_by_volume_pressure_compositeÂ ==Â trueÂ andÂ last_volume_trendÂ !=Â volume_pressure_trendÂ andÂ strategy.opentradesÂ >Â 0
Â Â Â Â trade_typeÂ =Â strategy.opentrades.entry_id(Â strategy.opentradesÂ -Â 1Â )
Â Â Â Â strategy.close_all(Â trade_typeÂ +Â "Â exit2Â ("Â +Â (Â (Â trade_typeÂ ==Â "Buy"Â andÂ closeÂ >Â entry_priceÂ )Â orÂ (Â trade_typeÂ ==Â "Sell"Â andÂ closeÂ <Â entry_priceÂ )Â ?Â "profit"Â :Â "loss"Â )Â +Â ")"Â )
Â Â Â Â entry_priceÂ :=Â 0.0
Â Â Â Â last_volume_trendÂ :=Â volume_pressure_trend
//Â trendÂ hasÂ changedÂ onÂ previousÂ candle,Â openÂ aÂ newÂ tradeÂ here
ifÂ trend_to_bearish_prevÂ orÂ trend_to_bullish_prev
Â Â Â Â ifÂ strategy.opentradesÂ ==Â 0
Â Â Â Â Â Â Â Â trade_typeÂ =Â trend_to_bullish_prevÂ ?Â "Buy"Â :Â "Sell"
Â Â Â Â Â Â Â Â open_tradeÂ =Â true
Â Â Â Â Â Â Â Â //Â checkÂ ifÂ weÂ shouldÂ onlyÂ openÂ tradesÂ byÂ theÂ volumeÂ pressureÂ trend
Â Â Â Â Â Â Â Â ifÂ i_use_volume_pressure_compositeÂ ==Â true
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (Â volume_pressure_trendÂ ==Â "bullish"Â andÂ trend_to_bearish_prevÂ )Â orÂ (Â volume_pressure_trendÂ ==Â "bearish"Â andÂ trend_to_bullish_prevÂ )
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â open_tradeÂ :=Â false
Â Â Â Â Â Â Â Â //Â checkÂ whetherÂ weÂ shouldÂ useÂ WPMAÂ toÂ openÂ longÂ tradesÂ belowÂ andÂ shortÂ onesÂ aboveÂ it
Â Â Â Â Â Â Â Â ifÂ i_trade_by_vpma
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (Â (Â i_trade_by_vpma_inverseÂ ==Â falseÂ andÂ trade_typeÂ ==Â "Buy"Â )Â orÂ (Â i_trade_by_vpma_inverseÂ ==Â trueÂ andÂ trade_typeÂ ==Â "Sell"Â )Â )Â andÂ closeÂ >=Â VPMavg
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â open_tradeÂ :=Â false
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (Â (Â i_trade_by_vpma_inverseÂ ==Â falseÂ andÂ trade_typeÂ ==Â "Sell"Â )Â orÂ (Â i_trade_by_vpma_inverseÂ ==Â trueÂ andÂ trade_typeÂ ==Â "Buy"Â )Â )Â andÂ closeÂ <=Â VPMavg
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â open_tradeÂ :=Â false
Â Â Â Â Â Â Â Â //Â doÂ weÂ openÂ tradesÂ inÂ trendÂ only?
Â Â Â Â Â Â Â Â ifÂ i_open_trades_on_trend_candlesÂ andÂ (Â (Â trade_typeÂ ==Â "Buy"Â andÂ closeÂ <Â openÂ )Â orÂ (Â trade_typeÂ ==Â "Sell"Â andÂ closeÂ >Â openÂ )Â )
Â Â Â Â Â Â Â Â Â Â Â Â open_tradeÂ :=Â false
Â Â Â Â Â Â Â Â ifÂ open_trade
Â Â Â Â Â Â Â Â Â Â Â Â entry_priceÂ :=Â close
Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â //Â calculateÂ SL
Â Â Â Â Â Â Â Â Â Â Â Â slÂ =Â 0.0
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ trend_to_bullish_prev
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â slÂ :=Â closeÂ -Â (Â (Â i_sl_percentÂ /Â 100Â )Â *Â closeÂ )
Â Â Â Â Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â slÂ :=Â closeÂ +Â (Â (Â i_sl_percentÂ /Â 100Â )Â *Â closeÂ )
Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â //Â checkÂ whetherÂ weÂ wantedÂ toÂ extendÂ theÂ SLÂ toÂ fullÂ candle'sÂ wick
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ i_sl_extend_to_full_candleÂ andÂ (Â (Â trade_typeÂ ==Â "Buy"Â andÂ slÂ >Â low[1]Â )Â orÂ (Â trade_typeÂ ==Â "Sell"Â andÂ slÂ <Â high[1]Â )Â )
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ trade_typeÂ ==Â "Buy"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â slÂ :=Â low[1]
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â elseÂ ifÂ trade_typeÂ ==Â "Sell"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â slÂ :=Â high[1]
Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â strategy.entry(Â trade_type,Â trend_to_bullish_prevÂ ?Â strategy.longÂ :Â strategy.shortÂ )
Â Â Â Â Â Â Â Â Â Â Â Â strategy.exit(Â trade_type,Â stopÂ =Â sl,Â commentÂ =Â trade_typeÂ +Â "Â closedÂ byÂ SL"Â )
//Â ExitÂ openÂ marketÂ positionÂ whenÂ dateÂ rangeÂ ends
ifÂ (notÂ inDateRange)
Â Â Â Â strategy.close_all()
Expand (235 lines)