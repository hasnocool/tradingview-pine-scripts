Script Name: Twin Range Filter Algo
Author: OrcChieftain
Description: @Colinmck used two different ranges to generate signals. Read his  release notes  to find out what the original script does.

I added one condition which seems to increase performance on 15m BTCUSD as well as 1h BTCUSD and that is ATR with 32 periods being smaller than ATR with 64 periods. I used my script  Volatility Optimiser  to discover this tendency.

Both...
PineScript code:

Pine Scriptâ„¢ strategy
Twin Range Filter Algo
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
//Â ThisÂ sourceÂ codeÂ isÂ subjectÂ toÂ theÂ termsÂ ofÂ theÂ MozillaÂ PublicÂ LicenseÂ 2.0Â atÂ https://mozilla.org/MPL/2.0/
//Â Â©Â colinmck,Â greenmask9
//@version=4
strategy(title="TwinÂ RangeÂ FilterÂ AlgoÂ v.3",Â shorttitleÂ =Â "TwinÂ RangeÂ Strategy",Â overlay=true)
sourceÂ =Â input(defval=close,Â title="Source")
//Â SmoothÂ AverageÂ Range
per1Â =Â input(defval=27,Â minval=1,Â title="FastÂ period",Â groupÂ ="TwinÂ RangeÂ FilterÂ @colinmck")
mult1Â =Â input(defval=1.6,Â minval=0.1,Â title="FastÂ range",Â groupÂ ="TwinÂ RangeÂ FilterÂ @colinmck")
per2Â =Â input(defval=55,Â minval=1,Â title="SlowÂ period",Â groupÂ ="TwinÂ RangeÂ FilterÂ @colinmck")
mult2Â =Â input(defval=2,Â minval=0.1,Â title="SlowÂ range",Â groupÂ ="TwinÂ RangeÂ FilterÂ @colinmck")
smoothrng(x,Â t,Â m)Â =>
Â Â Â Â wperÂ =Â tÂ *Â 2Â -Â 1
Â Â Â Â avrngÂ =Â ema(abs(xÂ -Â x[1]),Â t)
Â Â Â Â smoothrngÂ =Â ema(avrng,Â wper)Â *Â m
Â Â Â Â smoothrng
smrng1Â =Â smoothrng(source,Â per1,Â mult1)
smrng2Â =Â smoothrng(source,Â per2,Â mult2)
smrngÂ =Â (smrng1Â +Â smrng2)Â /Â 2
//Â RangeÂ Filter
rngfilt(x,Â r)Â =>
Â Â Â Â rngfiltÂ =Â x
Â Â Â Â rngfiltÂ :=Â xÂ >Â nz(rngfilt[1])Â ?Â xÂ -Â rÂ <Â nz(rngfilt[1])Â ?Â nz(rngfilt[1])Â :Â xÂ -Â rÂ :Â 
Â Â Â Â Â Â Â xÂ +Â rÂ >Â nz(rngfilt[1])Â ?Â nz(rngfilt[1])Â :Â xÂ +Â r
Â Â Â Â rngfilt
filtÂ =Â rngfilt(source,Â smrng)
upwardÂ =Â 0.0
upwardÂ :=Â filtÂ >Â filt[1]Â ?Â nz(upward[1])Â +Â 1Â :Â filtÂ <Â filt[1]Â ?Â 0Â :Â nz(upward[1])
downwardÂ =Â 0.0
downwardÂ :=Â filtÂ <Â filt[1]Â ?Â nz(downward[1])Â +Â 1Â :Â filtÂ >Â filt[1]Â ?Â 0Â :Â nz(downward[1])
hbandÂ =Â filtÂ +Â smrng
lbandÂ =Â filtÂ -Â smrng
longCondÂ =Â bool(na)
shortCondÂ =Â bool(na)
longCondÂ :=Â sourceÂ >Â filtÂ andÂ sourceÂ >Â source[1]Â andÂ upwardÂ >Â 0Â orÂ sourceÂ >Â filtÂ andÂ sourceÂ <Â source[1]Â andÂ upwardÂ >Â 0
shortCondÂ :=Â sourceÂ <Â filtÂ andÂ sourceÂ <Â source[1]Â andÂ downwardÂ >Â 0Â orÂ sourceÂ <Â filtÂ andÂ sourceÂ >Â source[1]Â andÂ downwardÂ >Â 0
CondIniÂ =Â 0
CondIniÂ :=Â longCondÂ ?Â 1Â :Â shortCondÂ ?Â -1Â :Â CondIni[1]
longÂ =Â longCondÂ andÂ CondIni[1]Â ==Â -1
shortÂ =Â shortCondÂ andÂ CondIni[1]Â ==Â 1
//Â Plotting
//Â Strategy
//Â FromÂ thisÂ partÂ on,Â programmerÂ isÂ greenmaks9
//
SeparatorÂ =Â input(title="FollowingÂ conditionsÂ andÂ backtestÂ algorithmÂ areÂ addedÂ byÂ @greenmask9Â ğŸ¯,Â originalÂ scriptÂ isÂ writtenÂ byÂ @colinmckÂ ğŸ‘.Â ReadÂ bothÂ ofÂ their'sÂ releaseÂ notesÂ forÂ moreÂ infoÂ onÂ howÂ thisÂ scriptÂ works.",Â type=input.bool,Â defval=false,Â groupÂ =Â "Greenmask'sÂ testingÂ resourcesÂ &Â ATRÂ condition")
disablerÂ =Â input(title="DisableÂ @greenmask9'sÂ ATRÂ conditions",Â type=input.bool,Â defval=false,Â groupÂ =Â "Greenmask'sÂ testingÂ resourcesÂ &Â ATRÂ condition")
//second
l2Â =Â input(title="ATR1",Â defval=32,Â minval=1,Â groupÂ =Â "ATRÂ condition",Â tooltipÂ =Â "C:Â Short-rangeÂ volatilityÂ mustÂ beÂ lowÂ thanÂ long-termÂ volatilityÂ measurementÂ forÂ theÂ entry.")
s2Â =Â input(title="Smoothing",Â defval="SMA",Â options=["RMA",Â "SMA",Â "EMA",Â "WMA"],Â tooltipÂ =Â "C:Â Short-rangeÂ volatilityÂ mustÂ beÂ lowÂ thanÂ long-termÂ volatilityÂ measurementÂ forÂ theÂ entry.",Â groupÂ =Â "ATRÂ condition")
atr2(source,Â l2)Â =>Â 
Â Â Â Â ifÂ s2Â ==Â "SMA"
Â Â Â Â Â Â Â Â sma(source,Â l2)
Â Â Â Â else
Â Â Â Â Â Â Â Â ifÂ s2Â ==Â "RMA"
Â Â Â Â Â Â Â Â Â Â Â Â rma(source,Â l2)
Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ s2Â ==Â "EMA"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ema(source,Â l2)
Â Â Â Â Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â wma(source,Â l2)
//third
l3Â =Â input(title="ATR2",Â defval=64,Â minval=1,Â groupÂ =Â "ATRÂ condition",Â tooltipÂ =Â "C:Â Short-rangeÂ volatilityÂ mustÂ beÂ lowÂ thanÂ long-termÂ volatilityÂ measurementÂ forÂ theÂ entry.")
s3Â =Â input(title="Smoothing",Â defval="RMA",Â options=["RMA",Â "SMA",Â "EMA",Â "WMA"],Â tooltipÂ =Â "C:Â Short-rangeÂ volatilityÂ mustÂ beÂ lowÂ thanÂ long-termÂ volatilityÂ measurementÂ forÂ theÂ entry.",Â groupÂ =Â "ATRÂ condition")
atr3(source,Â l3)Â =>Â 
Â Â Â Â ifÂ s3Â ==Â "RMA"
Â Â Â Â Â Â Â Â rma(source,Â l3)
Â Â Â Â else
Â Â Â Â Â Â Â Â ifÂ s3Â ==Â "SMA"
Â Â Â Â Â Â Â Â Â Â Â Â sma(source,Â l3)
Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ s3Â ==Â "EMA"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ema(source,Â l3)
Â Â Â Â Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â wma(source,Â l3)
atr20=atr2(tr(true),Â l2)
atr30=atr3(tr(true),Â l3)
ordersize=floor(strategy.initial_capital/close)
maxcandles_till_closeÂ =Â input(title="Time-basedÂ Close",Â type=input.integer,Â defval=17,Â groupÂ =Â "AlternativeÂ Exit")
i_timeÂ =Â input(true,Â "EnableÂ TimeÂ BaseÂ Close",Â groupÂ =Â "AlternativeÂ Exit"Â )
//stop
varipÂ stop_longÂ =Â 0.0,Â varipÂ entryÂ =Â 0.0,Â varipÂ stop_shortÂ =Â 0.0
i_sl_typeÂ =Â input("LowÂ -Â (closeÂ -Â lowestÂ low[len])Â *Â %",Â optionsÂ =Â ["LowÂ -Â (ATR[len]Â *Â %)",Â "LowÂ -Â (closeÂ -Â lowestÂ low[len])Â *Â %",Â "LowÂ -Â (closeÂ -Â averageÂ low[len])Â *Â %",Â "CloseÂ -Â (ATR[len]Â *Â %)",Â "LowÂ -Â TicksNumber"],Â title="CalculationÂ (Long)",Â groupÂ =Â "Stop-loss",Â tooltipÂ =Â "ThisÂ isÂ aÂ stop-lossÂ calculationÂ forÂ longÂ positions.Â ReversedÂ logicÂ isÂ usedÂ forÂ shortÂ stop-loss.Â *CalculationÂ LowÂ -Â TicksNumberÂ doesn'tÂ useÂ Percentage-basedÂ multiplier.Â **NumberÂ ofÂ ticksÂ isÂ alwaysÂ substractedÂ (added)Â afterÂ theÂ initialÂ calculation.Â ")
i_sl_atrÂ =Â input(10,Â "CalculationÂ Length",Â groupÂ =Â "Stop-loss")
i_sl_percÂ =Â input(80,Â "Percentage",Â groupÂ =Â "Stop-loss",Â typeÂ =Â input.float)Â /Â 100
i_sl_ticksÂ =Â input(defvalÂ =Â 10,Â minvalÂ =Â 1,Â titleÂ =Â "NumberÂ ofÂ ticks",Â groupÂ =Â "Stop-loss")Â *Â syminfo.mintick
i_stoplossÂ =Â input(true,Â "EnableÂ Stop-loss",Â groupÂ =Â "Stop-loss")
f_stop_longÂ (calculation,Â length,Â mult,Â ticks)Â =>
Â Â Â Â stop_0Â =Â calculationÂ ==Â "LowÂ -Â (ATR[len]Â *Â %)"Â ?Â lowÂ -Â (atr(length)Â *Â mult)Â -Â ticksÂ Â Â :
Â Â Â Â Â calculationÂ ==Â "LowÂ -Â (closeÂ -Â lowestÂ low[len])Â *Â %"Â ?Â lowÂ -Â (closeÂ -Â (lowest(low,Â length)))Â *Â multÂ -Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â "LowÂ -Â (closeÂ -Â averageÂ low[len])Â *Â %"Â ?Â lowÂ -Â (closeÂ -Â sma(low,Â length))Â *Â multÂ -Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â Â "CloseÂ -Â (ATR[len]Â *Â %)"Â ?Â closeÂ -Â (atr(length)Â *Â mult)Â -Â ticksÂ Â :
Â Â Â Â Â lowÂ -Â ticks
f_stop_shortÂ (calculation,Â length,Â mult,Â ticks)Â =>
Â Â Â Â stop_0Â =Â calculationÂ ==Â "LowÂ -Â (ATR[len]Â *Â %)"Â ?Â highÂ +Â (atr(length)Â *Â mult)Â +Â ticksÂ Â :
Â Â Â Â Â calculationÂ ==Â "LowÂ -Â (closeÂ -Â lowestÂ low[len])Â *Â %"Â ?Â highÂ +Â abs(closeÂ -Â lowest(high,Â length))Â *Â multÂ +Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â "LowÂ -Â (closeÂ -Â averageÂ low[len])Â *Â %"Â ?Â highÂ +Â abs(closeÂ -Â sma(high,Â length))Â *Â multÂ +Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â Â "CloseÂ -Â (ATR[len]Â *Â %)"Â ?Â closeÂ +Â (atr(length)Â *Â mult)Â +Â ticksÂ Â :
Â Â Â Â Â highÂ +Â ticks
//target
varipÂ target_longÂ =Â 0.0,Â varipÂ target_shortÂ =Â 0.0
i_tr_typeÂ =Â input("CloseÂ +Â (ATR[len]Â *Â %)",Â optionsÂ =Â ["HighÂ +Â (ATR[len]Â *Â %)",Â "CloseÂ +Â (ATR[len]Â *Â %)",Â "CloseÂ +Â abs(closeÂ -Â highestÂ high[len])Â *Â %",Â Â "CloseÂ +Â abs(closeÂ -Â averageÂ high[len])Â *Â %",Â Â "HighÂ +Â TicksNumber",Â "CloseÂ +Â TicksNumber"],Â title="CalculationÂ (Long)",Â groupÂ =Â "Target",Â tooltipÂ =Â "RawÂ numberÂ ofÂ ticksÂ isÂ alwaysÂ addedÂ toÂ theÂ target.")
i_tr_atrÂ =Â input(10,Â "CalculationÂ Length",Â groupÂ =Â "Target")
i_tr_percÂ =Â input(500,Â "Percentage",Â groupÂ =Â "Target",Â typeÂ =Â input.float)Â /Â 100
i_tr_ticksÂ =Â input(defvalÂ =Â 10,Â minvalÂ =Â 1,Â titleÂ =Â "NumberÂ ofÂ ticks",Â groupÂ =Â "Target")Â *Â syminfo.mintick
i_targetÂ =Â input(true,Â "EnableÂ Target",Â groupÂ =Â "Target")
f_target_longÂ (calculation,Â length,Â mult,Â ticks)Â =>
Â Â Â Â stop_0Â =Â calculationÂ ==Â "HighÂ +Â (ATR[len]Â *Â %)"Â ?Â highÂ +Â (atr(length)Â *Â mult)Â +Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â "CloseÂ +Â (ATR[len]Â *Â %)"Â ?Â closeÂ +Â (atr(length)Â *Â mult)Â +Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â "CloseÂ +Â abs(closeÂ -Â highestÂ high[len])Â *Â %"Â ?Â closeÂ +Â abs(closeÂ -Â (highest(high,Â length)))Â *Â multÂ +Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â "CloseÂ +Â abs(closeÂ -Â averageÂ high[len])Â *Â %"Â ?Â closeÂ +Â abs(closeÂ -Â sma(high,Â length))Â *Â multÂ +Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â Â "HighÂ +Â TicksNumber"Â ?Â highÂ +Â ticksÂ Â :
Â Â Â Â Â closeÂ +Â ticks
f_target_shortÂ (calculation,Â length,Â mult,Â ticks)Â =>
Â Â Â Â stop_0Â =Â calculationÂ ==Â "HighÂ +Â (ATR[len]Â *Â %)"Â ?Â lowÂ -Â (atr(length)Â *Â mult)Â -Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â "CloseÂ +Â (ATR[len]Â *Â %)"Â ?Â closeÂ -Â (atr(length)Â *Â mult)Â -Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â "CloseÂ +Â abs(closeÂ -Â highestÂ high[len])Â *Â %"Â ?Â closeÂ -Â abs(closeÂ -Â (lowest(low,Â length)))Â *Â multÂ -Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â "CloseÂ +Â abs(closeÂ -Â averageÂ high[len])Â *Â %"Â ?Â closeÂ -Â abs(closeÂ -Â sma(low,Â length))Â *Â multÂ -Â ticksÂ :
Â Â Â Â Â calculationÂ ==Â Â "HighÂ +Â TicksNumber"Â ?Â lowÂ -Â ticksÂ Â :
Â Â Â Â Â closeÂ -Â ticks
ifÂ (strategy.position_sizeÂ >=Â 0Â orÂ strategy.position_size[1]Â !=Â strategy.position_size)
Â Â Â Â stop_shortÂ :=Â i_stoplossÂ ?Â f_stop_short(i_sl_type,Â i_sl_atr,Â i_sl_perc,Â i_sl_ticks)Â :Â na
Â Â Â Â target_shortÂ :=Â i_targetÂ ?Â f_target_short(i_tr_type,Â i_tr_atr,Â i_tr_perc,Â i_tr_ticks)Â :Â na
ifÂ (strategy.position_sizeÂ <=Â 0Â orÂ strategy.position_size[1]Â !=Â strategy.position_size)
Â Â Â Â stop_longÂ :=Â i_stoplossÂ ?Â f_stop_long(i_sl_type,Â i_sl_atr,Â i_sl_perc,Â i_sl_ticks)Â :Â na
Â Â Â Â target_longÂ :=Â i_targetÂ ?Â f_target_long(i_tr_type,Â i_tr_atr,Â i_tr_perc,Â i_tr_ticks)Â :Â na
ifÂ (strategy.position_sizeÂ ==Â 0Â orÂ strategy.position_size[1]Â !=Â strategy.position_size)
Â Â Â Â entryÂ :=Â open
bullÂ =Â longÂ andÂ (atr20<atr30Â orÂ disabler)
bearÂ =Â shortÂ andÂ (atr20<atr30Â orÂ disabler)
bullclockÂ =Â barssince(bull)
bearclockÂ =Â barssince(bear)
ifÂ (bull)
Â Â Â Â strategy.entry("TwinÂ Long",Â strategy.long,Â ordersize)
strategy.exit("Exit",Â from_entryÂ =Â Â "TwinÂ Long",Â limitÂ =Â target_long,Â stopÂ =Â stop_long)
ifÂ (bear)
Â Â Â Â strategy.entry("TwinÂ Short",Â strategy.short,Â ordersize)
strategy.exit("Exit",Â from_entryÂ =Â "TwinÂ Short",Â limitÂ =Â target_short,Â stopÂ =Â stop_short)
i_message_longÂ =Â input("LongÂ entryÂ defaultÂ message:Â x",Â "LongÂ EntryÂ AlertÂ Message",Â groupÂ =Â "Alert")
i_long_alertÂ =Â input(true,"EnableÂ LongÂ Alert",Â groupÂ =Â "Alert")
i_message_shortÂ =Â input("LongÂ entryÂ defaultÂ message:Â x",Â "ShortÂ EntryÂ AlertÂ Message",Â groupÂ =Â "Alert")
i_short_alertÂ =Â input(true,"EnableÂ ShortÂ Alert",Â groupÂ =Â "Alert")
ifÂ (bullÂ andÂ strategy.position_size[1]Â ==Â 0Â andÂ i_long_alert)
Â Â Â Â alert(i_message_long,Â alert.freq_once_per_bar_close)
ifÂ (bearÂ andÂ strategy.position_size[1]Â ==Â 0Â andÂ i_short_alert)
Â Â Â Â alert(i_message_short,Â alert.freq_once_per_bar_close)
//timeÂ stoploss
ifÂ (i_time)
Â Â Â Â strategy.close("TwinÂ Long",Â whenÂ =Â bullclockÂ ==Â maxcandles_till_close,Â commentÂ =Â "Time")
Â Â Â Â strategy.close("TwinÂ Short",Â whenÂ =Â bearclockÂ ==Â maxcandles_till_close,Â commentÂ =Â "Time")
c_fill_stopÂ =Â color.new(color.red,Â 90)
c_fill_targetÂ =Â color.new(color.green,Â 90)
p_longstopÂ =Â plot(strategy.position_sizeÂ >Â 0Â andÂ i_stoplossÂ Â ?Â stop_longÂ :Â na,Â linewidthÂ =Â 2,Â colorÂ =Â color.red,Â styleÂ =Â plot.style_linebr)
p_shortstopÂ =Â plot(strategy.position_sizeÂ <Â 0Â andÂ i_stoplossÂ ?Â stop_shortÂ :Â na,Â linewidthÂ =Â 2,Â colorÂ =Â color.red,Â styleÂ =Â plot.style_linebr)
p_entryÂ =Â plot(strategy.position_sizeÂ !=Â 0Â ?Â entryÂ :Â na,Â linewidthÂ =Â 2,Â colorÂ =Â color.blue,Â styleÂ =Â plot.style_linebr)
p_longtargetÂ =Â plot(strategy.position_sizeÂ >Â 0Â andÂ i_targetÂ ?Â target_longÂ :Â na,Â linewidthÂ =Â 2,Â colorÂ =Â color.green,Â styleÂ =Â plot.style_linebr)
p_shorttargetÂ =Â plot(strategy.position_sizeÂ <Â 0Â andÂ i_targetÂ ?Â target_shortÂ :Â na,Â linewidthÂ =Â 2,Â colorÂ =Â color.green,Â styleÂ =Â plot.style_linebr)
fill(p_entry,Â p_longstop,Â c_fill_stop)
fill(p_entry,Â p_shortstop,Â c_fill_stop)
fill(p_entry,Â p_longtarget,Â c_fill_target)
fill(p_entry,Â p_shorttarget,Â c_fill_target)
Expand (217 lines)