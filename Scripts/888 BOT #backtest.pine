Script Name: 888 BOT #backtest
Author: UnknownUnicorn2151907
Description: â–ˆ 888 BOT #backtest (open source)

This is an Expert Advisor 'EA' or Automated trading script for â€˜longsâ€™ and â€˜shortsâ€™, which uses only a Take Profit or, in the worst case, a Stop Loss to close the trade.
It's a much improved version of the previous â€˜Repanochaâ€™. It doesn`t use 'Trailing Stop' or 'security()' functions (although using a security function doesn`t...
PineScript code:

Pine Scriptâ„¢ strategy
888 BOT #backtest
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
//Â ThisÂ sourceÂ codeÂ isÂ subjectÂ toÂ theÂ termsÂ ofÂ theÂ MozillaÂ PublicÂ LicenseÂ 2.0Â atÂ https://mozilla.org/MPL/2.0/
//Â Â©Â Xaviz
//@version=4
strategy(titleÂ =Â "888Â BOTÂ #backtest",Â shorttitleÂ =Â "888ðŸ’¹",Â overlayÂ =Â true,Â initial_capitalÂ =Â 10000,Â pyramidingÂ =Â 10,Â currencyÂ =Â "USD",
Â Â Â default_qty_typeÂ =Â strategy.percent_of_equity,Â default_qty_valueÂ =Â 0,Â commission_valueÂ =Â 0.04)
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â Inputs
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â SourceÂ input
srcÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(hlc3,Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒSOURCE",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.source)
//Â â€”â€”â€”â€”â€”Â JMAÂ inputs
Act_JMAÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "JURIKÂ MOVINGÂ AVERAGE",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
JMA_lengthÂ Â Â Â Â Â Â Â Â Â =Â input(30,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒJMAÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 0)
phaseÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(40,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒJMAÂ PHASE",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 0)
powerÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(2.5,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒJMAÂ POWER",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.5)
//Â â€”â€”â€”â€”â€”Â RangeÂ FilterÂ inputs
Act_RFÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "RANGEÂ FILTER",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
perÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(20,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒSAMPLINGÂ PERIOD",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
multÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(1.7,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒRANGEÂ MULTIPLIER",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0.1,Â Â Â stepÂ =Â 0.1)
//Â â€”â€”â€”â€”â€”Â ADXÂ inputs
Act_ADXÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "AVERAGEÂ DIRECTIONALÂ INDEX",Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
ADX_optionsÂ Â Â Â Â Â Â Â Â =Â input("CLASSIC",Â Â titleÂ =Â "â€ƒâ€ƒADXÂ OPTION",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â optionsÂ =Â ["CLASSIC",Â "MASANAKAMURA"])
ADX_lenÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(22,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒADXÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
thÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(20,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒADXÂ THRESHOLD",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.5)
//Â â€”â€”â€”â€”â€”Â SARÂ inputs
Act_SARÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "PARABOLICÂ SAR",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
SstÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â inputÂ (0.25,Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒSARÂ STAR",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0.01,Â Â stepÂ =Â 0.01)
SincÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â inputÂ (0.25,Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒSARÂ INC",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0.01,Â Â stepÂ =Â 0.01)
SmaxÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â inputÂ (0.13,Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒSARÂ MAX",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0.01,Â Â stepÂ =Â 0.01)
//Â â€”â€”â€”â€”â€”Â RSIÂ withÂ volumeÂ inputs
Act_RSIÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "RSIÂ VOLUMEÂ WEIGHTED",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
RSI_lenÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(34,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒRSIÂ LENGHT",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
RSI_obosÂ Â Â Â Â Â Â Â Â Â Â Â =Â input(45,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒRSIÂ CENTERÂ LINE",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
//Â â€”â€”â€”â€”â€”Â MACDÂ /Â MAC-ZÂ inputs
Act_MACDÂ Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "MAÂ CONVERGENCE/DIVERGENCE",Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
MACD_optionsÂ Â Â Â Â Â Â Â =Â input("MAC-Z",Â Â Â Â titleÂ =Â "â€ƒâ€ƒMACDÂ OPTION",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â optionsÂ =Â ["MACD",Â "MAC-Z"])
fastLengthÂ Â Â Â Â Â Â Â Â Â =Â input(45,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒMACDÂ FASTÂ MAÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
slowLengthÂ Â Â Â Â Â Â Â Â Â =Â input(47,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒMACDÂ SLOWÂ MAÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
signalLengthÂ Â Â Â Â Â Â Â =Â input(13,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒMACDÂ SIGNALÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
lengthzÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(9,Â Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒZ-VWAPÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
lengthStdevÂ Â Â Â Â Â Â Â Â =Â input(14,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒSTDEVÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
//Â â€”â€”â€”â€”â€”Â VolumeÂ inputsÂ forÂ entriesÂ conditionÂ andÂ forÂ calculateÂ quantitiesÂ later
Act_VolÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "VOLUMEÂ CONDITION",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
volume_fÂ Â Â Â Â Â Â Â Â Â Â Â =Â input(1.4,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒVOLUMEÂ FACTOR",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.1)
sma_lengthÂ Â Â Â Â Â Â Â Â Â =Â input(61,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒSMAÂ VOLUMEÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
//Â â€”â€”â€”â€”â€”Â FirstÂ takeÂ profitÂ input
tp_long0Â Â Â Â Â Â Â Â Â Â Â Â =Â input(1.7,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒTAKEÂ PROFITÂ LONGÂ %",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.1)Â 
tp_short0Â Â Â Â Â Â Â Â Â Â Â =Â input(1.8,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒTAKEÂ PROFITÂ SHORTÂ %",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.1)Â 
//Â â€”â€”â€”â€”â€”Â StopÂ LossÂ input
Act_slÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "ACTIVATEÂ STOPÂ LOSSÂ ðŸ§»",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
SL_optionsÂ Â Â Â Â Â Â Â Â Â =Â input("NORMAL",Â Â Â titleÂ =Â "â€ƒâ€ƒSTOPÂ LOSSÂ OPTION",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â optionsÂ =Â ["NORMAL",Â "ATR",Â "BOTH"])
sl0Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(3.7,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒSTOPÂ LOSSÂ %",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.1)
//Â â€”â€”â€”â€”â€”Â ATRÂ Inputs
atrPeriodÂ Â Â Â Â Â Â Â Â Â Â =Â input(13,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒATRÂ SLÂ PERIOD",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 0)
multiplierPeriodÂ Â Â Â =Â input(7.0,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒATRÂ SLÂ MULTIPLIER",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.1)
//Â â€”â€”â€”â€”â€”Â RiskÂ input
RiskÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(3.5,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒ%Â RISKÂ ALLOWED",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.5)
//Â â€”â€”â€”â€”â€”Â ConfirmedÂ StopÂ loss
Act_Conf_SLÂ Â Â Â Â Â Â Â Â =Â input(false,Â Â Â Â Â Â titleÂ =Â "STOPÂ LOSSÂ CONFIRMED",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
//Â â€”â€”â€”â€”â€”Â BollingerÂ BandsÂ inputs
Act_BBÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "ACTIVATEÂ BOLLINGERÂ BANDSÂ RE-ENTRYÂ ðŸš€",Â typeÂ =Â input.bool)
BB_lengthÂ Â Â Â Â Â Â Â Â Â Â =Â input(20,Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒBBÂ LENGTH",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)
BB_multÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(1.9,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒBBÂ MULTIPLIER",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0.001,Â stepÂ =Â 0.1)
bbBetterPriceÂ Â Â Â Â Â Â =Â input(0.5,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒ%Â MINIMUMÂ BETTERÂ PRICE",Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0.1,Â Â Â stepÂ =Â 0.1)
Act_divideÂ Â Â Â Â Â Â Â Â Â =Â input(false,Â Â Â Â Â Â titleÂ =Â "ACTIVATEÂ DIVIDEÂ TP",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
//Â â€”â€”â€”â€”â€”Â BacktestÂ input
Act_BTÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â input(true,Â Â Â Â Â Â Â titleÂ =Â "BACKTESTÂ ðŸ’¹",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.bool)
backtest_timeÂ Â Â Â Â Â Â =Â input(180,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒBACKTESTÂ DAYS",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1)*24*60*60*1000
entry_TypeÂ Â Â Â Â Â Â Â Â Â =Â input("%Â EQUITY",Â titleÂ =Â "â€ƒâ€ƒENTRYÂ TYPE",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â optionsÂ =Â ["CONTRACTS","CASH","%Â EQUITY"])
et_FactorÂ Â Â Â Â Â Â Â Â Â Â =Â (entry_TypeÂ ==Â "CONTRACTS")Â ?Â 1Â :Â (entry_TypeÂ ==Â "%Â EQUITY")Â ?Â (100/(strategy.equity/close))Â :Â close
quanTityÂ Â Â Â Â Â Â Â Â Â Â Â =Â input(8.0,Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒQUANTITYÂ (LEVERAGEÂ 1X)",Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.float,Â Â Â Â Â minvalÂ =Â 0,Â Â Â Â Â stepÂ =Â 0.5)Â /Â et_Factor
Max_LevÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â input(8,Â Â Â Â Â Â Â Â Â Â titleÂ =Â "â€ƒâ€ƒMAXIMUMÂ LEVERAGE",Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â input.integer,Â Â Â minvalÂ =Â 1,Â Â Â Â Â maxvalÂ =Â 8)Â Â Â 
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â Variables
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â Long/Short
varÂ boolÂ Â Â Â longCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â shortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ intÂ Â Â Â Â CondIni_longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0,Â Â Â Â varÂ intÂ Â Â Â Â CondIni_shortÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0
varÂ boolÂ Â Â Â _Final_longConditionÂ Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â _Final_shortConditionÂ Â Â Â Â Â Â =Â na
varÂ floatÂ Â Â last_open_longConditionÂ Â Â Â Â =Â na,Â Â Â varÂ floatÂ Â Â last_open_shortConditionÂ Â Â Â =Â na
varÂ floatÂ Â Â last_dynamic_Leverage_longÂ Â =Â na,Â Â Â varÂ floatÂ Â Â last_dynamic_Leverage_shortÂ =Â na
varÂ intÂ Â Â Â Â last_longConditionÂ Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ intÂ Â Â Â Â last_shortConditionÂ Â Â Â Â Â Â Â Â =Â na
varÂ intÂ Â Â Â Â last_Final_longConditionÂ Â Â Â =Â na,Â Â Â varÂ intÂ Â Â Â Â last_Final_shortConditionÂ Â Â =Â na
varÂ intÂ Â Â Â Â nLongsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ intÂ Â Â Â Â nShortsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
//Â â€”â€”â€”â€”â€”Â TakeÂ profit
varÂ boolÂ Â Â Â long_tpÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â short_tpÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ intÂ Â Â Â Â last_long_tpÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ intÂ Â Â Â Â last_short_tpÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â Final_Long_tpÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â Final_Short_tpÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
//Â â€”â€”â€”â€”â€”Â StopÂ Loss
varÂ intÂ Â Â Â Â CondIni_long_slÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â 0,Â Â Â Â varÂ intÂ Â Â Â Â CondIni_short_slÂ Â Â Â Â Â Â Â Â Â Â Â =Â 0
varÂ boolÂ Â Â Â Final_Long_sl0Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â Final_Short_sl0Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â Final_Long_slÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â Final_Short_slÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ intÂ Â Â Â Â last_long_slÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ intÂ Â Â Â Â last_short_slÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
//Â â€”â€”â€”â€”â€”Â Indicators
varÂ boolÂ Â Â Â JMA_longCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â JMA_shortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â RF_longCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â RF_shortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â ADX_longCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â ADX_shortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â SAR_longCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â SAR_shortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â RSI_longCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â RSI_shortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â MACD_longCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â MACD_shortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â VOL_longCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â VOL_shortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â JMA_XlongCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â JMA_XshortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â RF_XlongCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â RF_XshortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â ADX_XlongCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â ADX_XshortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ boolÂ Â Â Â SAR_XlongCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â SAR_XshortCondÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ intÂ Â Â Â Â CondIni_long_BBÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â 0,Â Â Â Â varÂ intÂ Â Â Â Â CondIni_short_BBÂ Â Â Â Â Â Â Â Â Â Â Â =Â 0
varÂ boolÂ Â Â Â Final_long_BBÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ boolÂ Â Â Â Final_short_BBÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
varÂ intÂ Â Â Â Â last_long_BBÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na,Â Â Â varÂ intÂ Â Â Â Â last_short_BBÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â na
//Â â€”â€”â€”â€”â€”Â AverageÂ Price
varÂ floatÂ Â Â sum_longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0.0,Â Â varÂ floatÂ Â Â sum_shortÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0.0
varÂ floatÂ Â Â Position_PriceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0.0
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â JurikÂ MovingÂ Average
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â JMAÂ calculation
JMA(_JMA_length,Â _phase,Â _power,Â _src)Â =>
Â Â Â Â phaseRatioÂ Â Â Â Â Â =Â _phaseÂ <Â -100Â ?Â 0.5Â :Â _phaseÂ >Â 100Â ?Â 2.5Â :Â _phaseÂ /Â 100Â +Â 1.5
Â Â Â Â betaÂ Â Â Â Â Â Â Â Â Â Â Â =Â 0.45Â *Â (_JMA_lengthÂ -Â 1)Â /Â (0.45Â *Â (_JMA_lengthÂ -Â 1)Â +Â 2)
Â Â Â Â alphaÂ Â Â Â Â Â Â Â Â Â Â =Â pow(beta,Â _power)
Â Â Â Â jmaÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â 0.0
Â Â Â Â e0Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0.0
Â Â Â Â e0Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â (1Â -Â alpha)Â *Â _srcÂ +Â alphaÂ *Â nz(e0[1])
Â Â Â Â e1Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0.0
Â Â Â Â e1Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â (_srcÂ -Â e0)Â *Â (1Â -Â beta)Â +Â betaÂ *Â nz(e1[1])
Â Â Â Â e2Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0.0
Â Â Â Â e2Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â (e0Â +Â phaseRatioÂ *Â e1Â -Â nz(jma[1]))Â *Â pow(1Â -Â alpha,Â 2)Â +Â pow(alpha,Â 2)Â *Â nz(e2[1])
Â Â Â Â jmaÂ Â Â Â Â Â Â Â Â Â Â Â Â :=Â e2Â +Â nz(jma[1])
Â Â Â Â 
//Â â€”â€”â€”â€”â€”Â DefiningÂ JMAÂ trend
JMA_RisingÂ Â Â Â Â Â Â Â Â Â =Â JMA(JMA_length,Â phase,Â power,Â src)Â >Â JMA(JMA_length,Â phase,Â power,Â src)[1]
JMA_FallingÂ Â Â Â Â Â Â Â Â =Â JMA(JMA_length,Â phase,Â power,Â src)Â <Â JMA(JMA_length,Â phase,Â power,Â src)[1]
//Â â€”â€”â€”â€”â€”Â JMAÂ Plotting
JMA_colorÂ Â Â Â Â Â Â Â Â Â Â =Â JMA_RisingÂ ?Â color.limeÂ :Â JMA_FallingÂ ?Â #e91e63Â :Â color.orange
plot(Act_JMAÂ ?Â JMA(JMA_length,Â phase,Â power,Â src)Â :Â na,Â color=JMA_color,Â linewidthÂ =Â 2,Â title=Â "JMA")
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â RangeÂ Filter
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â RangeÂ FilterÂ calculation
Range_filter(_src,Â _per,Â _mult)Â =>
Â Â Â Â floatÂ _upwardÂ Â Â =Â 0.0
Â Â Â Â floatÂ _downwardÂ =Â 0.0
Â Â Â Â wperÂ Â Â Â Â Â Â Â Â Â Â Â =Â (_per*2)Â -Â 1
Â Â Â Â avrngÂ Â Â Â Â Â Â Â Â Â Â =Â ema(abs(_srcÂ -Â _src[1]),Â _per)
Â Â Â Â _smoothrngÂ Â Â Â Â Â =Â ema(avrng,Â wper)Â *Â _mult
Â Â Â Â _filtÂ Â Â Â Â Â Â Â Â Â Â =Â _src
Â Â Â Â _filtÂ Â Â Â Â Â Â Â Â Â Â :=Â _srcÂ Â >Â nz(_filt[1])Â ?Â ((_src-_smoothrng)Â <Â nz(_filt[1])Â ?Â nz(_filt[1])Â :Â (_src-_smoothrng))Â :Â ((_src+_smoothrng)Â >Â nz(_filt[1])Â ?Â nz(_filt[1])Â :Â (_src+_smoothrng))
Â Â Â Â _upwardÂ Â Â Â Â Â Â Â Â :=Â _filtÂ >Â _filt[1]Â Â Â Â Â ?Â nz(_upward[1])Â Â Â +Â 1Â :Â _filtÂ <Â _filt[1]Â ?Â 0Â :Â nz(_upward[1])
Â Â Â Â _downwardÂ Â Â Â Â Â Â :=Â _filtÂ <Â _filt[1]Â Â Â Â Â ?Â nz(_downward[1])Â +Â 1Â :Â _filtÂ >Â _filt[1]Â ?Â 0Â :Â nz(_downward[1])
Â Â Â Â [_smoothrng,_filt,_upward,_downward]
Â Â Â Â 
//Â â€”â€”â€”â€”â€”Â DefiningÂ variablesÂ forÂ includeÂ inÂ futureÂ conditions
[smoothrng,Â filt,Â upward,Â downward]Â =Â Range_filter(src,Â per,Â mult)
//Â â€”â€”â€”â€”â€”Â DefiningÂ highÂ andÂ lowÂ bands
hbandÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â filtÂ +Â smoothrng
lbandÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â filtÂ -Â smoothrng
//Â â€”â€”â€”â€”â€”Â RangeÂ FilterÂ Plotting
filtcolorÂ Â Â Â Â Â Â Â Â Â Â =Â upwardÂ >Â 0Â ?Â color.limeÂ :Â downwardÂ >Â 0Â ?Â color.redÂ :Â color.orange
filtplotÂ Â Â Â Â Â Â Â Â Â Â Â =Â plot(Act_RFÂ ?Â filtÂ Â :Â na,Â colorÂ =Â filtcolor,Â Â linewidthÂ =Â 1,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â titleÂ =Â "RF")
hbandplotÂ Â Â Â Â Â Â Â Â Â Â =Â plot(Act_RFÂ ?Â hbandÂ :Â na,Â colorÂ =Â filtcolor,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â transpÂ =Â 50,Â Â Â Â titleÂ =Â "RFÂ HighÂ Target")
lbandplotÂ Â Â Â Â Â Â Â Â Â Â =Â plot(Act_RFÂ ?Â lbandÂ :Â na,Â colorÂ =Â filtcolor,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â transpÂ =Â 50,Â Â Â Â titleÂ =Â "RFÂ LowÂ Target")
fill(hbandplot,Â lbandplot,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â colorÂ =Â filtcolor,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â titleÂ =Â "RFÂ TargetÂ Range")
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â ADX
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â ClassicÂ ADXÂ calculating
calcADX(_len)Â =>
Â Â Â Â upÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â change(high)
Â Â Â Â downÂ Â Â Â Â Â Â Â Â Â Â Â =Â -change(low)
Â Â Â Â plusDMÂ Â Â Â Â Â Â Â Â Â =Â na(up)Â Â Â ?Â naÂ :Â (upÂ >Â downÂ andÂ upÂ >Â 0Â Â Â ?Â upÂ Â Â :Â 0)
Â Â Â Â minusDMÂ Â Â Â Â Â Â Â Â =Â na(down)Â ?Â naÂ :Â (downÂ >Â upÂ andÂ downÂ >Â 0Â ?Â downÂ :Â 0)
Â Â Â Â truerangeÂ Â Â Â Â Â Â =Â rma(tr,Â _len)
Â Â Â Â _plusÂ Â Â Â Â Â Â Â Â Â Â =Â fixnan(100Â *Â rma(plusDM,Â _len)Â Â /Â truerange)
Â Â Â Â _minusÂ Â Â Â Â Â Â Â Â Â =Â fixnan(100Â *Â rma(minusDM,Â _len)Â /Â truerange)
Â Â Â Â sumÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â _plusÂ +Â _minus
Â Â Â Â _adxÂ Â Â Â Â Â Â Â Â Â Â Â =Â 100Â *Â rma(abs(_plusÂ -Â _minus)Â /Â (sumÂ ==Â 0Â ?Â 1Â :Â sum),Â _len)
Â Â Â Â [_plus,_minus,_adx]
//Â â€”â€”â€”â€”â€”Â MasanakamuraÂ ADXÂ calculating
calcADX_Masanakamura(_len)Â =>
Â Â Â Â SmoothedTrueRangeÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â 0.0
Â Â Â Â SmoothedDirectionalMovementPlusÂ Â Â Â Â =Â 0.0
Â Â Â Â SmoothedDirectionalMovementMinusÂ Â Â Â =Â 0.0
Â Â Â Â TrueRangeÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â max(max(highÂ -Â low,Â abs(highÂ -Â nz(close[1]))),Â abs(lowÂ -Â nz(close[1])))
Â Â Â Â DirectionalMovementPlusÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â highÂ -Â nz(high[1])Â >Â nz(low[1])Â -Â lowÂ ?Â max(highÂ -Â nz(high[1]),Â 0)Â :Â 0
Â Â Â Â DirectionalMovementMinusÂ Â Â Â Â Â Â Â Â Â Â Â =Â nz(low[1])Â -Â lowÂ >Â highÂ -Â nz(high[1])Â ?Â max(nz(low[1])Â -Â low,Â 0)Â Â Â :Â 0
Â Â Â Â SmoothedTrueRangeÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â nz(SmoothedTrueRange[1])Â -Â (nz(SmoothedTrueRange[1])Â /_len)Â +Â TrueRange
Â Â Â Â SmoothedDirectionalMovementPlusÂ Â Â Â Â :=Â nz(SmoothedDirectionalMovementPlus[1])Â Â -Â (nz(SmoothedDirectionalMovementPlus[1])Â Â /Â _len)Â +Â DirectionalMovementPlus
Â Â Â Â SmoothedDirectionalMovementMinusÂ Â Â Â :=Â nz(SmoothedDirectionalMovementMinus[1])Â -Â (nz(SmoothedDirectionalMovementMinus[1])Â /Â _len)Â +Â DirectionalMovementMinus
Â Â Â Â DIPÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â SmoothedDirectionalMovementPlusÂ Â /Â SmoothedTrueRangeÂ *Â 100
Â Â Â Â DIMÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â SmoothedDirectionalMovementMinusÂ /Â SmoothedTrueRangeÂ *Â 100
Â Â Â Â DXÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â abs(DIP-DIM)Â /Â (DIP+DIM)*100
Â Â Â Â adxÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â sma(DX,Â _len)
Â Â Â Â [DIP,DIM,adx]
Â //Â â€”â€”â€”â€”â€”Â DefiningÂ variablesÂ forÂ includeÂ inÂ futureÂ conditionsÂ Â Â 
[DIPlusC,DIMinusC,ADXC]Â =Â calcADX(ADX_len)Â 
[DIPlusM,DIMinusM,ADXM]Â =Â calcADX_Masanakamura(ADX_len)
DIPlusÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â ADX_optionsÂ ==Â "CLASSIC"Â ?Â DIPlusCÂ Â Â Â :Â DIPlusM
DIMinusÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â ADX_optionsÂ ==Â "CLASSIC"Â ?Â DIMinusCÂ Â Â :Â DIMinusM
ADXÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â ADX_optionsÂ ==Â "CLASSIC"Â ?Â ADXCÂ Â Â Â Â Â Â :Â ADXM
//Â â€”â€”â€”â€”â€”Â PlottingÂ ADXÂ barÂ colors
ADX_colorÂ =Â DIPlusÂ >Â DIMinusÂ andÂ ADXÂ >Â thÂ ?Â color.greenÂ :Â DIPlusÂ <Â DIMinusÂ andÂ ADXÂ >Â thÂ ?Â color.redÂ :Â color.orange
barcolor(colorÂ =Â Act_ADXÂ ?Â ADX_colorÂ :Â na,Â titleÂ =Â "ADX")
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â SAR
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â SARÂ calculationÂ fromÂ TV
SARÂ =Â sar(Sst,Â Sinc,Â Smax)
//Â â€”â€”â€”â€”â€”Â SARÂ Plotting
plot(Act_SARÂ ?Â SARÂ :Â na,Â colorÂ =Â ADX_color,Â styleÂ =Â plot.style_circles,Â titleÂ =Â "SAR")Â 
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â RSIÂ withÂ Volume
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â RSIÂ withÂ volumeÂ calculation
WiMA(_src,Â W_length)Â =>Â 
Â Â Â Â varÂ floatÂ MA_sÂ Â =Â 0.0
Â Â Â Â MA_sÂ Â Â Â Â Â Â Â Â Â Â Â :=(_srcÂ +Â nz(MA_s[1]Â *Â (W_length-1)))/W_length
Â Â Â Â MA_s
RSI_Volume(fv,Â _length)Â =>Â Â 
Â Â Â Â upÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â iff(fvÂ >Â fv[1],Â abs(fvÂ -Â fv[1])Â *Â volume,Â 0)
Â Â Â Â dnÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â iff(fvÂ <Â fv[1],Â abs(fvÂ -Â fv[1])Â *Â volume,Â 0)
Â Â Â Â uptÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â WiMA(up,_length)
Â Â Â Â dntÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â WiMA(dn,_length)
Â Â Â Â 100Â *Â (uptÂ /Â (uptÂ +Â dnt))
//Â â€”â€”â€”â€”â€”Â DefiningÂ variableÂ forÂ includeÂ inÂ conditions
RSI_VÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â RSI_Volume(src,Â RSI_len)
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â MACD
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â MAC-ZÂ calculation
calc_zvwap(pds)Â =>
Â Â Â Â meanÂ Â Â Â Â Â Â Â Â Â Â Â =Â sum(volumeÂ *Â close,Â pds)Â /Â sum(volume,Â pds)
Â Â Â Â vwapsdÂ Â Â Â Â Â Â Â Â Â =Â sqrt(sma(pow(closeÂ -Â mean,Â 2),Â pds))
Â Â Â Â (closeÂ -Â meanÂ )Â /Â vwapsd
zscoreÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â calc_zvwap(lengthz)
fastMAÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â sma(src,Â fastLength)
slowMAÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â sma(src,Â slowLength)
macdÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â fastMAÂ -Â slowMA
maczÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â zscoreÂ +Â macdÂ /Â stdev(src,Â lengthStdev)
signalÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â sma(macz,Â signalLength)
histmaczÂ Â Â Â Â Â Â Â Â Â Â Â =Â maczÂ -Â signal
//Â â€”â€”â€”â€”â€”Â MACDÂ calculation
[_,_,histmacd]Â Â Â Â Â Â =Â macd(src,Â Â fastLength,Â slowLength,Â signalLength)
histÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â MACD_optionsÂ ==Â "MACD"Â ?Â histmacdÂ :Â histmacz
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â Strategy
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â AllÂ indicatorsÂ withÂ longÂ conditionsÂ andÂ enable/disableÂ option
JMA_longCondÂ Â Â Â Â Â Â Â :=Â (Act_JMAÂ Â Â Â Â ?Â (JMA_Rising)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â VOL_longCond)Â 
RF_longCondÂ Â Â Â Â Â Â Â Â :=Â (Act_RFÂ Â Â Â Â Â ?Â (highÂ >Â hbandÂ andÂ upwardÂ >Â 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â JMA_longCond)
ADX_longCondÂ Â Â Â Â Â Â Â :=Â (Act_ADXÂ Â Â Â Â ?Â (DIPlusÂ >Â DIMinusÂ andÂ ADXÂ >Â th)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â RF_longCond)
SAR_longCondÂ Â Â Â Â Â Â Â :=Â (Act_SARÂ Â Â Â Â ?Â (SARÂ <Â close)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â ADX_longCond)
RSI_longCondÂ Â Â Â Â Â Â Â :=Â (Act_RSIÂ Â Â Â Â ?Â (RSI_VÂ >Â RSI_obos)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â SAR_longCond)
MACD_longCondÂ Â Â Â Â Â Â :=Â (Act_MACDÂ Â Â Â ?Â (histÂ >Â 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â RSI_longCond)
VOL_longCondÂ Â Â Â Â Â Â Â :=Â (Act_VolÂ Â Â Â Â ?Â (volumeÂ >Â sma(volume,sma_length)Â *Â volume_f)Â Â :Â MACD_longCond)
//Â â€”â€”â€”â€”â€”Â AllÂ indicatorsÂ withÂ shortÂ conditionsÂ andÂ enable/disableÂ option
JMA_shortCondÂ Â Â Â Â Â Â :=Â (Act_JMAÂ Â Â Â Â ?Â (JMA_Falling)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â VOL_shortCond)Â 
RF_shortCondÂ Â Â Â Â Â Â Â :=Â (Act_RFÂ Â Â Â Â Â ?Â (lowÂ <Â lbandÂ andÂ downwardÂ >Â 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â JMA_shortCond)
ADX_shortCondÂ Â Â Â Â Â Â :=Â (Act_ADXÂ Â Â Â Â ?Â (DIPlusÂ <Â DIMinusÂ andÂ ADXÂ >Â th)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â RF_shortCond)
SAR_shortCondÂ Â Â Â Â Â Â :=Â (Act_SARÂ Â Â Â Â ?Â (SARÂ >Â close)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â ADX_shortCond)
RSI_shortCondÂ Â Â Â Â Â Â :=Â (Act_RSIÂ Â Â Â Â ?Â (RSI_VÂ <Â RSI_obos)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â SAR_shortCond)
MACD_shortCondÂ Â Â Â Â Â :=Â (Act_MACDÂ Â Â Â ?Â (histÂ <Â 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â RSI_shortCond)
VOL_shortCondÂ Â Â Â Â Â Â :=Â (Act_VolÂ Â Â Â Â ?Â (volumeÂ >Â sma(volume,sma_length)Â *Â volume_f)Â Â :Â MACD_shortCond)
//Â â€”â€”â€”â€”â€”Â DefiningÂ long/shortÂ conditionÂ fromÂ indicatorsÂ +Â volume
longCondÂ Â Â Â Â Â Â Â Â Â Â Â :=Â JMA_longCondÂ Â andÂ RF_longCondÂ Â andÂ ADX_longCondÂ Â andÂ SAR_longCondÂ Â andÂ RSI_longCondÂ Â andÂ MACD_longCondÂ Â andÂ VOL_longCond
shortCondÂ Â Â Â Â Â Â Â Â Â Â :=Â JMA_shortCondÂ andÂ RF_shortCondÂ andÂ ADX_shortCondÂ andÂ SAR_shortCondÂ andÂ RSI_shortCondÂ andÂ MACD_shortCondÂ andÂ VOL_shortCond
//Â â€”â€”â€”â€”â€”Â AvoidingÂ confirmedÂ long/shortÂ simultaneity
CondIni_longÂ Â Â Â Â Â Â Â :=Â longCond[1]Â ?Â 1Â :Â shortCond[1]Â ?Â -1Â :Â nz(CondIni_long[1])
CondIni_shortÂ Â Â Â Â Â Â :=Â longCond[1]Â ?Â 1Â :Â shortCond[1]Â ?Â -1Â :Â nz(CondIni_short[1])
//Â â€”â€”â€”â€”â€”Â ConfirmedÂ long/shortÂ conditions
longConditionÂ Â Â Â Â Â Â =Â (longCond[1]Â Â andÂ nz(CondIni_long[1])Â Â ==Â -1)
shortConditionÂ Â Â Â Â Â =Â (shortCond[1]Â andÂ nz(CondIni_short[1])Â ==Â 1)
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â PositionÂ Price
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â LastÂ openedÂ long/shortÂ priceÂ onÂ unconfirmed/confirmedÂ conditions
last_open_longConditionÂ Â Â Â Â :=Â longConditionÂ Â orÂ Final_long_BB[1]Â Â ?Â close[1]Â :Â nz(last_open_longCondition[1])
last_open_shortConditionÂ Â Â Â :=Â shortConditionÂ orÂ Final_short_BB[1]Â ?Â close[1]Â :Â nz(last_open_shortCondition[1])
//Â â€”â€”â€”â€”â€”Â CheckÂ ifÂ yourÂ lastÂ positionÂ wasÂ aÂ confirmedÂ longÂ orÂ aÂ short
last_longConditionÂ Â Â Â Â Â Â Â Â Â :=Â longConditionÂ Â orÂ Final_long_BB[1]Â Â ?Â timeÂ :Â nz(last_longCondition[1])
last_shortConditionÂ Â Â Â Â Â Â Â Â :=Â shortConditionÂ orÂ Final_short_BB[1]Â ?Â timeÂ :Â nz(last_shortCondition[1])
in_longConditionÂ Â Â Â Â Â Â Â Â Â Â Â =Â last_longConditionÂ Â >Â last_shortCondition
in_shortConditionÂ Â Â Â Â Â Â Â Â Â Â =Â last_shortConditionÂ >Â last_longCondition
//Â â€”â€”â€”â€”â€”Â CheckÂ ifÂ yourÂ lastÂ positionÂ wasÂ aÂ confirmedÂ finalÂ longÂ orÂ shortÂ withoutÂ BB
last_Final_longConditionÂ Â Â Â :=Â longConditionÂ Â ?Â timeÂ :Â nz(last_Final_longCondition[1])
last_Final_shortConditionÂ Â Â :=Â shortConditionÂ ?Â timeÂ :Â nz(last_Final_shortCondition[1])
//Â â€”â€”â€”â€”â€”Â CountingÂ longÂ &Â shortÂ iterations
nLongsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â nz(nLongs[1])
nShortsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â nz(nShorts[1])
//Â â€”â€”â€”â€”â€”Â LongsÂ Counter
ifÂ longConditionÂ orÂ Final_long_BB
Â Â Â Â nLongsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â nLongsÂ +Â 1
Â Â Â Â nShortsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â 0
Â Â Â Â sum_longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â nz(last_open_longCondition)Â +Â nz(sum_long[1])
Â Â Â Â sum_shortÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â 0.0
Â Â Â Â 
//Â â€”â€”â€”â€”â€”Â ShortsÂ Counter
ifÂ shortConditionÂ orÂ Final_short_BB
Â Â Â Â nLongsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â 0
Â Â Â Â nShortsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â nShortsÂ +Â 1
Â Â Â Â sum_shortÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â nz(last_open_shortCondition)Â +Â nz(sum_short[1])
Â Â Â Â sum_longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â 0.0
//Â â€”â€”â€”â€”â€”Â CalculatingÂ andÂ PlottingÂ theÂ priceÂ average
Position_PriceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â nz(Position_Price[1])
Position_PriceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â :=Â longConditionÂ orÂ Final_long_BBÂ ?Â sum_long/nLongsÂ :Â shortConditionÂ orÂ Final_short_BBÂ ?Â sum_short/nShortsÂ :Â na
plot((nLongsÂ >Â 1)Â orÂ (nShortsÂ >Â 1)Â ?Â Position_PriceÂ :Â na,Â titleÂ =Â "AverageÂ Price",Â colorÂ =Â in_longConditionÂ ?Â color.aquaÂ :Â color.orange,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_cross)
Â Â Â Â 
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â TakeÂ Profit
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â TakeÂ ProfitÂ dividedÂ byÂ nÂ entries
tp_longÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â (Act_divideÂ andÂ (nLongsÂ Â >Â 1)Â ?Â tp_long0Â Â /Â nLongsÂ Â :Â tp_long0)Â Â /Â 100
tp_shortÂ Â Â Â Â Â Â Â Â Â Â Â =Â (Act_divideÂ andÂ (nShortsÂ >Â 1)Â ?Â tp_short0Â /Â nShortsÂ :Â tp_short0)Â /Â 100
//Â â€”â€”â€”â€”â€”Â FirstÂ TPÂ Conditions
long_tpÂ Â Â Â Â Â Â Â Â Â Â Â Â :=Â highÂ >Â (fixnan(Position_Price)Â *Â (1Â +Â tp_long))Â Â andÂ in_longCondition
short_tpÂ Â Â Â Â Â Â Â Â Â Â Â :=Â lowÂ Â <Â (fixnan(Position_Price)Â *Â (1Â -Â tp_short))Â andÂ in_shortCondition
//Â â€”â€”â€”â€”â€”Â GetÂ theÂ timeÂ ofÂ theÂ lastÂ tpÂ close
last_long_tpÂ Â Â Â Â Â Â Â :=Â long_tpÂ Â ?Â timeÂ :Â nz(last_long_tp[1])
last_short_tpÂ Â Â Â Â Â Â :=Â short_tpÂ ?Â timeÂ :Â nz(last_short_tp[1])
//Â â€”â€”â€”â€”â€”Â FinalÂ TakeÂ profitÂ conditionÂ (neverÂ afterÂ theÂ stopÂ loss)
Final_Long_tpÂ Â Â Â Â Â Â :=Â (long_tpÂ Â andÂ last_longConditionÂ Â >Â nz(last_long_tp[1])Â Â andÂ last_longConditionÂ Â >Â nz(last_long_sl[1]))
Final_Short_tpÂ Â Â Â Â Â :=Â (short_tpÂ andÂ last_shortConditionÂ >Â nz(last_short_tp[1])Â andÂ last_shortConditionÂ >Â nz(last_short_sl[1]))
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â StopÂ Loss
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â StopÂ LossÂ ATRÂ calculation
ATR_SL_LongÂ Â Â Â Â Â Â Â Â =Â lowÂ Â -Â atr(atrPeriod)Â *Â multiplierPeriod
ATR_SL_ShortÂ Â Â Â Â Â Â Â =Â highÂ +Â atr(atrPeriod)Â *Â multiplierPeriod
longStopPrevÂ Â Â Â Â Â Â Â =Â nz(ATR_SL_Long[1],Â ATR_SL_Long)
shortStopPrevÂ Â Â Â Â Â Â =Â nz(ATR_SL_Short[1],Â ATR_SL_Short)
ATR_SL_LongÂ Â Â Â Â Â Â Â Â :=Â close[1]Â >Â longStopPrevÂ Â ?Â max(ATR_SL_Long,Â longStopPrev)Â Â Â :Â ATR_SL_Long
ATR_SL_ShortÂ Â Â Â Â Â Â Â :=Â close[1]Â <Â shortStopPrevÂ ?Â min(ATR_SL_Short,Â shortStopPrev)Â :Â ATR_SL_Short
//Â â€”â€”â€”â€”â€”Â CalculatingÂ SlÂ accordingÂ RiskÂ andÂ InitialÂ Capital
slÂ =Â in_longConditionÂ ?Â Â Â Â Â Â 
Â Â Â Â Â min(sl0,Â (((RiskÂ /Â (100Â /Â (strategy.equityÂ /Â close)))*100)Â /Â (quanTityÂ *Â max(1,Â last_dynamic_Leverage_long)Â Â *Â max(1,Â nLongs))))Â :Â 
Â Â Â Â Â min(sl0,Â (((RiskÂ /Â (100Â /Â (strategy.equityÂ /Â close)))*100)Â /Â (quanTityÂ *Â max(1,Â last_dynamic_Leverage_short)Â *Â max(1,Â nShorts))))
Â Â Â Â Â Â 
//Â â€”â€”â€”â€”â€”Â StopÂ LossÂ longÂ conditions
Normal_long_slÂ Â Â Â Â Â =Â Act_Conf_SLÂ ?Â Â ((SL_optionsÂ ==Â "NORMAL")Â ?Â ((Act_slÂ andÂ in_longConditionÂ Â andÂ closeÂ <=Â ((1Â -Â (slÂ /Â 100))Â *Â (fixnan(Position_Price)))))Â :Â na)Â :
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((SL_optionsÂ ==Â "NORMAL")Â ?Â ((Act_slÂ andÂ in_longConditionÂ Â andÂ lowÂ Â Â <=Â ((1Â -Â (slÂ /Â 100))Â *Â (fixnan(Position_Price)))))Â :Â na)
ATR_long_slÂ Â Â Â Â Â Â Â Â =Â Act_Conf_SLÂ ?Â Â ((SL_optionsÂ ==Â "ATR")Â ?Â Â Â Â ((Act_slÂ andÂ in_longConditionÂ Â andÂ closeÂ <=Â (ATR_SL_Long)))Â :Â na)Â :
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((SL_optionsÂ ==Â "ATR")Â ?Â Â Â Â ((Act_slÂ andÂ in_longConditionÂ Â andÂ lowÂ Â Â <=Â (ATR_SL_Long)))Â :Â na)
Both_long_slÂ Â Â Â Â Â Â Â =Â Act_Conf_SLÂ ?Â Â ((SL_optionsÂ ==Â "BOTH")Â ?Â Â Â ((Act_slÂ andÂ in_longConditionÂ Â andÂ closeÂ <=Â ((1Â -Â (slÂ /Â 100))Â *Â (fixnan(Position_Price))))Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((Act_slÂ andÂ in_longConditionÂ Â andÂ closeÂ <=Â (ATR_SL_Long))))Â :Â na)Â :
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((SL_optionsÂ ==Â "BOTH")Â ?Â Â Â ((Act_slÂ andÂ in_longConditionÂ Â andÂ lowÂ Â Â <=Â ((1Â -Â (slÂ /Â 100))Â *Â (fixnan(Position_Price))))Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((Act_slÂ andÂ in_longConditionÂ Â andÂ lowÂ Â Â <=Â (ATR_SL_Long))))Â :Â na)
//Â â€”â€”â€”â€”â€”Â StopÂ LossÂ shortÂ conditions
Normal_short_slÂ Â Â Â Â =Â Act_Conf_SLÂ ?Â Â ((SL_optionsÂ ==Â "NORMAL")Â ?Â ((Act_slÂ andÂ in_shortConditionÂ andÂ closeÂ >=Â ((1Â +Â (slÂ /Â 100))Â *Â (fixnan(Position_Price)))))Â :Â na)Â :
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((SL_optionsÂ ==Â "NORMAL")Â ?Â ((Act_slÂ andÂ in_shortConditionÂ andÂ highÂ Â >=Â ((1Â +Â (slÂ /Â 100))Â *Â (fixnan(Position_Price)))))Â :Â na)
ATR_short_slÂ Â Â Â Â Â Â Â =Â Act_Conf_SLÂ ?Â Â ((SL_optionsÂ ==Â "ATR")Â ?Â Â Â Â ((Act_slÂ andÂ in_shortConditionÂ andÂ closeÂ >=Â (ATR_SL_Short)))Â :Â na)Â :
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((SL_optionsÂ ==Â "ATR")Â ?Â Â Â Â ((Act_slÂ andÂ in_shortConditionÂ andÂ highÂ Â >=Â (ATR_SL_Short)))Â :Â na)
Both_short_slÂ Â Â Â Â Â Â =Â Act_Conf_SLÂ ?Â Â ((SL_optionsÂ ==Â "BOTH")Â ?Â Â Â ((Act_slÂ andÂ in_shortConditionÂ andÂ closeÂ >=Â ((1Â +Â (sl/100))Â *Â (fixnan(Position_Price))))Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((Act_slÂ andÂ in_shortConditionÂ andÂ closeÂ >=Â (ATR_SL_Short))))Â :Â na)Â :
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((SL_optionsÂ ==Â "BOTH")Â ?Â Â Â ((Act_slÂ andÂ in_shortConditionÂ andÂ highÂ Â >=Â ((1Â +Â (sl/100))Â *Â (fixnan(Position_Price))))Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ((Act_slÂ andÂ in_shortConditionÂ andÂ highÂ Â >=Â (ATR_SL_Short))))Â :Â na)
//Â â€”â€”â€”â€”â€”Â GetÂ theÂ timeÂ ofÂ theÂ lastÂ slÂ close
last_long_slÂ Â Â Â Â Â Â Â :=Â Normal_long_slÂ Â orÂ ATR_long_slÂ Â orÂ Both_long_slÂ Â ?Â timeÂ :Â nz(last_long_sl[1])
last_short_slÂ Â Â Â Â Â Â :=Â Normal_short_slÂ orÂ ATR_short_slÂ orÂ Both_short_slÂ ?Â timeÂ :Â nz(last_short_sl[1])
//Â â€”â€”â€”â€”â€”Â FinalÂ StopÂ LossÂ condition
Final_Long_slÂ Â Â Â Â Â Â :=Â (Normal_long_slÂ Â orÂ ATR_long_slÂ Â orÂ Both_long_sl)Â Â andÂ last_longConditionÂ Â >Â nz(last_long_sl[1])Â Â andÂ last_longConditionÂ Â >Â nz(last_long_tp[1])Â Â andÂ notÂ Final_Long_tp
Final_Short_slÂ Â Â Â Â Â :=Â (Normal_short_slÂ orÂ ATR_short_slÂ orÂ Both_short_sl)Â andÂ last_shortConditionÂ >Â nz(last_short_sl[1])Â andÂ last_shortConditionÂ >Â nz(last_short_tp[1])Â andÂ notÂ Final_Short_tp
//PlottinÂ ATRÂ SL
plot(Act_slÂ andÂ (SL_optionsÂ !=Â "NORMAL")Â ?Â in_longConditionÂ ?Â ATR_SL_Long[1]Â :Â ATR_SL_Short[1]Â :Â na,Â titleÂ =Â "ATRÂ SL",Â colorÂ =Â color.purple)
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â Â BollingerÂ BandsÂ Re-entry
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
BB_basisÂ Â Â Â Â Â Â Â Â Â Â Â =Â sma(src,Â BB_length)
BB_devÂ Â Â Â Â Â Â Â Â Â Â Â Â Â =Â BB_multÂ Â *Â stdev(src,Â BB_length)
BB_upperÂ Â Â Â Â Â Â Â Â Â Â Â =Â BB_basisÂ +Â BB_dev
BB_lowerÂ Â Â Â Â Â Â Â Â Â Â Â =Â BB_basisÂ -Â BB_dev
u_BBÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â plot(Act_BBÂ ?Â BB_upperÂ :Â na,Â Â titleÂ =Â "UpperÂ BollingerÂ Band",Â Â Â Â Â Â colorÂ =Â #009688,Â linewidthÂ =Â 2)
l_BBÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â =Â plot(Act_BBÂ ?Â BB_lowerÂ :Â na,Â Â titleÂ =Â "LowerÂ BollingerÂ Band",Â Â Â Â Â Â colorÂ =Â #f06292,Â linewidthÂ =Â 2)
fill(u_BB,Â l_BB,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â titleÂ =Â "BollingerÂ BandÂ Background",Â colorÂ =Â in_longConditionÂ ?Â #009688Â :Â #f06292,Â transpÂ =Â 95)
//Â â€”â€”â€”â€”â€”Â InitialÂ BollingerÂ BandsÂ conditions
BB_longÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â Act_BBÂ andÂ in_longConditionÂ Â andÂ notÂ (DIPlusÂ <Â DIMinusÂ andÂ ADXÂ >Â th)Â andÂ (closeÂ <=Â BB_lower)Â andÂ (closeÂ <Â last_open_longConditionÂ Â *Â (1Â -Â (bbBetterPriceÂ /Â 100)))
BB_shortÂ Â Â Â Â Â Â Â Â Â Â Â =Â Act_BBÂ andÂ in_shortConditionÂ andÂ notÂ (DIPlusÂ >Â DIMinusÂ andÂ ADXÂ >Â th)Â andÂ (closeÂ >=Â BB_upper)Â andÂ (closeÂ >Â last_open_shortConditionÂ *Â (1Â +Â (bbBetterPriceÂ /Â 100)))
//Â â€”â€”â€”â€”â€”Â GetÂ theÂ timeÂ ofÂ theÂ lastÂ BBÂ close
last_long_BBÂ Â Â Â Â Â Â Â :=Â BB_longÂ Â ?Â timeÂ :Â nz(last_long_BB[1])
last_short_BBÂ Â Â Â Â Â Â :=Â BB_shortÂ ?Â timeÂ :Â nz(last_short_BB[1])
//Â â€”â€”â€”â€”â€”Â FinalÂ BollingerÂ BandsÂ conditionÂ forÂ long
Final_long_BBÂ Â Â Â Â Â Â :=Â BB_longÂ andÂ last_Final_longConditionÂ >Â nz(last_long_BB[1])Â andÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â last_longConditionÂ >Â nz(last_long_tp[1])Â andÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â last_longConditionÂ >Â nz(last_long_sl[1])Â andÂ notÂ Final_Long_sl
//Â â€”â€”â€”â€”â€”Â FinalÂ BollingerÂ BandsÂ conditionÂ forÂ shortÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Final_short_BBÂ Â Â Â Â Â :=Â BB_shortÂ andÂ last_Final_shortConditionÂ >Â nz(last_short_BB[1])Â andÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â last_shortConditionÂ >Â nz(last_short_tp[1])Â andÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â last_shortConditionÂ >Â nz(last_short_sl[1])Â andÂ notÂ Final_Short_sl
//Â â€”â€”â€”â€”â€”Â FinalÂ confirmedÂ Re-entriesÂ onÂ longÂ &Â shortÂ conditions
Final_Long_BBÂ =Â Final_long_BB[1]
Final_Short_BBÂ =Â Final_short_BB[1]
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â Â SignalÂ Plotting
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â TPÂ LongÂ Levels
tplLevelÂ Â Â Â Â Â Â Â Â Â Â Â =Â (in_longConditionÂ andÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (last_longConditionÂ >Â nz(last_long_tp[1]))Â andÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (last_longConditionÂ >Â nz(last_long_sl[1]))Â andÂ notÂ Final_Long_sl[1])Â ?Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (nLongsÂ >Â 1)Â ?Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (fixnan(Position_Price)Â *Â (1Â +Â tp_long))Â :Â (last_open_longConditionÂ *Â (1Â +Â tp_long))Â :Â na
plot(tplLevel,Â Â Â Â Â Â Â Â Â Â Â Â titleÂ =Â "LongÂ TPÂ Level",Â Â Â Â Â Â Â styleÂ =Â plot.style_circles,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â colorÂ =Â color.lime,Â Â linewidthÂ =Â 2)
tpsLevelÂ Â Â Â Â Â Â Â Â Â Â Â =Â (in_shortConditionÂ andÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (last_shortConditionÂ >Â nz(last_short_tp[1]))Â andÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (last_shortConditionÂ >Â nz(last_short_sl[1]))Â andÂ notÂ Final_Short_sl[1])Â ?Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (nShortsÂ >Â 1)Â ?Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (fixnan(Position_Price)Â *Â (1Â -Â tp_short))Â :Â (last_open_shortConditionÂ *Â (1Â -Â tp_short))Â :Â na
plot(tpsLevel,Â Â Â Â Â Â Â Â Â Â Â Â titleÂ =Â "ShortÂ TPÂ Level",Â Â Â Â Â Â styleÂ =Â plot.style_circles,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â colorÂ =Â color.red,Â Â Â linewidthÂ =Â 2)
//Â â€”â€”â€”â€”â€”Â Weekend
W_colorÂ Â Â Â Â Â Â Â Â Â Â Â Â =Â (dayofweekÂ ==Â dayofweek.sundayÂ orÂ dayofweekÂ ==Â dayofweek.saturday)Â ?Â color.whiteÂ :Â na
bgcolor(W_color,Â Â Â Â Â Â Â Â Â Â titleÂ =Â "Weekend",Â Â Â Â transpÂ =Â 95)
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â Â Re-entryÂ Conditions
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â Re-entryÂ onÂ longÂ afterÂ tp,Â slÂ orÂ Xlong
ifÂ Final_Long_tpÂ orÂ Final_Long_sl
Â Â Â Â CondIni_longÂ Â Â Â :=Â -1
Â Â Â Â sum_longÂ Â Â Â Â Â Â Â :=Â 0.0
Â Â Â Â nLongsÂ Â Â Â Â Â Â Â Â Â :=Â na
Â Â Â Â 
//Â â€”â€”â€”â€”â€”Â Re-entryÂ onÂ shortÂ afterÂ tp,Â slÂ orÂ Xshort
ifÂ Final_Short_tpÂ orÂ Final_Short_sl
Â Â Â Â CondIni_shortÂ Â Â :=Â 1
Â Â Â Â sum_shortÂ Â Â Â Â Â Â :=Â 0.0
Â Â Â Â nShortsÂ Â Â Â Â Â Â Â Â :=Â na
Â Â Â Â 
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â Â Backtest
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”Â DefiningÂ newÂ finalÂ unconfirmedÂ longÂ conditions
_longConditionÂ Â Â Â Â Â =Â (longCondÂ andÂ notÂ in_longCondition)Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (longCondÂ andÂ Final_Long_tp)Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (longCondÂ andÂ Final_Long_sl)Â or
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (longCondÂ andÂ notÂ longConditionÂ andÂ (last_long_tpÂ >=Â nz(last_longCondition)))Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (longCondÂ andÂ notÂ longConditionÂ andÂ (last_long_slÂ >=Â nz(last_longCondition)))
Â Â Â 
//Â â€”â€”â€”â€”â€”Â DefiningÂ newÂ finalÂ unconfirmedÂ shortÂ conditions
_shortConditionÂ Â Â Â Â =Â (shortCondÂ andÂ notÂ in_shortCondition)Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (shortCondÂ andÂ Final_Short_tp)Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (shortCondÂ andÂ Final_Short_sl)Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (shortCondÂ andÂ notÂ shortConditionÂ andÂ (last_short_tpÂ >=Â nz(last_shortCondition)))Â orÂ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (shortCondÂ andÂ notÂ shortConditionÂ andÂ (last_short_slÂ >=Â nz(last_shortCondition)))
//Â â€”â€”â€”â€”â€”Â TestÂ periodÂ declaration
testPeriodÂ =Â timeÂ >=Â timenowÂ -Â backtest_time
//Â â€”â€”â€”â€”â€”Â VolumeÂ FactorÂ forÂ determineÂ quantities
Volume_Factor_LeverageÂ Â Â Â Â Â =Â min(Max_Lev,Â max(1,Â round(volumeÂ /Â sma(volume,Â sma_length))))
last_dynamic_Leverage_longÂ Â :=Â _longConditionÂ ?Â Volume_Factor_LeverageÂ Â :Â nz(last_dynamic_Leverage_long[1])
last_dynamic_Leverage_shortÂ :=Â _shortConditionÂ ?Â Volume_Factor_LeverageÂ :Â nz(last_dynamic_Leverage_short[1])
//Â â€”â€”â€”â€”â€”Â EnteringÂ longÂ positions
ifÂ (_longCondition)
Â Â Â Â strategy.entry("long",Â strategy.long,Â qtyÂ =Â Volume_Factor_LeverageÂ *Â quanTity,Â whenÂ =Â Act_BTÂ andÂ testPeriod)
ifÂ (Final_long_BB)
Â Â Â Â strategy.entry("long",Â strategy.long,Â qtyÂ =Â last_dynamic_Leverage_longÂ *Â quanTity,Â whenÂ =Â Act_BTÂ andÂ testPeriod)
Â Â Â 
//Â â€”â€”â€”â€”â€”Â EnteringÂ shortÂ positions
ifÂ (_shortCondition)Â 
Â Â Â Â strategy.entry("short",Â strategy.short,Â qtyÂ =Â Volume_Factor_LeverageÂ *Â quanTity,Â whenÂ =Â Act_BTÂ andÂ testPeriod)
ifÂ (Final_short_BB)Â 
Â Â Â Â strategy.entry("short",Â strategy.short,Â qtyÂ =Â last_dynamic_Leverage_shortÂ *Â quanTity,Â whenÂ =Â Act_BTÂ andÂ testPeriod)
//Â â€”â€”â€”â€”â€”Â ClosingÂ positionsÂ withÂ firstÂ longÂ TP
strategy.exit("Tpl",Â "long",Â 
Â Â Â profitÂ Â Â =Â (abs((last_open_longConditionÂ Â *Â (1Â +Â tp_long))Â -Â last_open_longCondition)Â /Â syminfo.mintick),Â 
Â Â Â limitÂ Â Â Â =Â nLongsÂ >=Â 1Â ?Â strategy.position_avg_priceÂ *Â (1Â +Â tp_long)Â :Â na,
Â Â Â lossÂ Â Â Â Â =Â Act_Conf_SLÂ ==Â falseÂ ?Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (iff(Act_slÂ andÂ (SL_optionsÂ ==Â "NORMAL"),Â (abs((last_open_longCondition*(1-(sl/100)))-last_open_longCondition)/syminfo.mintick),Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "ATR"),Â (abs(ATR_SL_Long-last_open_longCondition)/syminfo.mintick),Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "BOTH")Â andÂ ((abs((last_open_longCondition*(1-(sl/100)))-last_open_longCondition)/syminfo.mintick)Â <Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (abs(ATR_SL_Long-last_open_longCondition)/syminfo.mintick)),Â (abs((last_open_longCondition*(1-(sl/100)))-last_open_longCondition)/syminfo.mintick),
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "BOTH")Â andÂ ((abs((last_open_longCondition*(1-(sl/100)))-last_open_longCondition)/syminfo.mintick)Â >Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (abs(ATR_SL_Long-last_open_longCondition)/syminfo.mintick)),Â (abs(ATR_SL_Long-last_open_longCondition)/syminfo.mintick),Â na)))))Â :Â na,
Â Â Â stopÂ Â Â Â Â =Â Act_Conf_SLÂ ==Â falseÂ andÂ nLongsÂ >=Â 1Â ?Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (iff(Act_slÂ andÂ (SL_optionsÂ ==Â "NORMAL"),Â ((1-(sl/100))*strategy.position_avg_price),
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "ATR"),Â ATR_SL_Long,Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "BOTH")Â andÂ (((1-(sl/100))*strategy.position_avg_price)Â >Â ATR_SL_Long),Â ((1-(sl/100))*strategy.position_avg_price),Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "BOTH")Â andÂ (((1-(sl/100))*strategy.position_avg_price)Â <Â ATR_SL_Long),Â ATR_SL_Long,Â na)))))Â :Â na)
//Â CancelingÂ longÂ exitÂ ordersÂ toÂ avoidÂ simultaneityÂ withÂ re-entry
strategy.cancel("Tpl",Â whenÂ =Â Final_long_BB)
//Â â€”â€”â€”â€”â€”Â ClosingÂ positionsÂ withÂ firstÂ shortÂ TP
strategy.exit("Tps",Â "short",
Â Â Â profitÂ Â Â =Â (abs((last_open_shortConditionÂ *Â (1Â -Â tp_short))Â -Â last_open_shortCondition)Â /Â syminfo.mintick),Â 
Â Â Â limitÂ Â Â Â =Â nShortsÂ >=Â 1Â ?Â strategy.position_avg_price*(1-(tp_short))Â :Â na,
Â Â Â lossÂ Â Â Â Â =Â Act_Conf_SLÂ ==Â falseÂ ?Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (iff(Act_slÂ andÂ (SL_optionsÂ ==Â "NORMAL"),Â (abs((last_open_shortCondition*(1+(sl/100)))-last_open_shortCondition)/syminfo.mintick),Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "ATR"),Â (abs(ATR_SL_Short-last_open_shortCondition)/syminfo.mintick),Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "BOTH")Â andÂ ((abs((last_open_shortCondition*(1+(sl/100)))-last_open_shortCondition)/syminfo.mintick)Â <Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (abs(ATR_SL_Short-last_open_shortCondition)/syminfo.mintick)),Â (abs((last_open_shortCondition*(1+(sl/100)))-last_open_shortCondition)/syminfo.mintick),
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "BOTH")Â andÂ ((abs((last_open_shortCondition*(1+(sl/100)))-last_open_shortCondition)/syminfo.mintick)Â >Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (abs(ATR_SL_Short-last_open_shortCondition)/syminfo.mintick)),Â (abs(ATR_SL_Short-last_open_shortCondition)/syminfo.mintick),Â na)))))Â :Â na,
Â Â Â stopÂ Â Â Â Â =Â Act_Conf_SLÂ ==Â falseÂ andÂ nShortsÂ >=Â 1Â ?Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (iff(Act_slÂ andÂ (SL_optionsÂ ==Â "NORMAL"),Â ((1+(sl/100))*strategy.position_avg_price),
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "ATR"),Â ATR_SL_Short,Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "BOTH")Â andÂ (((1+(sl/100))*strategy.position_avg_price)Â <Â ATR_SL_Short),Â ((1+(sl/100))*strategy.position_avg_price),
Â Â Â Â Â Â Â Â Â Â Â Â Â iff(Act_slÂ Â andÂ (SL_optionsÂ ==Â "BOTH")Â andÂ (((1+(sl/100))*strategy.position_avg_price)Â >Â ATR_SL_Short),Â ATR_SL_Short,Â na)))))Â :Â na)
//Â CancelingÂ shortÂ exitÂ ordersÂ toÂ avoidÂ simultaneityÂ withÂ re-entry
strategy.cancel("Tps",Â whenÂ =Â Final_short_BB)
//Â â€”â€”â€”â€”â€”Â ClosingÂ allÂ positionsÂ withÂ Xlong/Xshort
strategy.close_all(whenÂ =Â (Final_Long_slÂ andÂ Act_Conf_SL)Â orÂ (Final_Short_slÂ andÂ Act_Conf_SL))
//Â --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------Â //
//Â â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Â Â byÂ Xaviz
Expand (598 lines)