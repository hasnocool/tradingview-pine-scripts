Script Name: Template Trailing Strategy
Author: jason5480
Description: This script is meant to be used as a generic template for new strategies. Take Profit, Stop Loss logic is provided out of the box with (or without) their trailing variations while the trailing for entry and exit orders can also be enabled and be configured!
Custom quantity risk management is provided along with the ability to set custom signal messages that can be...
PineScript code:

Pine Scriptâ„¢ strategy
Template Trailing Strategy
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788
789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823
824
825
826
827
828
829
830
831
832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847
848
849
850
851
852
853
854
855
856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892
893
894
895
896
897
898
899
900
901
902
903
904
905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930
931
932
933
934
935
936
937
938
939
940
941
942
943
944
945
946
947
948
949
950
951
952
953
954
955
956
957
958
959
960
961
962
963
964
965
966
967
968
969
970
971
972
973
974
975
976
977
978
979
980
981
982
983
984
985
986
987
988
989
990
991
992
993
994
995
996
997
998
999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231
1232
1233
1234
1235
1236
1237
1238
1239
1240
1241
1242
1243
1244
1245
1246
1247
1248
1249
1250
1251
1252
1253
1254
1255
1256
1257
1258
1259
1260
1261
1262
1263
1264
1265
1266
1267
1268
1269
1270
1271
1272
1273
1274
1275
1276
1277
1278
1279
1280
1281
1282
1283
1284
1285
1286
1287
1288
1289
1290
1291
1292
1293
1294
1295
1296
1297
1298
1299
1300
1301
1302
1303
1304
1305
1306
1307
1308
1309
1310
1311
1312
1313
1314
1315
1316
1317
1318
1319
1320
1321
1322
1323
1324
1325
1326
1327
1328
1329
1330
1331
1332
1333
1334
1335
1336
1337
1338
1339
1340
1341
1342
1343
1344
1345
1346
1347
1348
1349
1350
1351
1352
1353
1354
1355
1356
1357
1358
1359
1360
1361
1362
1363
1364
1365
1366
1367
1368
1369
1370
1371
1372
1373
1374
1375
1376
1377
1378
1379
1380
1381
1382
1383
1384
1385
1386
1387
1388
1389
1390
1391
1392
1393
1394
1395
1396
1397
1398
1399
1400
1401
1402
1403
1404
1405
1406
1407
1408
1409
1410
1411
1412
1413
1414
1415
1416
1417
1418
1419
1420
1421
1422
1423
1424
1425
1426
1427
1428
1429
1430
1431
1432
1433
1434
1435
1436
1437
1438
1439
1440
1441
1442
1443
1444
1445
1446
1447
1448
1449
1450
1451
1452
1453
1454
1455
1456
1457
1458
1459
1460
1461
1462
1463
1464
1465
1466
1467
1468
1469
1470
1471
1472
1473
1474
1475
1476
1477
1478
1479
1480
1481
1482
1483
1484
1485
1486
1487
1488
1489
1490
1491
1492
1493
1494
1495
1496
1497
1498
1499
1500
1501
1502
1503
1504
1505
1506
1507
1508
1509
1510
1511
1512
1513
1514
1515
1516
1517
1518
1519
1520
1521
1522
1523
1524
1525
1526
1527
1528
1529
1530
1531
1532
1533
1534
1535
1536
1537
1538
1539
1540
1541
1542
1543
1544
1545
1546
1547
1548
1549
1550
1551
1552
1553
1554
1555
1556
1557
1558
1559
1560
1561
1562
1563
1564
1565
1566
1567
1568
1569
1570
1571
1572
1573
1574
1575
1576
1577
1578
1579
1580
1581
1582
1583
1584
1585
1586
1587
1588
1589
1590
1591
1592
1593
1594
1595
1596
1597
1598
1599
1600
1601
1602
1603
1604
1605
1606
1607
1608
1609
1610
1611
1612
1613
1614
1615
1616
1617
1618
1619
1620
1621
1622
1623
1624
1625
1626
1627
1628
1629
1630
1631
1632
1633
1634
1635
1636
1637
1638
1639
1640
1641
1642
1643
1644
1645
1646
1647
1648
1649
1650
1651
1652
1653
1654
1655
1656
1657
1658
1659
1660
1661
1662
1663
1664
1665
1666
1667
1668
1669
1670
1671
1672
1673
1674
1675
1676
1677
1678
1679
1680
1681
1682
1683
1684
1685
1686
1687
1688
1689
1690
1691
1692
1693
1694
1695
1696
1697
1698
1699
1700
1701
1702
1703
1704
1705
1706
1707
1708
1709
1710
1711
1712
1713
1714
1715
1716
1717
1718
1719
1720
1721
1722
1723
1724
1725
1726
1727
1728
1729
1730
1731
1732
1733
1734
1735
1736
1737
1738
1739
1740
1741
1742
1743
1744
1745
1746
1747
1748
1749
1750
1751
1752
1753
1754
1755
1756
1757
1758
1759
1760
1761
1762
1763
1764
1765
1766
1767
1768
1769
1770
1771
1772
1773
1774
1775
1776
1777
1778
1779
1780
1781
1782
1783
1784
1785
1786
1787
1788
1789
1790
1791
1792
1793
1794
1795
1796
1797
1798
1799
1800
1801
1802
1803
1804
1805
1806
1807
1808
1809
1810
1811
1812
1813
1814
1815
1816
1817
1818
1819
1820
1821
1822
1823
1824
1825
1826
1827
1828
1829
1830
1831
1832
1833
1834
1835
1836
1837
1838
1839
1840
1841
1842
1843
1844
1845
1846
1847
1848
1849
1850
1851
1852
1853
1854
1855
1856
1857
1858
1859
1860
1861
1862
1863
1864
1865
1866
1867
1868
1869
1870
1871
1872
1873
1874
1875
1876
1877
1878
1879
1880
1881
1882
1883
1884
1885
1886
1887
1888
1889
1890
1891
1892
1893
1894
1895
1896
1897
1898
1899
1900
1901
1902
1903
1904
1905
1906
1907
1908
1909
1910
1911
1912
1913
1914
1915
1916
1917
1918
1919
1920
1921
1922
1923
1924
1925
1926
1927
1928
1929
1930
1931
1932
1933
1934
1935
1936
1937
1938
1939
1940
1941
1942
1943
1944
1945
1946
1947
1948
1949
1950
1951
1952
1953
1954
1955
1956
1957
1958
1959
1960
1961
1962
1963
1964
1965
1966
1967
1968
1969
1970
1971
1972
1973
1974
1975
1976
1977
1978
1979
1980
1981
1982
1983
1984
1985
1986
1987
1988
1989
1990
1991
1992
1993
1994
1995
1996
1997
1998
1999
2000
2001
2002
2003
2004
2005
2006
2007
2008
2009
2010
2011
2012
2013
2014
2015
2016
2017
2018
2019
2020
2021
2022
2023
2024
2025
2026
2027
2028
2029
2030
2031
2032
2033
2034
2035
2036
2037
2038
2039
2040
2041
2042
2043
2044
2045
2046
2047
//@version=5
//#regionÂ PREAMBLE
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Â CopyrightÂ Â©Â 2022-2023Â IasonÂ NikolasÂ |Â jason5480
//Â Â TheÂ "TemplateÂ TrailingÂ Strategy"Â scriptÂ mayÂ beÂ freelyÂ distributedÂ underÂ theÂ MITÂ license.
//Â Â 
//Â Â PermissionÂ isÂ herebyÂ granted,Â freeÂ ofÂ charge,
//Â Â toÂ anyÂ personÂ obtainingÂ aÂ copyÂ ofÂ thisÂ softwareÂ andÂ associatedÂ documentationÂ filesÂ (theÂ "Software"),
//Â Â toÂ dealÂ inÂ theÂ SoftwareÂ withoutÂ restriction,Â includingÂ withoutÂ limitationÂ theÂ rightsÂ toÂ use,Â copy,Â modify,Â merge,
//Â Â publish,Â distribute,Â sublicense,Â and/orÂ sellÂ copiesÂ ofÂ theÂ Software,Â andÂ toÂ permitÂ personsÂ toÂ whomÂ theÂ Software
//Â Â isÂ furnishedÂ toÂ doÂ so,Â subjectÂ toÂ theÂ followingÂ conditions:
//Â Â 
//Â Â TheÂ aboveÂ copyrightÂ noticeÂ andÂ thisÂ permissionÂ noticeÂ shallÂ beÂ includedÂ inÂ ALLÂ COPIESÂ orÂ substantialÂ portionsÂ of
//Â Â theÂ Software.
//Â Â 
//Â Â THEÂ SOFTWAREÂ ISÂ PROVIDEDÂ "ASÂ IS",Â WITHOUTÂ WARRANTYÂ OFÂ ANYÂ KIND,Â EXPRESSÂ ORÂ IMPLIED,Â INCLUDINGÂ BUTÂ NOTÂ LIMITEDÂ TOÂ THE
//Â Â WARRANTIESÂ OFÂ MERCHANTABILITY,Â FITNESSÂ FORÂ AÂ PARTICULARÂ PURPOSEÂ ANDÂ NONINFRINGEMENT.Â INÂ NOÂ EVENTÂ SHALLÂ THEÂ AUTHORS
//Â Â ORÂ COPYRIGHTÂ HOLDERSÂ BEÂ LIABLEÂ FORÂ ANYÂ CLAIM,Â DAMAGESÂ ORÂ OTHERÂ LIABILITY,Â WHETHERÂ INÂ ANÂ ACTIONÂ OFÂ CONTRACT,Â TORT
//Â Â ORÂ OTHERWISE,Â ARISINGÂ FROM,Â OUTÂ OFÂ ORÂ INÂ CONNECTIONÂ WITHÂ THEÂ SOFTWAREÂ ORÂ THEÂ USEÂ ORÂ OTHERÂ DEALINGSÂ INÂ THEÂ SOFTWARE.
//Â Â 
//Â Â Description
//Â Â --------------------------------------------------------------------------------------------------------------------
//Â Â ThisÂ scriptÂ isÂ designedÂ toÂ beÂ usedÂ asÂ aÂ templateÂ forÂ buildingÂ newÂ strategies.
//Â Â TheÂ frameworkÂ providesÂ youÂ withÂ aÂ configurableÂ implementationÂ ofÂ theÂ entry,Â exit,
//Â Â stopÂ lossÂ andÂ takeÂ profitÂ trailingÂ logic.Â TheÂ proposedÂ wayÂ toÂ useÂ thatÂ script
//Â Â isÂ inÂ combinationÂ withÂ aÂ customizedÂ signalÂ indicatorÂ whereÂ youÂ implementedÂ your
//Â Â ownÂ logicÂ ofÂ startÂ andÂ endÂ dealÂ conditions.Â SeeÂ myÂ "TwoÂ MAÂ SignalÂ Indicator"
//Â Â andÂ "TemplateÂ SignalÂ Indicator"Â inÂ myÂ profileÂ forÂ more.Â AnotherÂ wayÂ toÂ utilize
//Â Â thisÂ scriptÂ (notÂ recommended)Â isÂ toÂ copyÂ itÂ andÂ replaceÂ theÂ startLongDeal,
//Â Â startShortDeal,Â endLongDeal,Â endShortDeal,Â andÂ optionallyÂ ifÂ youÂ useÂ limitÂ orÂ stop-
//Â Â limitÂ ordersÂ forÂ entry/exitÂ theÂ cnlStartLongDeal,Â cnlStartShortDeal,Â cnlEndtLongDeal,
//Â Â cnlEndtShortDealÂ variablesÂ inÂ theÂ STRATEGYÂ 1Â moduleÂ accordingÂ toÂ yourÂ needs!
//Â Â However,Â doingÂ thatÂ wayÂ youÂ willÂ haveÂ toÂ re-implementÂ yourÂ changesÂ everyÂ timeÂ I
//Â Â releaseÂ aÂ newÂ updateÂ ifÂ youÂ wantÂ toÂ haveÂ thoseÂ newÂ changesÂ IÂ madeÂ inÂ yourÂ script.
//Â Â 
//Â Â --------------------------------------------------------------------------------------------------------------------
//Â Â Disclaimer:
//Â Â Â Â 1.Â IÂ amÂ notÂ licensedÂ financialÂ advisorsÂ orÂ broker-dealer.Â IÂ doÂ notÂ tellÂ youÂ whenÂ orÂ whatÂ toÂ buyÂ orÂ sell.
//Â Â Â Â Â Â Â IÂ developedÂ thisÂ softwareÂ whichÂ enablesÂ youÂ executeÂ manualÂ orÂ automatedÂ tradesÂ usingÂ TradingView.
//Â Â Â Â Â Â Â TheÂ softwareÂ allowsÂ youÂ toÂ setÂ theÂ criteriaÂ youÂ wantÂ forÂ enteringÂ andÂ exitingÂ trades.
//Â Â Â Â 2.Â DoÂ notÂ tradeÂ withÂ moneyÂ youÂ cannotÂ affordÂ toÂ lose.
//Â Â Â Â 3.Â IÂ doÂ notÂ guaranteeÂ consistentÂ profitsÂ orÂ thatÂ anyoneÂ canÂ makeÂ moneyÂ withÂ noÂ effort.
//Â Â Â Â Â Â Â AndÂ IÂ amÂ notÂ sellingÂ theÂ holyÂ grail.
//Â Â Â Â 4.Â EveryÂ systemÂ canÂ haveÂ winningÂ andÂ losingÂ streaks.
//Â Â Â Â 5.Â MoneyÂ managementÂ playsÂ aÂ largeÂ roleÂ inÂ theÂ resultsÂ ofÂ yourÂ trading.Â ForÂ example:Â lotÂ size,Â accountÂ size,
//Â Â Â Â Â Â Â brokerÂ leverage,Â andÂ brokerÂ marginÂ callÂ rulesÂ allÂ affectÂ onÂ results.Â Also,Â yourÂ TakeÂ ProfitÂ andÂ StopÂ Loss
//Â Â Â Â Â Â Â settingsÂ forÂ individualÂ pairÂ tradesÂ andÂ forÂ overallÂ accountÂ equityÂ haveÂ aÂ majorÂ impactÂ onÂ results.
//Â Â Â Â Â Â Â IfÂ youÂ areÂ newÂ toÂ tradingÂ andÂ doÂ notÂ understandÂ theseÂ items,Â thenÂ IÂ recommendÂ youÂ seekÂ educationalÂ materials
//Â Â Â Â Â Â Â toÂ furtherÂ yourÂ knowledge.
//Â Â Â Â 
//Â Â YOUÂ NEEDÂ TOÂ FINDÂ ANDÂ USEÂ THEÂ TRADINGÂ SYSTEMÂ THATÂ WORKSÂ BESTÂ FORÂ YOUÂ ANDÂ YOURÂ TRADINGÂ TOLERANCE.
//Â Â IÂ HAVEÂ PROVIDEDÂ NOTHINGÂ MOREÂ THANÂ AÂ TOOLÂ WITHÂ OPTIONSÂ FORÂ YOUÂ TOÂ TRADEÂ WITHÂ THISÂ PROGRAMÂ ONÂ TRADINGVIEW.
//Â Â 
//Â Â IÂ acceptÂ suggestionsÂ toÂ improveÂ theÂ script!Â ForÂ anyÂ changeÂ proposalÂ toÂ theÂ existingÂ functionality,
//Â Â anyÂ additionalÂ featureÂ youÂ haveÂ inÂ mind,Â orÂ evenÂ reportingÂ aÂ defectÂ (bug)Â youÂ found,Â youÂ shouldÂ writeÂ it
//Â Â downÂ hereÂ docs.google.com/spreadsheets/d/1xwpr2Ut4CmMX6kX9PxflWuvb4mZ6LFKJ1Y6C7LahQ5o/edit?usp=sharing
//Â Â andÂ letÂ meÂ knowÂ byÂ sendingÂ meÂ aÂ privateÂ messageÂ onÂ TradingView.
//Â Â IfÂ youÂ encounterÂ anyÂ problems,Â IÂ willÂ beÂ happyÂ toÂ shareÂ themÂ withÂ me.
//Â Â --------------------------------------------------------------------------------------------------------------------
//#endregionÂ ===========================================================================================================
//#regionÂ SETUP
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
strategy(titleÂ =Â 'TemplateÂ TrailingÂ Strategy',
Â Â Â Â Â Â Â Â Â shorttitleÂ =Â 'TTSv47',
Â Â Â Â Â Â Â Â Â overlayÂ =Â true,
Â Â Â Â Â Â Â Â Â pyramidingÂ =Â 0,
Â Â Â Â Â Â Â Â Â backtest_fill_limits_assumptionÂ =Â 1,
Â Â Â Â Â Â Â Â Â default_qty_typeÂ =Â strategy.percent_of_equity,
Â Â Â Â Â Â Â Â Â default_qty_valueÂ =Â 100,
Â Â Â Â Â Â Â Â Â initial_capitalÂ =Â 100000,
Â Â Â Â Â Â Â Â Â slippageÂ =Â 3,
Â Â Â Â Â Â Â Â Â commission_typeÂ =Â strategy.commission.percent,
Â Â Â Â Â Â Â Â Â commission_valueÂ =Â 0.1,
Â Â Â Â Â Â Â Â Â close_entries_ruleÂ =Â 'ANY',
Â Â Â Â Â Â Â Â Â max_lines_countÂ =Â 500,
Â Â Â Â Â Â Â Â Â max_labels_countÂ =Â 500)
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ“†Â FILTERS
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ filteringÂ outÂ longÂ andÂ shortÂ openÂ signalsÂ thatÂ doÂ notÂ meetÂ userÂ definedÂ rules
//Â Dependencies:Â NONE
//Â Results:Â longFiltersApproval,Â shortFiltersApproval
importÂ jason5480/time_filters/9Â asÂ tif
//Â INPUTÂ ===============================================================================================================
sourceTimezoneÂ =Â input.string(defvalÂ =Â 'Exchange',Â titleÂ =Â 'TimezonesÂ Src->Dst',Â optionsÂ =Â ['Exchange',Â 'UTC',Â 'America/Los_Angeles',Â 'America/Phoenix',Â 'America/Vancouver',Â 'America/El_Salvador',Â 'America/Bogota',Â 'America/Chicago',Â 'America/New_York',Â 'America/Toronto',Â 'America/Argentina/Buenos_Aires',Â 'America/Sao_Paulo',Â 'Etc/UTC',Â 'Europe/London',Â 'Europe/Berlin',Â 'Europe/Madrid',Â 'Europe/Paris',Â 'Europe/Warsaw',Â 'Europe/Athens',Â 'Europe/Moscow',Â 'Asia/Tehran',Â 'Asia/Dubai',Â 'Asia/Ashkhabad',Â 'Asia/Kolkata',Â 'Asia/Almaty',Â 'Asia/Bangkok',Â 'Asia/Hong_Kong',Â 'Asia/Shanghai',Â 'Asia/Singapore',Â 'Asia/Taipei',Â 'Asia/Seoul',Â 'Asia/Tokyo',Â 'Australia/ACT',Â 'Australia/Adelaide',Â 'Australia/Brisbane',Â 'Australia/Sydney',Â 'Pacific/Auckland',Â 'Pacific/Fakaofo',Â 'Pacific/Chatham',Â 'Pacific/Honolulu'],Â inlineÂ =Â 'Timezone',Â groupÂ =Â 'ğŸ“†Â Filters')
destinationTimezoneÂ =Â input.string(defvalÂ =Â 'Exchange',Â titleÂ =Â '->',Â optionsÂ =Â ['Exchange',Â 'UTC',Â 'America/Los_Angeles',Â 'America/Phoenix',Â 'America/Vancouver',Â 'America/El_Salvador',Â 'America/Bogota',Â 'America/Chicago',Â 'America/New_York',Â 'America/Toronto',Â 'America/Argentina/Buenos_Aires',Â 'America/Sao_Paulo',Â 'Etc/UTC',Â 'Europe/London',Â 'Europe/Berlin',Â 'Europe/Madrid',Â 'Europe/Paris',Â 'Europe/Warsaw',Â 'Europe/Athens',Â 'Europe/Moscow',Â 'Asia/Tehran',Â 'Asia/Dubai',Â 'Asia/Ashkhabad',Â 'Asia/Kolkata',Â 'Asia/Almaty',Â 'Asia/Bangkok',Â 'Asia/Hong_Kong',Â 'Asia/Shanghai',Â 'Asia/Singapore',Â 'Asia/Taipei',Â 'Asia/Seoul',Â 'Asia/Tokyo',Â 'Australia/ACT',Â 'Australia/Adelaide',Â 'Australia/Brisbane',Â 'Australia/Sydney',Â 'Pacific/Auckland',Â 'Pacific/Fakaofo',Â 'Pacific/Chatham',Â 'Pacific/Honolulu'],Â tooltipÂ =Â 'TheÂ SrcÂ isÂ theÂ sourceÂ timezoneÂ toÂ beÂ usedÂ asÂ aÂ referenceÂ forÂ theÂ timeÂ settings.Â TheÂ DstÂ isÂ theÂ destinationÂ timezoneÂ toÂ convertÂ intoÂ (e.g.Â theÂ charts\'Â timezone)',Â inlineÂ =Â 'Timezone',Â groupÂ =Â 'ğŸ“†Â Filters')
varÂ dateTimeWindowÂ =Â tif.DateTimeWindow.new(
Â Â fromDateTimeÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'From',Â inlineÂ =Â 'FromÂ Date',Â groupÂ =Â 'ğŸ“†Â Filters')Â ?Â input.time(defvalÂ =Â timestamp('01Â JanÂ 2022Â 00:00'),Â titleÂ =Â 'â€‹',Â inlineÂ =Â 'FromÂ Date',Â groupÂ =Â 'ğŸ“†Â Filters')Â :Â na,
Â Â toDateTimeÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'Toâ€ƒ',Â inlineÂ =Â 'ToÂ Date',Â groupÂ =Â 'ğŸ“†Â Filters')Â ?Â input.time(defvalÂ =Â timestamp('01Â JanÂ 2023Â 00:00'),Â titleÂ =Â 'â€‹â€‹',Â inlineÂ =Â 'ToÂ Date',Â groupÂ =Â 'ğŸ“†Â Filters')Â :Â na)
varÂ marketSessionÂ =Â tif.MarketSession.new(Â 
Â Â daysÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'SessionÂ Days',Â inlineÂ =Â 'SessionÂ Days',Â groupÂ =Â 'ğŸ“†Â Filters')Â ?Â tif.SessionDays.new(
Â Â Â Â Â Â monÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'Mon',Â inlineÂ =Â 'SessionÂ Days',Â groupÂ =Â 'ğŸ“†Â Filters'),
Â Â Â Â Â Â tueÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'Tue',Â inlineÂ =Â 'SessionÂ Days',Â groupÂ =Â 'ğŸ“†Â Filters'),
Â Â Â Â Â Â wedÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'Wed',Â inlineÂ =Â 'SessionÂ Days',Â groupÂ =Â 'ğŸ“†Â Filters'),
Â Â Â Â Â Â thuÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'Thu',Â inlineÂ =Â 'SessionÂ Days',Â groupÂ =Â 'ğŸ“†Â Filters'),
Â Â Â Â Â Â friÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'Fri',Â inlineÂ =Â 'SessionÂ Days',Â groupÂ =Â 'ğŸ“†Â Filters'),
Â Â Â Â Â Â satÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'Sat',Â inlineÂ =Â 'SessionÂ Days',Â groupÂ =Â 'ğŸ“†Â Filters'),
Â Â Â Â Â Â sunÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'Sun',Â inlineÂ =Â 'SessionÂ Days',Â groupÂ =Â 'ğŸ“†Â Filters'))Â :Â na,
Â Â startTimeÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'SessionÂ Start',Â inlineÂ =Â 'SessionÂ Start',Â groupÂ =Â 'ğŸ“†Â Filters')Â ?Â tif.SessionTime.new(
Â Â Â Â Â Â hourInDayÂ =Â input.int(defvalÂ =Â 12,Â titleÂ =Â 'â€‹â€‹â€‹',Â minvalÂ =Â 0,Â maxvalÂ =Â 23,Â stepÂ =Â 1,Â inlineÂ =Â 'SessionÂ Start',Â groupÂ =Â 'ğŸ“†Â Filters'),
Â Â Â Â Â Â minuteInHourÂ =Â input.int(defvalÂ =Â 00,Â titleÂ =Â ':â€‹',Â minvalÂ =Â 0,Â maxvalÂ =Â 59,Â stepÂ =Â 1,Â tooltipÂ =Â 'StartÂ timeÂ ofÂ theÂ session.',Â inlineÂ =Â 'SessionÂ Start',Â groupÂ =Â 'ğŸ“†Â Filters'))Â :Â na,
Â Â endTimeÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'SessionÂ End',Â inlineÂ =Â 'SessionÂ End',Â groupÂ =Â 'ğŸ“†Â Filters')Â ?Â tif.SessionTime.new(
Â Â Â Â Â Â hourInDayÂ =Â input.int(defvalÂ =Â 20,Â titleÂ =Â 'â€‹â€‹â€‹â€‹',Â minvalÂ =Â 0,Â maxvalÂ =Â 23,Â stepÂ =Â 1,Â inlineÂ =Â 'SessionÂ End',Â groupÂ =Â 'ğŸ“†Â Filters'),
Â Â Â Â Â Â minuteInHourÂ =Â input.int(defvalÂ =Â 00,Â titleÂ =Â ':â€‹â€‹',Â minvalÂ =Â 0,Â maxvalÂ =Â 59,Â stepÂ =Â 1,Â tooltipÂ =Â 'EndÂ timeÂ ofÂ theÂ session.',Â inlineÂ =Â 'SessionÂ End',Â groupÂ =Â 'ğŸ“†Â Filters'))Â :Â na)
//Â LOGICÂ ===============================================================================================================
boolÂ dateFilterApprovalÂ =Â dateTimeWindow.is_in_range(srcTimezoneÂ =Â sourceTimezone,Â dstTimezoneÂ =Â destinationTimezone)
boolÂ sessionFilterApprovalÂ =Â marketSession.is_in_range(srcTimezoneÂ =Â sourceTimezone,Â dstTimezoneÂ =Â destinationTimezone)
boolÂ timeFilterApprovalÂ =Â dateFilterApprovalÂ andÂ sessionFilterApproval
//Â PLOTÂ ================================================================================================================
bgcolor(colorÂ =Â timeFilterApprovalÂ ?Â naÂ :Â color.new(color.gray,Â 90),Â offsetÂ =Â 1,Â titleÂ =Â 'TimeÂ Window')
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ›¤ï¸Â TRACKÂ POSITION
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ general-purposeÂ variableÂ thatÂ neededÂ forÂ severalÂ otherÂ modules
//Â Dependencies:Â NONE
//Â Results:Â isLongPosition,Â isShortPosition,Â isFlatPosition,Â enteredLongTrade,Â enteredShortTrade,Â lastLongEntryBarIndex,Â lastShortEntryBarIndex,Â lastLongExitBarIndex,Â lastShortExitBarIndex,Â completedLongTrade,Â completedShortTrade
//Â LOGICÂ ===============================================================================================================
//Â numericÂ limits
varÂ floatÂ maxLimitFloatÂ =Â 999999.9
varÂ floatÂ minLimitFloatÂ =Â 0.0
varÂ intÂ maxLimitIntÂ =Â 999999
varÂ intÂ minLimitIntÂ =Â 0
//Â TheÂ currentÂ andÂ previousÂ positionÂ sizes
floatÂ currentPositionSizeÂ =Â strategy.opentrades.size(strategy.opentradesÂ -Â 1)
boolÂ isLongPositionÂ =Â currentPositionSizeÂ >Â 0
boolÂ isShortPositionÂ =Â currentPositionSizeÂ <Â 0
boolÂ isFlatPositionÂ =Â currentPositionSizeÂ ==Â 0
//Â fixedÂ orderÂ IdÂ names
varÂ stringÂ longOrderIdPrefixÂ =Â 'Long'
varÂ stringÂ shortOrderIdPrefixÂ =Â 'Short'
varÂ stringÂ entryOrderIdPostfixÂ =Â 'Entry'
varÂ stringÂ longOrderIdEntryÂ =Â str.format('{0}Â {1}',Â longOrderIdPrefix,Â entryOrderIdPostfix)
varÂ stringÂ shortOrderIdEntryÂ =Â str.format('{0}Â {1}',Â shortOrderIdPrefix,Â entryOrderIdPostfix)
varÂ stringÂ longOrderIdCloseÂ =Â str.format('CloseÂ entry(s)Â orderÂ {0}',Â longOrderIdEntry)
varÂ stringÂ shortOrderIdCloseÂ =Â str.format('CloseÂ entry(s)Â orderÂ {0}',Â shortOrderIdEntry)
varÂ stringÂ exitOrderIdPattern1Â =Â '{0}Â TakeÂ ProfitÂ {1,Â number,Â integer}Â /Â StopÂ LossÂ /Â LimitÂ Exit'
varÂ stringÂ exitOrderIdPattern2Â =Â '{0}Â StopÂ LossÂ /Â LimitÂ Exit'
//Â lastÂ exitÂ helperÂ functions
closedTradesExitId(intÂ n)Â =>
Â Â Â Â strategy.closedtrades.exit_id(strategy.closedtradesÂ -Â n)
closedTradeExitIdContains(simpleÂ stringÂ prefix,Â intÂ nÂ =Â 1)Â =>
Â Â Â Â strategy.closedtradesÂ >=Â nÂ ?Â str.contains(closedTradesExitId(n),Â prefix)Â :Â false
closedTradeExitIdIs(simpleÂ stringÂ exitId,Â intÂ nÂ =Â 1)Â =>
Â Â Â Â strategy.closedtradesÂ >=Â nÂ ?Â closedTradesExitId(n)Â ==Â exitIdÂ :Â false
closedTradesExitBarIndex(intÂ n)Â =>
Â Â Â Â strategy.closedtrades.exit_bar_index(strategy.closedtradesÂ -Â n)
closedTradesExitPrice(intÂ n)Â =>
Â Â Â Â strategy.closedtrades.exit_price(strategy.closedtradesÂ -Â n)
lastTwoClosedTradesExitedInTheSameBar()Â =>
Â Â Â Â strategy.closedtradesÂ >=Â 2Â ?Â closedTradesExitBarIndex(2)Â ==Â closedTradesExitBarIndex(1)Â :Â false
openTradeEntryIdStartsWith(simpleÂ stringÂ prefix,Â intÂ nÂ =Â 1)Â =>
Â Â Â Â str.startswith(strategy.opentrades.entry_id(strategy.opentradesÂ -Â n),Â prefix)
//Â lastÂ exitÂ barÂ idÂ andÂ price
varÂ intÂ lastLongExitBarIndexÂ =Â na
varÂ floatÂ lastLongExitPriceÂ =Â na
ifÂ ((closedTradeExitIdContains(longOrderIdPrefix)Â orÂ closedTradeExitIdIs(shortOrderIdEntry))Â andÂ notÂ isLongPosition)
Â Â Â Â lastLongExitBarIndexÂ :=Â closedTradesExitBarIndex(1)
Â Â Â Â lastLongExitPriceÂ :=Â closedTradesExitPrice(1)
elseÂ ifÂ ((closedTradeExitIdContains(longOrderIdPrefix,Â 2)Â orÂ closedTradeExitIdIs(shortOrderIdEntry,Â 2))Â andÂ lastTwoClosedTradesExitedInTheSameBar()Â andÂ notÂ isLongPosition)
Â Â Â Â lastLongExitBarIndexÂ :=Â closedTradesExitBarIndex(2)
Â Â Â Â lastLongExitPriceÂ :=Â closedTradesExitPrice(2)
varÂ intÂ lastShortExitBarIndexÂ =Â na
varÂ floatÂ lastShortExitPriceÂ =Â na
ifÂ ((closedTradeExitIdContains(shortOrderIdPrefix)Â orÂ closedTradeExitIdIs(longOrderIdEntry))Â andÂ notÂ isShortPosition)
Â Â Â Â lastShortExitBarIndexÂ :=Â closedTradesExitBarIndex(1)
Â Â Â Â lastShortExitPriceÂ :=Â closedTradesExitPrice(1)
elseÂ ifÂ ((closedTradeExitIdContains(shortOrderIdPrefix,Â 2)Â orÂ closedTradeExitIdIs(longOrderIdEntry,Â 2))Â andÂ lastTwoClosedTradesExitedInTheSameBar()Â andÂ notÂ isShortPosition)
Â Â Â Â lastShortExitBarIndexÂ :=Â closedTradesExitBarIndex(2)
Â Â Â Â lastShortExitPriceÂ :=Â closedTradesExitPrice(2)
//Â flagsÂ thatÂ areÂ trueÂ whenÂ alreadyÂ enteredÂ aÂ longÂ orÂ shortÂ trade
boolÂ enteredLongTradeÂ =Â strategy.opentradesÂ >Â 0Â ?Â bar_indexÂ ==Â strategy.opentrades.entry_bar_index(strategy.opentradesÂ -Â 1)Â andÂ openTradeEntryIdStartsWith(longOrderIdPrefix)Â :Â false
boolÂ enteredShortTradeÂ =Â strategy.opentradesÂ >Â 0Â ?Â bar_indexÂ ==Â strategy.opentrades.entry_bar_index(strategy.opentradesÂ -Â 1)Â andÂ openTradeEntryIdStartsWith(shortOrderIdPrefix)Â :Â false
//Â flagsÂ thatÂ areÂ trueÂ whenÂ completedÂ aÂ longÂ orÂ shortÂ trade
boolÂ completedLongTradeÂ =Â strategy.closedtradesÂ >Â 0Â ?Â bar_indexÂ ==Â lastLongExitBarIndexÂ :Â false
boolÂ completedShortTradeÂ =Â strategy.closedtradesÂ >Â 0Â ?Â bar_indexÂ ==Â lastShortExitBarIndexÂ :Â false
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ› ï¸Â STRATEGYÂ 1
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ openÂ positionÂ logic.Â ThisÂ isÂ implementedÂ basedÂ onÂ dealÂ conditionsÂ definedÂ internallyÂ (inÂ thisÂ script)Â orÂ externalyÂ (basedÂ onÂ conditionsÂ thatÂ takeÂ asÂ inputÂ otherÂ indicator)
//Â Dependencies:Â FILTERS,Â TRACKÂ POSITION
//Â Results:Â commissionRatio,Â openLongPosition,Â openShortPosition,Â cnlOpenLongPosition,Â cnlOpenShortPosition,Â endLongDeal,Â endShortDeal,Â cnlEndLongDeal,Â cnlEndShortDeal,Â validOpenLongPosition,Â validOpenShortPosition,Â validOpenPosition
importÂ jason5480/external_input_utils/6Â asÂ exiu
importÂ HeWhoMustNotBeNamed/ta/1Â asÂ eta
//Â INPUTÂ ===============================================================================================================
showOpenLabelsÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'Open',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
longOpenColorÂ =Â input.color(defvalÂ =Â color.new(#2962FF,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â OpenÂ ColorÂ Long/Shortâ€ƒâ€ƒâ€ƒâ€ƒ',Â inlineÂ =Â 'Open',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
shortOpenColorÂ =Â input.color(defvalÂ =Â color.new(#FF1744,Â 0),Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ openÂ long/shortÂ labels.',Â inlineÂ =Â 'Open',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
showCnlOpenLabelsÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'CancelÂ Open',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
longCnlOpenColorÂ =Â input.color(defvalÂ =Â color.new(#3179F5,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â CancelÂ OpenÂ ColorÂ Long/Shortâ€ƒ',Â inlineÂ =Â 'CancelÂ Open',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
shortCnlOpenColorÂ =Â input.color(defvalÂ =Â color.new(#F7525F,Â 0),Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ cancelÂ openÂ long/shortÂ labels.',Â inlineÂ =Â 'CancelÂ Open',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
showCloseLabelsÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'Close',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
longCloseColorÂ =Â input.color(defvalÂ =Â color.new(#D500F9,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â CloseÂ ColorÂ Long/Shortâ€ƒâ€ƒâ€ƒâ€ƒ',Â inlineÂ =Â 'Close',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
shortCloseColorÂ =Â input.color(defvalÂ =Â color.new(#D500F9,Â 0),Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ closeÂ long/shortÂ labels.',Â inlineÂ =Â 'Close',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
showCnlCloseLabelsÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'CancelÂ Close',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
longCnlCloseColorÂ =Â input.color(defvalÂ =Â color.new(#AB47BC,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â CancelÂ CloseÂ ColorÂ Long/Shortâ€ƒ',Â inlineÂ =Â 'CancelÂ Close',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
shortCnlCloseColorÂ =Â input.color(defvalÂ =Â color.new(#AB47BC,Â 0),Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ cancelÂ closeÂ long/shortÂ labels.',Â inlineÂ =Â 'CancelÂ Close',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
commissionRatioÂ =Â input.float(defvalÂ =Â 0.1,Â titleÂ =Â 'CommissionÂ %Â ğŸ›ˆâ¡',Â minvalÂ =Â 0.0,Â maxvalÂ =Â 100.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'FeesÂ paidÂ forÂ eachÂ transactionÂ entry,Â exit,Â takeÂ profitÂ andÂ stopÂ lossÂ (percentagewise).Â INFORMATION!Â ThisÂ valueÂ shouldÂ matchÂ theÂ commissionÂ valueÂ inÂ theÂ "Settings/Properties"Â tabÂ andÂ theÂ commissionÂ typeÂ shouldÂ beÂ setÂ toÂ "%"Â forÂ accurateÂ results.',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')Â /Â 100.0
dealModeÂ =Â input.string(defvalÂ =Â 'ğŸ”§Internal',Â titleÂ =Â 'DealÂ ConditionsÂ Mode',Â optionsÂ =Â ['ğŸ”¨External',Â 'ğŸ”§Internal'],Â tooltipÂ =Â 'UseÂ theÂ "Internal"Â MAÂ crossÂ over/underÂ logicÂ toÂ startÂ andÂ endÂ yourÂ deals.Â OrÂ useÂ anÂ "External"Â indicatorÂ toÂ constructÂ yourÂ ownÂ startÂ andÂ endÂ dealÂ conditions.',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
reverseOrdersEnabledÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'ReverseÂ Orders',Â tooltipÂ =Â 'EnableÂ reverseÂ orders.Â IfÂ youÂ areÂ alreadyÂ inÂ aÂ positionÂ whenÂ aÂ newÂ startÂ dealÂ conditionÂ isÂ metÂ andÂ itÂ isÂ pointingÂ outÂ toÂ theÂ otherÂ directionÂ then,Â ifÂ thisÂ settingÂ isÂ enabled,Â anÂ entryÂ signalÂ toÂ theÂ oppositeÂ directionÂ willÂ beÂ emittedÂ causingÂ theÂ existingÂ positionÂ toÂ exitÂ withÂ aÂ marketÂ orderÂ andÂ aÂ newÂ entryÂ willÂ beÂ placedÂ toÂ theÂ directionÂ ofÂ theÂ signalÂ accordingÂ toÂ theÂ "OrderÂ Type"Â thatÂ isÂ definedÂ inÂ theÂ ENTRYÂ section.Â IfÂ thisÂ settingÂ isÂ disabled,Â theÂ startÂ dealÂ conditionÂ willÂ beÂ ignoredÂ andÂ aÂ newÂ startÂ dealÂ conditionÂ willÂ beÂ neededÂ whenÂ youÂ areÂ notÂ inÂ aÂ position.',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
cooldownEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'CooldownÂ #Â ofÂ barsâ€ƒâ€ƒâ€ƒ',Â inlineÂ =Â 'Cooldown',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
cooldownBarsÂ =Â input.int(defvalÂ =Â 7,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'DoÂ NOTÂ emitÂ openÂ positionÂ signalÂ ifÂ noÂ moreÂ thanÂ theÂ givenÂ numberÂ ofÂ barsÂ haveÂ passedÂ sinceÂ theÂ previousÂ positionÂ exit.Â AÂ newÂ startÂ dealÂ conditionÂ hasÂ toÂ beÂ metÂ afterÂ thatÂ periodÂ toÂ openÂ aÂ newÂ position.',Â inlineÂ =Â 'Cooldown',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
externalInputÂ =Â input.source(defvalÂ =Â close,Â titleÂ =Â 'ExternalÂ InputÂ ğŸ›ˆâ¡',Â tooltipÂ =Â 'SelectÂ inputÂ fromÂ anÂ externalÂ indicator.Â INFORMATION!Â TheÂ indicatorÂ shouldÂ beÂ addedÂ toÂ theÂ sameÂ chartÂ withÂ thisÂ strategyÂ andÂ theÂ desiredÂ valueÂ thatÂ willÂ takeÂ partÂ inÂ theÂ conditionsÂ belowÂ shouldÂ beÂ plottedÂ inÂ theÂ chart.',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
startLongDealOperatorÂ =Â input.string(defvalÂ =Â '/10==',Â titleÂ =Â 'StartÂ LongÂ DealÂ whenÂ inputâ€ƒâ€ƒâ€ƒ',Â optionsÂ =Â ['==',Â '<',Â '>',Â '<=',Â '>=',Â '!=',Â 'crossover',Â 'crossunder',Â 'mod2==',Â 'mod3==',Â 'mod10==',Â 'mod100==',Â '/10==',Â 'noop'],Â inlineÂ =Â 'StartÂ LongÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
startLongDealValueÂ =Â input.float(defvalÂ =Â 2.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'ConditionÂ toÂ startÂ aÂ LongÂ DealÂ basedÂ onÂ externalÂ input.',Â inlineÂ =Â 'StartÂ LongÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
endLongDealOperatorÂ =Â input.string(defvalÂ =Â '/10==',Â titleÂ =Â 'EndÂ LongÂ DealÂ whenÂ inputâ€ƒâ€ƒâ€ƒâ€ƒ',Â optionsÂ =Â ['==',Â '<',Â '>',Â '<=',Â '>=',Â '!=',Â 'crossover',Â 'crossunder',Â 'mod2==',Â 'mod3==',Â 'mod10==',Â 'mod100==',Â '/10==',Â 'noop'],Â inlineÂ =Â 'EndÂ LongÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
endLongDealValueÂ =Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'ConditionÂ toÂ endÂ aÂ LongÂ DealÂ basedÂ onÂ externalÂ input.',Â inlineÂ =Â 'EndÂ LongÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
cnlStartLongDealOperatorÂ =Â input.string(defvalÂ =Â '/10==',Â titleÂ =Â 'CancelÂ StartÂ LongÂ DealÂ whenÂ input',Â optionsÂ =Â ['==',Â '<',Â '>',Â '<=',Â '>=',Â '!=',Â 'crossover',Â 'crossunder',Â 'mod2==',Â 'mod3==',Â 'mod10==',Â 'mod100==',Â '/10==',Â 'noop'],Â inlineÂ =Â 'CnlÂ StartÂ LongÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
cnlStartLongDealValueÂ =Â input.float(defvalÂ =Â 4.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'ConditionÂ toÂ cancelÂ theÂ startÂ LongÂ DealÂ ifÂ notÂ alreadyÂ enteredÂ theÂ positionÂ basedÂ onÂ externalÂ input.',Â inlineÂ =Â 'CnlÂ StartÂ LongÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
cnlEndLongDealOperatorÂ =Â input.string(defvalÂ =Â '/10==',Â titleÂ =Â 'CancelÂ EndÂ LongÂ DealÂ whenÂ inputâ€ƒ',Â optionsÂ =Â ['==',Â '<',Â '>',Â '<=',Â '>=',Â '!=',Â 'crossover',Â 'crossunder',Â 'mod2==',Â 'mod3==',Â 'mod10==',Â 'mod100==',Â '/10==',Â 'noop'],Â inlineÂ =Â 'CnlÂ EndÂ LongÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
cnlEndLongDealValueÂ =Â input.float(defvalÂ =Â 3.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'ConditionÂ toÂ cancelÂ theÂ endÂ LongÂ DealÂ ifÂ notÂ alreadyÂ exitedÂ theÂ positionÂ basedÂ onÂ externalÂ input.',Â inlineÂ =Â 'CnlÂ EndÂ LongÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
startShortDealOperatorÂ =Â input.string(defvalÂ =Â 'mod10==',Â titleÂ =Â 'StartÂ ShortÂ DealÂ whenÂ inputâ€ƒâ€ƒâ€ƒ',Â optionsÂ =Â ['==',Â '<',Â '>',Â '<=',Â '>=',Â '!=',Â 'crossover',Â 'crossunder',Â 'mod2==',Â 'mod3==',Â 'mod10==',Â 'mod100==',Â '/10==',Â 'noop'],Â inlineÂ =Â 'StartÂ ShortÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
startShortDealValueÂ =Â input.float(defvalÂ =Â 2.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'ConditionÂ toÂ startÂ aÂ ShortÂ DealÂ basedÂ onÂ externalÂ input.',Â inlineÂ =Â 'StartÂ ShortÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
endShortDealOperatorÂ =Â input.string(defvalÂ =Â 'mod10==',Â titleÂ =Â 'EndÂ ShortÂ DealÂ whenÂ inputâ€ƒâ€ƒâ€ƒâ€ƒ',Â optionsÂ =Â ['==',Â '<',Â '>',Â '<=',Â '>=',Â '!=',Â 'crossover',Â 'crossunder',Â 'mod2==',Â 'mod3==',Â 'mod10==',Â 'mod100==',Â '/10==',Â 'noop'],Â inlineÂ =Â 'EndÂ ShortÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
endShortDealValueÂ =Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'ConditionÂ toÂ endÂ aÂ ShortÂ DealÂ basedÂ onÂ externalÂ input.',Â inlineÂ =Â 'EndÂ ShortÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
cnlStartShortDealOperatorÂ =Â input.string(defvalÂ =Â 'mod10==',Â titleÂ =Â 'CancelÂ StartÂ ShortÂ DealÂ whenÂ input',Â optionsÂ =Â ['==',Â '<',Â '>',Â '<=',Â '>=',Â '!=',Â 'crossover',Â 'crossunder',Â 'mod2==',Â 'mod3==',Â 'mod10==',Â 'mod100==',Â '/10==',Â 'noop'],Â inlineÂ =Â 'CnlÂ StartÂ ShortÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
cnlStartShortDealValueÂ =Â input.float(defvalÂ =Â 4.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'ConditionÂ toÂ cancelÂ theÂ startÂ ShortÂ DealÂ ifÂ notÂ alreadyÂ enteredÂ theÂ positionÂ basedÂ onÂ externalÂ input.',Â inlineÂ =Â 'CnlÂ StartÂ ShortÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
cnlEndShortDealOperatorÂ =Â input.string(defvalÂ =Â 'mod10==',Â titleÂ =Â 'CancelÂ EndÂ ShortÂ DealÂ whenÂ inputâ€ƒ',Â optionsÂ =Â ['==',Â '<',Â '>',Â '<=',Â '>=',Â '!=',Â 'crossover',Â 'crossunder',Â 'mod2==',Â 'mod3==',Â 'mod10==',Â 'mod100==',Â '/10==',Â 'noop'],Â inlineÂ =Â 'CnlÂ EndÂ ShortÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
cnlEndShortDealValueÂ =Â input.float(defvalÂ =Â 3.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'ConditionÂ toÂ cancelÂ theÂ endÂ ShortÂ DealÂ ifÂ notÂ alreadyÂ exitedÂ theÂ positionÂ basedÂ onÂ externalÂ input.',Â inlineÂ =Â 'CnlÂ EndÂ ShortÂ Deal',Â groupÂ =Â 'ğŸ”¨Â StrategyÂ -Â External')
longDealsEnabledÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'LongÂ Deals',Â inlineÂ =Â 'Long/ShortÂ Deals',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
shortDealsEnabledÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'ShortÂ Deals',Â tooltipÂ =Â 'EnableÂ long/shortÂ start/end/cancelÂ deals.Â AnÂ openÂ signalÂ willÂ beÂ emittedÂ whenÂ theÂ long/shortÂ startÂ dealÂ conditionsÂ areÂ met.Â IfÂ thisÂ optionÂ isÂ uncheckedÂ youÂ willÂ notÂ enterÂ intoÂ long/shortÂ positions.',Â inlineÂ =Â 'Long/ShortÂ Deals',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
endDealsEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EndÂ Deals',Â tooltipÂ =Â 'EnableÂ endÂ deals.Â AÂ closeÂ signalÂ willÂ beÂ emittedÂ whenÂ theÂ endÂ dealÂ conditionsÂ areÂ met.Â IfÂ thisÂ optionÂ isÂ uncheckedÂ youÂ willÂ notÂ exitÂ yourÂ existingÂ positionÂ basedÂ onÂ theÂ strategyÂ logic.Â YouÂ willÂ exitÂ onlyÂ whenÂ theÂ stopÂ lossÂ orÂ theÂ takeÂ profitÂ targetsÂ areÂ reached.',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
cnlStartDealsEnabledÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'CancelÂ StartÂ Deals',Â inlineÂ =Â 'Start/EndÂ Deals',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
cnlEndDealsEnabledÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'CancelÂ EndÂ Deals',Â tooltipÂ =Â 'EnableÂ cancelÂ start/endÂ deals.Â AÂ cancelÂ start/closeÂ signalÂ willÂ beÂ emittedÂ whenÂ theÂ cancelÂ start/endÂ dealÂ conditionsÂ areÂ met.Â IfÂ thisÂ optionÂ isÂ uncheckedÂ youÂ willÂ notÂ cancelÂ yourÂ entry/exitÂ orderÂ basedÂ onÂ theÂ strategyÂ logicÂ whenÂ useÂ limit,Â stopÂ orÂ stop-limitÂ orders.',Â inlineÂ =Â 'Start/EndÂ Deals',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
emaFilterEnabledÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'EMAÂ Filter',Â tooltipÂ =Â 'EnableÂ long/shortÂ tradesÂ basedÂ onÂ EMA.',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
emaTimeframeÂ =Â input.timeframe(defvalÂ =Â '',Â titleÂ =Â 'â€ƒâ€ƒEMAÂ Res/Len/Src',Â inlineÂ =Â 'EMAÂ Filter',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
emaLengthÂ =Â input.int(defvalÂ =Â 200,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â inlineÂ =Â 'EMAÂ Filter',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
emaSrcÂ =Â exiu.str_to_src(input.string(defvalÂ =Â 'close',Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â optionsÂ =Â ['open',Â 'high',Â 'low',Â 'close',Â 'hl2',Â 'hlc3',Â 'ohlc4',Â 'hlcc4'],Â tooltipÂ =Â 'TheÂ timeframe,Â periodÂ andÂ sourceÂ forÂ theÂ EMAÂ calculation.',Â inlineÂ =Â 'EMAÂ Filter',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal'))
emaAtrBandEnabledÂ =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'EMAÂ ATRÂ Band',Â tooltipÂ =Â 'EnableÂ ATRÂ bandÂ forÂ EMAÂ filter.',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
filterAtrMulÂ =Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'â€ƒâ€ƒEMAÂ ATRÂ Mul/Len',Â minvalÂ =Â 0.1,Â stepÂ =Â 0.1,Â inlineÂ =Â 'EMAÂ ATR',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
filterAtrLengthÂ =Â input.int(defvalÂ =Â 5,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'ATRÂ multiplierÂ andÂ lengthÂ toÂ beÂ usedÂ forÂ theÂ ATRÂ calculationÂ thatÂ willÂ beÂ addedÂ onÂ topÂ ofÂ theÂ EMAÂ filter.',Â inlineÂ =Â 'EMAÂ ATR',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
adxFilterEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'ADXÂ Filter',Â tooltipÂ =Â 'EnableÂ long/shortÂ tradesÂ basedÂ onÂ ADX.',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
adxSmoothingÂ =Â input.int(defvalÂ =Â 14,Â titleÂ =Â 'â€ƒâ€ƒSmooth/DIÂ Len',Â minvalÂ =Â 1,Â inlineÂ =Â 'ADXÂ Filter',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
diLengthÂ =Â input.int(defvalÂ =Â 14,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'ADXÂ SmoothingÂ lengthÂ andÂ DirectionÂ Length.',Â inlineÂ =Â 'ADXÂ Filter',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
adxThresholdÂ =Â input.float(defvalÂ =Â 20.0,Â titleÂ =Â 'â€ƒâ€ƒThreshold',Â minvalÂ =Â 0.1,Â maxvalÂ =Â 100.0,Â stepÂ =Â 5.0,Â tooltipÂ =Â 'ADXÂ lowerÂ threshold.',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
fastMATypeÂ =Â str.lower(input.string(defvalÂ =Â 'SMA',Â titleÂ =Â 'FastÂ MAÂ Type/Len',Â optionsÂ =Â ['SMA',Â 'EMA',Â 'RMA',Â 'WMA',Â 'HMA',Â 'VWMA',Â 'SWMA',Â 'LINREG',Â 'MEDIAN'],Â inlineÂ =Â 'FastÂ MA',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal'))
fastMALenÂ =Â input.int(defvalÂ =Â 21,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ typeÂ andÂ theÂ lengthÂ ofÂ theÂ fastÂ MA.',Â inlineÂ =Â 'FastÂ MA',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')
slowMATypeÂ =Â str.lower(input.string(defvalÂ =Â 'SMA',Â titleÂ =Â 'SlowÂ MAÂ Type/Len',Â optionsÂ =Â ['SMA',Â 'EMA',Â 'RMA',Â 'WMA',Â 'HMA',Â 'VWMA',Â 'SWMA',Â 'LINREG',Â 'MEDIAN'],Â inlineÂ =Â 'SlowÂ MA',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal'))
slowMALenÂ =Â input.int(defvalÂ =Â 49,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ typeÂ andÂ theÂ lengthÂ ofÂ theÂ slowÂ MA.',Â inlineÂ =Â 'SlowÂ MA',Â groupÂ =Â 'ğŸ”§Â StrategyÂ -Â Internal')Â //Â LastÂ emptyÂ titleÂ 56
//Â LOGICÂ ===============================================================================================================
varÂ boolÂ startLongDealInternalÂ =Â false
varÂ boolÂ startShortDealInternalÂ =Â false
varÂ boolÂ endLongDealInternalÂ =Â false
varÂ boolÂ endShortDealInternalÂ =Â false
varÂ boolÂ cnlStartLongDealInternalÂ =Â false
varÂ boolÂ cnlStartShortDealInternalÂ =Â false
varÂ boolÂ cnlEndLongDealInternalÂ =Â false
varÂ boolÂ cnlEndShortDealInternalÂ =Â false
varÂ floatÂ fastMAÂ =Â na
varÂ floatÂ slowMAÂ =Â na
varÂ floatÂ emaUpperBandÂ =Â na
varÂ floatÂ emaLowerBandÂ =Â na
floatÂ emaLineÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â andÂ emaFilterEnabledÂ ?Â request.security(symbolÂ =Â syminfo.tickerid,Â timeframeÂ =Â emaTimeframe,Â expressionÂ =Â ta.ema(emaSrc,Â emaLength)[1])Â :Â na
ifÂ (dealModeÂ ==Â 'ğŸ”§Internal')
Â Â Â Â //Â TheÂ EMAÂ filter
Â Â Â Â varÂ boolÂ emaLongApprovalÂ =Â true
Â Â Â Â varÂ boolÂ emaShortApprovalÂ =Â true
Â Â Â Â ifÂ (emaFilterEnabled)
Â Â Â Â Â Â Â Â floatÂ emaAtrÂ =Â ta.atr(filterAtrLength)
Â Â Â Â Â Â Â Â emaUpperBandÂ :=Â emaLineÂ +Â filterAtrMulÂ *Â emaAtr
Â Â Â Â Â Â Â Â emaLowerBandÂ :=Â emaLineÂ -Â filterAtrMulÂ *Â emaAtr
Â Â Â Â Â Â Â Â floatÂ emaLongLineÂ =Â emaAtrBandEnabledÂ ?Â emaUpperBandÂ :Â emaLine
Â Â Â Â Â Â Â Â floatÂ emaShortLineÂ =Â emaAtrBandEnabledÂ ?Â emaLowerBandÂ :Â emaLine
Â Â Â Â Â Â Â Â emaLongApprovalÂ :=Â closeÂ >Â emaLongLineÂ andÂ openÂ >Â emaLongLine
Â Â Â Â Â Â Â Â emaShortApprovalÂ :=Â closeÂ <Â emaShortLineÂ andÂ openÂ <Â emaShortLine
Â Â Â Â 
Â Â Â Â //Â TheÂ ADXÂ filter
Â Â Â Â [_,Â _,Â adx]Â =Â ta.dmi(diLength,Â adxSmoothing)
Â Â Â Â boolÂ adxApprovalÂ =Â adxFilterEnabledÂ ?Â adxÂ >Â adxThresholdÂ :Â true
Â Â Â Â 
Â Â Â Â //Â TheÂ overallÂ filterÂ approvalsÂ forÂ eachÂ direction
Â Â Â Â boolÂ longFiltersApprovalÂ =Â emaLongApprovalÂ andÂ adxApproval
Â Â Â Â boolÂ shortFiltersApprovalÂ =Â emaShortApprovalÂ andÂ adxApproval
Â Â Â Â 
Â Â Â Â //Â TheÂ fastÂ andÂ slowÂ movingÂ averages
Â Â Â Â fastMAÂ :=Â eta.ma(close,Â fastMAType,Â fastMALen)
Â Â Â Â slowMAÂ :=Â eta.ma(close,Â slowMAType,Â slowMALen)
Â Â Â Â 
Â Â Â Â //Â ThenÂ mainÂ logicÂ forÂ startingÂ andÂ endingÂ dealsÂ isÂ basedÂ onÂ crossover/crossunderÂ conditions
Â Â Â Â boolÂ crossoverÂ =Â exiu.eval_cond(fastMA,Â 'crossover',Â slowMA)
Â Â Â Â boolÂ crossunderÂ =Â exiu.eval_cond(fastMA,Â 'crossunder',Â slowMA)
Â Â Â Â 
Â Â Â Â //Â TheÂ internalÂ startÂ endÂ cancelÂ signals.Â ThoseÂ shouldÂ matchÂ withÂ theÂ "TwoÂ MAÂ SignalÂ Indicator"Â dealÂ conditions
Â Â Â Â startLongDealInternalÂ :=Â longDealsEnabledÂ ?Â crossoverÂ andÂ longFiltersApprovalÂ :Â false
Â Â Â Â startShortDealInternalÂ :=Â shortDealsEnabledÂ ?Â crossunderÂ andÂ shortFiltersApprovalÂ :Â false
Â Â Â Â endLongDealInternalÂ :=Â endDealsEnabledÂ andÂ longDealsEnabledÂ ?Â crossunderÂ :Â false
Â Â Â Â endShortDealInternalÂ :=Â endDealsEnabledÂ andÂ shortDealsEnabledÂ ?Â crossoverÂ :Â false
Â Â Â Â cnlStartLongDealInternalÂ :=Â cnlStartDealsEnabledÂ andÂ longDealsEnabledÂ ?Â notÂ longFiltersApprovalÂ andÂ longFiltersApproval[1]Â :Â false
Â Â Â Â cnlStartShortDealInternalÂ :=Â cnlStartDealsEnabledÂ andÂ shortDealsEnabledÂ ?Â notÂ shortFiltersApprovalÂ andÂ shortFiltersApproval[1]Â :Â false
Â Â Â Â cnlEndLongDealInternalÂ :=Â cnlEndDealsEnabledÂ andÂ endDealsEnabledÂ andÂ longDealsEnabledÂ ?Â longFiltersApprovalÂ andÂ notÂ longFiltersApproval[1]Â :Â false
Â Â Â Â cnlEndShortDealInternalÂ :=Â cnlEndDealsEnabledÂ andÂ endDealsEnabledÂ andÂ shortDealsEnabledÂ ?Â shortFiltersApprovalÂ andÂ notÂ shortFiltersApproval[1]Â :Â false
//Â StartÂ dealsÂ shouldÂ happenÂ whenÂ theÂ mainÂ logicÂ appliesÂ andÂ theÂ filtersÂ forÂ thatÂ directionÂ areÂ approved
boolÂ startLongDealÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â startLongDealInternalÂ :Â exiu.eval_cond(externalInput,Â startLongDealOperator,Â startLongDealValue)
boolÂ startShortDealÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â startShortDealInternalÂ :Â exiu.eval_cond(externalInput,Â startShortDealOperator,Â startShortDealValue)
//Â EndÂ dealsÂ shouldÂ happenÂ whenÂ theÂ mainÂ logicÂ applies
boolÂ endLongDealÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â endLongDealInternalÂ :Â exiu.eval_cond(externalInput,Â endLongDealOperator,Â endLongDealValue)
boolÂ endShortDealÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â endShortDealInternalÂ :Â exiu.eval_cond(externalInput,Â endShortDealOperator,Â endShortDealValue)
//Â IfÂ youÂ usingÂ limit,Â stopÂ orÂ stop-limitÂ ordersÂ forÂ theÂ entryÂ andÂ notÂ enteredÂ yetÂ youÂ mayÂ wantÂ toÂ cancelÂ ifÂ theÂ conditionsÂ areÂ notÂ stillÂ favorableÂ toÂ theÂ initialÂ direction
boolÂ cnlStartLongDealÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â cnlStartLongDealInternalÂ :Â exiu.eval_cond(externalInput,Â cnlStartLongDealOperator,Â cnlStartLongDealValue)
boolÂ cnlStartShortDealÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â cnlStartShortDealInternalÂ :Â exiu.eval_cond(externalInput,Â cnlStartShortDealOperator,Â cnlStartShortDealValue)
//Â IfÂ youÂ usingÂ limit,Â stopÂ orÂ stop-limitÂ ordersÂ forÂ exitÂ andÂ notÂ exitedÂ yetÂ youÂ mayÂ wantÂ toÂ cancelÂ ifÂ theÂ conditionsÂ turnedÂ favorableÂ againÂ toÂ theÂ initialÂ direction
boolÂ cnlEndLongDealÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â cnlEndLongDealInternalÂ :Â exiu.eval_cond(externalInput,Â cnlEndLongDealOperator,Â cnlEndLongDealValue)
boolÂ cnlEndShortDealÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â cnlEndShortDealInternalÂ :Â exiu.eval_cond(externalInput,Â cnlEndShortDealOperator,Â cnlEndShortDealValue)
//Â CheckÂ ifÂ thereÂ isÂ noÂ currentÂ positionÂ andÂ theÂ reverseÂ ordersÂ areÂ enabled
boolÂ reverseOrderApprovalÂ =Â reverseOrdersEnabledÂ ?Â trueÂ :Â isFlatPosition
//Â CheckÂ theÂ barsÂ sinceÂ lastÂ tradeÂ completionÂ withÂ theÂ givenÂ numberÂ ofÂ cooldownÂ bars
intÂ barsSinceCompletedLongÂ =Â nz(ta.barssince(completedLongTrade),Â maxLimitInt)
intÂ barsSinceCompletedShortÂ =Â nz(ta.barssince(completedShortTrade),Â maxLimitInt)
boolÂ cooldownApprovalÂ =Â cooldownEnabledÂ ?Â math.min(barsSinceCompletedLong,Â barsSinceCompletedShort)Â >=Â cooldownBarsÂ :Â true
//Â OpenÂ newÂ positionÂ ifÂ allÂ conditionsÂ areÂ met
boolÂ openLongPositionÂ =Â timeFilterApprovalÂ andÂ startLongDealÂ andÂ cooldownApprovalÂ andÂ reverseOrderApproval
boolÂ openShortPositionÂ =Â timeFilterApprovalÂ andÂ startShortDealÂ andÂ cooldownApprovalÂ andÂ reverseOrderApproval
//Â IfÂ thereÂ isÂ aÂ newÂ endÂ dealÂ conditionÂ thisÂ willÂ alsoÂ cancelÂ theÂ previousÂ startÂ dealÂ (ifÂ posible)
boolÂ cnlOpenLongPositionÂ =Â (timeFilterApprovalÂ andÂ cnlStartLongDeal)Â orÂ (notÂ timeFilterApprovalÂ andÂ timeFilterApproval[1])
boolÂ cnlOpenShortPositionÂ =Â (timeFilterApprovalÂ andÂ cnlStartShortDeal)Â orÂ (notÂ timeFilterApprovalÂ andÂ timeFilterApproval[1])
//Â TheÂ openÂ signalsÂ whenÂ notÂ alreadyÂ intoÂ aÂ position
boolÂ validOpenLongPositionÂ =Â openLongPositionÂ andÂ notÂ isLongPosition
boolÂ validOpenShortPositionÂ =Â openShortPositionÂ andÂ notÂ isShortPosition
boolÂ validOpenPositionÂ =Â validOpenLongPositionÂ orÂ validOpenShortPosition
//Â PLOTÂ ================================================================================================================
plot(seriesÂ =Â externalInput,Â titleÂ =Â 'ExternalÂ Input',Â colorÂ =Â color.olive,Â displayÂ =Â dealModeÂ ==Â 'ğŸ”¨External'Â ?Â display.data_windowÂ :Â display.none)
varÂ colorÂ emaLineColorÂ =Â color.new(color.silver,Â 0)
plot(seriesÂ =Â emaLine,Â colorÂ =Â emaLineColor,Â styleÂ =Â plot.style_linebr,Â linewidthÂ =Â 2,Â titleÂ =Â 'EMAÂ Line',Â displayÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â andÂ emaFilterEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
varÂ colorÂ emaBandFillColorÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â andÂ emaFilterEnabledÂ andÂ emaAtrBandEnabledÂ ?Â color.new(emaLineColor,Â 90)Â :Â na
emaUpperBandPlotÂ =Â plot(seriesÂ =Â emaUpperBand,Â colorÂ =Â emaBandFillColor,Â styleÂ =Â plot.style_linebr,Â titleÂ =Â 'EMAÂ UpperÂ Band',Â displayÂ =Â display.data_window)
emaLowerBandPlotÂ =Â plot(seriesÂ =Â emaLowerBand,Â colorÂ =Â emaBandFillColor,Â styleÂ =Â plot.style_linebr,Â titleÂ =Â 'EMAÂ LowerÂ Band',Â displayÂ =Â display.data_window)
fill(plot1Â =Â emaUpperBandPlot,Â plot2Â =Â emaLowerBandPlot,Â colorÂ =Â emaBandFillColor,Â titleÂ =Â 'EMAÂ Band')
varÂ colorÂ fastColorÂ =Â color.new(color.yellow,Â 0)
plot(seriesÂ =Â fastMA,Â titleÂ =Â 'FastÂ MA',Â colorÂ =Â fastColor,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_line,Â displayÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
varÂ colorÂ slowColorÂ =Â color.new(color.orange,Â 0)
plot(seriesÂ =Â slowMA,Â titleÂ =Â 'SlowÂ MA',Â colorÂ =Â slowColor,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_line,Â displayÂ =Â dealModeÂ ==Â 'ğŸ”§Internal'Â ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ¢Â VOLATILITY
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ generalÂ purposeÂ volatilityÂ variableÂ thatÂ neededÂ forÂ severalÂ otherÂ modules
//Â Dependencies:Â NONE
//Â Results:Â negAtr,Â posAtr,Â negStDev,Â posStDev
importÂ HeWhoMustNotBeNamed/arraymethods/1â€ŠasÂ arraymethods
importÂ HeWhoMustNotBeNamed/arrayutils/22Â asÂ pa
//Â INPUTÂ ===============================================================================================================
atrMethodÂ =Â input.string(defvalÂ =Â 'STATIC',Â titleÂ =Â 'ATRÂ Method',Â optionsÂ =Â ['STATIC',Â 'DYNAMIC',Â 'LADDER'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ ATRÂ usedÂ forÂ theÂ trailing.Â UseÂ theÂ ATRÂ valueÂ atÂ theÂ timeÂ ofÂ openÂ signalÂ throughoutÂ theÂ wholeÂ tradeÂ (STATIC),Â orÂ useÂ theÂ currentÂ ATRÂ valueÂ (DYNAMIC),Â orÂ theÂ ATRÂ onlyÂ ofÂ theÂ green/redÂ barsÂ whenÂ tryÂ toÂ enter/exitÂ theÂ tradeÂ (LADDER).',Â groupÂ =Â 'ğŸ¢Â Volatility')
atrMaTypeÂ =Â str.lower(input.string(defvalÂ =Â 'RMA',Â titleÂ =Â 'â€ƒâ€ƒATRÂ SmoothÂ Type/Lenâ€ƒâ€ƒâ€ƒ',Â optionsÂ =Â ['SMA',Â 'EMA',Â 'RMA',Â 'WMA',Â 'HMA'],Â inlineÂ =Â 'ATR',Â groupÂ =Â 'ğŸ¢Â Volatility'))
atrLengthÂ =Â input.int(defvalÂ =Â 14,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ smoothingÂ typeÂ andÂ theÂ lengthÂ toÂ beÂ usedÂ forÂ theÂ ATRÂ calculation.',Â inlineÂ =Â 'ATR',Â groupÂ =Â 'ğŸ¢Â Volatility')
stdevMethodÂ =Â input.string(defvalÂ =Â 'STATIC',Â titleÂ =Â 'StDevÂ Method',Â optionsÂ =Â ['STATIC',Â 'DYNAMIC',Â 'LADDER'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ standardÂ deviationÂ usedÂ forÂ theÂ trailing.Â UseÂ theÂ StDevÂ valueÂ atÂ theÂ timeÂ ofÂ openÂ signalÂ throughoutÂ theÂ wholeÂ tradeÂ (STATIC),Â orÂ useÂ theÂ currentÂ StDevÂ valueÂ (DYNAMIC),Â orÂ theÂ StDevÂ onlyÂ ofÂ theÂ green/redÂ barsÂ whenÂ tryÂ toÂ enter/exitÂ theÂ tradeÂ (LADDER).',Â groupÂ =Â 'ğŸ¢Â Volatility')
stdevModeÂ =Â input.string(defvalÂ =Â 'PRICE',Â titleÂ =Â 'â€ƒâ€ƒStDevÂ Mode',Â optionsÂ =Â ['PRICE',Â 'RETURN'],Â tooltipÂ =Â 'UseÂ theÂ "PRICE"Â asÂ sourceÂ forÂ theÂ standardÂ deviationÂ calculations.Â OrÂ useÂ "RETURN"Â toÂ useÂ theÂ logÂ returnsÂ ofÂ theÂ priceÂ asÂ sourceÂ forÂ theÂ standardÂ deviation.',Â groupÂ =Â 'ğŸ¢Â Volatility')
stdevPriceSrcÂ =Â exiu.str_to_src(input.string(defvalÂ =Â 'close',Â titleÂ =Â 'â€ƒâ€ƒStDevÂ Src/Lenâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â optionsÂ =Â ['open',Â 'high',Â 'low',Â 'close',Â 'hl2',Â 'hlc3',Â 'ohlc4',Â 'hlcc4'],Â inlineÂ =Â 'StDev',Â groupÂ =Â 'ğŸ¢Â Volatility'))
stdevLengthÂ =Â input.int(defvalÂ =Â 20,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ sourceÂ andÂ theÂ lengthÂ toÂ beÂ usedÂ forÂ theÂ StDevÂ calculation.',Â inlineÂ =Â 'StDev',Â groupÂ =Â 'ğŸ¢Â Volatility')
//Â LOGICÂ ===============================================================================================================
//Â CalculateÂ atrÂ andÂ StDevÂ basedÂ onÂ methodÂ selected,Â staticÂ atrÂ whenÂ lastÂ openÂ signalÂ wasÂ emitted,Â dynamicÂ isÂ theÂ currentÂ atr/stdevÂ thatÂ changeÂ overÂ time,Â ladderÂ atr/stdevÂ forÂ positiveÂ andÂ negativeÂ bars
varÂ float[]Â positiveTrsÂ =Â array.new<float>()
varÂ float[]Â negativeTrsÂ =Â array.new<float>()
varÂ float[]Â positiveStDevsÂ =Â array.new<float>()
varÂ float[]Â negativeStDevsÂ =Â array.new<float>()
ifÂ (atrMethodÂ ==Â 'LADDER')
Â Â Â Â if(closeÂ >Â open)
Â Â Â Â Â Â Â Â positiveTrs.push(ta.tr(true),Â atrLength)
Â Â Â Â else
Â Â Â Â Â Â Â Â negativeTrs.push(ta.tr(true),Â atrLength)
ifÂ (stdevMethodÂ ==Â 'LADDER')
Â Â Â Â floatÂ stdevSrcÂ =Â stdevModeÂ ==Â 'PRICE'Â ?Â stdevPriceSrcÂ :Â math.log(stdevPriceSrc/stdevPriceSrc[1])
Â Â Â Â if(closeÂ >Â open)
Â Â Â Â Â Â Â Â positiveStDevs.push(stdevSrc,Â stdevLength)
Â Â Â Â else
Â Â Â Â Â Â Â Â negativeStDevs.push(stdevSrc,Â stdevLength)
floatÂ dynamicAtrÂ =Â eta.ma(ta.tr(true),Â atrMaType,Â atrLength)
floatÂ staticAtrÂ =Â ta.valuewhen(validOpenPosition,Â dynamicAtr,Â 0)
floatÂ dynamicStDevÂ =Â ta.stdev(stdevPriceSrc,Â stdevLength)
floatÂ staticStDevÂ =Â ta.valuewhen(validOpenPosition,Â dynamicStDev,Â 0)
floatÂ negAtrÂ =Â switchÂ atrMethod
Â Â Â Â 'STATIC'Â =>Â staticAtr
Â Â Â Â 'DYNAMIC'Â =>Â dynamicAtr
Â Â Â Â 'LADDER'Â =>Â pa.ma(negativeTrs,Â atrMaType,Â atrLength)
Â Â Â Â =>Â na
floatÂ posAtrÂ =Â switchÂ atrMethod
Â Â Â Â 'STATIC'Â =>Â staticAtr
Â Â Â Â 'DYNAMIC'Â =>Â dynamicAtr
Â Â Â Â 'LADDER'Â =>Â pa.ma(positiveTrs,Â atrMaType,Â atrLength)
Â Â Â Â =>Â na
floatÂ negStDevÂ =Â switchÂ stdevMethod
Â Â Â Â 'STATIC'Â =>Â staticStDev
Â Â Â Â 'DYNAMIC'Â =>Â dynamicStDev
Â Â Â Â 'LADDER'Â =>Â stdevModeÂ ==Â 'PRICE'Â ?Â negativeStDevs.stdev(false)Â :Â stdevPriceSrcÂ *Â (math.exp(negativeStDevs.stdev(false))Â -Â 1.0)
Â Â Â Â =>Â na
floatÂ posStDevÂ =Â switchÂ stdevMethod
Â Â Â Â 'STATIC'Â =>Â staticStDev
Â Â Â Â 'DYNAMIC'Â =>Â dynamicStDev
Â Â Â Â 'LADDER'Â =>Â stdevModeÂ ==Â 'PRICE'Â ?Â positiveStDevs.stdev(false)Â :Â stdevPriceSrcÂ *Â (math.exp(positiveStDevs.stdev(false))Â -Â 1.0)
Â Â Â Â =>Â na
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ“Â DISTANCE
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ generalÂ purposeÂ distanceÂ calculationsÂ usedÂ byÂ otherÂ modules
//Â Dependencies:Â NONE
//Â Results:Â NONE
importÂ jason5480/distance_ratio/11Â asÂ dr
importÂ jason5480/biased_price_target/2â€ŠasÂ biased_price_target
//Â LOGICÂ ===============================================================================================================
getUpwardsMovingBarrierPrice(simpleÂ stringÂ barrier)Â =>
Â Â Â Â barrierÂ ==Â 'FRONT'Â ?Â highÂ :Â low
getDownwardsMovingBarrierPrice(simpleÂ stringÂ barrier)Â =>
Â Â Â Â barrierÂ ==Â 'FRONT'Â ?Â lowÂ :Â high
longBiasedAuxDataÂ =Â dr.AuxData.new(atrÂ =Â posAtr,Â stdevÂ =Â posStDev)
shortBiasedAuxDataÂ =Â dr.AuxData.new(atrÂ =Â negAtr,Â stdevÂ =Â negStDev)
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ”·Â ENTRY
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ entryÂ logicÂ implementationÂ basedÂ onÂ orderÂ type
//Â Dependencies:Â TRACKÂ POSITION,Â STRATEGYÂ 1,Â VOLATILITY,Â DISTANCE
//Â Results:Â longIsActive,Â validCnlOpenLongPosition,Â longLimitOrStopEntryIsActive,Â shortIsActive,Â validCnlOpenShortPosition,Â shortLimitOrStopEntryIsActive,Â longEntryPrice,Â shortEntryPrice
//Â INPUTÂ ===============================================================================================================
longEntryColorÂ =Â input.color(defvalÂ =Â color.new(#2962FF,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â EntryÂ ColorÂ Long/Shortâ€ƒ',Â inlineÂ =Â 'Entry',Â groupÂ =Â 'ğŸ”·Â Entry')
shortEntryColorÂ =Â input.color(defvalÂ =Â color.new(#FF1744,Â 0),Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ long/shortÂ limit,Â stopÂ andÂ stop-limitÂ entryÂ prices.',Â inlineÂ =Â 'Entry',Â groupÂ =Â 'ğŸ”·Â Entry')
posColorÂ =Â input.color(defvalÂ =Â color.new(color.gray,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â PositionÂ EntryÂ PriceÂ Color',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ positionÂ entryÂ price.',Â groupÂ =Â 'ğŸ”·Â Entry')
entryOrderTypeÂ =Â input.string(defvalÂ =Â 'MARKET',Â titleÂ =Â 'OrderÂ Typeâ€‹',Â optionsÂ =Â ['MARKET',Â 'LIMIT',Â 'STOP',Â 'STOP-LIMIT'],Â tooltipÂ =Â 'UseÂ marketÂ orderÂ toÂ enterÂ atÂ theÂ openÂ ofÂ theÂ nextÂ barÂ (MARKET),Â orÂ useÂ limitÂ orderÂ toÂ enterÂ atÂ aÂ "better"Â priceÂ definedÂ byÂ theÂ distanceÂ fromÂ theÂ closeÂ priceÂ andÂ theÂ limitÂ modeÂ (LIMIT),Â orÂ useÂ stopÂ marketÂ orderÂ toÂ enterÂ atÂ aÂ "worst"Â priceÂ definedÂ byÂ theÂ distanceÂ fromÂ theÂ closeÂ priceÂ andÂ theÂ limitÂ modeÂ (STOP),Â orÂ useÂ stop-limitÂ orderÂ toÂ enterÂ atÂ aÂ "worst"Â priceÂ definedÂ byÂ theÂ distanceÂ fromÂ theÂ closeÂ priceÂ andÂ theÂ limitÂ modeÂ (STOP-LIMIT).',Â groupÂ =Â 'ğŸ”·Â Entry')
entryStopLimitMarginMethodÂ =Â input.string(defvalÂ =Â 'ATR',Â titleÂ =Â 'â€ƒâ€ƒStop-LimitÂ MarÂ Method',Â optionsÂ =Â ['ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ marginÂ usedÂ forÂ theÂ entryÂ stop-limitÂ orders.Â OffsetÂ theÂ limitÂ priceÂ targetÂ byÂ aÂ multipleÂ ofÂ theÂ ATRÂ valueÂ (ATR),Â orÂ byÂ aÂ multipleÂ ofÂ theÂ StDevÂ valueÂ (STDEV),Â orÂ byÂ aÂ numberÂ ofÂ ticksÂ (TICKS)',Â groupÂ =Â 'ğŸ”·Â Entry')
entryStopLimitMarMulÂ =Â input.float(defvalÂ =Â 0.5,Â titleÂ =Â 'â€ƒâ€ƒStop-LimitÂ MarÂ Mul',Â stepÂ =Â 0.1,Â tooltipÂ =Â 'TheÂ acceptableÂ marginÂ forÂ theÂ entryÂ stop-limitÂ ordersÂ isÂ definedÂ byÂ thisÂ multiplierÂ andÂ itÂ isÂ appliedÂ eitherÂ asÂ percentageÂ orÂ atrÂ multiplierÂ orÂ ticks,Â basedÂ onÂ theÂ "Stop-LimitÂ MarginÂ Method".',Â groupÂ =Â 'ğŸ”·Â Entry')
entryLimitModeÂ =Â input.string(defvalÂ =Â 'FIXED',Â titleÂ =Â 'LimitÂ Modeâ€‹',Â optionsÂ =Â ['FIXED',Â 'TRAIL'],Â tooltipÂ =Â 'WhenÂ youÂ useÂ limit,Â stopÂ orÂ stop-limitÂ ordersÂ toÂ enter,Â useÂ aÂ fixedÂ priceÂ definedÂ byÂ theÂ distanceÂ andÂ theÂ closeÂ priceÂ whenÂ theÂ openÂ signalÂ occursÂ (FIXED),Â orÂ trailÂ byÂ followingÂ theÂ priceÂ toÂ theÂ directionÂ ofÂ theÂ entryÂ forÂ limitÂ ordersÂ orÂ theÂ otherÂ directionÂ ofÂ theÂ entryÂ forÂ stopÂ andÂ stop-limitÂ ordersÂ (TRAIL).',Â groupÂ =Â 'ğŸ”·Â Entry')
entryTrailBarrierÂ =Â input.string(defvalÂ =Â 'FRONT',Â titleÂ =Â 'â€ƒâ€ƒTrailÂ Barrierâ€‹â€‹',Â optionsÂ =Â ['FRONT',Â 'REAR'],Â tooltipÂ =Â 'TheÂ priceÂ referenceÂ thatÂ willÂ beÂ usedÂ forÂ theÂ entryÂ trailingÂ logic.Â ForÂ enteringÂ intoÂ aÂ positionÂ withÂ aÂ LIMITÂ order,Â followÂ theÂ highÂ forÂ longÂ andÂ lowÂ forÂ shortÂ (FRONT),Â orÂ followÂ theÂ lowÂ forÂ longÂ andÂ highÂ forÂ shortÂ (REAR).Â ForÂ theÂ STOPÂ andÂ STOP-LIMITÂ ordersÂ theÂ logicÂ isÂ reversed.',Â groupÂ =Â 'ğŸ”·Â Entry')
varÂ entryDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'ATR',Â titleÂ =Â 'DistanceÂ Methodâ€‹',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS',Â 'HHLL'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ distanceÂ ofÂ theÂ limit,Â stopÂ andÂ stop-limitÂ entry.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV),Â TickÂ basedÂ (TICKS)Â orÂ HighestÂ high/LowestÂ lowÂ (HHLL).',Â groupÂ =Â 'ğŸ”·Â Entry'),
Â Â distMulÂ =Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'â€ƒâ€ƒDistÂ Mul|Lenâ€‹',Â minvalÂ =Â 0.01,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'TheÂ distanceÂ multiplierÂ orÂ lengthÂ toÂ defineÂ theÂ entryÂ priceÂ fromÂ closeÂ whenÂ theÂ openÂ signalÂ occursÂ orÂ fromÂ theÂ barrierÂ priceÂ whenÂ trailing.Â TheÂ multiplierÂ willÂ beÂ appliedÂ toÂ theÂ unitÂ priceÂ thatÂ isÂ definedÂ byÂ theÂ distanceÂ methodÂ thatÂ isÂ used.Â IfÂ theÂ HHLLÂ methodÂ isÂ used,Â thenÂ theÂ lengthÂ willÂ defineÂ theÂ windowÂ forÂ theÂ highestÂ highÂ andÂ lowestÂ lowÂ calculations.',Â groupÂ =Â 'ğŸ”·Â Entry'))
varÂ entryMarSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'TICKS',Â titleÂ =Â 'MarginÂ DistanceÂ Methodâ€‹',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ marginÂ toÂ offsetÂ theÂ distanceÂ ofÂ theÂ limit,Â stopÂ andÂ stop-limitÂ entryÂ priceÂ target.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸ”·Â Entry'),
Â Â distMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'DistanceÂ EntryÂ Margin',Â groupÂ =Â 'ğŸ”·Â Entry')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 5.0,Â titleÂ =Â 'MarÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹',Â stepÂ =Â 0.5,Â tooltipÂ =Â 'TheÂ marginÂ multiplierÂ toÂ defineÂ theÂ entryÂ distanceÂ offset.',Â inlineÂ =Â 'DistanceÂ EntryÂ Margin',Â groupÂ =Â 'ğŸ”·Â Entry')Â :Â na)
varÂ entryRestrictSettingsÂ =Â dr.RestrictSettings.new(
Â Â restrDistMethodÂ =Â input.string(defvalÂ =Â 'PERC',Â titleÂ =Â 'RestrictÂ DistanceÂ Methodâ€‹',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ maximum/minimumÂ distanceÂ ofÂ theÂ entryÂ price.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸ”·Â Entry'),
Â Â minDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'EntryÂ MinÂ Distance',Â groupÂ =Â 'ğŸ”·Â Entry')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'MinÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ minimumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â ThisÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ theÂ entryÂ willÂ notÂ beÂ placedÂ tooÂ closeÂ fromÂ theÂ referenceÂ price.Â Otherwise,Â aÂ tightÂ entryÂ priceÂ wouldÂ makeÂ theÂ entryÂ toÂ easilyÂ beÂ reachedÂ duringÂ volatileÂ marketÂ conditions.',Â inlineÂ =Â 'EntryÂ MinÂ Distance',Â groupÂ =Â 'ğŸ”·Â Entry')Â :Â na,
Â Â maxDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'EntryÂ MaxÂ Distance',Â groupÂ =Â 'ğŸ”·Â Entry')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 4.0,Â titleÂ =Â 'MaxÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ maximumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â ThisÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ theÂ entryÂ willÂ notÂ beÂ placedÂ tooÂ farÂ fromÂ theÂ referenceÂ price.Â Otherwise,Â aÂ looseÂ entryÂ priceÂ wouldÂ riskÂ toÂ notÂ beÂ reachedÂ inÂ aÂ timelyÂ manner.',Â inlineÂ =Â 'EntryÂ MaxÂ Distance',Â groupÂ =Â 'ğŸ”·Â Entry')Â :Â na)
treatCloseAsCancelÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'TreatÂ CloseÂ asÂ Cancel',Â tooltipÂ =Â 'IfÂ enabledÂ theÂ invalidÂ closeÂ positionÂ signalsÂ willÂ beÂ treatedÂ asÂ cancelÂ openÂ signalsÂ toÂ cancelÂ limit,Â stopÂ andÂ stop-limitÂ entryÂ orders.',Â groupÂ =Â 'ğŸ”·Â Entry')
//Â LOGICÂ ===============================================================================================================
//Â MarkÂ whenÂ longÂ positionÂ isÂ active
boolÂ longIsActiveÂ =Â validOpenLongPositionÂ orÂ isLongPosition
//Â TheÂ longÂ cancelÂ openÂ signal
varÂ boolÂ validCnlOpenLongPositionÂ =Â false
//Â CountÂ howÂ farÂ areÂ theÂ lastÂ longÂ validÂ cancelÂ open,Â open,Â entryÂ andÂ validÂ openÂ signals
intÂ barsSinceValidOpenLongÂ =Â nz(ta.barssince(validOpenLongPosition),Â maxLimitInt)
intÂ barsSinceValidCnlOpenLongÂ =Â nz(ta.barssince(validCnlOpenLongPosition),Â maxLimitInt)
intÂ barsSinceEnteredLongÂ =Â nz(ta.barssince(enteredLongTrade),Â maxLimitInt)
boolÂ openLongIsActiveÂ =Â barsSinceValidCnlOpenLongÂ >Â barsSinceValidOpenLongÂ //Â validCancelOpenÂ ->Â validOpen
boolÂ enterLongIsPendingÂ =Â barsSinceEnteredLongÂ >=Â barsSinceValidOpenLongÂ //Â enteredÂ ->Â validOpen
//Â ValidateÂ theÂ longÂ cancelÂ openÂ signalÂ whenÂ notÂ alreadyÂ intoÂ aÂ position
validCnlOpenLongPositionÂ :=Â entryOrderTypeÂ !=Â 'MARKET'Â ?Â (cnlOpenLongPositionÂ orÂ validOpenShortPositionÂ orÂ (treatCloseAsCancelÂ ?Â timeFilterApprovalÂ andÂ endLongDealÂ :Â false))Â andÂ notÂ isLongPositionÂ andÂ openLongIsActiveÂ andÂ enterLongIsPendingÂ andÂ notÂ validOpenLongPositionÂ :Â false
floatÂ entryHighestHighÂ =Â ta.highest(high,Â math.max(math.floor(entryDistSettings.distMul),Â 1))
//Â CalculateÂ theÂ actualÂ entryÂ priceÂ fromÂ theÂ referenceÂ usingÂ aÂ longÂ biasedÂ distanceÂ withÂ aÂ downwardsÂ movingÂ potential
getLongEntryHigherPrice(floatÂ referencePrice)Â =>
Â Â Â Â entryDistSettings.higher_long_biased_price(referencePrice,Â longBiasedAuxData,Â entryRestrictSettings,Â entryMarSettings,Â entryHighestHigh)
floatÂ entryLowestLowÂ =Â ta.lowest(low,Â math.max(math.floor(entryDistSettings.distMul),Â 1))
//Â CalculateÂ theÂ actualÂ entryÂ priceÂ fromÂ theÂ referenceÂ usingÂ aÂ longÂ biasedÂ distanceÂ withÂ anÂ upwardsÂ movingÂ potential
getLongEntryLowerPrice(floatÂ referencePrice)Â =>
Â Â Â Â entryDistSettings.lower_long_biased_price(referencePrice,Â longBiasedAuxData,Â entryRestrictSettings,Â entryMarSettings,Â entryLowestLow)
varÂ floatÂ longLimitOrStopEntryPriceÂ =Â na
boolÂ isFirstValidOpenLongPositionÂ =Â entryOrderTypeÂ !=Â 'MARKET'Â ?Â validOpenLongPositionÂ andÂ (na(longLimitOrStopEntryPrice[1])Â orÂ completedLongTrade)Â :Â false
boolÂ tryEnterLongPositionÂ =Â entryOrderTypeÂ !=Â 'MARKET'Â ?Â timeFilterApprovalÂ andÂ notÂ isLongPositionÂ andÂ notÂ completedLongTradeÂ andÂ notÂ na(longLimitOrStopEntryPrice[1])Â andÂ notÂ validCnlOpenLongPositionÂ :Â false
longLimitOrStopEntryPriceÂ :=Â ifÂ (isFirstValidOpenLongPosition)
Â Â Â Â ifÂ (entryOrderTypeÂ ==Â 'LIMIT')
Â Â Â Â Â Â Â Â getLongEntryLowerPrice(close)
Â Â Â Â elseÂ ifÂ (entryOrderTypeÂ ==Â 'STOP'Â orÂ entryOrderTypeÂ ==Â 'STOP-LIMIT')
Â Â Â Â Â Â Â Â getLongEntryHigherPrice(close)
elseÂ ifÂ (tryEnterLongPosition)
Â Â Â Â ifÂ (entryLimitModeÂ ==Â 'TRAIL'Â orÂ (entryLimitModeÂ ==Â 'FIXED'Â andÂ validOpenLongPosition))
Â Â Â Â Â Â Â Â ifÂ (entryOrderTypeÂ ==Â 'LIMIT')
Â Â Â Â Â Â Â Â Â Â Â Â math.max(getLongEntryLowerPrice(getUpwardsMovingBarrierPrice(entryTrailBarrier)),Â nz(longLimitOrStopEntryPrice[1],Â minLimitFloat))
Â Â Â Â Â Â Â Â elseÂ ifÂ (entryOrderTypeÂ ==Â 'STOP'Â orÂ entryOrderTypeÂ ==Â 'STOP-LIMIT')
Â Â Â Â Â Â Â Â Â Â Â Â math.min(getLongEntryHigherPrice(getDownwardsMovingBarrierPrice(entryTrailBarrier)),Â nz(longLimitOrStopEntryPrice[1],Â maxLimitFloat))
Â Â Â Â else
Â Â Â Â Â Â Â Â nz(longLimitOrStopEntryPrice[1],Â maxLimitFloat)
floatÂ longStopLimitEntryPriceÂ =Â entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â longLimitOrStopEntryPriceÂ +Â entryStopLimitMarMulÂ *Â (entryStopLimitMarginMethodÂ ==Â 'ATR'Â ?Â posAtrÂ :Â entryStopLimitMarginMethodÂ ==Â 'STDEV'Â ?Â posStDevÂ :Â syminfo.mintick)Â :Â na
varÂ boolÂ longStopLimitStopEntryExecutedÂ =Â false
ifÂ (ta.crossover(high,Â longLimitOrStopEntryPrice)Â andÂ entryOrderTypeÂ ==Â 'STOP-LIMIT')
Â Â Â Â longStopLimitStopEntryExecutedÂ :=Â true
elseÂ ifÂ (enteredLongTrade)
Â Â Â Â longStopLimitStopEntryExecutedÂ :=Â false
boolÂ longLimitOrStopEntryIsActiveÂ =Â notÂ na(longLimitOrStopEntryPrice)
//Â MarkÂ whenÂ shortÂ positionÂ isÂ active
boolÂ shortIsActiveÂ =Â validOpenShortPositionÂ orÂ isShortPosition
//Â TheÂ shortÂ cancelÂ openÂ signal
varÂ boolÂ validCnlOpenShortPositionÂ =Â false
//Â CountÂ howÂ farÂ areÂ theÂ lastÂ shortÂ validÂ cancelÂ open,Â open,Â entryÂ andÂ validÂ openÂ signals
intÂ barsSinceValidOpenShortÂ =Â nz(ta.barssince(validOpenShortPosition),Â maxLimitInt)
intÂ barsSinceValidCnlOpenShortÂ =Â nz(ta.barssince(validCnlOpenShortPosition),Â maxLimitInt)
intÂ barsSinceEnteredShortÂ =Â nz(ta.barssince(enteredShortTrade),Â maxLimitInt)
boolÂ openShortIsActiveÂ =Â barsSinceValidCnlOpenShortÂ >Â barsSinceValidOpenShortÂ //Â validCancelOpenÂ ->Â validOpen
boolÂ enterShortIsPendingÂ =Â barsSinceEnteredShortÂ >=Â barsSinceValidOpenShortÂ //Â enteredÂ ->Â validOpen
//Â ValidateÂ theÂ shortÂ cancelÂ openÂ signalÂ whenÂ notÂ alreadyÂ intoÂ aÂ position
validCnlOpenShortPositionÂ :=Â entryOrderTypeÂ !=Â 'MARKET'Â ?Â (cnlOpenShortPositionÂ orÂ validOpenLongPositionÂ orÂ (treatCloseAsCancelÂ ?Â timeFilterApprovalÂ andÂ endShortDealÂ :Â false))Â andÂ notÂ isShortPositionÂ andÂ openShortIsActiveÂ andÂ enterShortIsPendingÂ andÂ notÂ validOpenShortPositionÂ :Â false
//Â CalculateÂ theÂ actualÂ entryÂ priceÂ fromÂ theÂ referenceÂ usingÂ aÂ shortÂ biasedÂ distanceÂ withÂ aÂ downwardsÂ movingÂ potential
getShortEntryHigherPrice(floatÂ referencePrice)Â =>
Â Â Â Â entryDistSettings.higher_short_biased_price(referencePrice,Â shortBiasedAuxData,Â entryRestrictSettings,Â entryMarSettings,Â entryHighestHigh)
//Â CalculateÂ theÂ actualÂ entryÂ priceÂ fromÂ theÂ referenceÂ usingÂ aÂ shortÂ biasedÂ distanceÂ withÂ anÂ upwardsÂ movingÂ potential
getShortEntryLowerPrice(floatÂ referencePrice)Â =>
Â Â Â Â entryDistSettings.lower_short_biased_price(referencePrice,Â shortBiasedAuxData,Â entryRestrictSettings,Â entryMarSettings,Â entryLowestLow)
varÂ floatÂ shortLimitOrStopEntryPriceÂ =Â na
boolÂ isFirstValidOpenShortPositionÂ =Â entryOrderTypeÂ !=Â 'MARKET'Â ?Â validOpenShortPositionÂ andÂ (na(shortLimitOrStopEntryPrice[1])Â orÂ completedShortTrade)Â :Â false
boolÂ tryEnterShortPositionÂ =Â entryOrderTypeÂ !=Â 'MARKET'Â ?Â timeFilterApprovalÂ andÂ notÂ isShortPositionÂ andÂ notÂ completedShortTradeÂ andÂ notÂ na(shortLimitOrStopEntryPrice[1])Â andÂ notÂ validCnlOpenShortPositionÂ :Â false
shortLimitOrStopEntryPriceÂ :=Â ifÂ (isFirstValidOpenShortPosition)
Â Â Â Â ifÂ (entryOrderTypeÂ ==Â 'LIMIT')
Â Â Â Â Â Â Â Â getShortEntryHigherPrice(close)
Â Â Â Â elseÂ ifÂ (entryOrderTypeÂ ==Â 'STOP'Â orÂ entryOrderTypeÂ ==Â 'STOP-LIMIT')
Â Â Â Â Â Â Â Â getShortEntryLowerPrice(close)
elseÂ ifÂ (tryEnterShortPosition)
Â Â Â Â ifÂ (entryLimitModeÂ ==Â 'TRAIL'Â orÂ (entryLimitModeÂ ==Â 'FIXED'Â andÂ validOpenShortPosition))
Â Â Â Â Â Â Â Â ifÂ (entryOrderTypeÂ ==Â 'LIMIT')
Â Â Â Â Â Â Â Â Â Â Â Â math.min(getShortEntryHigherPrice(getDownwardsMovingBarrierPrice(entryTrailBarrier)),Â nz(shortLimitOrStopEntryPrice[1],Â maxLimitFloat))
Â Â Â Â Â Â Â Â elseÂ ifÂ (entryOrderTypeÂ ==Â 'STOP'Â orÂ entryOrderTypeÂ ==Â 'STOP-LIMIT')
Â Â Â Â Â Â Â Â Â Â Â Â math.max(getShortEntryLowerPrice(getUpwardsMovingBarrierPrice(entryTrailBarrier)),Â nz(shortLimitOrStopEntryPrice[1],Â minLimitFloat))
Â Â Â Â else
Â Â Â Â Â Â Â Â nz(shortLimitOrStopEntryPrice[1],Â minLimitFloat)
floatÂ shortStopLimitEntryPriceÂ =Â entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â shortLimitOrStopEntryPriceÂ -Â entryStopLimitMarMulÂ *Â (entryStopLimitMarginMethodÂ ==Â 'ATR'Â ?Â negAtrÂ :Â entryStopLimitMarginMethodÂ ==Â 'STDEV'Â ?Â negStDevÂ :Â syminfo.mintick)Â :Â na
varÂ boolÂ shortStopLimitStopEntryExecutedÂ =Â false
ifÂ (ta.crossunder(low,Â shortLimitOrStopEntryPrice)Â andÂ entryOrderTypeÂ ==Â 'STOP-LIMIT')
Â Â Â Â shortStopLimitStopEntryExecutedÂ :=Â true
elseÂ ifÂ (enteredShortTrade)
Â Â Â Â shortStopLimitStopEntryExecutedÂ :=Â false
boolÂ shortLimitOrStopEntryIsActiveÂ =Â notÂ na(shortLimitOrStopEntryPrice)
//Â BarÂ indexÂ whenÂ theÂ enteredÂ theÂ lastÂ longÂ andÂ shortÂ trades
intÂ longEntryBarIdÂ =Â ta.valuewhen(enteredLongTrade,Â entryOrderTypeÂ ==Â 'MARKET'Â ?Â bar_index[1]Â :Â bar_index,Â 0)
intÂ shortEntryBarIdÂ =Â ta.valuewhen(enteredShortTrade,Â entryOrderTypeÂ ==Â 'MARKET'Â ?Â bar_index[1]Â :Â bar_index,Â 0)
//Â CurrentÂ entryÂ positionÂ price
floatÂ posPriceÂ =Â strategy.opentrades.entry_price(strategy.opentradesÂ -Â 1)
//Â PriceÂ whenÂ enteredÂ aÂ positionÂ orÂ potentialÂ entryÂ priceÂ inÂ caseÂ ofÂ limit,Â stopÂ andÂ stop-limitÂ orders
floatÂ longEntryPriceÂ =Â notÂ na(posPrice)Â andÂ isLongPositionÂ andÂ notÂ validOpenLongPositionÂ ?Â posPrice
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â longLimitOrStopEntryIsActiveÂ ?Â longStopLimitStopEntryExecutedÂ ?Â longStopLimitEntryPriceÂ :Â longLimitOrStopEntryPrice
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â validOpenLongPositionÂ andÂ entryOrderTypeÂ ==Â 'MARKET'Â ?Â close
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â na
floatÂ shortEntryPriceÂ =Â notÂ na(posPrice)Â andÂ isShortPositionÂ andÂ notÂ validOpenShortPositionÂ ?Â posPrice
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â shortLimitOrStopEntryIsActiveÂ ?Â shortStopLimitStopEntryExecutedÂ ?Â shortStopLimitEntryPriceÂ :Â shortLimitOrStopEntryPrice
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â validOpenShortPositionÂ andÂ entryOrderTypeÂ ==Â 'MARKET'Â ?Â close
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â na
//Â PLOTÂ ================================================================================================================
varÂ colorÂ textColorÂ =Â color.new(color.white,Â 0)
ifÂ (validCnlOpenLongPositionÂ andÂ showCnlOpenLabelsÂ andÂ barstate.isconfirmed)
Â Â Â Â label.new(xÂ =Â bar_index,Â yÂ =Â nz(longLimitOrStopEntryPrice[1],Â close),Â textÂ =Â 'Cancel',Â ylocÂ =Â yloc.price,Â colorÂ =Â longCnlOpenColor,Â styleÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â label.style_label_upÂ :Â label.style_label_down,Â textcolorÂ =Â textColor)
ifÂ (validCnlOpenShortPositionÂ andÂ showCnlOpenLabelsÂ andÂ barstate.isconfirmed)
Â Â Â Â label.new(xÂ =Â bar_index,Â yÂ =Â nz(shortLimitOrStopEntryPrice[1],Â close),Â textÂ =Â 'Cancel',Â ylocÂ =Â yloc.price,Â colorÂ =Â shortCnlOpenColor,Â styleÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â label.style_label_downÂ :Â label.style_label_up,Â textcolorÂ =Â textColor)
longLimitOrStopEntryPlotÂ =Â plot(seriesÂ =Â longLimitOrStopEntryPrice,Â titleÂ =Â 'LongÂ LimitÂ orÂ StopÂ EntryÂ Price',Â colorÂ =Â longStopLimitStopEntryExecutedÂ ?Â naÂ :Â longEntryColor,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1)
longStopLimitEntryPlotÂ =Â plot(seriesÂ =Â longStopLimitEntryPrice,Â titleÂ =Â 'LongÂ Stop-LimitÂ EntryÂ Price',Â colorÂ =Â longStopLimitStopEntryExecutedÂ ?Â longEntryColorÂ :Â na,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â display.paneÂ +Â display.data_window)
varÂ colorÂ longEntryFillColorÂ =Â entryOrderTypeÂ ==Â 'STOP-LIMIT'Â andÂ entryStopLimitMarMulÂ >Â 0.0Â ?Â color.new(longEntryColor,Â 90)Â :Â na
fill(plot1Â =Â longLimitOrStopEntryPlot,Â plot2Â =Â longStopLimitEntryPlot,Â colorÂ =Â longEntryFillColor,Â titleÂ =Â 'LongÂ Stop-LimitÂ Margin')
shortLimitOrStopEntryPlotÂ =Â plot(seriesÂ =Â shortLimitOrStopEntryPrice,Â titleÂ =Â 'ShortÂ LimitÂ orÂ StopÂ EntryÂ Price',Â colorÂ =Â shortStopLimitStopEntryExecutedÂ ?Â naÂ :Â shortEntryColor,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1)
shortStopLimitEntryPlotÂ =Â plot(seriesÂ =Â shortStopLimitEntryPrice,Â titleÂ =Â 'ShortÂ Stop-LimitÂ EntryÂ Price',Â colorÂ =Â shortStopLimitStopEntryExecutedÂ ?Â shortEntryColorÂ :Â na,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â display.paneÂ +Â display.data_window)
varÂ colorÂ shortEntryFillColorÂ =Â entryOrderTypeÂ ==Â 'STOP-LIMIT'Â andÂ entryStopLimitMarMulÂ >Â 0.0Â ?Â color.new(shortEntryColor,Â 90)Â :Â na
fill(plot1Â =Â shortLimitOrStopEntryPlot,Â plot2Â =Â shortStopLimitEntryPlot,Â colorÂ =Â shortEntryFillColor,Â titleÂ =Â 'ShortÂ Stop-LimitÂ Margin')
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ¯Â TAKEÂ PROFITÂ 1
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ takeÂ profitÂ logicÂ implementationÂ basedÂ onÂ theÂ methodÂ andÂ theÂ numberÂ ofÂ stepÂ takeÂ profitÂ targetsÂ andÂ theÂ trailingÂ distance
//Â Dependencies:Â TRACKÂ POSITION
//Â Results:Â takeProfitTargetsSize,Â longTrailTakeProfitExecuted,Â shortTrailTakeProfitExecuted,Â longIthTrailTakeProfitExecuted,Â shortIthTrailTakeProfitExecuted,Â highestHighSinceLongEntry,Â lowestLowSinceShortEntry
//Â INPUTÂ ===============================================================================================================
takeProfitColorÂ =Â input.color(defvalÂ =Â color.new(color.teal,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â TakeÂ ProfitÂ Color',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ takeÂ profitÂ priceÂ targetÂ lines.',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')
numOfTakeProfitTargetsÂ =Â input.int(defvalÂ =Â 1,Â titleÂ =Â 'TakeÂ ProfitÂ Targets',Â minvalÂ =Â 0,Â maxvalÂ =Â 5,Â tooltipÂ =Â 'TheÂ numberÂ ofÂ takeÂ profitÂ targetsÂ toÂ beÂ setÂ forÂ eachÂ entry.Â TheÂ firstÂ targetÂ isÂ theÂ initialÂ targetÂ andÂ everyÂ additionalÂ targetÂ isÂ aÂ stepÂ target.',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')
//Â LOGICÂ ===============================================================================================================
//Â ArraysÂ withÂ theÂ updatedÂ takeÂ ProfitÂ Prices
varÂ float[]Â longTakeProfitPricesÂ =Â array.new<float>(numOfTakeProfitTargets,Â na)
varÂ float[]Â shortTakeProfitPricesÂ =Â array.new<float>(numOfTakeProfitTargets,Â na)
//Â ArraysÂ withÂ theÂ trailingÂ takeÂ profitÂ ticks
varÂ int[]Â longTrailTakeProfitOffsetTicksÂ =Â array.new<int>(numOfTakeProfitTargets,Â na)
varÂ int[]Â shortTrailTakeProfitOffsetTicksÂ =Â array.new<int>(numOfTakeProfitTargets,Â na)
//Â TakeÂ profitÂ hasÂ toÂ communicateÂ theÂ executionÂ ofÂ takeÂ profitÂ targetsÂ withÂ theÂ stopÂ lossÂ logicÂ whenÂ 'TP'Â modeÂ isÂ selected
varÂ bool[]Â longTrailTakeProfitExecutedÂ =Â array.new<bool>(numOfTakeProfitTargets,Â false)
varÂ bool[]Â shortTrailTakeProfitExecutedÂ =Â array.new<bool>(numOfTakeProfitTargets,Â false)
//Â TakeÂ profitÂ relatedÂ tablesÂ sizeÂ usedÂ forÂ for...toÂ loops
varÂ intÂ takeProfitTargetsSizeÂ =Â numOfTakeProfitTargetsÂ -Â 1Â >=Â 0Â ?Â numOfTakeProfitTargetsÂ -Â 1Â :Â na
//Â CountÂ theÂ TakeÂ ProfitÂ targetsÂ thatÂ executed
intÂ longTrailTakeProfitExecutedCountÂ =Â 0
intÂ shortTrailTakeProfitExecutedCountÂ =Â 0
//Â CalculateÂ theÂ highestÂ highÂ sinceÂ theÂ longÂ entry
varÂ floatÂ highestHighSinceLongEntryÂ =Â na
ifÂ (enteredLongTrade)
Â Â Â Â highestHighSinceLongEntryÂ :=Â high
elseÂ ifÂ (isLongPositionÂ orÂ completedLongTrade)
Â Â Â Â highestHighSinceLongEntryÂ :=Â math.max(high,Â nz(highestHighSinceLongEntry[1],Â high))
forÂ [i,Â longTakeProfitPrice]Â inÂ longTakeProfitPrices
Â Â Â Â boolÂ justExecutedÂ =Â false
Â Â Â Â forÂ jÂ =Â 0Â toÂ takeProfitTargetsSizeÂ +Â 1
Â Â Â Â Â Â Â Â justExecutedÂ :=Â justExecutedÂ orÂ (strategy.closedtradesÂ >Â jÂ ?Â bar_indexÂ ==Â strategy.closedtrades.exit_bar_index(strategy.closedtradesÂ -Â 1Â -Â j)Â andÂ strategy.closedtrades.exit_id(strategy.closedtradesÂ -Â 1Â -Â j)Â ==Â str.format(exitOrderIdPattern1,Â longOrderIdPrefix,Â iÂ +Â 1)Â andÂ strategy.closedtrades.profit(strategy.closedtradesÂ -Â 1Â -Â j)Â >Â 0.0Â :Â false)
Â Â Â Â boolÂ executedÂ =Â isLongPositionÂ orÂ completedLongTradeÂ ?Â (longTrailTakeProfitExecuted.get(i)Â orÂ (justExecutedÂ andÂ highestHighSinceLongEntryÂ >=Â longTakeProfitPrice))Â :Â false
Â Â Â Â longTrailTakeProfitExecuted.set(i,Â executed)
Â Â Â Â ifÂ (executed)
Â Â Â Â Â Â Â Â longTrailTakeProfitExecutedCountÂ :=Â longTrailTakeProfitExecutedCountÂ +Â 1
//Â CalculateÂ theÂ lowestÂ lowÂ sinceÂ theÂ shortÂ entry
varÂ floatÂ lowestLowSinceShortEntryÂ =Â na
ifÂ (enteredShortTrade)
Â Â Â Â lowestLowSinceShortEntryÂ :=Â low
elseÂ ifÂ (isShortPositionÂ orÂ completedShortTrade)
Â Â Â Â lowestLowSinceShortEntryÂ :=Â math.min(low,Â nz(lowestLowSinceShortEntry[1],Â low))
forÂ [i,Â shortTakeProfitPrice]Â inÂ shortTakeProfitPrices
Â Â Â Â boolÂ justExecutedÂ =Â false
Â Â Â Â forÂ jÂ =Â 0Â toÂ takeProfitTargetsSizeÂ +Â 1
Â Â Â Â Â Â Â Â justExecutedÂ :=Â justExecutedÂ orÂ (strategy.closedtradesÂ >Â jÂ ?Â bar_indexÂ ==Â strategy.closedtrades.exit_bar_index(strategy.closedtradesÂ -Â 1Â -Â j)Â andÂ strategy.closedtrades.exit_id(strategy.closedtradesÂ -Â 1Â -Â j)Â ==Â str.format(exitOrderIdPattern1,Â shortOrderIdPrefix,Â iÂ +Â 1)Â andÂ strategy.closedtrades.profit(strategy.closedtradesÂ -Â 1Â -Â j)Â >Â 0.0Â :Â false)
Â Â Â Â boolÂ executedÂ =Â isShortPositionÂ orÂ completedShortTradeÂ ?Â (shortTrailTakeProfitExecuted.get(i)Â orÂ (justExecutedÂ andÂ lowestLowSinceShortEntryÂ <=Â shortTakeProfitPrice))Â :Â false
Â Â Â Â shortTrailTakeProfitExecuted.set(i,Â executed)
Â Â Â Â ifÂ (executed)
Â Â Â Â Â Â Â Â shortTrailTakeProfitExecutedCountÂ :=Â shortTrailTakeProfitExecutedCountÂ +Â 1
//Â CheckÂ ifÂ theÂ i-thÂ TakeÂ ProfitÂ targetÂ wasÂ executed
longIthTrailTakeProfitExecuted(intÂ i)Â =>
Â Â Â Â numOfTakeProfitTargetsÂ >=Â iÂ ?Â longTrailTakeProfitExecuted.get(iÂ -Â 1)Â :Â false
shortIthTrailTakeProfitExecuted(intÂ i)Â =>
Â Â Â Â numOfTakeProfitTargetsÂ >=Â iÂ ?Â shortTrailTakeProfitExecuted.get(iÂ -Â 1)Â :Â false
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ›‘Â STOPÂ LOSS
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ stopÂ lossÂ logicÂ implementationÂ basedÂ onÂ theÂ methodÂ andÂ theÂ trailingÂ mode
//Â Dependencies:Â VOLATILITY,Â DISTANCE,Â ENTRY,Â TAKEÂ PROFITÂ 1
//Â Results:Â longStopLossPrice,Â shortStopLossPrice,Â longStopLossRatio,Â shortStopLossRatio,Â longEntryStopLossRatio,Â shortEntryStopLossPerc
//Â INPUTÂ ===============================================================================================================
stopLossColorÂ =Â input.color(defvalÂ =Â color.new(color.maroon,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â StopÂ LossÂ Color',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ stopÂ lossÂ price.',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')
varÂ longStopLossDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'ATR',Â titleÂ =Â 'StopÂ LossÂ DistanceÂ Method',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS',Â 'HHLL'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ distanceÂ ofÂ theÂ stopÂ lossÂ priceÂ target.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV),Â TickÂ basedÂ (TICKS)Â orÂ HighestÂ high/LowestÂ lowÂ (HHLL).',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'),
Â Â distMulÂ =Â input.float(defvalÂ =Â 3.0,Â titleÂ =Â 'â€ƒâ€ƒDistÂ Mul|LenÂ Long/Shortâ€ƒâ€ƒ',Â minvalÂ =Â 0.05,Â stepÂ =Â 0.05,Â inlineÂ =Â 'StopÂ LossÂ DistanceÂ Perc',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'))
varÂ stopLossMarSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'ATR',Â titleÂ =Â 'MarginÂ DistanceÂ Methodâ€‹â€‹',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ marginÂ toÂ offsetÂ theÂ distanceÂ ofÂ theÂ stopÂ lossÂ priceÂ target.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'),
Â Â distMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'StopÂ LossÂ DistanceÂ Margin',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 0.5,Â titleÂ =Â 'MarÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹',Â stepÂ =Â 0.5,Â tooltipÂ =Â 'TheÂ marginÂ multiplierÂ toÂ defineÂ theÂ stopÂ lossÂ distanceÂ offset.',Â inlineÂ =Â 'StopÂ LossÂ DistanceÂ Margin',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')Â :Â na)
varÂ stopLossRestrictSettingsÂ =Â dr.RestrictSettings.new(
Â Â restrDistMethodÂ =Â input.string(defvalÂ =Â 'PERC',Â titleÂ =Â 'RestrictÂ DistanceÂ Methodâ€‹â€‹',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ maximum/minimumÂ distanceÂ ofÂ theÂ stopÂ lossÂ price.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'),
Â Â minDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'StopÂ LossÂ MinÂ Distance',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'MinÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ minimumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â ThisÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ theÂ stopÂ lossÂ willÂ notÂ beÂ placedÂ tooÂ closeÂ fromÂ theÂ entryÂ price.Â Otherwise,Â aÂ tightÂ stopÂ lossÂ priceÂ wouldÂ makeÂ theÂ stopÂ lossÂ toÂ easilyÂ beÂ reachedÂ duringÂ volatileÂ marketÂ conditions.',Â inlineÂ =Â 'StopÂ LossÂ MinÂ Distance',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')Â :Â na,
Â Â maxDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'StopÂ LossÂ MaxÂ Distance',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 10.0,Â titleÂ =Â 'MaxÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ maximumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â ThisÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ theÂ stopÂ lossÂ willÂ notÂ beÂ placedÂ tooÂ farÂ fromÂ theÂ entryÂ price.Â Otherwise,Â aÂ looseÂ stopÂ lossÂ priceÂ wouldÂ increaseÂ theÂ maxÂ drawdownÂ andÂ lossesÂ whenÂ itÂ isÂ reached.',Â inlineÂ =Â 'StopÂ LossÂ MaxÂ Distance',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')Â :Â na)
varÂ shortStopLossDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â longStopLossDistSettings.distMethod,
Â Â distMulÂ =Â input.float(defvalÂ =Â 3.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 0.05,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'TheÂ distanceÂ multiplierÂ toÂ defineÂ theÂ long/shortÂ stopÂ lossÂ priceÂ fromÂ theÂ closeÂ priceÂ whenÂ theÂ openÂ signalÂ occursÂ orÂ fromÂ theÂ barrierÂ priceÂ whenÂ trailing.Â TheÂ multiplierÂ willÂ beÂ appliedÂ toÂ theÂ unitÂ priceÂ thatÂ isÂ definedÂ byÂ theÂ distanceÂ methodÂ thatÂ isÂ used.Â IfÂ theÂ HHLLÂ methodÂ isÂ used,Â thenÂ theÂ lengthÂ willÂ defineÂ theÂ windowÂ forÂ theÂ highestÂ highÂ andÂ lowestÂ lowÂ calculations.',Â inlineÂ =Â 'StopÂ LossÂ DistanceÂ Perc',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'))
stopLossMoveActModeÂ =Â input.string(defvalÂ =Â 'OFF',Â titleÂ =Â 'MoveÂ ActivationÂ Mode',Â optionsÂ =Â ['OFF',Â 'ONCETP',Â 'ONCEPRICE',Â 'MULTITP',Â 'MULTIPRICE'],Â tooltipÂ =Â 'MoveÂ theÂ stopÂ lossÂ toÂ theÂ entryÂ priceÂ (a.k.aÂ breakeven)Â whenÂ theÂ activationÂ takeÂ profitÂ priceÂ targetÂ isÂ reachedÂ (ONCETP),Â orÂ moveÂ theÂ stopÂ lossÂ toÂ theÂ entryÂ priceÂ (a.k.aÂ breakeven)Â whenÂ theÂ currentÂ priceÂ movesÂ awayÂ fromÂ theÂ entryÂ byÂ aÂ distanceÂ (ONCEPRICE),Â orÂ moveÂ theÂ stopÂ lossÂ toÂ theÂ previousÂ takeÂ profitÂ priceÂ targetÂ everyÂ timeÂ aÂ newÂ takeÂ profitÂ isÂ reachedÂ (MULTITP),Â orÂ moveÂ theÂ stopÂ lossÂ toÂ theÂ previousÂ distanceÂ fromÂ entryÂ priceÂ everyÂ timeÂ theÂ priceÂ movesÂ awayÂ fromÂ theÂ entryÂ byÂ aÂ distanceÂ (MULTIPRICE).Â Thus,Â moreÂ thanÂ oneÂ takeÂ profitÂ priceÂ targetÂ isÂ neededÂ toÂ seeÂ aÂ differenceÂ betweenÂ theÂ ONCETPÂ andÂ MULTITPÂ modes!Â IfÂ bothÂ moveÂ andÂ trailingÂ areÂ activatedÂ theÂ stopÂ lossÂ isÂ definedÂ byÂ theÂ moreÂ strictÂ priceÂ atÂ anyÂ givenÂ time.',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')
stopLossMoveTPActNumÂ =Â input.int(defvalÂ =Â 1,Â titleÂ =Â 'â€ƒâ€ƒActÂ TakeÂ ProfitÂ #â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ TakeÂ ProfitÂ numberÂ (upÂ toÂ theÂ "TakeÂ ProfitÂ Targets"Â numberÂ setÂ inÂ TAKEÂ PROFITÂ section)Â thatÂ willÂ activateÂ theÂ movementÂ ofÂ theÂ stopÂ lossÂ toÂ theÂ entryÂ priceÂ afterÂ itÂ isÂ reached.Â TheÂ MoveÂ ActivationÂ shouldÂ beÂ setÂ toÂ "ONCE".',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')
varÂ stopLossMoveDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'PERC',Â titleÂ =Â 'â€ƒâ€ƒActÂ PriceÂ DistanceÂ Method',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ distanceÂ ofÂ theÂ currentÂ priceÂ fromÂ entry.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR)Â orÂ StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'),
Â Â distMulÂ =Â input.float(defvalÂ =Â 2.0,Â titleÂ =Â 'â€ƒâ€ƒâ€ƒâ€ƒPriceÂ DistÂ Mul',Â minvalÂ =Â 0.01,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'TheÂ distanceÂ multiplierÂ toÂ defineÂ theÂ activationÂ priceÂ fromÂ theÂ entryÂ inÂ orderÂ toÂ moveÂ theÂ stopÂ lossÂ toÂ breakeven.Â TheÂ multiplierÂ willÂ beÂ appliedÂ toÂ theÂ unitÂ priceÂ thatÂ isÂ definedÂ byÂ theÂ distanceÂ methodÂ thatÂ isÂ used.Â IfÂ theÂ HHLLÂ methodÂ isÂ used,Â thenÂ theÂ lengthÂ willÂ defineÂ theÂ windowÂ forÂ theÂ highestÂ highÂ andÂ lowestÂ lowÂ calculations.',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'))
stopLossTrailActModeÂ =Â input.string(defvalÂ =Â 'OFF',Â titleÂ =Â 'TrailÂ ActivationÂ Mode',Â optionsÂ =Â ['OFF',Â 'START',Â 'TP'],Â tooltipÂ =Â 'EnablesÂ theÂ trailingÂ forÂ theÂ stopÂ lossÂ fromÂ theÂ veryÂ beginningÂ ofÂ theÂ entryÂ orderÂ (START),Â orÂ whenÂ theÂ activationÂ takeÂ profitÂ priceÂ targetÂ isÂ reachedÂ (TP)Â orÂ notÂ atÂ allÂ (OFF).',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')
stopLossTrailTPActNumÂ =Â input.int(defvalÂ =Â 1,Â titleÂ =Â 'â€ƒâ€ƒActÂ TakeÂ ProfitÂ #â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ TakeÂ ProfitÂ numberÂ (upÂ toÂ theÂ "TakeÂ ProfitÂ Targets"Â numberÂ setÂ inÂ TAKEÂ PROFITÂ section)Â thatÂ willÂ activateÂ theÂ trailingÂ ofÂ theÂ stopÂ lossÂ afterÂ itÂ isÂ reached.Â TheÂ TrailingÂ ActivationÂ shouldÂ beÂ setÂ toÂ "TP".',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')
stopLossTrailBarrierÂ =Â input.string(defvalÂ =Â 'REAR',Â titleÂ =Â 'â€ƒâ€ƒTrailÂ Barrierâ€‹â€‹â€‹',Â optionsÂ =Â ['FRONT',Â 'REAR'],Â tooltipÂ =Â 'TheÂ priceÂ referenceÂ thatÂ willÂ beÂ usedÂ forÂ theÂ stopÂ lossÂ trailingÂ logic.Â ForÂ exitingÂ fromÂ aÂ position,Â followÂ theÂ highÂ forÂ longÂ andÂ lowÂ forÂ shortÂ (FRONT),Â orÂ followÂ theÂ lowÂ forÂ longÂ andÂ theÂ highÂ forÂ shortÂ (REAR).',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')
varÂ longStopLossStepTrailDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'OFF',Â titleÂ =Â 'TrailÂ StepÂ Mode',Â optionsÂ =Â ['ON',Â 'OFF'],Â tooltipÂ =Â 'WhenÂ stopÂ lossÂ trailiningÂ isÂ activatedÂ theÂ distanceÂ willÂ trailÂ theÂ priceÂ accordingÂ toÂ theÂ stopÂ lossÂ methodÂ soÂ itÂ maintainsÂ itsÂ maximumÂ valueÂ fromÂ theÂ currentÂ high/lowÂ (OFF),Â orÂ theÂ distanceÂ willÂ changeÂ everyÂ timeÂ aÂ newÂ takeÂ profitÂ isÂ reachedÂ andÂ willÂ addÂ theÂ correspondingÂ stepÂ valueÂ toÂ theÂ previousÂ (ON).Â Thus,Â moreÂ thanÂ oneÂ takeÂ profitÂ priceÂ targetÂ isÂ neededÂ toÂ seeÂ aÂ differenceÂ betweenÂ twoÂ modes!Â IfÂ bothÂ moveÂ andÂ trailingÂ areÂ activatedÂ theÂ stopÂ lossÂ isÂ definedÂ byÂ theÂ moreÂ strictÂ priceÂ atÂ anyÂ givenÂ time.',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'),
Â Â distMulÂ =Â input.float(defvalÂ =Â 2.0,Â titleÂ =Â 'â€ƒâ€ƒStepÂ DistÂ Mul|LenÂ Long/Shortâ€‹',Â stepÂ =Â 0.05,Â inlineÂ =Â 'StepÂ DistanceÂ Perc',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'))
varÂ shortStopLossStepTrailDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â longStopLossStepTrailDistSettings.distMethod,
Â Â distMulÂ =Â input.float(defvalÂ =Â 2.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â stepÂ =Â 0.05,Â tooltipÂ =Â 'TheÂ distanceÂ multiplierÂ orÂ lengthÂ toÂ beÂ addedÂ onÂ topÂ ofÂ theÂ long/shortÂ stopÂ lossÂ distanceÂ multiplierÂ orÂ lengthÂ afterÂ aÂ takeÂ profitÂ targetÂ isÂ reached,Â toÂ defineÂ theÂ newÂ long/shortÂ stopÂ lossÂ priceÂ target.Â TheÂ multiplierÂ willÂ beÂ appliedÂ toÂ theÂ unitÂ priceÂ thatÂ isÂ definedÂ byÂ theÂ distanceÂ methodÂ thatÂ isÂ used.Â IfÂ theÂ HHLLÂ methodÂ isÂ used,Â thenÂ theÂ stepÂ lengthÂ willÂ beÂ addedÂ toÂ theÂ existingÂ lengthÂ ofÂ theÂ windowÂ forÂ theÂ highestÂ highÂ andÂ lowestÂ lowÂ calculations.',Â inlineÂ =Â 'StepÂ DistanceÂ Perc',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss'))
stopLossWaitCloseConfirmÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'WaitÂ closeÂ confirmation',Â tooltipÂ =Â 'WhenÂ thisÂ optionÂ isÂ enabled,Â theÂ stopÂ lossÂ willÂ notÂ beÂ executedÂ immediatelyÂ butÂ willÂ waitÂ forÂ theÂ barÂ closeÂ confirmation.Â ThisÂ mightÂ causeÂ theÂ strategyÂ toÂ haveÂ greaterÂ lossesÂ thanÂ theÂ expected.Â AÂ "CloseÂ Market"Â alertÂ willÂ beÂ triggeredÂ instead.',Â groupÂ =Â 'ğŸ›‘Â StopÂ Loss')
//Â LOGICÂ ===============================================================================================================
floatÂ stopLossLowestLowÂ =Â ta.lowest(low,Â math.max(longStopLossStepTrailDistSettings.distMethodÂ ==Â 'ON'Â ?Â math.floor(longStopLossDistSettings.distMul)Â +Â longTrailTakeProfitExecutedCountÂ *Â math.floor(longStopLossStepTrailDistSettings.distMul)Â :Â math.floor(longStopLossDistSettings.distMul),Â 1))
//Â CalculateÂ theÂ actualÂ longÂ stopÂ lossÂ priceÂ thatÂ isÂ lowerÂ fromÂ theÂ referenceÂ usingÂ aÂ shortÂ biasedÂ distanceÂ withÂ anÂ upwardsÂ movingÂ potential
getLongStopLossPrice(floatÂ referencePrice)Â =>
Â Â Â Â longStopLossSteppedDistÂ =Â longStopLossDistSettings.stepped_dist(stepÂ =Â longStopLossStepTrailDistSettings,Â countÂ =Â longTrailTakeProfitExecutedCount)
Â Â Â Â longStopLossSteppedDist.lower_short_biased_price(referencePrice,Â shortBiasedAuxData,Â stopLossRestrictSettings,Â stopLossMarSettings,Â stopLossLowestLow)
//Â CalculateÂ theÂ actualÂ longÂ moveÂ distanceÂ priceÂ thatÂ isÂ higherÂ fromÂ theÂ longÂ entry
getLongStopLossMoveDistPrice()Â =>
Â Â Â Â stopLossMoveDistSettings.price(longEntryPrice,Â shortBiasedAuxData)
floatÂ longStopLossMoveDistPriceÂ =Â stopLossMoveActModeÂ ==Â 'ONCEPRICE'Â orÂ stopLossMoveActModeÂ ==Â 'MULTIPRICE'Â ?Â getLongStopLossMoveDistPrice()Â :Â na
intÂ longDistMovePriceCountÂ =Â stopLossMoveActModeÂ ==Â 'MULTIPRICE'Â ?Â math.floor((highestHighSinceLongEntryÂ -Â longEntryPrice)Â /Â longStopLossMoveDistPrice)Â :Â na
intÂ chgLongDistMovePriceCountÂ =Â ta.change(longDistMovePriceCount)
varÂ boolÂ stopLossAdjustmentIsNeededÂ =Â (entryOrderTypeÂ ==Â 'MARKET'Â orÂ entryOrderTypeÂ ==Â 'STOP')Â andÂ longStopLossDistSettings.distMethodÂ !=Â 'HHLL'Â andÂ stopLossTrailActModeÂ !=Â 'START'
//Â CalculateÂ theÂ stopÂ lossÂ priceÂ whenÂ enterÂ longÂ positionÂ andÂ peserveÂ itsÂ valueÂ untilÂ theÂ positionÂ closes
varÂ floatÂ longStopLossPriceÂ =Â na
ifÂ (longLimitOrStopEntryIsActiveÂ orÂ validOpenLongPosition)
Â Â Â Â longStopLossPriceÂ :=Â getLongStopLossPrice(longEntryPrice)
elseÂ ifÂ (enteredLongTradeÂ andÂ stopLossAdjustmentIsNeeded)
Â Â Â Â longStopLossPriceÂ :=Â longStopLossPriceÂ +Â (longEntryPriceÂ -Â nz(longEntryPrice[1],Â longEntryPrice))
elseÂ ifÂ (isLongPosition)
Â Â Â Â //Â TrailingÂ startsÂ whenÂ theÂ selectedÂ takeÂ profitÂ priceÂ isÂ reachedÂ ifÂ 'TP'Â modeÂ isÂ setÂ orÂ fromÂ theÂ veryÂ beginingÂ ifÂ 'START'Â modeÂ isÂ selected
Â Â Â Â boolÂ longStopLossTrailEnabledÂ =Â stopLossTrailActModeÂ ==Â 'START'Â orÂ (stopLossTrailActModeÂ ==Â 'TP'Â andÂ longIthTrailTakeProfitExecuted(stopLossTrailTPActNum))
Â Â Â Â floatÂ stopPriceÂ =Â longStopLossTrailEnabledÂ ?Â getLongStopLossPrice(getUpwardsMovingBarrierPrice(stopLossTrailBarrier))Â :Â longStopLossPrice[1]
Â Â Â Â stopPriceÂ :=Â (stopLossMoveActModeÂ ==Â 'ONCETP'Â andÂ longTrailTakeProfitExecutedCountÂ >=Â stopLossMoveTPActNum)Â orÂ (stopLossMoveActModeÂ ==Â 'ONCEPRICE'Â andÂ (highestHighSinceLongEntryÂ -Â longEntryPrice)Â >=Â longStopLossMoveDistPrice)Â orÂ (stopLossMoveActModeÂ ==Â 'MULTITP'Â andÂ longTrailTakeProfitExecutedCountÂ ==Â 1)Â ?Â math.max(stopPrice,Â longEntryPrice)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â stopLossMoveActModeÂ ==Â 'MULTITP'Â andÂ longTrailTakeProfitExecutedCountÂ >Â 1Â ?Â math.max(stopPrice,Â longTakeProfitPrices.get(longTrailTakeProfitExecutedCountÂ -Â 2))
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â stopLossMoveActModeÂ ==Â 'MULTIPRICE'Â andÂ chgLongDistMovePriceCountÂ >Â 0Â ?Â math.max(stopPrice,Â stopPriceÂ +Â longDistMovePriceCountÂ *Â longStopLossMoveDistPrice)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â stopPrice
Â Â Â Â longStopLossPriceÂ :=Â math.max(stopPrice,Â nz(longStopLossPrice[1],Â minLimitFloat))
floatÂ longStopLossRatioÂ =Â (longEntryPriceÂ -Â longStopLossPrice)Â /Â longEntryPrice
floatÂ longEntryStopLossRatioÂ =Â ta.valuewhen(enteredLongTrade,Â longStopLossRatio[1],Â 0)
floatÂ stopLossHighestHighÂ =Â ta.highest(high,Â math.max(shortStopLossStepTrailDistSettings.distMethodÂ ==Â 'ON'Â ?Â math.floor(shortStopLossDistSettings.distMul)Â +Â shortTrailTakeProfitExecutedCountÂ *Â math.floor(shortStopLossStepTrailDistSettings.distMul)Â :Â math.floor(shortStopLossDistSettings.distMul),Â 1))
//Â CalculateÂ theÂ actualÂ shortÂ stopÂ lossÂ priceÂ thatÂ isÂ higherÂ fromÂ theÂ referenceÂ usingÂ aÂ longÂ biasedÂ distanceÂ withÂ aÂ downwardsÂ movingÂ potential
getShortStopLossPrice(floatÂ referencePrice)Â =>
Â Â Â Â shortStopLossSteppedDistÂ =Â shortStopLossDistSettings.stepped_dist(stepÂ =Â shortStopLossStepTrailDistSettings,Â countÂ =Â shortTrailTakeProfitExecutedCount)
Â Â Â Â shortStopLossSteppedDist.higher_long_biased_price(referencePrice,Â longBiasedAuxData,Â stopLossRestrictSettings,Â stopLossMarSettings,Â stopLossHighestHigh)
//Â CalculateÂ theÂ actualÂ shortÂ moveÂ distanceÂ thatÂ isÂ lowerÂ fromÂ theÂ shortÂ entry
getShortStopLossMoveDistPrice()Â =>
Â Â Â Â stopLossMoveDistSettings.price(shortEntryPrice,Â longBiasedAuxData)
floatÂ shortStopLossMoveDistPriceÂ =Â stopLossMoveActModeÂ ==Â 'ONCEPRICE'Â orÂ stopLossMoveActModeÂ ==Â 'MULTIPRICE'Â ?Â getShortStopLossMoveDistPrice()Â :Â na
intÂ shortDistMovePriceCountÂ =Â stopLossMoveActModeÂ ==Â 'MULTIPRICE'Â ?Â math.floor((shortEntryPriceÂ -Â lowestLowSinceShortEntry)Â /Â shortStopLossMoveDistPrice)Â :Â na
intÂ chgShortDistMovePriceCountÂ =Â ta.change(shortDistMovePriceCount)
//Â CalculateÂ theÂ stopÂ lossÂ priceÂ whenÂ enterÂ shortÂ positionÂ andÂ peserveÂ itsÂ valueÂ untilÂ theÂ positionÂ closes
varÂ floatÂ shortStopLossPriceÂ =Â na
ifÂ (shortLimitOrStopEntryIsActiveÂ orÂ validOpenShortPosition)
Â Â Â Â shortStopLossPriceÂ :=Â getShortStopLossPrice(shortEntryPrice)
elseÂ ifÂ (enteredShortTradeÂ andÂ stopLossAdjustmentIsNeeded)
Â Â Â Â shortStopLossPriceÂ :=Â shortStopLossPriceÂ +Â (shortEntryPriceÂ -Â nz(shortEntryPrice[1],Â shortEntryPrice))
elseÂ ifÂ (isShortPosition)
Â Â Â Â //Â TrailingÂ startsÂ whenÂ theÂ selectedÂ takeÂ profitÂ priceÂ isÂ reachedÂ ifÂ 'TP'Â modeÂ isÂ setÂ orÂ fromÂ theÂ veryÂ beginingÂ ifÂ 'START'Â modeÂ isÂ selected
Â Â Â Â boolÂ shortStopLossTrailEnabledÂ =Â stopLossTrailActModeÂ ==Â 'START'Â orÂ (stopLossTrailActModeÂ ==Â 'TP'Â andÂ shortIthTrailTakeProfitExecuted(stopLossTrailTPActNum))
Â Â Â Â floatÂ stopPriceÂ =Â shortStopLossTrailEnabledÂ ?Â getShortStopLossPrice(getDownwardsMovingBarrierPrice(stopLossTrailBarrier))Â :Â shortStopLossPrice[1]
Â Â Â Â stopPriceÂ :=Â (stopLossMoveActModeÂ ==Â 'ONCETP'Â andÂ shortTrailTakeProfitExecutedCountÂ >=Â stopLossMoveTPActNum)Â orÂ (stopLossMoveActModeÂ ==Â 'ONCEPRICE'Â andÂ (shortEntryPriceÂ -Â lowestLowSinceShortEntry)Â >=Â shortStopLossMoveDistPrice)Â orÂ (stopLossMoveActModeÂ ==Â 'MULTITP'Â andÂ shortTrailTakeProfitExecutedCountÂ ==Â 1)Â ?Â math.min(stopPrice,Â shortEntryPrice)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â stopLossMoveActModeÂ ==Â 'MULTITP'Â andÂ shortTrailTakeProfitExecutedCountÂ >Â 1Â ?Â math.min(stopPrice,Â shortTakeProfitPrices.get(shortTrailTakeProfitExecutedCountÂ -Â 2))
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â stopLossMoveActModeÂ ==Â 'MULTIPRICE'Â andÂ chgShortDistMovePriceCountÂ >Â 0Â ?Â math.min(stopPrice,Â stopPriceÂ -Â chgShortDistMovePriceCountÂ *Â shortStopLossMoveDistPrice)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â stopPrice
Â Â Â Â shortStopLossPriceÂ :=Â math.min(stopPrice,Â nz(shortStopLossPrice[1],Â maxLimitFloat))
floatÂ shortStopLossRatioÂ =Â (shortStopLossPriceÂ -Â shortEntryPrice)Â /Â shortEntryPrice
floatÂ shortEntryStopLossRatioÂ =Â ta.valuewhen(enteredShortTrade,Â shortStopLossRatio[1],Â 0)
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ› ï¸Â STRATEGYÂ 2
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ closeÂ positionÂ logic.Â ThisÂ isÂ implementedÂ basedÂ onÂ dealÂ conditionsÂ definedÂ internallyÂ (inÂ thisÂ script)Â orÂ externalyÂ (basedÂ onÂ conditionsÂ thatÂ takeÂ asÂ inputÂ otherÂ indicator)
//Â Dependencies:Â FILTERS,Â STRATEGYÂ 1,Â ENTRY
//Â Results:Â validCloseLongPosition,Â validCloseShortPosition
//Â INPUTÂ ===============================================================================================================
closeEarlyEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'CloseÂ EarlyÂ #Â ofÂ barsâ€ƒâ€ƒâ€ƒ',Â inlineÂ =Â 'CloseÂ Early',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
closeEarlyBarsÂ =Â input.int(defvalÂ =Â 7,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'EmitÂ closeÂ positionÂ signalÂ ifÂ theÂ givenÂ numberÂ ofÂ barsÂ haveÂ passedÂ sinceÂ theÂ entryÂ andÂ theÂ activationÂ takeÂ profitÂ priceÂ targetÂ hasÂ notÂ beenÂ reachedÂ yet.',Â inlineÂ =Â 'CloseÂ Early',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
closeEarlyTPActNumÂ =Â input.int(defvalÂ =Â 1,Â titleÂ =Â 'â€ƒâ€ƒActÂ TakeÂ ProfitÂ #â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ TakeÂ ProfitÂ numberÂ (upÂ toÂ theÂ "TakeÂ ProfitÂ Targets"Â numberÂ setÂ inÂ TAKEÂ PROFITÂ section)Â thatÂ willÂ activateÂ theÂ closeÂ earlyÂ ifÂ itÂ isÂ notÂ reachedÂ withinÂ theÂ givenÂ numberÂ ofÂ barsÂ fromÂ theÂ entry.',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
closeAtSessionEndÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'CloseÂ atÂ SessionÂ End',Â tooltipÂ =Â 'CloseÂ allÂ positionsÂ atÂ theÂ marketÂ priceÂ atÂ theÂ endÂ ofÂ eachÂ sessionÂ orÂ theÂ endÂ ofÂ timeÂ window.',Â groupÂ =Â 'ğŸ› ï¸Â Strategy')
//Â LOGICÂ ===============================================================================================================
boolÂ closeLongPositionÂ =Â endLongDealÂ orÂ (closeEarlyEnabledÂ ?Â bar_indexÂ -Â longEntryBarIdÂ ==Â closeEarlyBarsÂ andÂ notÂ longIthTrailTakeProfitExecuted(closeEarlyTPActNum)Â :Â false)
boolÂ closeShortPositionÂ =Â endShortDealÂ orÂ (closeEarlyEnabledÂ ?Â bar_indexÂ -Â shortEntryBarIdÂ ==Â closeEarlyBarsÂ andÂ notÂ shortIthTrailTakeProfitExecuted(closeEarlyTPActNum)Â :Â false)
boolÂ closeAllPositionsÂ =Â closeAtSessionEndÂ andÂ notÂ timeFilterApproval
//Â CancelÂ theÂ previousÂ endÂ dealÂ conditionÂ whenÂ usingÂ limitÂ orÂ stopÂ forÂ exitÂ (ifÂ notÂ alreadyÂ exitedÂ theÂ position)
boolÂ cnlCloseLongPositionÂ =Â (timeFilterApprovalÂ andÂ cnlEndLongDeal)Â orÂ (notÂ timeFilterApprovalÂ andÂ timeFilterApproval[1])
boolÂ cnlCloseShortPositionÂ =Â (timeFilterApprovalÂ andÂ cnlEndShortDeal)Â orÂ (notÂ timeFilterApprovalÂ andÂ timeFilterApproval[1])
//Â TheÂ closeÂ signalsÂ whenÂ alreadyÂ intoÂ aÂ positionÂ toÂ thatÂ directionÂ orÂ ifÂ youÂ wantÂ toÂ startÂ aÂ positionÂ toÂ theÂ otherÂ direction
boolÂ validCloseLongPositionÂ =Â closeLongPositionÂ andÂ isLongPosition
boolÂ validCloseShortPositionÂ =Â closeShortPositionÂ andÂ isShortPosition
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸŸªÂ EXIT
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ exitÂ logicÂ implementationÂ basedÂ onÂ theÂ orderÂ type
//Â Dependencies:Â TRACKÂ POSITION,Â VOLATILITY,Â DISTANCE,Â STRATEGYÂ 2
//Â Results:Â longLimitOrStopExitPrice,Â shortLimitOrStopExitPrice,Â longLimitExitIsActive,Â shortLimitExitIsActive,Â longExitPrice,Â shortExitPrice
//Â INPUTÂ ===============================================================================================================
longExitColorÂ =Â input.color(defvalÂ =Â color.new(#D500F9,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â ExitÂ ColorÂ Long/Shortâ€ƒâ€ƒâ€ƒâ€ƒ',Â inlineÂ =Â 'Exit',Â groupÂ =Â 'ğŸŸªÂ Exit')
shortExitColorÂ =Â input.color(defvalÂ =Â color.new(#D500F9,Â 0),Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ long/shortÂ limitÂ andÂ stopÂ exitÂ prices.',Â inlineÂ =Â 'Exit',Â groupÂ =Â 'ğŸŸªÂ Exit')
exitOrderTypeÂ =Â input.string(defvalÂ =Â 'MARKET',Â titleÂ =Â 'OrderÂ Typeâ€‹â€‹',Â optionsÂ =Â ['MARKET',Â 'LIMIT',Â 'STOP'],Â tooltipÂ =Â 'UseÂ marketÂ orderÂ toÂ exitÂ atÂ theÂ openÂ ofÂ theÂ nextÂ barÂ (MARKET),Â orÂ useÂ limitÂ orderÂ toÂ exitÂ atÂ aÂ "better"Â priceÂ definedÂ byÂ theÂ distanceÂ fromÂ theÂ closeÂ priceÂ andÂ theÂ limitÂ modeÂ (LIMIT),Â orÂ useÂ stopÂ marketÂ orderÂ toÂ exitÂ atÂ aÂ "worst"Â priceÂ definedÂ byÂ theÂ distanceÂ fromÂ theÂ closeÂ priceÂ andÂ theÂ limitÂ modeÂ (STOP).Â LimitÂ andÂ stopÂ ordersÂ lastÂ untilÂ theyÂ areÂ filledÂ orÂ canceled.',Â groupÂ =Â 'ğŸŸªÂ Exit')
exitLimitModeÂ =Â input.string(defvalÂ =Â 'FIXED',Â titleÂ =Â 'LimitÂ Modeâ€‹â€‹',Â optionsÂ =Â ['FIXED',Â 'TRAIL'],Â tooltipÂ =Â 'WhenÂ youÂ useÂ limitÂ orÂ stopÂ ordersÂ toÂ exit,Â useÂ aÂ fixedÂ priceÂ definedÂ byÂ theÂ distanceÂ andÂ theÂ closeÂ priceÂ whenÂ theÂ openÂ signalÂ sÂ (FIXED),Â orÂ trailÂ byÂ followingÂ theÂ priceÂ toÂ theÂ directionÂ ofÂ theÂ exitÂ forÂ limitÂ ordersÂ orÂ theÂ otherÂ directionÂ ofÂ theÂ exitÂ forÂ stopÂ ordersÂ (TRAIL).',Â groupÂ =Â 'ğŸŸªÂ Exit')
exitTrailBarrierÂ =Â input.string(defvalÂ =Â 'FRONT',Â titleÂ =Â 'â€ƒâ€ƒTrailÂ Barrierâ€‹â€‹â€‹â€‹',Â optionsÂ =Â ['FRONT',Â 'REAR'],Â tooltipÂ =Â 'TheÂ priceÂ referenceÂ thatÂ willÂ beÂ usedÂ forÂ theÂ exitÂ trailingÂ logic.Â ForÂ exitingÂ fromÂ aÂ positionÂ withÂ aÂ LIMITÂ order,Â followÂ theÂ lowÂ forÂ longÂ andÂ highÂ forÂ shortÂ (FRONT),Â orÂ followÂ theÂ highÂ forÂ longÂ andÂ theÂ lowÂ forÂ shortÂ (REAR).Â ForÂ theÂ STOPÂ ordersÂ theÂ logicÂ isÂ reversed.',Â groupÂ =Â 'ğŸŸªÂ Exit')
varÂ exitDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'ATR',Â titleÂ =Â 'DistanceÂ Methodâ€‹â€‹',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS',Â 'HHLL'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ distanceÂ ofÂ theÂ limitÂ andÂ stopÂ exit.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV),Â TickÂ basedÂ (TICKS)Â orÂ HighestÂ high/LowestÂ lowÂ (HHLL).',Â groupÂ =Â 'ğŸŸªÂ Exit'),
Â Â distMulÂ =Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'â€ƒâ€ƒDistÂ Mul|Lenâ€‹â€‹',Â minvalÂ =Â 0.01,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'TheÂ distanceÂ multiplierÂ toÂ defineÂ theÂ exitÂ priceÂ fromÂ theÂ closeÂ priceÂ whenÂ theÂ closeÂ signalÂ occursÂ orÂ fromÂ theÂ barrierÂ priceÂ whenÂ trailing.Â TheÂ multiplierÂ willÂ beÂ appliedÂ toÂ theÂ unitÂ priceÂ thatÂ isÂ definedÂ byÂ theÂ distanceÂ methodÂ thatÂ isÂ used.Â IfÂ theÂ HHLLÂ methodÂ isÂ used,Â thenÂ theÂ lengthÂ willÂ defineÂ theÂ windowÂ forÂ theÂ highestÂ highÂ andÂ lowestÂ lowÂ calculations.',Â groupÂ =Â 'ğŸŸªÂ Exit'))
varÂ exitMarSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'TICKS',Â titleÂ =Â 'MarginÂ DistanceÂ Methodâ€‹â€‹â€‹',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ marginÂ toÂ offsetÂ theÂ distanceÂ ofÂ theÂ exitÂ priceÂ target.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸŸªÂ Exit'),
Â Â distMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'DistanceÂ ExitÂ Margin',Â groupÂ =Â 'ğŸŸªÂ Exit')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 5.0,Â titleÂ =Â 'MarÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹â€‹',Â stepÂ =Â 0.5,Â tooltipÂ =Â 'TheÂ marginÂ multiplierÂ toÂ defineÂ theÂ exitÂ distanceÂ offset.',Â inlineÂ =Â 'DistanceÂ ExitÂ Margin',Â groupÂ =Â 'ğŸŸªÂ Exit')Â :Â na)
varÂ exitRestrictSettingsÂ =Â dr.RestrictSettings.new(
Â Â restrDistMethodÂ =Â input.string(defvalÂ =Â 'PERC',Â titleÂ =Â 'RestrictÂ DistanceÂ Methodâ€‹â€‹â€‹',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ maximum/minimumÂ distanceÂ ofÂ theÂ exitÂ price.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸŸªÂ Exit'),
Â Â minDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'ExitÂ MinÂ Distance',Â groupÂ =Â 'ğŸŸªÂ Exit')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'MinÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹â€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ minimumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â ThisÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ theÂ exitÂ willÂ notÂ beÂ placedÂ tooÂ closeÂ fromÂ theÂ referenceÂ price.Â Otherwise,Â aÂ tightÂ exitÂ priceÂ wouldÂ makeÂ theÂ exitÂ toÂ easilyÂ beÂ reachedÂ duringÂ volatileÂ marketÂ conditions.',Â inlineÂ =Â 'ExitÂ MinÂ Distance',Â groupÂ =Â 'ğŸŸªÂ Exit')Â :Â na,
Â Â maxDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'ExitÂ MaxÂ Distance',Â groupÂ =Â 'ğŸŸªÂ Exit')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 4.0,Â titleÂ =Â 'MaxÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹â€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ maximumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â ThisÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ theÂ exitÂ willÂ notÂ beÂ placedÂ tooÂ farÂ fromÂ theÂ referenceÂ price.Â Otherwise,Â aÂ looseÂ exitÂ priceÂ wouldÂ riskÂ toÂ notÂ beÂ reachedÂ inÂ aÂ timelyÂ manner.',Â inlineÂ =Â 'ExitÂ MaxÂ Distance',Â groupÂ =Â 'ğŸŸªÂ Exit')Â :Â na)
treatOpenAsCancelÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'TreatÂ OpenÂ asÂ Cancel',Â tooltipÂ =Â 'IfÂ enabledÂ theÂ invalidÂ openÂ positionÂ signalsÂ willÂ beÂ treatedÂ asÂ cancelÂ closeÂ signalsÂ toÂ cancelÂ stopÂ exitÂ orders.',Â groupÂ =Â 'ğŸŸªÂ Exit')
//Â LOGICÂ ===============================================================================================================
//Â TheÂ longÂ cancelÂ closeÂ signal
varÂ boolÂ validCnlCloseLongPositionÂ =Â false
//Â CountÂ howÂ farÂ areÂ theÂ lastÂ longÂ validÂ closeÂ andÂ exitÂ signals
intÂ barsSinceValidCloseLongÂ =Â nz(ta.barssince(validCloseLongPositionÂ orÂ validOpenShortPosition),Â maxLimitInt)
intÂ barsSinceValidCnlCloseLongÂ =Â nz(ta.barssince(validCnlCloseLongPosition),Â maxLimitInt)
boolÂ closeLongIsActiveÂ =Â barsSinceValidCnlCloseLongÂ >Â barsSinceValidCloseLongÂ //Â validCancelCloseÂ ->Â validClose
boolÂ exitLongIsPendingÂ =Â barsSinceCompletedLongÂ >=Â barsSinceValidCloseLongÂ //Â completedÂ ->Â validClose
//Â ValidateÂ theÂ longÂ cancelÂ closeÂ signalÂ whenÂ alreadyÂ intoÂ aÂ position
validCnlCloseLongPositionÂ :=Â exitOrderTypeÂ !=Â 'MARKET'Â ?Â (cnlCloseLongPositionÂ orÂ (treatOpenAsCancelÂ ?Â timeFilterApprovalÂ andÂ startLongDealÂ :Â false))Â andÂ isLongPositionÂ andÂ closeLongIsActiveÂ andÂ exitLongIsPendingÂ andÂ notÂ validCloseLongPositionÂ :Â false
floatÂ exitLowestLowÂ =Â ta.lowest(low,Â math.max(math.floor(exitDistSettings.distMul),Â 1))
//Â CalculateÂ theÂ actualÂ longÂ exitÂ priceÂ fromÂ theÂ referenceÂ usingÂ aÂ shortÂ biasedÂ distanceÂ withÂ anÂ upwardsÂ movingÂ potential
getLongExitLowerPrice(floatÂ referencePrice)Â =>
Â Â Â Â exitDistSettings.lower_short_biased_price(referencePrice,Â shortBiasedAuxData,Â exitRestrictSettings,Â exitMarSettings,Â exitLowestLow)
floatÂ exitHighestHighÂ =Â ta.highest(high,Â math.max(math.floor(exitDistSettings.distMul),Â 1))
//Â CalculateÂ theÂ actualÂ longÂ exitÂ priceÂ fromÂ theÂ referenceÂ usingÂ aÂ shortÂ biasedÂ distanceÂ withÂ aÂ downwardsÂ movingÂ potential
getLongExitHigherPrice(floatÂ referencePrice)Â =>
Â Â Â Â exitDistSettings.higher_short_biased_price(referencePrice,Â shortBiasedAuxData,Â exitRestrictSettings,Â exitMarSettings,Â exitHighestHigh)
varÂ floatÂ longLimitOrStopExitPriceÂ =Â na
boolÂ isFirstValidCloseLongPositionÂ =Â exitOrderTypeÂ !=Â 'MARKET'Â ?Â validCloseLongPositionÂ andÂ isLongPositionÂ andÂ na(longLimitOrStopExitPrice[1])Â andÂ notÂ (validOpenShortPositionÂ andÂ entryOrderTypeÂ ==Â 'MARKET')Â :Â false
boolÂ tryExitLongPositionÂ =Â exitOrderTypeÂ !=Â 'MARKET'Â ?Â isLongPositionÂ andÂ notÂ na(longLimitOrStopExitPrice[1])Â andÂ notÂ validCnlCloseLongPositionÂ :Â false
longLimitOrStopExitPriceÂ :=Â ifÂ (isFirstValidCloseLongPosition)
Â Â Â Â ifÂ (exitOrderTypeÂ ==Â 'LIMIT')
Â Â Â Â Â Â Â Â getLongExitHigherPrice(close)
Â Â Â Â elseÂ ifÂ (exitOrderTypeÂ ==Â 'STOP')
Â Â Â Â Â Â Â Â getLongExitLowerPrice(close)
elseÂ ifÂ (tryExitLongPosition)
Â Â Â Â ifÂ (exitLimitModeÂ ==Â 'TRAIL'Â orÂ (exitLimitModeÂ ==Â 'FIXED'Â andÂ validCloseLongPosition))
Â Â Â Â Â Â Â Â ifÂ (exitOrderTypeÂ ==Â 'LIMIT')
Â Â Â Â Â Â Â Â Â Â Â Â math.min(getLongExitHigherPrice(getDownwardsMovingBarrierPrice(exitTrailBarrier)),Â nz(longLimitOrStopExitPrice[1],Â maxLimitFloat))
Â Â Â Â Â Â Â Â elseÂ ifÂ (exitOrderTypeÂ ==Â 'STOP')
Â Â Â Â Â Â Â Â Â Â Â Â math.max(getLongExitLowerPrice(getUpwardsMovingBarrierPrice(exitTrailBarrier)),Â nz(longLimitOrStopExitPrice[1],Â minLimitFloat))
Â Â Â Â else
Â Â Â Â Â Â Â Â nz(longLimitOrStopExitPrice[1],Â minLimitFloat)
boolÂ longLimitExitIsActiveÂ =Â notÂ na(longLimitOrStopExitPrice)
//Â TheÂ shortÂ cancelÂ closeÂ signal
varÂ boolÂ validCnlCloseShortPositionÂ =Â false
//Â CountÂ howÂ farÂ areÂ theÂ lastÂ shortÂ validÂ closeÂ andÂ exitÂ signals
intÂ barsSinceValidCloseShortÂ =Â nz(ta.barssince(validCloseShortPositionÂ orÂ validOpenLongPosition),Â maxLimitInt)
intÂ barsSinceValidCnlCloseShortÂ =Â nz(ta.barssince(validCnlCloseShortPosition),Â maxLimitInt)
boolÂ closeShortIsActiveÂ =Â barsSinceValidCnlCloseShortÂ >Â barsSinceValidCloseShortÂ //Â validCancelCloseÂ ->Â validClose
boolÂ exitShortIsPendingÂ =Â barsSinceCompletedShortÂ >=Â barsSinceValidCloseShortÂ //Â completedÂ ->Â validClose
//Â ValidateÂ theÂ shortÂ cancelÂ closeÂ signalÂ whenÂ alreadyÂ intoÂ aÂ position
validCnlCloseShortPositionÂ :=Â exitOrderTypeÂ !=Â 'MARKET'Â ?Â (cnlCloseShortPositionÂ orÂ (treatOpenAsCancelÂ ?Â timeFilterApprovalÂ andÂ startShortDealÂ :Â false))Â andÂ isShortPositionÂ andÂ closeShortIsActiveÂ andÂ exitShortIsPendingÂ andÂ notÂ validCloseShortPositionÂ :Â false
//Â CalculateÂ theÂ actualÂ shortÂ exitÂ priceÂ fromÂ theÂ referenceÂ usingÂ aÂ longÂ biasedÂ distanceÂ withÂ anÂ upwardsÂ movingÂ potential
getShortExitLowerPrice(floatÂ referencePrice)Â =>
Â Â Â Â exitDistSettings.lower_long_biased_price(referencePrice,Â longBiasedAuxData,Â exitRestrictSettings,Â exitMarSettings,Â exitLowestLow)
//Â CalculateÂ theÂ actualÂ shortÂ exitÂ priceÂ fromÂ theÂ referenceÂ usingÂ aÂ longÂ biasedÂ distanceÂ withÂ aÂ downwardsÂ movingÂ potential
getShortExitHigherPrice(floatÂ referencePrice)Â =>
Â Â Â Â exitDistSettings.higher_long_biased_price(referencePrice,Â longBiasedAuxData,Â exitRestrictSettings,Â exitMarSettings,Â exitHighestHigh)
varÂ floatÂ shortLimitOrStopExitPriceÂ =Â na
boolÂ isFirstValidCloseShortPositionÂ =Â exitOrderTypeÂ !=Â 'MARKET'Â ?Â validCloseShortPositionÂ andÂ isShortPositionÂ andÂ na(shortLimitOrStopExitPrice[1])Â andÂ notÂ (validOpenLongPositionÂ andÂ entryOrderTypeÂ ==Â 'MARKET')Â :Â false
boolÂ tryExitShortPositionÂ =Â exitOrderTypeÂ !=Â 'MARKET'Â ?Â isShortPositionÂ andÂ notÂ na(shortLimitOrStopExitPrice[1])Â andÂ notÂ validCnlCloseShortPositionÂ :Â false
shortLimitOrStopExitPriceÂ :=Â ifÂ (isFirstValidCloseShortPosition)
Â Â Â Â ifÂ (exitOrderTypeÂ ==Â 'LIMIT')
Â Â Â Â Â Â Â Â getShortExitLowerPrice(close)
Â Â Â Â elseÂ ifÂ (exitOrderTypeÂ ==Â 'STOP')
Â Â Â Â Â Â Â Â getShortExitHigherPrice(close)
elseÂ ifÂ (tryExitShortPosition)
Â Â Â Â ifÂ (exitLimitModeÂ ==Â 'TRAIL'Â orÂ (exitLimitModeÂ ==Â 'FIXED'Â andÂ validCloseShortPosition))
Â Â Â Â Â Â Â Â ifÂ (exitOrderTypeÂ ==Â 'LIMIT')
Â Â Â Â Â Â Â Â Â Â Â Â math.max(getShortExitLowerPrice(getUpwardsMovingBarrierPrice(exitTrailBarrier)),Â nz(shortLimitOrStopExitPrice[1],Â minLimitFloat))
Â Â Â Â Â Â Â Â elseÂ ifÂ (exitOrderTypeÂ ==Â 'STOP')
Â Â Â Â Â Â Â Â Â Â Â Â math.min(getShortExitHigherPrice(getDownwardsMovingBarrierPrice(exitTrailBarrier)),Â nz(shortLimitOrStopExitPrice[1],Â maxLimitFloat))
Â Â Â Â else
Â Â Â Â Â Â Â Â nz(shortLimitOrStopExitPrice[1],Â maxLimitFloat)
boolÂ shortLimitExitIsActiveÂ =Â notÂ na(shortLimitOrStopExitPrice)
//Â PriceÂ whenÂ exitedÂ aÂ positionÂ orÂ potentialÂ exitÂ priceÂ inÂ caseÂ ofÂ limitÂ orÂ stopÂ orders
floatÂ longExitPriceÂ =Â (validOpenShortPositionÂ andÂ (isLongPositionÂ orÂ exitOrderTypeÂ ==Â 'MARKET'))Â orÂ (stopLossWaitCloseConfirmÂ andÂ closeÂ <Â longStopLossPrice)Â ?Â close
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â longLimitExitIsActiveÂ ?Â longLimitOrStopExitPrice
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â na
floatÂ shortExitPriceÂ =Â (validOpenLongPositionÂ andÂ (isShortPositionÂ orÂ exitOrderTypeÂ ==Â 'MARKET'))Â orÂ (stopLossWaitCloseConfirmÂ andÂ closeÂ >Â shortStopLossPrice)Â ?Â close
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â shortLimitExitIsActiveÂ ?Â shortLimitOrStopExitPrice
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :Â na
//Â PLOTÂ ================================================================================================================
ifÂ (validCloseLongPositionÂ andÂ showCloseLabelsÂ andÂ barstate.isconfirmed)
Â Â Â Â label.new(xÂ =Â bar_index,Â yÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â ?Â longLimitOrStopExitPriceÂ :Â na,Â textÂ =Â 'Close',Â ylocÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â ?Â yloc.priceÂ :Â yloc.abovebar,Â colorÂ =Â longCloseColor,Â styleÂ =Â label.style_label_down,Â textcolorÂ =Â textColor)
ifÂ (validCloseShortPositionÂ andÂ showCloseLabelsÂ andÂ barstate.isconfirmed)
Â Â Â Â label.new(xÂ =Â bar_index,Â yÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â ?Â shortLimitOrStopExitPriceÂ :Â na,Â textÂ =Â 'Close',Â ylocÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â ?Â yloc.priceÂ :Â yloc.belowbar,Â colorÂ =Â shortCloseColor,Â styleÂ =Â label.style_label_up,Â textcolorÂ =Â textColor)
ifÂ (validCnlCloseLongPositionÂ andÂ showCnlCloseLabelsÂ andÂ barstate.isconfirmed)
Â Â Â Â label.new(xÂ =Â bar_index,Â yÂ =Â longLimitOrStopExitPrice[1],Â textÂ =Â 'Cancel',Â ylocÂ =Â yloc.price,Â colorÂ =Â longCnlCloseColor,Â styleÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â ?Â label.style_label_downÂ :Â label.style_label_up,Â textcolorÂ =Â textColor)
ifÂ (validCnlCloseShortPositionÂ andÂ showCnlCloseLabelsÂ andÂ barstate.isconfirmed)
Â Â Â Â label.new(xÂ =Â bar_index,Â yÂ =Â shortLimitOrStopExitPrice[1],Â textÂ =Â 'Cancel',Â ylocÂ =Â yloc.price,Â colorÂ =Â shortCnlCloseColor,Â styleÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â ?Â label.style_label_upÂ :Â label.style_label_down,Â textcolorÂ =Â textColor)
plot(seriesÂ =Â longLimitOrStopExitPrice,Â titleÂ =Â 'LongÂ LimitÂ orÂ StopÂ ExitÂ Price',Â colorÂ =Â longExitColor,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1)
plot(seriesÂ =Â shortLimitOrStopExitPrice,Â titleÂ =Â 'ShortÂ LimitÂ orÂ StopÂ ExitÂ Price',Â colorÂ =Â shortExitColor,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1)
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ’°Â QUANTITY/RISKÂ MANAGEMENT
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ calculationÂ ofÂ theÂ quantityÂ percentageÂ thatÂ willÂ beÂ usedÂ onÂ eachÂ entry
//Â Dependencies:Â ENTRY,Â STRATEGYÂ 2,Â EXIT
//Â Results:Â longEntryBaseQuantity,Â shortEntryBaseQuantity,Â longTakeProfitQuantity,Â shortTakeProfitQuantity,Â longRemainingQuantity,Â shortRemainingQuantity,Â longRemainingQuantityRatio,Â shortRemainingQuantityRatio
importÂ jason5480/math_utils/8â€ŠasÂ math_utils
//Â INPUTÂ ===============================================================================================================
quantityMethodÂ =Â input.string(defvalÂ =Â 'RISK',Â titleÂ =Â 'QuantityÂ Method',Â optionsÂ =Â ['RISK',Â 'EQUITY',Â 'SIZE',Â 'CONTR'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ quantityÂ toÂ enterÂ eachÂ newÂ position.Â UseÂ anÂ amountÂ soÂ thatÂ ifÂ theÂ stopÂ lossÂ isÂ reachedÂ noÂ moreÂ thanÂ aÂ percentÂ ofÂ equityÂ isÂ lostÂ (RISK),Â orÂ useÂ aÂ fixedÂ percentÂ ofÂ equityÂ (EQUITY),Â orÂ useÂ aÂ fixedÂ amountÂ inÂ quoteÂ currencyÂ e.g.Â USDÂ (SIZE),Â orÂ useÂ aÂ fixedÂ amountÂ ofÂ contractsÂ (CONTR).',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')
capitalRiskRatioÂ =Â input.float(defvalÂ =Â 1.0,Â titleÂ =Â 'â€ƒâ€ƒCapitalÂ RiskÂ %',Â minvalÂ =Â 0.1,Â maxvalÂ =Â 10.0,Â stepÂ =Â 0.5,Â tooltipÂ =Â 'TheÂ maximumÂ percentageÂ ofÂ theÂ totalÂ equityÂ toÂ riskÂ inÂ everyÂ tradeÂ whenÂ noÂ leverageÂ isÂ used.',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')Â /Â 100.0
equityRatioÂ =Â input.float(defvalÂ =Â 10.0,Â titleÂ =Â 'â€ƒâ€ƒEquityÂ %â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ',Â minvalÂ =Â 1.0,Â maxvalÂ =Â 100.0,Â stepÂ =Â 0.5,Â tooltipÂ =Â 'TheÂ percentageÂ ofÂ theÂ equityÂ toÂ enterÂ inÂ everyÂ tradeÂ whenÂ noÂ leverageÂ isÂ used.',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')Â /Â 100.0
orderSizeÂ =Â input.float(defvalÂ =Â 10000.0,Â titleÂ =Â 'â€ƒâ€ƒOrderÂ Sizeâ€ƒâ€ƒâ€ƒâ€ƒ',Â minvalÂ =Â 1.0,Â tooltipÂ =Â 'TheÂ fixedÂ tradeÂ sizeÂ inÂ quoteÂ currencyÂ usedÂ toÂ enterÂ inÂ everyÂ tradeÂ whenÂ noÂ leverageÂ isÂ used.',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')
contractsÂ =Â input.int(defvalÂ =Â 1,Â titleÂ =Â 'â€ƒâ€ƒContractsâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ fixedÂ numberÂ ofÂ contractsÂ toÂ enterÂ inÂ everyÂ tradeÂ whenÂ noÂ leverageÂ isÂ used.',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')
minOrderSizeÂ =Â input.float(defvalÂ =Â 10.0,Â titleÂ =Â 'MinimumÂ OrderÂ Size',Â minvalÂ =Â 0.0,Â stepÂ =Â 1.0,Â tooltipÂ =Â 'TheÂ minimumÂ tradeÂ sizeÂ inÂ quoteÂ currencyÂ thatÂ isÂ allowedÂ inÂ theÂ exchangeÂ forÂ aÂ validÂ newÂ positionÂ (e.g.Â inÂ BinanceÂ youÂ cannotÂ tradeÂ amountsÂ thatÂ areÂ equalÂ orÂ lessÂ thanÂ 10Â USD).',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')
longLeverageÂ =Â input.int(defvalÂ =Â 1,Â titleÂ =Â 'LeverageÂ Long/ShortÂ ğŸ›ˆâ¡â€ƒâ€ƒâ€ƒ',Â minvalÂ =Â 1,Â inlineÂ =Â 'Leverage',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')
shortLeverageÂ =Â input.int(defvalÂ =Â 1,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1,Â tooltipÂ =Â 'LeverageÂ factorÂ usedÂ toÂ multiplyÂ theÂ initialÂ riskÂ quantityÂ ofÂ eachÂ tradeÂ (byÂ borrowingÂ theÂ remainingÂ amount).Â Thus,Â theÂ profitsÂ andÂ lossesÂ areÂ multipliedÂ respectively.Â INFORMATION!Â TheÂ marginÂ forÂ long/shortÂ positionsÂ valueÂ inÂ theÂ "Settings/Properties"Â shouldÂ beÂ adjustedÂ accoridnglyÂ toÂ correctlyÂ triggerÂ marginÂ calls.',Â inlineÂ =Â 'Leverage',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')
moonbagQuantityRatioÂ =Â input.float(defvalÂ =Â 0.0,Â titleÂ =Â 'MoonbagÂ QuantityÂ %',Â minvalÂ =Â 0.0,Â maxvalÂ =Â 99.9,Â stepÂ =Â 0.5,Â tooltipÂ =Â 'TheÂ percentageÂ ofÂ theÂ positionÂ thatÂ willÂ NOTÂ beÂ exitedÂ whenÂ ALLÂ theÂ takeÂ profitÂ priceÂ targetsÂ areÂ reached.Â IfÂ moreÂ thanÂ oneÂ takeÂ profitÂ priceÂ targetÂ isÂ set,Â thenÂ ALLÂ targetsÂ willÂ shareÂ equallyÂ theÂ remainingÂ amountÂ andÂ exitÂ whenÂ takeÂ profitÂ targetsÂ areÂ reached.Â TheÂ moonbagÂ amountÂ willÂ exitÂ onlyÂ whenÂ stopÂ lossÂ isÂ reachedÂ orÂ aÂ closeÂ signalÂ isÂ received.',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')Â /Â 100.0Â 
maxDrawdownEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'MaxÂ DrawdownÂ %â€ƒâ€ƒâ€ƒâ€ƒ',Â inlineÂ =Â 'Drawdown',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')
maxDrawdownPercÂ =Â input.float(defvalÂ =Â 25.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 1.0,Â maxvalÂ =Â 100.0,Â stepÂ =Â 0.5,Â tooltipÂ =Â 'TheÂ maximumÂ drawdownÂ toÂ stopÂ trading.',Â inlineÂ =Â 'Drawdown',Â groupÂ =Â 'ğŸ’°Â Quantity/RiskÂ Management')
//Â LOGICÂ ===============================================================================================================
varÂ floatÂ takeProfitAproxQuantityRatioÂ =Â 0.0005Â +Â (1.0Â -Â moonbagQuantityRatio)Â /Â numOfTakeProfitTargets
varÂ floatÂ takeProfitQuantityRatioÂ =Â numOfTakeProfitTargetsÂ ==Â 0Â ?Â 0Â :Â takeProfitAproxQuantityRatio.clamp_up(0.0,Â 1.0,Â 3)
varÂ intÂ quoteDecimalDigitsÂ =Â (syminfo.mintickÂ *Â syminfo.pointvalue).num_of_decimal_digits()Â +Â 1
getEntryQuantityDecimalDigits(floatÂ entryPrice)Â =>
Â Â Â Â (minOrderSizeÂ /Â entryPrice).num_of_decimal_digits()Â +Â 1
getExitQuantityDecimalDigits(floatÂ entryPrice)Â =>
Â Â Â Â getEntryQuantityDecimalDigits(entryPrice)Â +Â 1
varÂ intÂ numOfExitsPerTradeÂ =Â math.max(moonbagQuantityRatioÂ ==Â 0.0Â ?Â numOfTakeProfitTargetsÂ :Â numOfTakeProfitTargetsÂ +Â 1,Â 1)
varÂ floatÂ minEntrySizeÂ =Â minOrderSizeÂ *Â numOfExitsPerTrade
getRiskQuoteQuantity(simpleÂ intÂ leverage,Â floatÂ stopLossRatio)Â =>
Â Â Â Â (strategy.equityÂ *Â capitalRiskRatioÂ *Â leverageÂ /Â stopLossRatio).clamp_down(minEntrySize,Â strategy.equityÂ *Â leverage,Â quoteDecimalDigits)
getEquityQuoteQuantity(simpleÂ intÂ leverage)Â =>
Â Â Â Â (strategy.equityÂ *Â equityRatioÂ *Â leverage).clamp_down(minEntrySize,Â strategy.equityÂ *Â leverage,Â quoteDecimalDigits)
getSizeQuoteQuantity(simpleÂ intÂ leverage)Â =>
Â Â Â Â (orderSizeÂ *Â leverage).clamp_down(minEntrySize,Â strategy.equityÂ *Â leverage,Â quoteDecimalDigits)
getContractsQuoteQuantity(simpleÂ intÂ leverage,Â floatÂ entryPrice)Â =>
Â Â Â Â (contractsÂ *Â entryPriceÂ *Â leverage).clamp_down(minEntrySize,Â strategy.equityÂ *Â leverage,Â quoteDecimalDigits)
getBaseQuantity(floatÂ quoteQuantity,Â floatÂ entryPrice)Â =>
Â Â Â Â (quoteQuantityÂ /Â entryPrice).floor(getEntryQuantityDecimalDigits(entryPrice))
getQuoteQuantity(simpleÂ intÂ leverage,Â floatÂ stopLossRatio,Â floatÂ entryPrice)Â =>
Â Â Â Â switchÂ quantityMethod
Â Â Â Â Â Â Â Â 'RISK'Â =>Â getRiskQuoteQuantity(leverage,Â stopLossRatio)
Â Â Â Â Â Â Â Â 'EQUITY'Â =>Â getEquityQuoteQuantity(leverage)
Â Â Â Â Â Â Â Â 'SIZE'Â =>Â getSizeQuoteQuantity(leverage)
Â Â Â Â Â Â Â Â 'CONTR'Â =>Â getContractsQuoteQuantity(leverage,Â entryPrice)
Â Â Â Â Â Â Â Â =>Â na
getCapitalRisk(floatÂ stopLossRatio,Â floatÂ entryPrice)Â =>
Â Â Â Â switchÂ quantityMethod
Â Â Â Â Â Â Â Â 'RISK'Â =>Â capitalRiskRatio
Â Â Â Â Â Â Â Â 'EQUITY'Â =>Â equityRatioÂ *Â stopLossRatio
Â Â Â Â Â Â Â Â 'SIZE'Â =>Â (orderSizeÂ /Â strategy.equity)Â *Â stopLossRatio
Â Â Â Â Â Â Â Â 'CONTR'Â =>Â (contractsÂ *Â entryPriceÂ /Â strategy.equity)Â *Â stopLossRatio
Â Â Â Â Â Â Â Â =>Â na
floatÂ longRemainingQuantityRatioÂ =Â math.max(0.0,Â 1.0Â -Â longTrailTakeProfitExecutedCountÂ *Â takeProfitQuantityRatio)
varÂ floatÂ longEntryQuoteQuantityÂ =Â na
varÂ floatÂ longEntryQuoteQuantityRatioÂ =Â na
varÂ floatÂ longEntryBaseQuantityÂ =Â na
varÂ floatÂ longTakeProfitQuantityÂ =Â na
varÂ floatÂ longCapitalRiskRatioÂ =Â na
ifÂ (longLimitOrStopEntryIsActiveÂ orÂ validOpenLongPosition)
Â Â Â Â longEntryQuoteQuantityÂ :=Â getQuoteQuantity(longLeverage,Â longStopLossRatio,Â longEntryPrice)
Â Â Â Â longEntryQuoteQuantityRatioÂ :=Â longEntryQuoteQuantityÂ /Â strategy.equity
Â Â Â Â longEntryBaseQuantityÂ :=Â getBaseQuantity(longEntryQuoteQuantity,Â longEntryPrice)
Â Â Â Â longTakeProfitQuantityÂ :=Â (longEntryBaseQuantityÂ *Â takeProfitQuantityRatio).ceil(getExitQuantityDecimalDigits(longEntryPrice))
Â Â Â Â longCapitalRiskRatioÂ :=Â getCapitalRisk(longStopLossRatio,Â longEntryPrice)
varÂ floatÂ longRemainingQuantityÂ =Â na
ifÂ (validOpenLongPositionÂ orÂ enteredLongTradeÂ orÂ isLongPositionÂ orÂ completedLongTrade)
Â Â Â Â longRemainingQuantityÂ :=Â (longEntryBaseQuantityÂ *Â longRemainingQuantityRatio).ceil(getExitQuantityDecimalDigits(longEntryPrice))
floatÂ shortRemainingQuantityRatioÂ =Â math.max(0.0,Â 1.0Â -Â shortTrailTakeProfitExecutedCountÂ *Â takeProfitQuantityRatio)
varÂ floatÂ shortEntryQuoteQuantityÂ =Â na
varÂ floatÂ shortEntryQuoteQuantityRatioÂ =Â na
varÂ floatÂ shortEntryBaseQuantityÂ =Â na
varÂ floatÂ shortTakeProfitQuantityÂ =Â na
varÂ floatÂ shortCapitalRiskRatioÂ =Â na
ifÂ (shortLimitOrStopEntryIsActiveÂ orÂ validOpenShortPosition)
Â Â Â Â shortEntryQuoteQuantityÂ :=Â getQuoteQuantity(shortLeverage,Â shortStopLossRatio,Â shortEntryPrice)
Â Â Â Â shortEntryQuoteQuantityRatioÂ :=Â shortEntryQuoteQuantityÂ /Â strategy.equity
Â Â Â Â shortEntryBaseQuantityÂ :=Â getBaseQuantity(shortEntryQuoteQuantity,Â shortEntryPrice)
Â Â Â Â shortTakeProfitQuantityÂ :=Â (shortEntryBaseQuantityÂ *Â takeProfitQuantityRatio).ceil(getExitQuantityDecimalDigits(shortEntryPrice))
Â Â Â Â shortCapitalRiskRatioÂ :=Â getCapitalRisk(shortStopLossRatio,Â shortEntryPrice)
varÂ floatÂ shortRemainingQuantityÂ =Â na
ifÂ (validOpenShortPositionÂ orÂ enteredShortTradeÂ orÂ isShortPositionÂ orÂ completedShortTrade)
Â Â Â Â shortRemainingQuantityÂ :=Â (shortEntryBaseQuantityÂ *Â shortRemainingQuantityRatio).ceil(getExitQuantityDecimalDigits(shortEntryPrice))
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ¯Â TAKEÂ PROFITÂ 2
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ takeÂ profitÂ logicÂ implementationÂ basedÂ onÂ theÂ methodÂ andÂ theÂ numberÂ ofÂ stepÂ takeÂ profitÂ targetsÂ andÂ theÂ trailingÂ distance
//Â Dependencies:Â VOLATILITY,Â DISTANCE,Â ENTRY,Â TAKEÂ PROFITÂ 1
//Â Results:Â longTakeProfitPrices,Â shortTakeProfitPrices,Â longTrailTakeProfitOffsetTicks,Â shortTrailTakeProfitOffsetTicks,Â takeProfitTrailEnabled
//Â INPUTÂ ===============================================================================================================
varÂ longTakeProfitDistInitSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'ATR',Â titleÂ =Â 'InitÂ TPÂ DistanceÂ Method',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS',Â 'PROF',Â 'RR',Â 'HHLL'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ distanceÂ ofÂ theÂ firstÂ takeÂ profitÂ priceÂ target.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV),Â TickÂ basedÂ (TICKS),Â FixedÂ ProfitÂ (PROF),Â Risk-RewardÂ basedÂ (RR)Â orÂ HighestÂ high/LowestÂ lowÂ (HHLL).',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â distMulÂ =Â input.float(defvalÂ =Â 5.0,Â titleÂ =Â 'â€ƒâ€ƒInitÂ DistÂ Mul|LenÂ Long/Short',Â minvalÂ =Â 0.05,Â stepÂ =Â 0.05,Â inlineÂ =Â 'InitÂ TakeÂ ProfitÂ Perc',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â commissionRatioÂ =Â commissionRatio)
varÂ takeProfitInitMarSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'TICKS',Â titleÂ =Â 'InitÂ MarginÂ DistanceÂ Method',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ marginÂ toÂ offsetÂ theÂ distanceÂ ofÂ theÂ takeÂ profitÂ priceÂ target.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â distMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'InitÂ TakeÂ ProfitÂ Margin',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 5.0,Â titleÂ =Â 'InitÂ MarÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ',Â stepÂ =Â 0.5,Â tooltipÂ =Â 'TheÂ marginÂ multiplierÂ toÂ defineÂ theÂ initialÂ takeÂ profitÂ distanceÂ offset.',Â inlineÂ =Â 'InitÂ TakeÂ ProfitÂ Margin',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â :Â na)
varÂ takeProfitInitRestrictSettingsÂ =Â dr.RestrictSettings.new(
Â Â restrDistMethodÂ =Â input.string(defvalÂ =Â 'PERC',Â titleÂ =Â 'InitÂ RestrictÂ DistanceÂ Method',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS',Â 'PROF',Â 'RR'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ maximum/minimumÂ distanceÂ ofÂ theÂ initialÂ takeÂ profitÂ price.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV),Â TickÂ basedÂ (TICKS),Â ProfitÂ basedÂ (PROF)Â orÂ Risk-RewardÂ basedÂ (RR).',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â minDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'InitÂ TakeÂ ProfitÂ MinÂ Distance',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 0.1,Â titleÂ =Â 'MinÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹â€‹â€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ minimumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â TheÂ minimumÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ youÂ willÂ compensateÂ forÂ (atÂ least)Â theÂ commissionÂ rates,Â especiallyÂ whenÂ youÂ areÂ tradingÂ onÂ lowerÂ timeÂ frames.',Â inlineÂ =Â 'InitÂ TakeÂ ProfitÂ MinÂ Distance',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â :Â na,
Â Â maxDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'InitÂ TakeÂ ProfitÂ MaxÂ Distance',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 10.0,Â titleÂ =Â 'MaxÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹â€‹â€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ maximumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â TheÂ maximumÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ youÂ getÂ someÂ profitsÂ whenÂ theÂ priceÂ movesÂ inÂ theÂ desiredÂ direction.',Â inlineÂ =Â 'InitÂ TakeÂ ProfitÂ MaxÂ Distance',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â :Â na,
Â Â commissionRatioÂ =Â commissionRatio)
varÂ shortTakeProfitInitDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â longTakeProfitDistInitSettings.distMethod,
Â Â distMulÂ =Â input.float(defvalÂ =Â 5.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 0.05,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'TheÂ distanceÂ multiplierÂ toÂ defineÂ theÂ long/shortÂ firstÂ takeÂ profitÂ priceÂ fromÂ theÂ openÂ price.Â TheÂ multiplierÂ willÂ beÂ appliedÂ toÂ theÂ unitÂ priceÂ thatÂ isÂ definedÂ byÂ theÂ distanceÂ methodÂ thatÂ isÂ used.Â IfÂ theÂ HHLLÂ methodÂ isÂ used,Â thenÂ theÂ lengthÂ willÂ defineÂ theÂ windowÂ forÂ theÂ highestÂ highÂ andÂ lowestÂ lowÂ calculations.',Â inlineÂ =Â 'InitÂ TakeÂ ProfitÂ Perc',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â commissionRatioÂ =Â commissionRatio)
varÂ longTakeProfitStepDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'PERC',Â titleÂ =Â 'StepÂ TPÂ DistanceÂ Method',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS',Â 'PROF',Â 'RR'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ distanceÂ ofÂ additionalÂ stepÂ takeÂ profitÂ priceÂ targets.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV),Â TickÂ basedÂ (TICKS),Â FixedÂ ProfitÂ (PROF)Â orÂ Risk-RewardÂ basedÂ (RR).',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â distMulÂ =Â input.float(defvalÂ =Â 5.0,Â titleÂ =Â 'â€ƒâ€ƒStepÂ DistÂ MulÂ Long/Shortâ€ƒâ€ƒâ€‹â€‹',Â minvalÂ =Â 0.05,Â stepÂ =Â 0.05,Â inlineÂ =Â 'StepÂ TakeÂ ProfitÂ Perc',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â commissionRatioÂ =Â commissionRatio)
varÂ takeProfitStepRestrictSettingsÂ =Â dr.RestrictSettings.new(
Â Â restrDistMethodÂ =Â input.string(defvalÂ =Â 'PERC',Â titleÂ =Â 'StepÂ RestrictÂ DistanceÂ Method',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS',Â 'PROF',Â 'RR'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ maximum/minimumÂ distanceÂ ofÂ theÂ stepÂ takeÂ profitÂ price.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR),Â StandardÂ deviationÂ basedÂ (STDEV),Â TickÂ basedÂ (TICKS),Â ProfitÂ basedÂ (PROF)Â orÂ Risk-RewardÂ basedÂ (RR).',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â minDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'StepÂ TakeÂ ProfitÂ MinÂ Distance',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 0.1,Â titleÂ =Â 'MinÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ minimumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â TheÂ minimumÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ youÂ willÂ compensateÂ forÂ (atÂ least)Â theÂ commissionÂ rates,Â especiallyÂ whenÂ youÂ areÂ tradingÂ onÂ lowerÂ timeÂ frames.',Â inlineÂ =Â 'StepÂ TakeÂ ProfitÂ MinÂ Distance',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â :Â na,
Â Â maxDistMulÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â inlineÂ =Â 'StepÂ TakeÂ ProfitÂ MaxÂ Distance',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â input.float(defvalÂ =Â 5.0,Â titleÂ =Â 'MaxÂ DistÂ Mulâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 0.0,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'EnableÂ aÂ maximumÂ distanceÂ definedÂ byÂ thisÂ multiplierÂ andÂ theÂ restrictÂ distanceÂ method.Â TheÂ maximumÂ canÂ beÂ usedÂ toÂ makeÂ sureÂ thatÂ youÂ getÂ someÂ profitsÂ whenÂ theÂ priceÂ movesÂ inÂ theÂ desiredÂ direction.',Â inlineÂ =Â 'StepÂ TakeÂ ProfitÂ MaxÂ Distance',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')Â :Â na,
Â Â commissionRatioÂ =Â commissionRatio)
varÂ shortTakeProfitStepDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â longTakeProfitStepDistSettings.distMethod,
Â Â distMulÂ =Â input.float(defvalÂ =Â 5.0,Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â minvalÂ =Â 0.05,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'TheÂ distanceÂ multiplierÂ toÂ beÂ addedÂ onÂ topÂ ofÂ theÂ firstÂ long/shortÂ takeÂ profitÂ distanceÂ multiplierÂ toÂ defineÂ theÂ long/shortÂ stepÂ takeÂ profitÂ priceÂ target.Â TheÂ multiplierÂ willÂ beÂ appliedÂ toÂ theÂ unitÂ priceÂ thatÂ isÂ definedÂ byÂ theÂ distanceÂ methodÂ thatÂ isÂ used.',Â inlineÂ =Â 'StepÂ TakeÂ ProfitÂ Perc',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â commissionRatioÂ =Â commissionRatio)
takeProfitTrailEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ Trailâš ï¸ğŸ’¹',Â tooltipÂ =Â 'EnableÂ orÂ disableÂ theÂ trailingÂ forÂ takeÂ profit.Â WARNING!Â ThisÂ featureÂ willÂ repaint.Â MakeÂ sureÂ youÂ useÂ itÂ alongÂ withÂ "BarÂ Magnifier"Â andÂ "DeepÂ Backtesting"Â forÂ realisticÂ backtestÂ results.',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit')
varÂ takeProfitTrailDistSettingsÂ =Â dr.DistSettings.new(
Â Â distMethodÂ =Â input.string(defvalÂ =Â 'PERC',Â titleÂ =Â 'â€ƒâ€ƒTrailÂ TPÂ DistanceÂ Method',Â optionsÂ =Â ['PERC',Â 'ATR',Â 'STDEV',Â 'TICKS'],Â tooltipÂ =Â 'TheÂ methodÂ toÂ calculateÂ theÂ distanceÂ ofÂ theÂ trailingÂ takeÂ profit.Â PercentageÂ basedÂ (PERC),Â ATRÂ basedÂ (ATR)Â orÂ StandardÂ deviationÂ basedÂ (STDEV)Â orÂ TickÂ basedÂ (TICKS).',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'),
Â Â distMulÂ =Â input.float(defvalÂ =Â 2.0,Â titleÂ =Â 'â€ƒâ€ƒâ€ƒâ€ƒTrailÂ DistÂ Mul',Â minvalÂ =Â 0.01,Â stepÂ =Â 0.05,Â tooltipÂ =Â 'TheÂ distanceÂ multiplierÂ toÂ defineÂ theÂ takeÂ profitÂ priceÂ offsetÂ fromÂ theÂ high/lowÂ priceÂ afterÂ theÂ targetÂ isÂ reachedÂ whenÂ trailing.Â TheÂ multiplierÂ willÂ beÂ appliedÂ toÂ theÂ unitÂ priceÂ thatÂ isÂ definedÂ byÂ theÂ distanceÂ methodÂ thatÂ isÂ used.',Â groupÂ =Â 'ğŸ¯Â TakeÂ Profit'))
//Â LOGICÂ ===============================================================================================================
floatÂ takeProfitHighestHighÂ =Â ta.highest(high,Â math.max(math.floor(longTakeProfitDistInitSettings.distMul),Â 1))
//Â CalculateÂ theÂ actualÂ longÂ takeÂ profitÂ priceÂ andÂ ticksÂ thatÂ isÂ higherÂ fromÂ theÂ referenceÂ usingÂ theÂ distance
getLongTakeProfitPrice(dr.DistSettingsÂ dist,Â floatÂ reference,Â dr.AuxDataÂ shortBiasedAuxData,Â dr.RestrictSettingsÂ restrict,Â dr.DistSettingsÂ marÂ =Â na)Â =>
Â Â Â Â dist.higher_short_biased_price(reference,Â shortBiasedAuxData,Â restrict,Â mar,Â takeProfitHighestHigh)
getlongTakeProfitTicks(dr.DistSettingsÂ distSettings,Â floatÂ referencePrice,Â dr.AuxDataÂ shortBiasedAuxData)Â =>
Â Â Â Â distSettings.ticks(referencePrice,Â shortBiasedAuxData)
varÂ boolÂ takeProfitAdjustmentIsNeededÂ =Â (entryOrderTypeÂ ==Â 'MARKET'Â orÂ entryOrderTypeÂ ==Â 'STOP')Â andÂ longTakeProfitDistInitSettings.distMethodÂ !=Â 'HHLL'
ifÂ (longLimitOrStopEntryIsActiveÂ orÂ validOpenLongPosition)
Â Â Â Â longTakeProfitShortBiasedAuxDataÂ =Â dr.AuxData.new(atrÂ =Â negAtr,Â stdevÂ =Â negStDev,Â baseQuantityÂ =Â longTakeProfitQuantity,Â stopLossRatioÂ =Â longStopLossRatio)
Â Â Â Â floatÂ currentLongTakeProfitPriceÂ =Â getLongTakeProfitPrice(longTakeProfitDistInitSettings,Â longEntryPrice,Â longTakeProfitShortBiasedAuxData,Â takeProfitInitRestrictSettings,Â takeProfitInitMarSettings)
Â Â Â Â forÂ iÂ =Â 0Â toÂ takeProfitTargetsSize
Â Â Â Â Â Â Â Â longTakeProfitPrices.set(i,Â currentLongTakeProfitPrice)
Â Â Â Â Â Â Â Â longTrailTakeProfitOffsetTicks.set(i,Â getlongTakeProfitTicks(takeProfitTrailDistSettings,Â currentLongTakeProfitPrice,Â longTakeProfitShortBiasedAuxData))
Â Â Â Â Â Â Â Â ifÂ (iÂ <Â takeProfitTargetsSize)
Â Â Â Â Â Â Â Â Â Â Â Â currentLongTakeProfitPriceÂ :=Â getLongTakeProfitPrice(longTakeProfitStepDistSettings,Â currentLongTakeProfitPrice,Â longTakeProfitShortBiasedAuxData,Â takeProfitStepRestrictSettings)
elseÂ ifÂ (enteredLongTradeÂ andÂ takeProfitAdjustmentIsNeeded)
Â Â Â Â floatÂ longEntryPriceOffsetÂ =Â longEntryPriceÂ -Â nz(longEntryPrice[1],Â longEntryPrice)
Â Â Â Â forÂ iÂ =Â 0Â toÂ takeProfitTargetsSize
Â Â Â Â Â Â Â Â longTakeProfitPrices.set(i,Â longTakeProfitPrices.get(i)Â +Â longEntryPriceOffset)
Â Â Â Â Â Â Â Â longTrailTakeProfitOffsetTicks.set(i,Â longTrailTakeProfitOffsetTicks.get(i)Â +Â math.floor(longEntryPriceOffsetÂ /Â syminfo.mintick))
floatÂ takeProfitLowestLowÂ =Â ta.lowest(low,Â math.max(math.floor(shortTakeProfitInitDistSettings.distMul),Â 1))
//Â CalculateÂ theÂ actualÂ shortÂ takeÂ priceÂ andÂ ticksÂ thatÂ isÂ lowerÂ fromÂ theÂ referenceÂ usingÂ theÂ distance
getShortTakeProfitPrice(dr.DistSettingsÂ dist,Â floatÂ reference,Â dr.AuxDataÂ longBiasedAuxData,Â dr.RestrictSettingsÂ restrict,Â dr.DistSettingsÂ marÂ =Â na)Â =>
Â Â Â Â dist.lower_long_biased_price(reference,Â longBiasedAuxData,Â restrict,Â mar,Â takeProfitLowestLow)
getShortTakeProfitTicks(dr.DistSettingsÂ distSettings,Â floatÂ referencePrice,Â dr.AuxDataÂ longBiasedAuxData)Â =>
Â Â Â Â distSettings.ticks(referencePrice,Â longBiasedAuxData)
ifÂ (shortLimitOrStopEntryIsActiveÂ orÂ validOpenShortPosition)
Â Â Â Â shortTakeProfitLongBiasedAuxDataÂ =Â dr.AuxData.new(atrÂ =Â posAtr,Â stdevÂ =Â posStDev,Â baseQuantityÂ =Â shortTakeProfitQuantity,Â stopLossRatioÂ =Â shortStopLossRatio)
Â Â Â Â floatÂ currentShortTakeProfitPriceÂ =Â getShortTakeProfitPrice(shortTakeProfitInitDistSettings,Â shortEntryPrice,Â shortTakeProfitLongBiasedAuxData,Â takeProfitInitRestrictSettings,Â takeProfitInitMarSettings)
Â Â Â Â forÂ iÂ =Â 0Â toÂ takeProfitTargetsSize
Â Â Â Â Â Â Â Â shortTakeProfitPrices.set(i,Â currentShortTakeProfitPrice)
Â Â Â Â Â Â Â Â shortTrailTakeProfitOffsetTicks.set(i,Â getShortTakeProfitTicks(takeProfitTrailDistSettings,Â currentShortTakeProfitPrice,Â shortTakeProfitLongBiasedAuxData))
Â Â Â Â Â Â Â Â ifÂ (iÂ <Â takeProfitTargetsSize)
Â Â Â Â Â Â Â Â Â Â Â Â currentShortTakeProfitPriceÂ :=Â getShortTakeProfitPrice(shortTakeProfitStepDistSettings,Â currentShortTakeProfitPrice,Â shortTakeProfitLongBiasedAuxData,Â takeProfitStepRestrictSettings)
elseÂ ifÂ (enteredShortTradeÂ andÂ takeProfitAdjustmentIsNeeded)
Â Â Â Â floatÂ shortEntryPriceOffsetÂ =Â shortEntryPriceÂ -Â nz(shortEntryPrice[1],Â shortEntryPrice)
Â Â Â Â forÂ iÂ =Â 0Â toÂ takeProfitTargetsSize
Â Â Â Â Â Â Â Â shortTakeProfitPrices.set(i,Â shortTakeProfitPrices.get(i)Â +Â shortEntryPriceOffset)
Â Â Â Â Â Â Â Â shortTrailTakeProfitOffsetTicks.set(i,Â shortTrailTakeProfitOffsetTicks.get(i)Â +Â math.floor(shortEntryPriceOffsetÂ /Â syminfo.mintick))
//Â PLOTÂ ================================================================================================================
ifÂ (validOpenLongPositionÂ andÂ showOpenLabelsÂ andÂ barstate.isconfirmed)
Â Â Â Â stringÂ longOpenTooltipÂ =Â str.format('Quantity:Â {0,Â number,Â percent}\nCapitalÂ Risk:Â {1,Â number,Â percent}\nEntryÂ Price:Â {2,Â number,Â currency}\nSL:Â {3,Â number,Â currency}',Â longEntryQuoteQuantityRatio,Â longCapitalRiskRatio,Â longEntryPrice,Â longStopLossPrice)
Â Â Â Â forÂ [i,Â longTakeProfitPrice]Â inÂ longTakeProfitPrices
Â Â Â Â Â Â Â Â longOpenTooltipÂ :=Â longOpenTooltipÂ +Â str.format('\nTP{0,Â number,Â integer}:Â {1,Â number,Â currency}',Â iÂ +Â 1,Â longTakeProfitPrice)
Â Â Â Â label.new(xÂ =Â bar_index,Â yÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â nz(longLimitOrStopEntryPrice,Â close)Â :Â na,Â textÂ =Â 'Open',Â ylocÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â yloc.priceÂ :Â yloc.belowbar,Â colorÂ =Â longOpenColor,Â styleÂ =Â label.style_label_up,Â textcolorÂ =Â textColor,Â tooltipÂ =Â longOpenTooltip)
ifÂ (validOpenShortPositionÂ andÂ showOpenLabelsÂ andÂ barstate.isconfirmed)
Â Â Â Â stringÂ shortOpenTooltipÂ =Â str.format('Quantity:Â {0,Â number,Â percent}\nCapitalÂ Risk:Â {1,Â number,Â percent}\nEntryÂ Price:Â {2,Â number,Â currency}\nSL:Â {3,Â number,Â currency}',Â shortEntryQuoteQuantityRatio,Â shortCapitalRiskRatio,Â shortEntryPrice,Â shortStopLossPrice)
Â Â Â Â forÂ [i,Â shortTakeProfitPrice]Â inÂ shortTakeProfitPrices
Â Â Â Â Â Â Â Â shortOpenTooltipÂ :=Â shortOpenTooltipÂ +Â str.format('\nTP{0,Â number,Â integer}:Â {1,Â number,Â currency}',Â iÂ +Â 1,Â shortTakeProfitPrice)
Â Â Â Â label.new(xÂ =Â bar_index,Â yÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â nz(shortLimitOrStopEntryPrice,Â close)Â :Â na,Â textÂ =Â 'Open',Â ylocÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â yloc.priceÂ :Â yloc.abovebar,Â colorÂ =Â shortOpenColor,Â styleÂ =Â label.style_label_down,Â textcolorÂ =Â textColor,Â tooltipÂ =Â shortOpenTooltip)
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ“ŠÂ ANALYTICS
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ plottingÂ additionalÂ informationÂ forÂ statisticsÂ andÂ backtestingÂ purposes
//Â Dependencies:Â TRACKÂ POSITION,Â ENTRY,Â TAKEÂ PROFITÂ 1,Â TAKEÂ PROFITÂ 2
//Â Results:Â NONE
//Â INPUTÂ ===============================================================================================================
winColorÂ =Â input.color(defvalÂ =Â color.new(color.green,Â 0),Â titleÂ =Â 'ğŸ¨ï¸Â Win/LossÂ Colorâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ',Â inlineÂ =Â 'Entry',Â groupÂ =Â 'ğŸ“ŠÂ Analytics')
lossColorÂ =Â input.color(defvalÂ =Â color.new(color.red,Â 0),Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'TheÂ colorÂ ofÂ theÂ win/lossÂ labelsÂ andÂ theÂ markÂ tradeÂ lines.',Â inlineÂ =Â 'Entry',Â groupÂ =Â 'ğŸ“ŠÂ Analytics')
showTradeStatsÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'ShowÂ TradeÂ Statsâš ï¸ğŸŒ',Â tooltipÂ =Â 'ShowÂ theÂ winning/losingÂ tradeÂ statsÂ whenÂ complete.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ“ŠÂ Analytics')
showStatsTableÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'ShowÂ StatsÂ Tableâš ï¸ğŸŒâ€ƒ',Â inlineÂ =Â 'StatsÂ Table',Â groupÂ =Â 'ğŸ“ŠÂ Analytics')
statsTablePosÂ =Â input.string(defvalÂ =Â 'TOPRIGHT',Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â optionsÂ =Â ['TOPRIGHT',Â 'TOPLEFT',Â 'BOTRIGHT',Â 'BOTLEFT'],Â tooltipÂ =Â 'ShowÂ theÂ tableÂ withÂ theÂ overallÂ tradeÂ statisticsÂ onÂ theÂ selectedÂ corner.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â inlineÂ =Â 'StatsÂ Table',Â groupÂ =Â 'ğŸ“ŠÂ Analytics')
showMetricsTableÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'ShowÂ MetricsÂ Tableâš ï¸ğŸŒ',Â inlineÂ =Â 'MetricsÂ Table',Â groupÂ =Â 'ğŸ“ŠÂ Analytics')
metricsTablePosÂ =Â input.string(defvalÂ =Â 'BOTLEFT',Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â optionsÂ =Â ['TOPRIGHT',Â 'TOPLEFT',Â 'BOTRIGHT',Â 'BOTLEFT'],Â tooltipÂ =Â 'ShowÂ theÂ tableÂ withÂ theÂ tradeÂ metricsÂ onÂ theÂ selectedÂ corner.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â inlineÂ =Â 'MetricsÂ Table',Â groupÂ =Â 'ğŸ“ŠÂ Analytics')
//Â LOGICÂ ===============================================================================================================
varÂ boolÂ showTableÂ =Â showStatsTableÂ orÂ showMetricsTable
varÂ boolÂ showStatsÂ =Â showTableÂ orÂ showTradeStats
getTablePosition(simpleÂ stringÂ pos)Â =>
Â Â Â Â switchÂ pos
Â Â Â Â Â Â Â Â 'BOTCENTER'Â =>Â position.bottom_center
Â Â Â Â Â Â Â Â 'BOTLEFT'Â =>Â position.bottom_left
Â Â Â Â Â Â Â Â 'BOTRIGHT'Â =>Â position.bottom_right
Â Â Â Â Â Â Â Â 'MIDCENTER'Â =>Â position.middle_center
Â Â Â Â Â Â Â Â 'MIDLEFT'Â =>Â position.middle_left
Â Â Â Â Â Â Â Â 'MIDRIGHT'Â =>Â position.middle_right
Â Â Â Â Â Â Â Â 'TOPCENTER'Â =>Â position.top_center
Â Â Â Â Â Â Â Â 'TOPLEFT'Â =>Â position.top_left
Â Â Â Â Â Â Â Â 'TOPRIGHT'Â =>Â position.top_right
Â Â Â Â Â Â Â Â =>Â position.middle_center
//Â CountÂ winning/losingÂ streaks
varÂ intÂ maxWinningStreakÂ =Â 0
varÂ intÂ maxLosingStreakÂ =Â 0
varÂ intÂ currentWinningStreakÂ =Â 0
varÂ intÂ currentLosingStreakÂ =Â 0
varÂ intÂ numOfInconclusiveExitsÂ =Â 0
//Â StoreÂ theÂ freeÂ winning/losingÂ profitÂ percentages
varÂ float[]Â winTradeFreeProfitsPercÂ =Â array.new<float>()
varÂ float[]Â lossTradeFreeProfitsPercÂ =Â array.new<float>()
//Â StoreÂ theÂ winning/losingÂ profitÂ percentages
varÂ float[]Â winTradeProfitsPercÂ =Â array.new<float>()
varÂ float[]Â lossTradeProfitsPercÂ =Â array.new<float>()
//Â StoreÂ theÂ gainsÂ onÂ account
varÂ float[]Â winTradeGainsPercÂ =Â array.new<float>()
varÂ float[]Â lossTradeGainsPercÂ =Â array.new<float>()
//Â TakeÂ ProfitsÂ executedÂ counts
varÂ floatÂ winSumTakeProfitExecutedCountÂ =Â 0.0
varÂ floatÂ lossSumTakeProfitExecutedCountÂ =Â 0.0
//Â QuantityÂ sums
varÂ floatÂ winSumQuantityPercÂ =Â 0.0
varÂ floatÂ lossSumQuantityPercÂ =Â 0.0
//Â Risks
varÂ float[]Â winRisksPercÂ =Â array.new<float>()
varÂ float[]Â lossRisksPercÂ =Â array.new<float>()
//Â Risk/ReawardÂ ratios
varÂ float[]Â winRiskRewardRatiosÂ =Â array.new<float>()
varÂ float[]Â lossRiskRewardRatiosÂ =Â array.new<float>()
closedTradesEntryBarIndex(intÂ n)Â =>
Â Â Â Â strategy.closedtrades.entry_bar_index(strategy.closedtradesÂ -Â n)
closedTradesEntryPrice(intÂ n)Â =>
Â Â Â Â strategy.closedtrades.entry_price(strategy.closedtradesÂ -Â n)
closedTradeEntryIdStartsWith(simpleÂ stringÂ prefix,Â intÂ nÂ =Â 1)Â =>
Â Â Â Â strategy.closedtradesÂ >=Â nÂ ?Â str.startswith(strategy.closedtrades.entry_id(strategy.closedtradesÂ -Â n),Â prefix)Â :Â false
lastTwoClosedTradesEnteredInTheSameBar()Â =>
Â Â Â Â strategy.closedtradesÂ >=Â 2Â ?Â closedTradesEntryBarIndex(2)Â ==Â closedTradesEntryBarIndex(1)Â :Â false
getNumOfExits(simpleÂ stringÂ orderIdClose,Â intÂ takeProfitCount)Â =>
Â Â Â Â strategy.closedtrades.exit_id(strategy.closedtradesÂ -Â 1)Â ==Â orderIdCloseÂ ?Â takeProfitCountÂ +Â 1Â :Â moonbagQuantityRatioÂ ==Â 0.0Â andÂ numOfTakeProfitTargetsÂ >Â 0Â ?Â numOfTakeProfitTargetsÂ :Â numOfTakeProfitTargetsÂ +Â 1
ifÂ (completedLongTradeÂ andÂ showStats)
Â Â Â Â //Â LongÂ entryÂ barÂ idÂ andÂ price
Â Â Â Â varÂ intÂ lastLongEntryBarIndexÂ =Â na
Â Â Â Â varÂ floatÂ lastLongEntryPriceÂ =Â na
Â Â Â Â ifÂ (closedTradeEntryIdStartsWith(longOrderIdPrefix)Â orÂ (closedTradeEntryIdStartsWith(longOrderIdPrefix,Â 2)Â andÂ lastTwoClosedTradesEnteredInTheSameBar()))
Â Â Â Â Â Â Â Â lastLongEntryBarIndexÂ :=Â closedTradesEntryBarIndex(1)
Â Â Â Â Â Â Â Â lastLongEntryPriceÂ :=Â closedTradesEntryPrice(1)
Â Â Â Â elseÂ ifÂ (strategy.closedtradesÂ >Â 1Â ?Â closedTradeEntryIdStartsWith(longOrderIdPrefix,Â 2)Â andÂ lastTwoClosedTradesExitedInTheSameBar()Â :Â false)
Â Â Â Â Â Â Â Â lastLongEntryBarIndexÂ :=Â closedTradesEntryBarIndex(2)
Â Â Â Â Â Â Â Â lastLongEntryPriceÂ :=Â closedTradesEntryPrice(2)
Â Â Â Â floatÂ exRatioÂ =Â lastLongExitPriceÂ /Â lastLongEntryPrice
Â Â Â Â floatÂ longFreeProfitRatioÂ =Â exRatioÂ -Â 1.0Â -Â exRatioÂ *Â commissionRatioÂ -Â commissionRatio
Â Â Â Â floatÂ longProfitRatioÂ =Â -Â commissionRatio
Â Â Â Â boolÂ longInconclusiveExitÂ =Â false
Â Â Â Â intÂ histIdÂ =Â longLimitOrStopEntryIsActiveÂ orÂ validOpenLongPositionÂ orÂ enteredLongTradeÂ ?Â 1Â :Â 0
Â Â Â Â intÂ numOfExitsÂ =Â getNumOfExits(longOrderIdClose,Â longTrailTakeProfitExecutedCount)
Â Â Â Â forÂ iÂ =Â strategy.closedtradesÂ -Â 1Â toÂ strategy.closedtradesÂ -Â numOfExits
Â Â Â Â Â Â Â Â floatÂ ithExPriceÂ =Â closedTradeExitIdContains(longOrderIdPrefix)Â ?Â strategy.closedtrades.exit_price(i)Â :Â strategy.closedtrades.exit_price(iÂ -Â 1)
Â Â Â Â Â Â Â Â floatÂ ithExRatioÂ =Â ithExPriceÂ /Â lastLongEntryPrice
Â Â Â Â Â Â Â Â floatÂ quantityRatioÂ =Â str.startswith(strategy.closedtrades.exit_id(i),Â str.format('{0}Â TakeÂ Profit',Â longOrderIdPrefix))Â ?Â takeProfitQuantityRatioÂ :Â longRemainingQuantityRatio
Â Â Â Â Â Â Â Â longProfitRatioÂ +=Â (ithExRatioÂ -Â 1.0Â -Â ithExRatioÂ *Â commissionRatio)Â *Â quantityRatio
Â Â Â Â Â Â Â Â intÂ tpIdÂ =Â moonbagQuantityRatioÂ ==Â 0.0Â ?Â numOfTakeProfitTargetsÂ +Â iÂ -Â strategy.closedtradesÂ :Â numOfTakeProfitTargetsÂ +Â iÂ -Â strategy.closedtradesÂ -Â 1
Â Â Â Â Â Â Â Â longInconclusiveStopLossÂ =Â tpIdÂ <Â numOfTakeProfitTargetsÂ andÂ tpIdÂ >=Â 0Â andÂ lowÂ <Â longStopLossPriceÂ ?Â highestHighSinceLongEntryÂ >Â (longTakeProfitPrices[histId]).get(tpId)Â andÂ notÂ longTrailTakeProfitExecuted.get(tpId)Â :Â false
Â Â Â Â Â Â Â Â longInconclusiveTakeProfitÂ =Â false
Â Â Â Â Â Â Â Â forÂ jÂ =Â strategy.closedtradesÂ -Â 1Â toÂ strategy.closedtradesÂ -Â numOfExits
Â Â Â Â Â Â Â Â Â Â Â Â longInconclusiveTakeProfitÂ :=Â bar_indexÂ ==Â strategy.closedtrades.exit_bar_index(i)Â andÂ bar_indexÂ ==Â strategy.closedtrades.exit_bar_index(j)Â andÂ strategy.closedtrades.exit_price(i)Â !=Â strategy.closedtrades.exit_price(j)Â andÂ lowÂ <Â longStopLossPrice[histId]
Â Â Â Â Â Â Â Â longInconclusiveExitÂ :=Â longInconclusiveExitÂ orÂ longInconclusiveStopLossÂ orÂ longInconclusiveTakeProfit
Â Â Â Â floatÂ longGainPercÂ =Â longProfitRatioÂ *Â 100.0Â *Â longEntryQuoteQuantityRatio[histId]
Â Â Â Â floatÂ longAvgTakeProfitRatioÂ =Â nz(((longTakeProfitPrices[histId]).avg()Â -Â lastLongEntryPrice)Â /Â lastLongEntryPrice)
Â Â Â Â floatÂ longRiskRewardRatioÂ =Â longAvgTakeProfitRatioÂ /Â longEntryStopLossRatio
Â Â Â Â boolÂ isWinÂ =Â longProfitRatioÂ >=Â 0.0
Â Â Â Â //Â KeepÂ statsÂ forÂ laterÂ use
Â Â Â Â ifÂ (showTable)
Â Â Â Â Â Â Â Â ifÂ (isWin)
Â Â Â Â Â Â Â Â Â Â Â Â currentWinningStreakÂ :=Â currentWinningStreakÂ +Â 1
Â Â Â Â Â Â Â Â Â Â Â Â winTradeFreeProfitsPerc.push(100.0Â *Â longFreeProfitRatio)
Â Â Â Â Â Â Â Â Â Â Â Â winTradeProfitsPerc.push(100.0Â *Â longProfitRatio)
Â Â Â Â Â Â Â Â Â Â Â Â winTradeGainsPerc.push(longGainPerc)
Â Â Â Â Â Â Â Â Â Â Â Â winSumTakeProfitExecutedCountÂ :=Â winSumTakeProfitExecutedCountÂ +Â longTrailTakeProfitExecutedCount
Â Â Â Â Â Â Â Â Â Â Â Â winSumQuantityPercÂ :=Â winSumQuantityPercÂ +Â 100.0Â *Â longEntryQuoteQuantityRatio[histId]
Â Â Â Â Â Â Â Â Â Â Â Â currentLosingStreakÂ :=Â 0
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (quantityMethodÂ !=Â 'RISK')
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â winRisksPerc.push(100.0Â *Â longCapitalRiskRatio[histId])
Â Â Â Â Â Â Â Â Â Â Â Â winRiskRewardRatios.push(longRiskRewardRatio)
Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â currentLosingStreakÂ :=Â currentLosingStreakÂ +Â 1
Â Â Â Â Â Â Â Â Â Â Â Â lossTradeFreeProfitsPerc.push(100.0Â *Â longFreeProfitRatio)
Â Â Â Â Â Â Â Â Â Â Â Â lossTradeProfitsPerc.push(100.0Â *Â longProfitRatio)
Â Â Â Â Â Â Â Â Â Â Â Â lossTradeGainsPerc.push(longGainPerc)
Â Â Â Â Â Â Â Â Â Â Â Â lossSumTakeProfitExecutedCountÂ :=Â lossSumTakeProfitExecutedCountÂ +Â longTrailTakeProfitExecutedCount
Â Â Â Â Â Â Â Â Â Â Â Â lossSumQuantityPercÂ :=Â lossSumQuantityPercÂ +Â 100.0Â *Â longEntryQuoteQuantityRatio[histId]
Â Â Â Â Â Â Â Â Â Â Â Â currentWinningStreakÂ :=Â 0
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (quantityMethodÂ !=Â 'RISK')
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â lossRisksPerc.push(100.0Â *Â longCapitalRiskRatio[histId])
Â Â Â Â Â Â Â Â Â Â Â Â lossRiskRewardRatios.push(longRiskRewardRatio)
Â Â Â Â Â Â Â Â maxWinningStreakÂ :=Â math.max(currentWinningStreak,Â maxWinningStreak)
Â Â Â Â Â Â Â Â maxLosingStreakÂ :=Â math.max(currentLosingStreak,Â maxLosingStreak)
Â Â Â Â Â Â Â Â ifÂ (longInconclusiveExit)
Â Â Â Â Â Â Â Â Â Â Â Â numOfInconclusiveExitsÂ :=Â numOfInconclusiveExitsÂ +Â 1
Â Â Â Â //Â PlotÂ trades'Â lineÂ andÂ label
Â Â Â Â ifÂ (showTradeStats)
Â Â Â Â Â Â Â Â stringÂ longFreeProfitPercStrÂ =Â (longFreeProfitRatioÂ >=Â 0.0Â ?Â '+'Â :Â '')Â +Â str.tostring(100.0Â *Â longFreeProfitRatio,Â format.percent)
Â Â Â Â Â Â Â Â stringÂ longProfitPercStrÂ =Â (isWinÂ ?Â '+'Â :Â '')Â +Â str.tostring(100.0Â *Â longProfitRatio,Â format.percent)
Â Â Â Â Â Â Â Â stringÂ longGainPercStrÂ =Â (isWinÂ ?Â '+'Â :Â '')Â +Â str.tostring(longGainPerc,Â format.percent)
Â Â Â Â Â Â Â Â floatÂ tradePriceÂ =Â isWinÂ andÂ longTrailTakeProfitExecutedCountÂ >Â 0Â ?Â math.max((longTakeProfitPrices[histId]).get(longTrailTakeProfitExecutedCountÂ -Â 1),Â longStopLossPrice[histId],Â lastLongExitPrice)Â :Â lastLongExitPrice
Â Â Â Â Â Â Â Â intÂ labelBarIdÂ =Â math.floor((lastLongEntryBarIndexÂ +Â lastLongExitBarIndexÂ +Â 1)Â /Â 2)
Â Â Â Â Â Â Â Â line.new(x1Â =Â labelBarId,Â y1Â =Â tradePrice,Â x2Â =Â lastLongEntryBarIndex,Â y2Â =Â lastLongEntryPrice,Â xlocÂ =Â xloc.bar_index,Â extendÂ =Â extend.none,Â colorÂ =Â isWinÂ ?Â winColorÂ :Â lossColor,Â styleÂ =Â line.style_arrow_right,Â widthÂ =Â 1)
Â Â Â Â Â Â Â Â line.new(x1Â =Â labelBarId,Â y1Â =Â tradePrice,Â x2Â =Â lastLongExitBarIndex,Â y2Â =Â lastLongExitPrice,Â xlocÂ =Â xloc.bar_index,Â extendÂ =Â extend.none,Â colorÂ =Â isWinÂ ?Â winColorÂ :Â lossColor,Â styleÂ =Â line.style_arrow_right,Â widthÂ =Â 1)
Â Â Â Â Â Â Â Â label.new(xÂ =Â labelBarId,Â yÂ =Â tradePrice,Â textÂ =Â (longInconclusiveExitÂ ?Â 'ğŸš¨'Â :Â '')Â +Â (isWinÂ ?Â 'Win'Â :Â 'Loss'),Â xlocÂ =Â xloc.bar_index,Â ylocÂ =Â yloc.price,Â colorÂ =Â isWinÂ ?Â winColorÂ :Â lossColor,Â styleÂ =Â isWinÂ ?Â label.style_label_downÂ :Â label.style_label_up,Â textcolorÂ =Â textColor,Â sizeÂ =Â size.normal,
Â Â Â Â Â Â Â Â Â Â tooltipÂ =Â str.format('Quantity:Â {0,Â number,Â percent}\nCapitalÂ Risk:Â {1,Â number,Â percent}\nEntryÂ Price:Â {2,Â number,Â currency}\nExitÂ Price:Â {3,Â number,Â currency}\nFreeÂ Profit:Â {4}\nProfit:Â {5}\nGain:Â {6}\nTPÂ ExecÂ #:Â {7,Â number,Â integer}\nRiskÂ Reward:Â {8,Â number,Â #.##}\nInitÂ SL:Â {9,Â number,Â percent}\nAvgÂ TP:Â {10,Â number,Â percent}',
Â Â Â Â Â Â Â Â Â Â Â Â Â longEntryQuoteQuantityRatio[histId],Â longCapitalRiskRatio[histId],Â lastLongEntryPrice,Â lastLongExitPrice,Â longFreeProfitPercStr,Â longProfitPercStr,Â longGainPercStr,Â longTrailTakeProfitExecutedCount,Â longRiskRewardRatio,Â longEntryStopLossRatio,Â longAvgTakeProfitRatio))
ifÂ (completedShortTradeÂ andÂ showStats)
Â Â Â Â //Â ShortÂ entryÂ barÂ idÂ andÂ price
Â Â Â Â varÂ intÂ lastShortEntryBarIndexÂ =Â na
Â Â Â Â varÂ floatÂ lastShortEntryPriceÂ =Â na
Â Â Â Â ifÂ (closedTradeEntryIdStartsWith(shortOrderIdPrefix)Â orÂ (closedTradeEntryIdStartsWith(shortOrderIdPrefix,Â 2)Â andÂ lastTwoClosedTradesEnteredInTheSameBar()))
Â Â Â Â Â Â Â Â lastShortEntryBarIndexÂ :=Â closedTradesEntryBarIndex(1)
Â Â Â Â Â Â Â Â lastShortEntryPriceÂ :=Â closedTradesEntryPrice(1)
Â Â Â Â elseÂ ifÂ (strategy.closedtradesÂ >Â 1Â ?Â closedTradeEntryIdStartsWith(shortOrderIdPrefix,Â 2)Â andÂ lastTwoClosedTradesExitedInTheSameBar()Â :Â false)
Â Â Â Â Â Â Â Â lastShortEntryBarIndexÂ :=Â closedTradesEntryBarIndex(2)
Â Â Â Â Â Â Â Â lastShortEntryPriceÂ :=Â closedTradesEntryPrice(2)
Â Â Â Â floatÂ exRatioÂ =Â lastShortExitPriceÂ /Â lastShortEntryPrice
Â Â Â Â floatÂ shortFreeProfitRatioÂ =Â 1.0Â -Â exRatioÂ -Â exRatioÂ *Â commissionRatioÂ -Â commissionRatio
Â Â Â Â floatÂ shortProfitRatioÂ =Â -Â commissionRatio
Â Â Â Â boolÂ shortInconclusiveExitÂ =Â false
Â Â Â Â intÂ histIdÂ =Â shortLimitOrStopEntryIsActiveÂ orÂ validOpenShortPositionÂ orÂ enteredShortTradeÂ ?Â 1Â :Â 0
Â Â Â Â intÂ numOfExitsÂ =Â getNumOfExits(shortOrderIdClose,Â shortTrailTakeProfitExecutedCount)
Â Â Â Â forÂ iÂ =Â strategy.closedtradesÂ -Â 1Â toÂ strategy.closedtradesÂ -Â numOfExits
Â Â Â Â Â Â Â Â floatÂ ithExPriceÂ =Â closedTradeExitIdContains(shortOrderIdPrefix)Â ?Â strategy.closedtrades.exit_price(i)Â :Â strategy.closedtrades.exit_price(iÂ -Â 1)
Â Â Â Â Â Â Â Â floatÂ ithExRatioÂ =Â ithExPriceÂ /Â lastShortEntryPrice
Â Â Â Â Â Â Â Â floatÂ quanityRatioÂ =Â str.startswith(strategy.closedtrades.exit_id(i),Â str.format('{0}Â TakeÂ Profit',Â shortOrderIdPrefix))Â ?Â takeProfitQuantityRatioÂ :Â shortRemainingQuantityRatio
Â Â Â Â Â Â Â Â shortProfitRatioÂ +=Â (1.0Â -Â ithExRatioÂ -Â ithExRatioÂ *Â commissionRatio)Â *Â quanityRatio
Â Â Â Â Â Â Â Â intÂ tpIdÂ =Â moonbagQuantityRatioÂ ==Â 0.0Â ?Â numOfTakeProfitTargetsÂ +Â iÂ -Â strategy.closedtradesÂ :Â numOfTakeProfitTargetsÂ +Â iÂ -Â strategy.closedtradesÂ -Â 1
Â Â Â Â Â Â Â Â shortInconclusiveStopLossÂ =Â tpIdÂ <Â numOfTakeProfitTargetsÂ andÂ tpIdÂ >=Â 0Â andÂ highÂ >Â shortStopLossPriceÂ ?Â lowestLowSinceShortEntryÂ <Â (shortTakeProfitPrices[histId]).get(tpId)Â andÂ notÂ shortTrailTakeProfitExecuted.get(tpId)Â :Â false
Â Â Â Â Â Â Â Â shortInconclusiveTakeProfitÂ =Â false
Â Â Â Â Â Â Â Â forÂ jÂ =Â strategy.closedtradesÂ -Â 1Â toÂ strategy.closedtradesÂ -Â numOfExits
Â Â Â Â Â Â Â Â Â Â Â Â shortInconclusiveTakeProfitÂ :=Â bar_indexÂ ==Â strategy.closedtrades.exit_bar_index(i)Â andÂ bar_indexÂ ==Â strategy.closedtrades.exit_bar_index(j)Â andÂ strategy.closedtrades.exit_price(i)Â !=Â strategy.closedtrades.exit_price(j)Â andÂ highÂ >Â shortStopLossPrice[histId]
Â Â Â Â Â Â Â Â shortInconclusiveExitÂ :=Â shortInconclusiveExitÂ orÂ shortInconclusiveStopLossÂ orÂ shortInconclusiveTakeProfit
Â Â Â Â floatÂ shortGainPercÂ =Â shortProfitRatioÂ *Â 100.0Â *Â shortEntryQuoteQuantityRatio[histId]
Â Â Â Â floatÂ shortAvgTakeProfitRatioÂ =Â nz((lastShortEntryPriceÂ -Â (shortTakeProfitPrices[histId]).avg())Â /Â lastShortEntryPrice)
Â Â Â Â floatÂ shortRiskRewardRatioÂ =Â shortAvgTakeProfitRatioÂ /Â shortEntryStopLossRatio
Â Â Â Â boolÂ isWinÂ =Â shortProfitRatioÂ >=Â 0.0
Â Â Â Â //Â KeepÂ statsÂ forÂ laterÂ use
Â Â Â Â ifÂ (showTable)
Â Â Â Â Â Â Â Â ifÂ (isWin)
Â Â Â Â Â Â Â Â Â Â Â Â currentWinningStreakÂ :=Â currentWinningStreakÂ +Â 1
Â Â Â Â Â Â Â Â Â Â Â Â winTradeFreeProfitsPerc.push(100.0Â *Â shortFreeProfitRatio)
Â Â Â Â Â Â Â Â Â Â Â Â winTradeProfitsPerc.push(100.0Â *Â shortProfitRatio)
Â Â Â Â Â Â Â Â Â Â Â Â winTradeGainsPerc.push(shortGainPerc)
Â Â Â Â Â Â Â Â Â Â Â Â winSumTakeProfitExecutedCountÂ :=Â winSumTakeProfitExecutedCountÂ +Â shortTrailTakeProfitExecutedCount
Â Â Â Â Â Â Â Â Â Â Â Â winSumQuantityPercÂ :=Â winSumQuantityPercÂ +Â 100.0Â *Â shortEntryQuoteQuantityRatio[histId]
Â Â Â Â Â Â Â Â Â Â Â Â currentLosingStreakÂ :=Â 0
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (quantityMethodÂ !=Â 'RISK')
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â winRisksPerc.push(100.0Â *Â shortCapitalRiskRatio[histId])
Â Â Â Â Â Â Â Â Â Â Â Â winRiskRewardRatios.push(shortRiskRewardRatio)
Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â currentLosingStreakÂ :=Â currentLosingStreakÂ +Â 1
Â Â Â Â Â Â Â Â Â Â Â Â lossTradeFreeProfitsPerc.push(100.0Â *Â shortFreeProfitRatio)
Â Â Â Â Â Â Â Â Â Â Â Â lossTradeProfitsPerc.push(100.0Â *Â shortProfitRatio)
Â Â Â Â Â Â Â Â Â Â Â Â lossTradeGainsPerc.push(shortGainPerc)
Â Â Â Â Â Â Â Â Â Â Â Â lossSumTakeProfitExecutedCountÂ :=Â lossSumTakeProfitExecutedCountÂ +Â shortTrailTakeProfitExecutedCount
Â Â Â Â Â Â Â Â Â Â Â Â lossSumQuantityPercÂ :=Â lossSumQuantityPercÂ +Â 100.0Â *Â shortEntryQuoteQuantityRatio[histId]
Â Â Â Â Â Â Â Â Â Â Â Â currentWinningStreakÂ :=Â 0
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (quantityMethodÂ !=Â 'RISK')
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â lossRisksPerc.push(100.0Â *Â shortCapitalRiskRatio[histId])
Â Â Â Â Â Â Â Â Â Â Â Â lossRiskRewardRatios.push(shortRiskRewardRatio)
Â Â Â Â Â Â Â Â maxWinningStreakÂ :=Â math.max(currentWinningStreak,Â maxWinningStreak)
Â Â Â Â Â Â Â Â maxLosingStreakÂ :=Â math.max(currentLosingStreak,Â maxLosingStreak)
Â Â Â Â Â Â Â Â ifÂ (shortInconclusiveExit)
Â Â Â Â Â Â Â Â Â Â Â Â numOfInconclusiveExitsÂ :=Â numOfInconclusiveExitsÂ +Â 1
Â Â Â Â //Â PlotÂ tradeÂ statsÂ (lineÂ andÂ label)
Â Â Â Â ifÂ (showTradeStats)
Â Â Â Â Â Â Â Â stringÂ shortFreeProfitPercStrÂ =Â (shortFreeProfitRatioÂ >=Â 0.0Â ?Â '+'Â :Â '')Â +Â str.tostring(100.0Â *Â shortFreeProfitRatio,Â format.percent)
Â Â Â Â Â Â Â Â stringÂ shortProfitPercStrÂ =Â (isWinÂ ?Â '+'Â :Â '')Â +Â str.tostring(100.0Â *Â shortProfitRatio,Â format.percent)
Â Â Â Â Â Â Â Â stringÂ shortGainPercStrÂ =Â (isWinÂ ?Â '+'Â :Â '')Â +Â str.tostring(shortGainPerc,Â format.percent)
Â Â Â Â Â Â Â Â floatÂ tradePriceÂ =Â isWinÂ andÂ shortTrailTakeProfitExecutedCountÂ >Â 0Â ?Â math.min((shortTakeProfitPrices[histId]).get(shortTrailTakeProfitExecutedCountÂ -Â 1),Â shortStopLossPrice[histId],Â lastShortExitPrice)Â :Â lastShortExitPrice
Â Â Â Â Â Â Â Â intÂ labelBarIdÂ =Â math.floor((lastShortEntryBarIndexÂ +Â lastShortExitBarIndexÂ +Â 1)Â /Â 2)
Â Â Â Â Â Â Â Â line.new(x1Â =Â labelBarId,Â y1Â =Â tradePrice,Â x2Â =Â lastShortEntryBarIndex,Â y2Â =Â lastShortEntryPrice,Â xlocÂ =Â xloc.bar_index,Â extendÂ =Â extend.none,Â colorÂ =Â isWinÂ ?Â winColorÂ :Â lossColor,Â styleÂ =Â line.style_arrow_right,Â widthÂ =Â 1)
Â Â Â Â Â Â Â Â line.new(x1Â =Â labelBarId,Â y1Â =Â tradePrice,Â x2Â =Â lastShortExitBarIndex,Â y2Â =Â lastShortExitPrice,Â xlocÂ =Â xloc.bar_index,Â extendÂ =Â extend.none,Â colorÂ =Â isWinÂ ?Â winColorÂ :Â lossColor,Â styleÂ =Â line.style_arrow_right,Â widthÂ =Â 1)
Â Â Â Â Â Â Â Â label.new(xÂ =Â labelBarId,Â yÂ =Â tradePrice,Â textÂ =Â (shortInconclusiveExitÂ ?Â 'ğŸš¨'Â :Â '')Â +Â (isWinÂ ?Â 'Win'Â :Â 'Loss'),Â xlocÂ =Â xloc.bar_index,Â ylocÂ =Â yloc.price,Â colorÂ =Â isWinÂ ?Â winColorÂ :Â lossColor,Â styleÂ =Â isWinÂ ?Â label.style_label_upÂ :Â label.style_label_down,Â textcolorÂ =Â textColor,Â sizeÂ =Â size.normal,
Â Â Â Â Â Â Â Â Â Â tooltipÂ =Â str.format('Quantity:Â {0,Â number,Â percent}\nCapitalÂ Risk:Â {1,Â number,Â percent}\nEntryÂ Price:Â {2,Â number,Â currency}\nExitÂ Price:Â {3,Â number,Â currency}\nFreeÂ Profit:Â {4}\nProfit:Â {5}\nGain:Â {6}\nTPÂ ExecÂ #:Â {7,Â number,Â integer}\nRiskÂ Reward:Â {8,Â number,Â #.##}\nInitÂ SL:Â {9,Â number,Â percent}\nAvgÂ TP:Â {10,Â number,Â percent}',
Â Â Â Â Â Â Â Â Â Â Â Â Â shortEntryQuoteQuantityRatio[histId],Â shortCapitalRiskRatio[histId],Â lastShortEntryPrice,Â lastShortExitPrice,Â shortFreeProfitPercStr,Â shortProfitPercStr,Â shortGainPercStr,Â shortTrailTakeProfitExecutedCount,Â shortRiskRewardRatio,Â shortEntryStopLossRatio,Â shortAvgTakeProfitRatio))
//Â Buy&Hold
varÂ floatÂ firstEntryÂ =Â 0.0
varÂ boolÂ firstBuyInitÂ =Â false
varÂ floatÂ buyAndHoldPercÂ =Â 0.0
ifÂ (showMetricsTableÂ andÂ (notÂ firstBuyInitÂ andÂ (enteredLongTradeÂ orÂ enteredShortTrade)))
Â Â Â Â firstEntryÂ :=Â enteredLongTradeÂ ?Â longEntryPriceÂ :Â shortEntryPrice
Â Â Â Â firstBuyInitÂ :=Â true
ifÂ (showMetricsTableÂ andÂ (completedLongTradeÂ orÂ completedShortTrade))
Â Â Â Â buyAndHoldPercÂ :=Â 100.0Â *Â (strategy.closedtrades.exit_price(strategy.closedtradesÂ -Â 1)Â -Â firstEntry)Â /Â firstEntry
//Â PLOTÂ ================================================================================================================
ifÂ (showTableÂ andÂ (barstate.islastconfirmedhistoryÂ orÂ barstate.islast))
Â Â Â Â //Â Trades
Â Â Â Â intÂ numOfWinsÂ =Â winTradeProfitsPerc.size()
Â Â Â Â intÂ numOfLossesÂ =Â lossTradeProfitsPerc.size()
Â Â Â Â intÂ numOfTradesÂ =Â numOfWinsÂ +Â numOfLosses
Â Â Â Â //Â Rate
Â Â Â Â floatÂ winRateÂ =Â numOfWinsÂ /Â numOfTrades
Â Â Â Â floatÂ lossRateÂ =Â numOfLossesÂ /Â numOfTrades
Â Â Â Â //Â AvgÂ FreeÂ Profit
Â Â Â Â varÂ floatÂ winSumFreeProfitÂ =Â nz(winTradeFreeProfitsPerc.sum())
Â Â Â Â varÂ floatÂ lossSumFreeProfitÂ =Â nz(lossTradeFreeProfitsPerc.sum())
Â Â Â Â floatÂ winAvgFreeProfitÂ =Â nz(winSumFreeProfitÂ /Â numOfWins)
Â Â Â Â floatÂ lossAvgFreeProfitÂ =Â nz(lossSumFreeProfitÂ /Â numOfLosses)
Â Â Â Â floatÂ avgFreeProfitÂ =Â winAvgFreeProfitÂ *Â winRateÂ +Â lossAvgFreeProfitÂ *Â lossRate
Â Â Â Â //Â FreeÂ ProfitÂ Dev
Â Â Â Â floatÂ winFreeProfitStDevÂ =Â nz(winTradeFreeProfitsPerc.stdev())
Â Â Â Â floatÂ lossFreeProfitStDevÂ =Â nz(lossTradeFreeProfitsPerc.stdev())
Â Â Â Â floatÂ freeProfitStDevÂ =Â winFreeProfitStDevÂ *Â winRateÂ +Â lossFreeProfitStDevÂ *Â lossRate
Â Â Â Â //Â AvgÂ Profit
Â Â Â Â floatÂ winSumProfitÂ =Â nz(winTradeProfitsPerc.sum())
Â Â Â Â floatÂ winAvgProfitÂ =Â nz(winSumProfitÂ /Â numOfWins)
Â Â Â Â floatÂ lossSumProfitÂ =Â nz(lossTradeProfitsPerc.sum())
Â Â Â Â floatÂ lossAvgProfitÂ =Â nz(lossSumProfitÂ /Â numOfLosses)
Â Â Â Â floatÂ avgProfitÂ =Â winAvgProfitÂ *Â winRateÂ +Â lossAvgProfitÂ *Â lossRate
Â Â Â Â //Â ProfitÂ Dev
Â Â Â Â floatÂ winProfitStDevÂ =Â nz(winTradeProfitsPerc.stdev())
Â Â Â Â floatÂ lossProfitStDevÂ =Â nz(lossTradeProfitsPerc.stdev())
Â Â Â Â floatÂ profitStDevÂ =Â winProfitStDevÂ *Â winRateÂ +Â lossProfitStDevÂ *Â lossRate
Â Â Â Â //Â AvgÂ Gain
Â Â Â Â floatÂ winSumGainÂ =Â nz(winTradeGainsPerc.sum())
Â Â Â Â floatÂ winAvgGainÂ =Â nz(winSumGainÂ /Â numOfWins)
Â Â Â Â floatÂ lossSumGainÂ =Â nz(lossTradeGainsPerc.sum())
Â Â Â Â floatÂ lossAvgGainÂ =Â nz(lossSumGainÂ /Â numOfLosses)
Â Â Â Â floatÂ avgGainÂ =Â winAvgGainÂ *Â winRateÂ +Â lossAvgGainÂ *Â lossRate
Â Â Â Â //Â GainÂ Dev
Â Â Â Â floatÂ winGainStDevÂ =Â nz(winTradeGainsPerc.stdev())
Â Â Â Â floatÂ lossGainStDevÂ =Â nz(lossTradeGainsPerc.stdev())
Â Â Â Â floatÂ gainStDevÂ =Â winGainStDevÂ *Â winRateÂ +Â lossGainStDevÂ *Â lossRate
Â Â Â Â //Â Quantity
Â Â Â Â floatÂ winAvgQuantityPercÂ =Â quantityMethodÂ !=Â 'EQUITY'Â ?Â nz(winSumQuantityPercÂ /Â numOfWins)Â :Â 100.0Â *Â equityRatio
Â Â Â Â floatÂ lossAvgQuantityPercÂ =Â quantityMethodÂ !=Â 'EQUITY'Â ?Â nz(lossSumQuantityPercÂ /Â numOfLosses)Â :Â 100.0Â *Â equityRatio
Â Â Â Â floatÂ avgQuantityPercÂ =Â winAvgQuantityPercÂ *Â winRateÂ +Â lossAvgQuantityPercÂ *Â lossRate
Â Â Â Â //Â Risk
Â Â Â Â floatÂ winAvgCapitalRiskPercÂ =Â quantityMethodÂ !=Â 'RISK'Â ?Â nz(winRisksPerc.avg())Â :Â 100.0Â *Â capitalRiskRatio
Â Â Â Â floatÂ lossAvgCapitalRiskPercÂ =Â quantityMethodÂ !=Â 'RISK'Â ?Â nz(lossRisksPerc.avg())Â :Â 100.0Â *Â capitalRiskRatio
Â Â Â Â floatÂ avgCapitalRiskPercÂ =Â winAvgCapitalRiskPercÂ *Â winRateÂ +Â lossAvgCapitalRiskPercÂ *Â lossRate
Â Â Â Â //Â TPÂ ExecÂ #
Â Â Â Â floatÂ winAvgTPExecutedCountÂ =Â nz(winSumTakeProfitExecutedCountÂ /Â numOfWins)
Â Â Â Â floatÂ lossAvgTPExecutedCountÂ =Â nz(lossSumTakeProfitExecutedCountÂ /Â numOfLosses)
Â Â Â Â floatÂ avgTPExecutedCountÂ =Â winAvgTPExecutedCountÂ *Â winRateÂ +Â lossAvgTPExecutedCountÂ *Â lossRate
Â Â Â Â //Â Risk/Reward
Â Â Â Â floatÂ winAvgRiskRewardRatioÂ =Â nz(winRiskRewardRatios.avg())
Â Â Â Â floatÂ lossAvgRiskRewardRatioÂ =Â nz(lossRiskRewardRatios.avg())
Â Â Â Â floatÂ avgRiskRewardRatioÂ =Â winAvgRiskRewardRatioÂ *Â winRateÂ +Â lossAvgRiskRewardRatioÂ *Â lossRate
Â Â Â Â //Â StatÂ Strings
Â Â Â Â stringÂ avgFreeProfitStrÂ =Â (avgFreeProfitÂ >Â 0.0Â ?Â '+'Â :Â '')Â +Â str.tostring(avgFreeProfit,Â format.percent)
Â Â Â Â stringÂ freeProfitStDevStrÂ =Â 'Â±'Â +Â str.tostring(freeProfitStDev,Â format.percent)
Â Â Â Â stringÂ lossFreeProfitStDevStrÂ =Â str.tostring(lossFreeProfitStDev,Â format.percent)
Â Â Â Â stringÂ avgProfitStrÂ =Â (avgProfitÂ >Â 0.0Â ?Â '+'Â :Â '')Â +Â str.tostring(avgProfit,Â format.percent)
Â Â Â Â stringÂ profitStDevStrÂ =Â 'Â±'Â +Â str.tostring(profitStDev,Â format.percent)
Â Â Â Â stringÂ lossProfitStDevStrÂ =Â 'Â±'Â +Â str.tostring(lossProfitStDev,Â format.percent)
Â Â Â Â stringÂ avgQuantityStrÂ =Â str.tostring(avgQuantityPerc,Â format.percent)
Â Â Â Â //Â TableÂ colors
Â Â Â Â varÂ colorÂ txtColorÂ =Â color.new(color.silver,Â 0)
Â Â Â Â varÂ colorÂ bgColorÂ =Â color.new(color.black,Â 95)
Â Â Â Â varÂ colorÂ borderColorÂ =Â color.new(color.black,Â 0)
Â Â Â Â varÂ colorÂ positiveTxtColorÂ =Â color.new(takeProfitColor,Â 0)
Â Â Â Â varÂ colorÂ negativeTxtColorÂ =Â color.new(lossColor,Â 0)
Â Â Â Â varÂ colorÂ positiveBgColorÂ =Â color.new(winColor,Â 95)
Â Â Â Â varÂ colorÂ negativeBgColorÂ =Â color.new(stopLossColor,Â 95)
Â Â Â Â //Â TheÂ StatsÂ table
Â Â Â Â ifÂ (showStatsTable)
Â Â Â Â Â Â Â Â varÂ tableÂ statsTableÂ =Â table.new(positionÂ =Â getTablePosition(statsTablePos),Â columnsÂ =Â 4,Â rowsÂ =Â 14,Â frame_colorÂ =Â borderColor,Â frame_widthÂ =Â 2,Â border_colorÂ =Â borderColor,Â border_widthÂ =Â 1)
Â Â Â Â Â Â Â Â //Â HorizontalÂ headers
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 0,Â textÂ =Â 'All',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'AllÂ tradesÂ (winningÂ andÂ losing).')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 0,Â textÂ =Â 'Wins',Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â positiveBgColor,Â tooltipÂ =Â 'TheÂ winningÂ trades.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 0,Â textÂ =Â 'Losses',Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â negativeBgColor,Â tooltipÂ =Â 'TheÂ losingÂ trades.')
Â Â Â Â Â Â Â Â //Â VerticalÂ headers
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 1,Â textÂ =Â 'Trades',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ totalÂ numberÂ ofÂ tradesÂ andÂ thoseÂ thatÂ hadÂ aÂ winning/losingÂ outcome.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 2,Â textÂ =Â 'Streak',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ maximumÂ consecutiveÂ numberÂ ofÂ wins/lossesÂ inÂ aÂ row.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 3,Â textÂ =Â 'Rate',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ percentÂ ofÂ theÂ wins/losses.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 4,Â textÂ =Â 'AvgÂ FreeÂ Profit',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ freeÂ averageÂ profitÂ (percentagewise)Â perÂ tradeÂ ofÂ all/winning/losingÂ trades.Â ThisÂ isÂ theÂ profitÂ youÂ wouldÂ haveÂ ifÂ youÂ enteredÂ andÂ exitedÂ allÂ theÂ tradesÂ withoutÂ anyÂ stopÂ lossÂ andÂ takeÂ profitsÂ reached.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 5,Â textÂ =Â 'FreeÂ ProfitÂ Dev',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ standardÂ deviationÂ ofÂ all/winning/losingÂ tradeÂ freeÂ profits.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 6,Â textÂ =Â 'AvgÂ Profit',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ averageÂ profitÂ (percentagewise)Â perÂ tradeÂ ofÂ all/winning/losingÂ trades.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 7,Â textÂ =Â 'ProfitÂ Dev',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ standardÂ deviationÂ ofÂ all/winning/losingÂ tradeÂ profits.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 8,Â textÂ =Â 'AvgÂ Gain',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ averageÂ gainÂ onÂ accountÂ (percentagewise)Â perÂ tradeÂ ofÂ all/winning/losingÂ tradesÂ weightedÂ byÂ theÂ entryÂ quantityÂ percentage.Â ThusÂ theÂ resultÂ isÂ non-compounding.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 9,Â textÂ =Â 'GainÂ Dev',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ standardÂ deviationÂ ofÂ all/winning/losingÂ tradeÂ gains.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 10,Â textÂ =Â 'Quantity',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ averageÂ quantityÂ percentÂ ofÂ all/winning/losingÂ trades.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 11,Â textÂ =Â 'CapitalÂ Risk',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ averageÂ capitalÂ atÂ riskÂ ofÂ all/winning/losingÂ trades.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 12,Â textÂ =Â 'TPÂ ExecÂ #',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ averageÂ numberÂ ofÂ takeÂ profitÂ targetsÂ executedÂ duringÂ all/winning/losingÂ trades.')
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 13,Â textÂ =Â 'RiskÂ Reward',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'TheÂ averageÂ riskÂ toÂ rewardÂ ratioÂ whenÂ enteredÂ all/winning/losingÂ trades.')
Â Â Â Â Â Â Â Â //Â Trades
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 1,Â textÂ =Â str.tostring(numOfTrades),Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 1,Â textÂ =Â str.tostring(numOfWins),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 1,Â textÂ =Â str.tostring(numOfLosses),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â Streak
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 2,Â textÂ =Â numOfInconclusiveExitsÂ >Â 0Â ?Â 'ğŸš¨'Â :Â '',Â bgcolorÂ =Â numOfInconclusiveExitsÂ >Â 0Â ?Â negativeBgColorÂ :Â bgColor,Â tooltipÂ =Â str.format('WARNING!Â {0,Â number,Â integer}Â inconclusiveÂ exitÂ order(s)Â wereÂ detectedÂ thisÂ isÂ theÂ {1,Â number,Â percent}Â ofÂ allÂ theÂ trades.Â ThisÂ meansÂ thatÂ ordersÂ existÂ wereÂ bothÂ takeÂ profitÂ andÂ stopÂ lossÂ couldÂ beÂ reachedÂ atÂ theÂ sameÂ barÂ andÂ exitÂ theÂ trade,Â butÂ dueÂ toÂ theÂ "lossÂ ofÂ information"Â inÂ thatÂ timeframeÂ aÂ randomÂ exitÂ wereÂ chosen.Â PleaseÂ useÂ aÂ lowerÂ timeframeÂ orÂ theÂ barÂ magnifierÂ featureÂ toÂ haveÂ moreÂ accurateÂ results.',Â numOfInconclusiveExits,Â numOfInconclusiveExitsÂ /Â numOfTrades))
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 2,Â textÂ =Â str.tostring(maxWinningStreak),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 2,Â textÂ =Â str.tostring(maxLosingStreak),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â Rate
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 3,Â textÂ =Â str.tostring(100.0Â *Â (winRateÂ +Â lossRate),Â format.percent),Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 3,Â textÂ =Â str.tostring(100.0Â *Â winRate,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 3,Â textÂ =Â str.tostring(100.0Â *Â lossRate,Â format.percent),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â FreeÂ AvgÂ Profit
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 4,Â textÂ =Â avgFreeProfitStr,Â text_colorÂ =Â avgFreeProfitÂ >Â 0.0Â ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 4,Â textÂ =Â '+'Â +Â str.tostring(winAvgFreeProfit,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 4,Â textÂ =Â str.tostring(lossAvgFreeProfit,Â format.percent),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â FreeÂ ProfitÂ Dev
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 5,Â textÂ =Â freeProfitStDevStr,Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 5,Â textÂ =Â 'Â±'Â +Â str.tostring(winFreeProfitStDev,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 5,Â textÂ =Â lossFreeProfitStDevStr,Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â AvgÂ Profit
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 6,Â textÂ =Â avgProfitStr,Â text_colorÂ =Â avgProfitÂ >Â 0.0Â ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 6,Â textÂ =Â '+'Â +Â str.tostring(winAvgProfit,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 6,Â textÂ =Â str.tostring(lossAvgProfit,Â format.percent),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â ProfitÂ Dev
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 7,Â textÂ =Â profitStDevStr,Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 7,Â textÂ =Â 'Â±'Â +Â str.tostring(winProfitStDev,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 7,Â textÂ =Â lossProfitStDevStr,Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â AvgÂ Gain
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 8,Â textÂ =Â (avgGainÂ >Â 0.0Â ?Â '+'Â :Â '')Â +Â str.tostring(avgGain,Â format.percent),Â text_colorÂ =Â avgGainÂ >Â 0.0Â ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 8,Â textÂ =Â '+'Â +Â str.tostring(winAvgGain,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 8,Â textÂ =Â str.tostring(lossAvgGain,Â format.percent),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â GainÂ Dev
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 9,Â textÂ =Â 'Â±'Â +Â str.tostring(gainStDev,Â format.percent),Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 9,Â textÂ =Â 'Â±'Â +Â str.tostring(winGainStDev,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 9,Â textÂ =Â 'Â±'Â +Â str.tostring(lossGainStDev,Â format.percent),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â Quantity
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 10,Â textÂ =Â avgQuantityStr,Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 10,Â textÂ =Â str.tostring(winAvgQuantityPerc,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 10,Â textÂ =Â str.tostring(lossAvgQuantityPerc,Â format.percent),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â Risk
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 11,Â textÂ =Â str.tostring(avgCapitalRiskPerc,Â format.percent),Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 11,Â textÂ =Â str.tostring(winAvgCapitalRiskPerc,Â format.percent),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 11,Â textÂ =Â str.tostring(lossAvgCapitalRiskPerc,Â format.percent),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â TPÂ ExecÂ #
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 12,Â textÂ =Â str.tostring(avgTPExecutedCount,Â '#.##'),Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 12,Â textÂ =Â str.tostring(winAvgTPExecutedCount,Â '#.##'),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 12,Â textÂ =Â str.tostring(lossAvgTPExecutedCount,Â '#.##'),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â Risk/Reward
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 1,Â rowÂ =Â 13,Â textÂ =Â str.tostring(avgRiskRewardRatio,Â '#.##'),Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â bgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 2,Â rowÂ =Â 13,Â textÂ =Â str.tostring(winAvgRiskRewardRatio,Â '#.##'),Â text_colorÂ =Â positiveTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â positiveBgColor)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 3,Â rowÂ =Â 13,Â textÂ =Â str.tostring(lossAvgRiskRewardRatio,Â '#.##'),Â text_colorÂ =Â negativeTxtColor,Â text_sizeÂ =Â size.small,Â bgcolorÂ =Â negativeBgColor)
Â Â Â Â Â Â Â Â //Â TableÂ Description
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â statsTable,Â columnÂ =Â 0,Â rowÂ =Â 0,Â textÂ =Â 'â“',Â text_colorÂ =Â txtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â bgColor,Â tooltipÂ =Â 'ThisÂ tableÂ summarizesÂ theÂ overallÂ statisticsÂ ofÂ all/winning/losingÂ tradesÂ ofÂ theÂ strategy.Â InÂ contrastÂ toÂ theÂ TVÂ backtestÂ engine,Â aÂ tradeÂ isÂ consideredÂ toÂ beÂ completeÂ whenÂ theÂ entireÂ entryÂ positionÂ wasÂ exitedÂ andÂ notÂ whenÂ anÂ orderÂ isÂ executedÂ (e.g.Â aÂ takeÂ profitÂ priceÂ targetÂ isÂ reached).')
Â Â Â Â //Â TheÂ MetricsÂ table
Â Â Â Â ifÂ (showMetricsTable)
Â Â Â Â Â Â Â Â varÂ tableÂ metricsTableÂ =Â table.new(positionÂ =Â getTablePosition(metricsTablePos),Â columnsÂ =Â 3,Â rowsÂ =Â 2,Â frame_colorÂ =Â borderColor,Â frame_widthÂ =Â 2,Â border_colorÂ =Â borderColor,Â border_widthÂ =Â 1)
Â Â Â Â Â Â Â Â //Â MetricsÂ AlphaÂ -Â BetaÂ -Â Gamma
Â Â Â Â Â Â Â Â floatÂ sumProfitÂ =Â winSumProfitÂ +Â lossSumProfit
Â Â Â Â Â Â Â Â floatÂ alphaÂ =Â 1.0Â +Â nz((sumProfitÂ -Â buyAndHoldPerc)Â /Â math.abs(buyAndHoldPerc))
Â Â Â Â Â Â Â Â boolÂ alphaAcceptanceÂ =Â alphaÂ >=Â 1.0
Â Â Â Â Â Â Â Â floatÂ netProfitPercÂ =Â 100.0Â *Â strategy.netprofitÂ /Â strategy.initial_capital
Â Â Â Â Â Â Â Â floatÂ betaÂ =Â 1.0Â +Â nz((netProfitPercÂ -Â buyAndHoldPerc)Â /Â math.abs(buyAndHoldPerc))
Â Â Â Â Â Â Â Â boolÂ betaAcceptanceÂ =Â betaÂ >=Â 1.0
Â Â Â Â Â Â Â Â floatÂ kellyRatioPercÂ =Â 100.0Â *Â (winRateÂ *Â avgRiskRewardRatioÂ -Â lossRate)Â /Â avgRiskRewardRatio
Â Â Â Â Â Â Â Â floatÂ gammaÂ =Â 1.0Â +Â nz((kellyRatioPercÂ -Â avgQuantityPerc)Â /Â avgQuantityPerc)
Â Â Â Â Â Â Â Â boolÂ gammaAcceptanceÂ =Â gammaÂ >=Â 1.0
Â Â Â Â Â Â Â Â stringÂ buyAndHoldPercStrÂ =Â str.tostring(buyAndHoldPerc,Â format.percent)
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â metricsTable,Â columnÂ =Â 0,Â rowÂ =Â 0,Â textÂ =Â str.format('Î±:Â {0,Â number,Â percent}',Â alpha),Â text_colorÂ =Â alphaAcceptanceÂ ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â alphaAcceptanceÂ ?Â positiveBgColorÂ :Â negativeBgColor,Â tooltipÂ =Â str.format('ThisÂ alphaÂ metricÂ showsÂ howÂ betterÂ orÂ worstÂ theÂ sumÂ ofÂ theÂ profits/lossesÂ isÂ ({0})Â asÂ aÂ percentageÂ comparedÂ toÂ theÂ buyÂ andÂ holdÂ returnÂ ({1}).Â IfÂ theÂ alphaÂ valueÂ isÂ lessÂ thanÂ 100%Â thisÂ meansÂ thatÂ theÂ strategyÂ performedÂ worseÂ thanÂ theÂ buyÂ andÂ holdÂ forÂ theÂ periodÂ ofÂ theÂ backtesting.',Â str.tostring(sumProfit,Â format.percent),Â buyAndHoldPercStr))
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â metricsTable,Â columnÂ =Â 1,Â rowÂ =Â 0,Â textÂ =Â str.format('Î²:Â {0,Â number,Â percent}',Â beta),Â text_colorÂ =Â betaAcceptanceÂ ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â betaAcceptanceÂ ?Â positiveBgColorÂ :Â negativeBgColor,Â tooltipÂ =Â str.format('ThisÂ betaÂ metricÂ showsÂ howÂ betterÂ orÂ worstÂ theÂ netÂ profitÂ isÂ ({0})Â asÂ aÂ percentageÂ comparedÂ toÂ theÂ buyÂ andÂ holdÂ returnÂ ({1}).Â IfÂ theÂ betaÂ valueÂ isÂ lessÂ thanÂ 100%Â thisÂ meansÂ thatÂ theÂ strategyÂ performedÂ worseÂ thanÂ theÂ buyÂ andÂ holdÂ forÂ theÂ periodÂ ofÂ theÂ backtesting.',Â str.tostring(netProfitPerc,Â format.percent),Â buyAndHoldPercStr))
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â metricsTable,Â columnÂ =Â 2,Â rowÂ =Â 0,Â textÂ =Â str.format('Î³:Â {0,Â number,Â percent}',Â gamma),Â text_colorÂ =Â gammaAcceptanceÂ ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â gammaAcceptanceÂ ?Â positiveBgColorÂ :Â negativeBgColor,Â tooltipÂ =Â str.format('ThisÂ gammaÂ metricÂ showsÂ howÂ betterÂ orÂ worstÂ theÂ averageÂ quantityÂ percentÂ perÂ tradeÂ isÂ ({0})Â asÂ aÂ percentageÂ comparedÂ toÂ theÂ KellyÂ ratioÂ ({1}).Â IfÂ theÂ gammaÂ valueÂ isÂ lessÂ thanÂ 100%Â andÂ theÂ kellyÂ ratioÂ isÂ possitiveÂ thisÂ meansÂ youÂ takeÂ tooÂ muchÂ riskÂ onÂ everyÂ tradeÂ forÂ theÂ periodÂ ofÂ theÂ backtestingÂ andÂ youÂ haveÂ toÂ decreaseÂ theÂ quantityÂ pecentageÂ (orÂ capitalÂ atÂ riskÂ %)Â ofÂ eachÂ trade.Â AnÂ otherÂ alternativeÂ isÂ toÂ tryÂ toÂ increaseÂ theÂ kellyÂ ratioÂ byÂ increasingÂ theÂ winÂ rateÂ and/orÂ theÂ riskÂ toÂ rewardÂ ratio.',Â avgQuantityStr,Â str.tostring(kellyRatioPerc,Â format.percent)))
Â Â Â Â Â Â Â Â //Â MetricsÂ ChiÂ -Â PsiÂ -Â Zeta
Â Â Â Â Â Â Â Â floatÂ chiÂ =Â 1.0Â +Â nz((avgProfitÂ -Â avgFreeProfit)Â /Â math.abs(avgFreeProfit))
Â Â Â Â Â Â Â Â boolÂ chiAcceptanceÂ =Â chiÂ >=Â 1.0
Â Â Â Â Â Â Â Â floatÂ profitStDevIncÂ =Â 1.0Â +Â nz((profitStDevÂ -Â freeProfitStDev)Â /Â math.abs(freeProfitStDev))
Â Â Â Â Â Â Â Â floatÂ psiÂ =Â chiÂ /Â profitStDevInc
Â Â Â Â Â Â Â Â boolÂ psiAcceptanceÂ =Â psiÂ >=Â 1.0
Â Â Â Â Â Â Â Â floatÂ lossProfitStDevIncÂ =Â 1.0Â +Â nz((lossProfitStDevÂ -Â lossFreeProfitStDev)Â /Â math.abs(lossFreeProfitStDev))
Â Â Â Â Â Â Â Â floatÂ zetaÂ =Â chiÂ /Â lossProfitStDevInc
Â Â Â Â Â Â Â Â boolÂ zetaAcceptanceÂ =Â zetaÂ >=Â 1.0
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â metricsTable,Â columnÂ =Â 0,Â rowÂ =Â 1,Â textÂ =Â str.format('Ï‡:Â {0,Â number,Â percent}',Â chi),Â text_colorÂ =Â chiAcceptanceÂ ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â chiAcceptanceÂ ?Â positiveBgColorÂ :Â negativeBgColor,Â tooltipÂ =Â str.format('ThisÂ chiÂ metricÂ showsÂ howÂ betterÂ orÂ worstÂ theÂ averageÂ profitÂ isÂ ({0})Â asÂ aÂ percentageÂ comparedÂ toÂ theÂ freeÂ profitÂ ({1}).Â IfÂ theÂ chiÂ valueÂ isÂ lessÂ thanÂ 100%Â thisÂ meansÂ thatÂ theÂ strategyÂ wouldÂ haveÂ moreÂ profitsÂ withoutÂ theÂ takeÂ profitÂ targetsÂ forÂ theÂ periodÂ ofÂ theÂ backtesting.',Â avgProfitStr,Â avgFreeProfitStr))
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â metricsTable,Â columnÂ =Â 1,Â rowÂ =Â 1,Â textÂ =Â str.format('Ïˆ:Â {0,Â number,Â percent}',Â psi),Â text_colorÂ =Â psiAcceptanceÂ ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â psiAcceptanceÂ ?Â positiveBgColorÂ :Â negativeBgColor,Â tooltipÂ =Â str.format('ThisÂ psiÂ metricÂ showsÂ theÂ ratioÂ ofÂ theÂ chiÂ withÂ theÂ standardÂ deviationÂ percentageÂ increaseÂ ({0,Â number,Â percent}).Â ThatÂ showsÂ howÂ betterÂ orÂ worstÂ theÂ standardÂ deviationÂ isÂ ({1})Â asÂ aÂ percentageÂ comparedÂ toÂ theÂ freeÂ standardÂ deviationÂ ({2}).Â IfÂ theÂ psiÂ valueÂ isÂ lessÂ thanÂ 100%Â thisÂ meansÂ thatÂ theÂ strategyÂ increasesÂ theÂ standardÂ deviationÂ wayÂ tooÂ muchÂ forÂ theÂ additionalÂ profitsÂ thatÂ returnsÂ onÂ topÂ ofÂ theÂ freeÂ profitÂ forÂ theÂ periodÂ ofÂ theÂ backtesting.',Â profitStDevInc,Â profitStDevStr,Â freeProfitStDevStr))
Â Â Â Â Â Â Â Â table.cell(table_idÂ =Â metricsTable,Â columnÂ =Â 2,Â rowÂ =Â 1,Â textÂ =Â str.format('Î¶:Â {0,Â number,Â percent}',Â zeta),Â text_colorÂ =Â zetaAcceptanceÂ ?Â positiveTxtColorÂ :Â negativeTxtColor,Â text_sizeÂ =Â size.normal,Â bgcolorÂ =Â zetaAcceptanceÂ ?Â positiveBgColorÂ :Â negativeBgColor,Â tooltipÂ =Â str.format('TheÂ zetaÂ metricÂ showsÂ theÂ ratioÂ ofÂ theÂ chiÂ withÂ theÂ downsideÂ deviationÂ percentageÂ increaseÂ ({0,Â number,Â percent}).Â ThatÂ showsÂ howÂ betterÂ orÂ worstÂ theÂ downwardsÂ deviationÂ isÂ ({1})Â asÂ aÂ percentageÂ comparedÂ toÂ theÂ freeÂ downwardsÂ deviationÂ ({2}).Â IfÂ theÂ zetaÂ valueÂ isÂ lessÂ thanÂ 100%Â thisÂ meansÂ thatÂ theÂ strategyÂ increasesÂ theÂ downwardsÂ deviationÂ wayÂ tooÂ muchÂ forÂ theÂ additionalÂ profitsÂ thatÂ returnsÂ onÂ topÂ ofÂ theÂ freeÂ profitÂ forÂ theÂ periodÂ ofÂ theÂ backtesting.',Â lossProfitStDevInc,Â lossProfitStDevStr,Â lossFreeProfitStDevStr))
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ—²Â EXECUTIONÂ CONDITIONS
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ conditionalÂ variablesÂ toÂ enterÂ andÂ exitÂ orders
//Â Dependencies:Â ENTRY,Â EXIT
//Â Results:Â ALL
//Â LOGICÂ ===============================================================================================================
boolÂ doCloseMarketLongÂ =Â (exitOrderTypeÂ ==Â 'MARKET'Â andÂ validCloseLongPosition)Â orÂ (stopLossWaitCloseConfirmÂ andÂ closeÂ <Â longStopLossPrice)Â orÂ validOpenShortPosition
boolÂ doCloseMarketShortÂ =Â (exitOrderTypeÂ ==Â 'MARKET'Â andÂ validCloseShortPosition)Â orÂ (stopLossWaitCloseConfirmÂ andÂ closeÂ >Â shortStopLossPrice)Â orÂ validOpenLongPosition
boolÂ doEnterMarketLongÂ =Â entryOrderTypeÂ ==Â 'MARKET'Â ?Â validOpenLongPositionÂ :Â longLimitOrStopEntryIsActive
boolÂ doCnlLimitEntryLongÂ =Â longLimitOrStopEntryIsActive[1]Â andÂ validCnlOpenLongPosition
boolÂ doSLorExitLimitLongÂ =Â longLimitExitIsActiveÂ orÂ longIsActive
boolÂ doCnlLimitExitLongÂ =Â longLimitExitIsActiveÂ andÂ validCnlCloseLongPosition
boolÂ doEnterMarketShortÂ =Â entryOrderTypeÂ ==Â 'MARKET'Â ?Â validOpenShortPositionÂ :Â shortLimitOrStopEntryIsActive
boolÂ doCnlLimitEntryShortÂ =Â shortLimitOrStopEntryIsActive[1]Â andÂ validCnlOpenShortPosition
boolÂ doSLorExitLimitShortÂ =Â shortLimitExitIsActiveÂ orÂ shortIsActive
boolÂ doCnlLimitExitShortÂ =Â shortLimitExitIsActiveÂ andÂ validCnlCloseShortPosition
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ””Â ALERTÂ MESSAGES
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ messageÂ outputsÂ whenÂ strategyÂ ordersÂ areÂ beingÂ executed
//Â Dependencies:Â ENTRY,Â TAKEÂ PROFITÂ 1,Â EXIT,Â STOPÂ LOSS,Â TAKEÂ PROFITÂ 2,Â QUANTITY/RISKÂ MANAGEMENT,Â EXECUTIONÂ CONDITIONS
//Â Results:Â ALL
importÂ jason5480/string_utils/3Â asÂ su
//Â INPUTÂ ===============================================================================================================
tickerPrefixÂ =Â input.string(defvalÂ =Â '',Â titleÂ =Â 'TickerÂ IdÂ Prefix/Postfix',Â inlineÂ =Â 'Ticker',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
tickerPostfixÂ =Â input.string(defvalÂ =Â '',Â titleÂ =Â 'â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹',Â tooltipÂ =Â 'Prepend/AppendÂ aÂ customÂ stringÂ toÂ theÂ TVsÂ tickerÂ idÂ whenÂ youÂ useÂ {{ticker}}Â asÂ variableÂ inÂ theÂ alertÂ messages.',Â inlineÂ =Â 'Ticker',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
usePercRange100Â =Â input.bool(defvalÂ =Â true,Â titleÂ =Â 'PercentageÂ RangeÂ [0,Â 100]',Â tooltipÂ =Â 'EnableÂ toÂ multiplyÂ allÂ theÂ percentatgesÂ withÂ 100Â soÂ thatÂ theÂ valuesÂ rangeÂ fromÂ [0,Â 100]Â insteadÂ ofÂ [0,Â 1].',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
marginMsgTicksÂ =Â input.int(defvalÂ =Â 5,Â titleÂ =Â 'MarginÂ Ticks',Â minvalÂ =Â 1,Â tooltipÂ =Â 'TheÂ ticksÂ thatÂ willÂ beÂ added/substractedÂ fromÂ entry/exitÂ priceÂ toÂ calculateÂ theÂ {${ENTRY+}},Â {${ENTRY-}},Â {${EXIT+}},Â {${EXIT-}}Â variables.Â ThoseÂ valuesÂ couldÂ beÂ usedÂ ifÂ youÂ wantÂ toÂ sendÂ aÂ limitÂ orderÂ toÂ yourÂ exchangeÂ andÂ theÂ priceÂ mightÂ goÂ toÂ theÂ "wrong"Â sideÂ dueÂ toÂ theÂ highÂ volatilityÂ ofÂ theÂ marketÂ andÂ delayÂ betweenÂ theÂ timeÂ ofÂ computationÂ andÂ execution.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
msgEnteredEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ EntryÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "entryÂ orderÂ fills"Â ofÂ theÂ strategyÂ (e.g.Â market,Â limit,Â stopÂ andÂ stop-limitÂ entry).Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
rawMsgEnteredMarketLongÂ =Â msgEnteredEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Entry({{ticker}}):Â BoughtÂ atÂ marketÂ priceÂ ofÂ {{entry_price}}Â {{quote_currency}}Â anÂ amountÂ equalÂ toÂ {{base_quantity}}Â {{base_currency}}Â (forÂ {{quote_quantity}}Â {{quote_currency}})Â andÂ riskÂ ofÂ {{risk_perc}}%.Â TheÂ stopÂ lossÂ wasÂ placedÂ atÂ {{stop_loss_price}}Â {{quote_currency}}Â andÂ takeÂ profitÂ targetsÂ atÂ [{{take_profit_price_1}},Â {{take_profit_price_2}},Â {{take_profit_price_3}},Â {{take_profit_price_4}},Â {{take_profit_price_5}}]Â {{quote_currency}}',Â titleÂ =Â 'EnterÂ MarketÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ enteredÂ longÂ position.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgEnteredMarketShortÂ =Â msgEnteredEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Entry({{ticker}}):Â SoldÂ atÂ marketÂ priceÂ ofÂ {{entry_price}}Â {{quote_currency}}Â anÂ amountÂ equalÂ toÂ {{base_quantity}}Â {{base_currency}}Â (forÂ {{quote_quantity}}Â {{quote_currency}})Â andÂ riskÂ ofÂ {{risk_perc}}%.Â TheÂ stopÂ lossÂ wasÂ placedÂ atÂ {{stop_loss_price}}Â {{quote_currency}}Â andÂ takeÂ profitÂ targetsÂ atÂ [{{take_profit_price_1}},Â {{take_profit_price_2}},Â {{take_profit_price_3}},Â {{take_profit_price_4}},Â {{take_profit_price_5}}]Â {{quote_currency}}',Â titleÂ =Â 'EnterÂ MarketÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ enteredÂ shortÂ position.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgEnteredLimitOrStopLongÂ =Â msgEnteredEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Entry({{ticker}}):Â BoughtÂ withÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ atÂ theÂ priceÂ ofÂ {{entry_price}}Â {{quote_currency}}Â anÂ amountÂ equalÂ toÂ {{base_quantity}}Â {{base_currency}}Â andÂ riskÂ ofÂ {{risk_perc}}%.Â TheÂ stopÂ lossÂ wasÂ placedÂ atÂ {{stop_loss_price}}Â {{quote_currency}}Â andÂ takeÂ profitÂ targetsÂ atÂ [{{take_profit_price_1}},Â {{take_profit_price_2}},Â {{take_profit_price_3}},Â {{take_profit_price_4}},Â {{take_profit_price_5}}]Â {{quote_currency}}',Â titleÂ =Â 'EnterÂ LimitÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ enteredÂ longÂ positionÂ withÂ aÂ limit,Â stopÂ orÂ stop-limitÂ order.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgEnteredLimitOrStopShortÂ =Â msgEnteredEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Entry({{ticker}}):Â SoldÂ withÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ atÂ theÂ priceÂ ofÂ {{entry_price}}Â {{quote_currency}}Â anÂ amountÂ equalÂ toÂ {{base_quantity}}Â {{base_currency}}Â andÂ riskÂ ofÂ {{risk_perc}}%.Â TheÂ stopÂ lossÂ wasÂ placedÂ atÂ {{stop_loss_price}}Â {{quote_currency}}Â andÂ takeÂ profitÂ targetsÂ atÂ [{{take_profit_price_1}},Â {{take_profit_price_2}},Â {{take_profit_price_3}},Â {{take_profit_price_4}},Â {{take_profit_price_5}}]Â {{quote_currency}}',Â titleÂ =Â 'EnterÂ LimitÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ enteredÂ shortÂ positionÂ withÂ aÂ limit,Â stopÂ orÂ stop-limitÂ order.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
msgClosedOrExitedEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ Close/ExitÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "close/exitÂ orderÂ fills"Â ofÂ theÂ strategyÂ (e.g.Â market,Â limitÂ andÂ stopÂ exit).Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
rawMsgClosedMarketLongÂ =Â msgClosedOrExitedEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Close({{ticker}}):Â SoldÂ atÂ marketÂ priceÂ ofÂ {{exit_price}}Â {{quote_currency}}Â {{remaining_quantity_perc}}%Â ofÂ theÂ initialÂ position',Â titleÂ =Â 'CloseÂ MarketÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ closedÂ longÂ position.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgClosedMarketShortÂ =Â msgClosedOrExitedEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Close({{ticker}}):Â BoughtÂ atÂ marketÂ priceÂ ofÂ {{exit_price}}Â {{quote_currency}}Â {{remaining_quantity_perc}}%Â ofÂ theÂ initialÂ position',Â titleÂ =Â 'CloseÂ MarketÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ closedÂ shortÂ position.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgExitedLimitOrStopLongÂ =Â msgClosedOrExitedEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Exit({{ticker}}):Â SoldÂ withÂ limitÂ orÂ stopÂ exitÂ orderÂ atÂ theÂ priceÂ ofÂ {{exit_price}}Â {{quote_currency}}Â {{remaining_quantity_perc}}%Â ofÂ theÂ initialÂ position',Â titleÂ =Â 'ExitÂ LimitÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ exitedÂ longÂ positionÂ withÂ aÂ limitÂ orÂ stopÂ order.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgExitedLimitOrStopShortÂ =Â msgClosedOrExitedEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Exit({{ticker}}):Â BoughtÂ withÂ limitÂ orÂ stopÂ exitÂ orderÂ atÂ theÂ priceÂ ofÂ {{exit_price}}Â {{quote_currency}}Â {{remaining_quantity_perc}}%Â ofÂ theÂ initialÂ position',Â titleÂ =Â 'ExitÂ LimitÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ exitedÂ shortÂ positionÂ withÂ aÂ limitÂ orÂ stopÂ order.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgClosedAllÂ =Â msgClosedOrExitedEnabledÂ ?Â input.text_area(defvalÂ =Â 'CloseÂ All({{ticker}}):Â ClosedÂ allÂ positionsÂ atÂ marketÂ priceÂ ofÂ {{exit_price}}Â {{quote_currency}}',Â titleÂ =Â 'CloseÂ All',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ closedÂ allÂ positions.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
msgTakeProfitEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ TakeÂ ProfitÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "profitÂ orderÂ fills"Â ofÂ theÂ strategyÂ (e.g.Â takeÂ profitÂ "partial"Â exit).Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
varÂ intÂ numOfMaxTPAlertsÂ =Â 5
varÂ string[]Â rawMsgRchTPLongÂ =Â array.new<string>(numOfMaxTPAlerts,Â na)
varÂ string[]Â rawMsgRchTPShortÂ =Â array.new<string>(numOfMaxTPAlerts,Â na)
rawMsgRchTPLong.set(0,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 1Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_1}}Â {{quote_currency}}Â andÂ soldÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP1Â Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ firstÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ longÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPShort.set(0,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 1Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_1}}Â {{quote_currency}}Â andÂ boughtÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP1Â Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ firstÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ shortÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPLong.set(1,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 2Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_2}}Â {{quote_currency}}Â andÂ soldÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP2Â Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ secondÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ longÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPShort.set(1,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 2Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_2}}Â {{quote_currency}}Â andÂ boughtÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP2Â Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ secondÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ shortÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPLong.set(2,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 3Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_3}}Â {{quote_currency}}Â andÂ soldÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP3Â Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ thirdÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ longÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPShort.set(2,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 3Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_3}}Â {{quote_currency}}Â andÂ boughtÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP3Â Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ thirdÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ shortÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPLong.set(3,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 4Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_4}}Â {{quote_currency}}Â andÂ soldÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP4Â Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ forthÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ longÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPShort.set(3,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 4Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_4}}Â {{quote_currency}}Â andÂ boughtÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP4Â Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ forthÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ shortÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPLong.set(4,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 5Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_5}}Â {{quote_currency}}Â andÂ soldÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP5Â Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ fifthÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ longÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
rawMsgRchTPShort.set(4,Â msgTakeProfitEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Exit({{ticker}}):Â TakeÂ ProfitÂ 5Â executedÂ atÂ theÂ priceÂ ofÂ {{take_profit_price_5}}Â {{quote_currency}}Â andÂ boughtÂ {{take_profit_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{take_profit_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'TP5Â Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ fifthÂ takeÂ profitÂ priceÂ targetÂ forÂ theÂ shortÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na)
msgStopLossEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ StopÂ LossÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "stop_lossÂ orderÂ fills"Â ofÂ theÂ strategyÂ (e.g.Â stopÂ lossÂ exit).Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
rawMsgRchSLLongÂ =Â msgStopLossEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ Exit({{ticker}}):Â StopÂ LossÂ executedÂ atÂ theÂ priceÂ ofÂ {{stop_loss_price}}Â {{quote_currency}}Â andÂ soldÂ {{remaining_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{remaining_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'SLÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ lastÂ stopÂ lossÂ targetÂ forÂ theÂ longÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgRchSLShortÂ =Â msgStopLossEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ Exit({{ticker}}):Â StopÂ LossÂ executedÂ atÂ theÂ priceÂ ofÂ {{stop_loss_price}}Â {{quote_currency}}Â andÂ boughtÂ {{remaining_quantity_perc}}%Â ofÂ theÂ initialÂ position,Â thatÂ equalsÂ toÂ anÂ amountÂ ofÂ {{remaining_base_quantity}}Â {{base_currency}}',Â titleÂ =Â 'SLÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ lastÂ stopÂ lossÂ targetÂ forÂ theÂ shortÂ positionÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
msgChgTrEntryEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ TrÂ EntryÂ ChangeÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "alert()Â functionÂ calls"Â whenÂ theÂ trailingÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ priceÂ changes.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
rawMsgChgTrEntryLongÂ =Â msgChgTrEntryEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ TrailingÂ EntryÂ Update({{ticker}}):Â LongÂ trailingÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ changedÂ andÂ setÂ atÂ aÂ newÂ priceÂ ofÂ {{entry_price}}Â {{quote_currency}}',Â titleÂ =Â 'ChgÂ TrÂ EntryÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ longÂ trailingÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ changed.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgChgTrEntryShortÂ =Â msgChgTrEntryEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ TrailingÂ EntryÂ Update({{ticker}}):Â ShortÂ trailingÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ changedÂ andÂ setÂ atÂ aÂ newÂ priceÂ ofÂ {{entry_price}}Â {{quote_currency}}',Â titleÂ =Â 'ChgÂ TrÂ EntryÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ shortÂ trailingÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ changed.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
msgChgTrExitEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ TrÂ ExitÂ ChangeÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "alert()Â functionÂ calls"Â whenÂ theÂ trailingÂ limitÂ orÂ stopÂ exitÂ priceÂ changes.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
rawMsgChgTrExitLongÂ =Â msgChgTrExitEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ TrailingÂ ExitÂ Update({{ticker}}):Â LongÂ trailingÂ limitÂ orÂ stopÂ exitÂ orderÂ changedÂ andÂ setÂ atÂ aÂ newÂ priceÂ ofÂ {{exit_price}}Â {{quote_currency}}',Â titleÂ =Â 'ChgÂ TrÂ ExitÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ longÂ trailingÂ limitÂ orÂ stopÂ exitÂ orderÂ changed.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgChgTrExitShortÂ =Â msgChgTrExitEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ TrailingÂ ExitÂ Update({{ticker}}):Â ShortÂ trailingÂ limitÂ orÂ stopÂ exitÂ orderÂ changedÂ andÂ setÂ atÂ aÂ newÂ priceÂ ofÂ {{exit_price}}Â {{quote_currency}}',Â titleÂ =Â 'ChgÂ TrÂ ExitÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ shortÂ trailingÂ limitÂ orÂ stopÂ exitÂ orderÂ changed.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
msgChgSLEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ StopÂ LossÂ ChangeÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "alert()Â functionÂ calls"Â whenÂ theÂ stopÂ lossÂ priceÂ changes.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
rawMsgChgSLLongÂ =Â msgChgSLEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ StopÂ LossÂ Update({{ticker}}):Â StopÂ LossÂ valueÂ changedÂ andÂ setÂ atÂ aÂ newÂ priceÂ ofÂ {{stop_loss_price}}Â {{quote_currency}}',Â titleÂ =Â 'ChgÂ SLÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ stopÂ lossÂ targetÂ forÂ theÂ longÂ positionÂ changed.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgChgSLShortÂ =Â msgChgSLEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ StopÂ LossÂ Update({{ticker}}):Â StopÂ LossÂ valueÂ changedÂ andÂ setÂ atÂ aÂ newÂ priceÂ ofÂ {{stop_loss_price}}Â {{quote_currency}}',Â titleÂ =Â 'ChgÂ SLÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ stopÂ lossÂ targetÂ forÂ theÂ shortÂ positionÂ changed.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
msgCnlLimitOrStopEntryEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ LimitÂ EntryÂ CancelÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "alert()Â functionÂ calls"Â whenÂ useÂ limit,Â stopÂ orÂ stop-limitÂ orderÂ forÂ entryÂ andÂ itÂ cancels.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
rawMsgCnlLimitOrStopEntryLongÂ =Â msgCnlLimitOrStopEntryEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ LimitÂ EntryÂ Cancel({{ticker}}):Â LongÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ canceled',Â titleÂ =Â 'CnlÂ LimitÂ EntryÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ longÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ canceled.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgCnlLimitOrStopEntryShortÂ =Â msgCnlLimitOrStopEntryEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ LimitÂ EntryÂ Cancel({{ticker}}):Â ShortÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ canceled',Â titleÂ =Â 'CnlÂ LimitÂ EntryÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ shortÂ limit,Â stopÂ orÂ stop-limitÂ entryÂ orderÂ canceled.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
msgCnlLimitOrStopExitEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ LimitÂ ExitÂ CancelÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ "alert()Â functionÂ calls"Â whenÂ useÂ limitÂ orÂ stopÂ orderÂ forÂ exitÂ andÂ itÂ cancels.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
rawMsgCnlLimitOrStopExitLongÂ =Â msgCnlLimitOrStopExitEnabledÂ ?Â input.text_area(defvalÂ =Â 'LongÂ LimitÂ ExitÂ Cancel({{ticker}}):Â LongÂ limitÂ orÂ stopÂ exitÂ orderÂ canceled',Â titleÂ =Â 'CnlÂ LimitÂ ExitÂ Long',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ longÂ limitÂ orÂ stopÂ exitÂ orderÂ canceled.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
rawMsgCnlLimitOrStopExitShortÂ =Â msgCnlLimitOrStopExitEnabledÂ ?Â input.text_area(defvalÂ =Â 'ShortÂ LimitÂ ExitÂ Cancel({{ticker}}):Â ShortÂ limitÂ orÂ stopÂ exitÂ orderÂ canceled',Â titleÂ =Â 'CnlÂ LimitÂ ExitÂ Short',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ shortÂ limitÂ orÂ stopÂ exitÂ orderÂ canceled.Â InÂ theÂ "Condition"Â comboboxÂ ofÂ theÂ "CreateÂ Alert"Â dialog,Â theÂ "OrderÂ fillsÂ andÂ alert()Â functionÂ calls"Â orÂ theÂ "alert()Â functionÂ callsÂ only"Â optionsÂ shouldÂ beÂ selectedÂ toÂ beÂ ableÂ toÂ receiveÂ thisÂ alertÂ message.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
msgMaxDrawdownEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'EnableÂ MaxÂ DrawdownÂ Alertsâš ï¸ğŸŒ',Â tooltipÂ =Â 'EnableÂ theÂ alertÂ messagesÂ thatÂ correspondÂ toÂ maxÂ drawÂ downÂ reachedÂ event.Â WARNING!Â ComputationalÂ heavyÂ operation.Â IfÂ youÂ getÂ aÂ timeoutÂ errorÂ adjustÂ theÂ timeÂ windowÂ filterÂ orÂ disableÂ otherÂ computationalÂ heavyÂ operations.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')
msgMaxDrawdownÂ =Â msgMaxDrawdownEnabledÂ ?Â input.text_area(defvalÂ =Â 'MaxÂ drawdownÂ wasÂ reached:Â AllÂ pendingÂ ordersÂ areÂ canceled,Â allÂ openÂ positionsÂ areÂ closedÂ andÂ noÂ newÂ ordersÂ canÂ beÂ placed!Â RIPâš°ï¸',Â titleÂ =Â 'MaxÂ Drawdown',Â tooltipÂ =Â 'AlertÂ messageÂ emittedÂ whenÂ theÂ maxÂ drawdownÂ limitÂ isÂ reached.Â TextÂ thatÂ willÂ replaceÂ theÂ \'{{strategy.order.alert_message}}\'Â placeholderÂ whenÂ oneÂ isÂ usedÂ inÂ theÂ "Message"Â fieldÂ ofÂ theÂ "CreateÂ Alert"Â dialog.',Â groupÂ =Â 'ğŸ””Â AlertÂ Messages')Â :Â na
showAlertsEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'ShowÂ Alerts',Â tooltipÂ =Â 'ShowÂ alertÂ messagesÂ thatÂ correspondÂ toÂ eventsÂ inÂ theÂ chart.',Â groupÂ =Â 'ğŸÂ Debug')
//Â LOGICÂ ===============================================================================================================
varÂ stringÂ msgEnteredMarketLongÂ =Â na
varÂ stringÂ msgEnteredMarketShortÂ =Â na
varÂ stringÂ msgEnteredLimitOrStopLongÂ =Â na
varÂ stringÂ msgEnteredLimitOrStopShortÂ =Â na
varÂ stringÂ msgClosedMarketLongÂ =Â na
varÂ stringÂ msgClosedMarketShortÂ =Â na
varÂ stringÂ msgExitedLimitOrStopLongÂ =Â na
varÂ stringÂ msgExitedLimitOrStopShortÂ =Â na
varÂ string[]Â msgRchTPLongÂ =Â array.new<string>(numOfMaxTPAlerts,Â na)
varÂ string[]Â msgRchTPShortÂ =Â array.new<string>(numOfMaxTPAlerts,Â na)
varÂ stringÂ msgRchSLLongÂ =Â na
varÂ stringÂ msgRchSLShortÂ =Â na
varÂ stringÂ msgClosedAllÂ =Â na
varÂ su.PairStrStr[]Â stringVariablePairsÂ =Â array.new<su.PairStrStr>()
varÂ su.PairStrNum[]Â numberVariablePairsÂ =Â array.new<su.PairStrNum>()
varÂ su.PairStrNum[]Â numberVariablePairsLongÂ =Â array.new<su.PairStrNum>()
varÂ su.PairStrNum[]Â numberVariablePairsShortÂ =Â array.new<su.PairStrNum>()
ifÂ (msgEnteredEnabledÂ orÂ msgClosedOrExitedEnabledÂ orÂ msgTakeProfitEnabledÂ orÂ msgStopLossEnabledÂ orÂ msgChgTrEntryEnabledÂ orÂ msgChgTrExitEnabledÂ orÂ msgChgSLEnabledÂ orÂ msgCnlLimitOrStopEntryEnabledÂ orÂ msgCnlLimitOrStopExitEnabled)
Â Â Â Â varÂ boolÂ stringVariablesInitÂ =Â false
Â Â Â Â ifÂ (notÂ stringVariablesInit)
Â Â Â Â Â Â Â Â stringVariablePairsÂ :=Â array.from(su.PairStrStr.new('{{ticker}}',Â tickerPrefixÂ +Â syminfo.tickerÂ +Â tickerPostfix),Â su.PairStrStr.new('{{base_currency}}',Â syminfo.basecurrency),Â su.PairStrStr.new('{{quote_currency}}',Â syminfo.currency))
Â Â Â Â Â Â Â Â stringVariablesInitÂ :=Â true
Â Â Â Â varÂ floatÂ percMulÂ =Â usePercRange100Â ?Â 100.0Â :Â 1.0
Â Â Â Â varÂ boolÂ numberVariablesInitÂ =Â false
Â Â Â Â ifÂ (notÂ numberVariablesInit)
Â Â Â Â Â Â Â Â numberVariablePairsÂ :=Â array.from(su.PairStrNum.new('{{take_profit_quantity_perc}}',Â takeProfitQuantityRatioÂ *Â percMul))Â //Â TakeÂ ProfitÂ quantityÂ percentage
Â Â Â Â Â Â Â Â numberVariablesInitÂ :=Â true
Â Â Â Â 
Â Â Â Â ifÂ (longLimitOrStopEntryIsActiveÂ orÂ validOpenLongPositionÂ orÂ enteredLongTradeÂ orÂ isLongPositionÂ orÂ completedLongTrade)
Â Â Â Â Â Â Â Â numberVariablePairsLongÂ :=Â array.from(su.PairStrNum.new('{{base_quantity}}',Â longEntryBaseQuantity),Â su.PairStrNum.new('{{quote_quantity}}',Â longEntryQuoteQuantity),Â //Â LongÂ base/quoteÂ currencyÂ entryÂ quantity
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{quote_quantity_perc}}',Â longEntryQuoteQuantityRatioÂ *Â percMul),Â su.PairStrNum.new('{{take_profit_base_quantity}}',Â longTakeProfitQuantity),Â //Â LongÂ quoteÂ currencyÂ entryÂ quantityÂ percentage,Â LongÂ TakeÂ ProfitÂ baseÂ quantity
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{remaining_quantity_perc}}',Â longRemainingQuantityRatioÂ *Â percMul),Â su.PairStrNum.new('{{remaining_base_quantity}}',Â longRemainingQuantity),Â //Â LongÂ remainingÂ quantityÂ percentage,Â LongÂ remainingÂ baseÂ quantity
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{risk_perc}}',Â longCapitalRiskRatioÂ *Â percMul),Â su.PairStrNum.new('{{stop_loss_price}}',Â longStopLossPrice),Â //Â LongÂ riskÂ percentageÂ ofÂ theÂ entryÂ quantity,Â LongÂ StopÂ LossÂ price
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{entry_price}}',Â longEntryPrice),Â su.PairStrNum.new('{{entry+_price}}',Â longEntryPriceÂ +Â marginMsgTicksÂ *Â syminfo.mintick),Â su.PairStrNum.new('{{entry-_price}}',Â longEntryPriceÂ -Â marginMsgTicksÂ *Â syminfo.mintick),Â //Â LongÂ EntryÂ price,Â LongÂ EntryÂ priceÂ plusÂ theÂ marginÂ ticks,Â LongÂ EntryÂ priceÂ minusÂ theÂ marginÂ ticks
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{exit_price}}',Â longExitPrice),Â su.PairStrNum.new('{{exit+_price}}',Â longExitPriceÂ +Â marginMsgTicksÂ *Â syminfo.mintick),Â su.PairStrNum.new('{{exit-_price}}',Â longExitPriceÂ -Â marginMsgTicksÂ *Â syminfo.mintick),Â //Â LongÂ ExitÂ price,Â LongÂ ExitÂ priceÂ plusÂ theÂ marginÂ ticks,Â LongÂ ExitÂ priceÂ minusÂ theÂ marginÂ ticks
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{take_profit_price_1}}',Â numOfTakeProfitTargetsÂ >Â 0Â ?Â longTakeProfitPrices.get(0)Â :Â na),Â su.PairStrNum.new('{{take_profit_price_2}}',Â numOfTakeProfitTargetsÂ >Â 1Â ?Â longTakeProfitPrices.get(1)Â :Â na),Â //Â LongÂ TakeÂ ProfitÂ targetÂ 1Â andÂ 2Â prices
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{take_profit_price_3}}',Â numOfTakeProfitTargetsÂ >Â 2Â ?Â longTakeProfitPrices.get(2)Â :Â na),Â su.PairStrNum.new('{{take_profit_price_4}}',Â numOfTakeProfitTargetsÂ >Â 3Â ?Â longTakeProfitPrices.get(3)Â :Â na),Â //Â LongÂ TakeÂ ProfitÂ targetÂ 3Â andÂ 4Â prices
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{take_profit_price_5}}',Â numOfTakeProfitTargetsÂ >Â 4Â ?Â longTakeProfitPrices.get(4)Â :Â na))Â //Â LongÂ TakeÂ ProfitÂ targetÂ 5Â price
Â Â Â Â 
Â Â Â Â ifÂ (shortLimitOrStopEntryIsActiveÂ orÂ validOpenShortPositionÂ orÂ enteredShortTradeÂ orÂ isShortPositionÂ orÂ completedShortTrade)
Â Â Â Â Â Â Â Â numberVariablePairsShortÂ :=Â array.from(su.PairStrNum.new('{{base_quantity}}',Â shortEntryBaseQuantity),Â su.PairStrNum.new('{{quote_quantity}}',Â shortEntryQuoteQuantity),Â //Â ShortÂ base/quoteÂ currencyÂ entryÂ quantity
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{quote_quantity_perc}}',Â shortEntryQuoteQuantityRatioÂ *Â percMul),Â su.PairStrNum.new('{{take_profit_base_quantity}}',Â shortTakeProfitQuantity),Â //Â ShortÂ quoteÂ currencyÂ entryÂ quantityÂ percentage,Â ShortÂ TakeÂ ProfitÂ baseÂ quantity
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{remaining_quantity_perc}}',Â shortRemainingQuantityRatioÂ *Â percMul),Â su.PairStrNum.new('{{remaining_base_quantity}}',Â shortRemainingQuantity),Â //Â ShortÂ remainingÂ quantityÂ percentage,Â ShortÂ remainingÂ baseÂ quantity
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{risk_perc}}',Â shortCapitalRiskRatioÂ *Â percMul),Â su.PairStrNum.new('{{stop_loss_price}}',Â shortStopLossPrice),Â //Â ShortÂ riskÂ percentageÂ ofÂ theÂ entryÂ quantity,Â ShortÂ StopÂ LossÂ price
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{entry_price}}',Â shortEntryPrice),Â su.PairStrNum.new('{{entry+_price}}',Â shortEntryPriceÂ +Â marginMsgTicksÂ *Â syminfo.mintick),Â su.PairStrNum.new('{{entry-_price}}',Â shortEntryPriceÂ -Â marginMsgTicksÂ *Â syminfo.mintick),Â //Â ShortÂ EntryÂ price,Â ShortÂ EntryÂ priceÂ plusÂ theÂ marginÂ ticks,Â ShortÂ EntryÂ priceÂ minusÂ theÂ marginÂ ticks
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{exit_price}}',Â shortExitPrice),Â su.PairStrNum.new('{{exit+_price}}',Â shortExitPriceÂ +Â marginMsgTicksÂ *Â syminfo.mintick),Â su.PairStrNum.new('{{exit-_price}}',Â shortExitPriceÂ -Â marginMsgTicksÂ *Â syminfo.mintick),Â //Â ShortÂ ExitÂ price,Â ShortÂ ExitÂ priceÂ plusÂ theÂ marginÂ ticks,Â ShortÂ ExitÂ priceÂ minusÂ theÂ marginÂ ticks
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{take_profit_price_1}}',Â numOfTakeProfitTargetsÂ >Â 0Â ?Â shortTakeProfitPrices.get(0)Â :Â na),Â su.PairStrNum.new('{{take_profit_price_2}}',Â numOfTakeProfitTargetsÂ >Â 1Â ?Â shortTakeProfitPrices.get(1)Â :Â na),Â //Â ShortÂ TakeÂ ProfitÂ targetÂ 1Â andÂ 2Â prices
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{take_profit_price_3}}',Â numOfTakeProfitTargetsÂ >Â 2Â ?Â shortTakeProfitPrices.get(2)Â :Â na),Â su.PairStrNum.new('{{take_profit_price_4}}',Â numOfTakeProfitTargetsÂ >Â 3Â ?Â shortTakeProfitPrices.get(3)Â :Â na),Â //Â ShortÂ TakeÂ ProfitÂ targetÂ 3Â andÂ 4Â prices
Â Â Â Â Â Â Â Â Â Â Â Â Â su.PairStrNum.new('{{take_profit_price_5}}',Â numOfTakeProfitTargetsÂ >Â 4Â ?Â shortTakeProfitPrices.get(4)Â :Â na))Â //Â ShortÂ TakeÂ ProfitÂ targetÂ 5Â price
Â Â Â Â 
Â Â Â Â //Â SignalÂ enteredÂ alerts
Â Â Â Â ifÂ (msgEnteredEnabled)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgEnteredMarketLongÂ =Â rawMsgEnteredMarketLong.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgEnteredMarketShortÂ =Â rawMsgEnteredMarketShort.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgEnteredLimitOrStopLongÂ =Â rawMsgEnteredLimitOrStopLong.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgEnteredLimitOrStopShortÂ =Â rawMsgEnteredLimitOrStopShort.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â msgEnteredMarketLongÂ :=Â doEnterMarketLongÂ ?Â varMsgEnteredMarketLong.replace(numberVariablePairsLong)Â :Â na
Â Â Â Â Â Â Â Â msgEnteredMarketShortÂ :=Â doEnterMarketShortÂ ?Â varMsgEnteredMarketShort.replace(numberVariablePairsShort)Â :Â na
Â Â Â Â Â Â Â Â msgEnteredLimitOrStopLongÂ :=Â doEnterMarketLongÂ ?Â varMsgEnteredLimitOrStopLong.replace(numberVariablePairsLong)Â :Â na
Â Â Â Â Â Â Â Â msgEnteredLimitOrStopShortÂ :=Â doEnterMarketShortÂ ?Â varMsgEnteredLimitOrStopShort.replace(numberVariablePairsShort)Â :Â na
Â Â Â Â 
Â Â Â Â //Â SignalÂ closed/exitedÂ alerts
Â Â Â Â ifÂ (msgClosedOrExitedEnabled)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgClosedMarketLongÂ =Â rawMsgClosedMarketLong.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgClosedMarketShortÂ =Â rawMsgClosedMarketShort.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgExitedLimitOrStopLongÂ =Â rawMsgExitedLimitOrStopLong.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgExitedLimitOrStopShortÂ =Â rawMsgExitedLimitOrStopShort.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgClosedAllÂ =Â rawMsgClosedAll.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â msgClosedMarketLongÂ :=Â doCloseMarketLongÂ ?Â varMsgClosedMarketLong.replace(numberVariablePairsLong)Â :Â na
Â Â Â Â Â Â Â Â msgClosedMarketShortÂ :=Â doCloseMarketShortÂ ?Â varMsgClosedMarketShort.replace(numberVariablePairsShort)Â :Â na
Â Â Â Â Â Â Â Â msgExitedLimitOrStopLongÂ :=Â doSLorExitLimitLongÂ ?Â varMsgExitedLimitOrStopLong.replace(numberVariablePairsLong)Â :Â na
Â Â Â Â Â Â Â Â msgExitedLimitOrStopShortÂ :=Â doSLorExitLimitShortÂ ?Â varMsgExitedLimitOrStopShort.replace(numberVariablePairsShort):Â na
Â Â Â Â Â Â Â Â msgClosedAllÂ :=Â closeAllPositionsÂ ?Â varMsgClosedAll.replace(numberVariablePairsLong).replace(numberVariablePairsShort)Â :Â na
Â Â Â Â //Â SignalÂ takeÂ profitÂ alerts
Â Â Â Â ifÂ (msgTakeProfitEnabled)Â Â Â 
Â Â Â Â Â Â Â Â varÂ string[]Â varMsgRchTPLongÂ =Â array.new<string>(numOfMaxTPAlerts,Â na)
Â Â Â Â Â Â Â Â varÂ string[]Â varMsgRchTPShortÂ =Â array.new<string>(numOfMaxTPAlerts,Â na)
Â Â Â Â Â Â Â Â varÂ boolÂ msgRchTPInitÂ =Â false
Â Â Â Â Â Â Â Â ifÂ (notÂ msgRchTPInit)
Â Â Â Â Â Â Â Â Â Â Â Â forÂ [i,Â rawMsg]Â inÂ rawMsgRchTPLong
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â varMsgRchTPLong.set(i,Â numOfTakeProfitTargetsÂ >Â iÂ ?Â rawMsg.replace_all(stringVariablePairs).replace(numberVariablePairs)Â :Â na)
Â Â Â Â Â Â Â Â Â Â Â Â forÂ [i,Â rawMsg]Â inÂ rawMsgRchTPShort
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â varMsgRchTPShort.set(i,Â numOfTakeProfitTargetsÂ >Â iÂ ?Â rawMsg.replace_all(stringVariablePairs).replace(numberVariablePairs)Â :Â na)
Â Â Â Â Â Â Â Â Â Â Â Â msgRchTPInitÂ :=Â true
Â Â Â Â Â Â Â Â ifÂ (doSLorExitLimitLong)
Â Â Â Â Â Â Â Â Â Â Â Â forÂ [i,Â varMsg]Â inÂ varMsgRchTPLong
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â msgRchTPLong.set(i,Â numOfTakeProfitTargetsÂ >Â iÂ ?Â varMsg.replace(numberVariablePairsLong)Â :Â na)
Â Â Â Â Â Â Â Â ifÂ (doSLorExitLimitShort)
Â Â Â Â Â Â Â Â Â Â Â Â forÂ [i,Â varMsg]Â inÂ varMsgRchTPShort
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â msgRchTPShort.set(i,Â numOfTakeProfitTargetsÂ >Â iÂ ?Â varMsg.replace(numberVariablePairsShort)Â :Â na)
Â Â Â Â 
Â Â Â Â //Â SignalÂ stopÂ lossÂ alerts
Â Â Â Â ifÂ (msgStopLossEnabled)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgRchSLLongÂ =Â rawMsgRchSLLong.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgRchSLShortÂ =Â rawMsgRchSLShort.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â msgRchSLLongÂ :=Â doSLorExitLimitLongÂ ?Â varMsgRchSLLong.replace(numberVariablePairsLong)Â :Â na
Â Â Â Â Â Â Â Â msgRchSLShortÂ :=Â doSLorExitLimitShortÂ ?Â varMsgRchSLShort.replace(numberVariablePairsShort)Â :Â na
//Â SignalÂ changedÂ alerts
ifÂ (msgChgTrEntryEnabled)
Â Â Â Â varÂ stringÂ varMsgChgTrEntryLongÂ =Â rawMsgChgTrEntryLong.replace_all(stringVariablePairs)
Â Â Â Â ifÂ (ta.change(longEntryPrice))
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgChgTrEntryLong.replace(numberVariablePairsLong),Â freqÂ =Â alert.freq_once_per_bar_close)
Â Â Â Â varÂ stringÂ varMsgChgTrEntryShortÂ =Â rawMsgChgTrEntryShort.replace_all(stringVariablePairs)
Â Â Â Â ifÂ (ta.change(shortEntryPrice))
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgChgTrEntryShort.replace(numberVariablePairsShort),Â freqÂ =Â alert.freq_once_per_bar_close)
ifÂ (msgChgTrExitEnabled)
Â Â Â Â varÂ stringÂ varMsgChgTrExitLongÂ =Â rawMsgChgTrExitLong.replace_all(stringVariablePairs)
Â Â Â Â ifÂ (ta.change(longExitPrice))
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgChgTrExitLong.replace(numberVariablePairsLong),Â freqÂ =Â alert.freq_once_per_bar_close)
Â Â Â Â varÂ stringÂ varMsgChgTrExitShortÂ =Â rawMsgChgTrExitShort.replace_all(stringVariablePairs)
Â Â Â Â ifÂ (ta.change(shortExitPrice))
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgChgTrExitShort.replace(numberVariablePairsShort),Â freqÂ =Â alert.freq_once_per_bar_close)
ifÂ (msgChgSLEnabled)
Â Â Â Â varÂ stringÂ varMsgChgSLLongÂ =Â rawMsgChgSLLong.replace_all(stringVariablePairs)
Â Â Â Â ifÂ (na(longLimitOrStopEntryPrice)Â andÂ ta.change(longStopLossPrice))
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgChgSLLong.replace(numberVariablePairsLong),Â freqÂ =Â alert.freq_once_per_bar_close)
Â Â Â Â varÂ stringÂ varMsgChgSLShortÂ =Â rawMsgChgSLShort.replace_all(stringVariablePairs)
Â Â Â Â ifÂ (na(shortLimitOrStopEntryPrice)Â andÂ ta.change(shortStopLossPrice))
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgChgSLShort.replace(numberVariablePairsShort),Â freqÂ =Â alert.freq_once_per_bar_close)
ifÂ (msgCnlLimitOrStopExitEnabled)
Â Â Â Â varÂ stringÂ varMsgCnlLimitOrStopExitLongÂ =Â rawMsgCnlLimitOrStopExitLong.replace_all(stringVariablePairs)
Â Â Â Â ifÂ (doCnlLimitExitLong)
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgCnlLimitOrStopExitLong.replace(numberVariablePairsLong),Â freqÂ =Â alert.freq_once_per_bar_close)
Â Â Â Â varÂ stringÂ varMsgCnlLimitOrStopExitShortÂ =Â rawMsgCnlLimitOrStopExitShort.replace_all(stringVariablePairs)
Â Â Â Â ifÂ (doCnlLimitExitShort)
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgCnlLimitOrStopExitShort.replace(numberVariablePairsShort),Â freqÂ =Â alert.freq_once_per_bar_close)
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸ§¹Â CLEANÂ UP
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ resettingÂ variablesÂ afterÂ tradesÂ hadÂ beenÂ completed
//Â Dependencies:Â TAKEÂ PROFITÂ 1,Â STOPÂ LOSS,Â TAKEÂ PROFITÂ 2,Â QUANTITY/RISKÂ MANAGEMENT
//Â Results:Â ALL
//Â LOGICÂ ===============================================================================================================
ifÂ (completedLongTrade)
Â Â Â Â forÂ iÂ =Â 0Â toÂ takeProfitTargetsSize
Â Â Â Â Â Â Â Â longTrailTakeProfitExecuted.set(i,Â false)
ifÂ (completedShortTrade)
Â Â Â Â forÂ iÂ =Â 0Â toÂ takeProfitTargetsSize
Â Â Â Â Â Â Â Â shortTrailTakeProfitExecuted.set(i,Â false)
ifÂ ((completedLongTradeÂ andÂ notÂ (longLimitOrStopEntryIsActiveÂ orÂ validOpenLongPositionÂ orÂ enteredLongTrade))Â orÂ validCnlOpenLongPositionÂ orÂ closeAllPositions)
Â Â Â Â longEntryPriceÂ :=Â na
Â Â Â Â highestHighSinceLongEntryÂ :=Â na
Â Â Â Â longStopLossPriceÂ :=Â na
Â Â Â Â forÂ iÂ =Â 0Â toÂ takeProfitTargetsSize
Â Â Â Â Â Â Â Â longTakeProfitPrices.set(i,Â na)
Â Â Â Â Â Â Â Â longTrailTakeProfitOffsetTicks.set(i,Â na)
Â Â Â Â longEntryQuoteQuantityÂ :=Â na
Â Â Â Â longEntryQuoteQuantityRatioÂ :=Â na
Â Â Â Â longEntryBaseQuantityÂ :=Â na
Â Â Â Â longTakeProfitQuantityÂ :=Â na
Â Â Â Â longRemainingQuantityÂ :=Â na
Â Â Â Â longCapitalRiskRatioÂ :=Â naÂ 
ifÂ ((completedShortTradeÂ andÂ notÂ (shortLimitOrStopEntryIsActiveÂ orÂ validOpenShortPositionÂ orÂ enteredShortTrade))Â orÂ validCnlOpenShortPositionÂ orÂ closeAllPositions)
Â Â Â Â shortEntryPriceÂ :=Â na
Â Â Â Â lowestLowSinceShortEntryÂ :=Â na
Â Â Â Â shortStopLossPriceÂ :=Â na
Â Â Â Â forÂ iÂ =Â 0Â toÂ takeProfitTargetsSize
Â Â Â Â Â Â Â Â shortTakeProfitPrices.set(i,Â na)
Â Â Â Â Â Â Â Â shortTrailTakeProfitOffsetTicks.set(i,Â na)
Â Â Â Â shortEntryQuoteQuantityÂ :=Â na
Â Â Â Â shortEntryQuoteQuantityRatioÂ :=Â na
Â Â Â Â shortEntryBaseQuantityÂ :=Â na
Â Â Â Â shortTakeProfitQuantityÂ :=Â na
Â Â Â Â shortRemainingQuantityÂ :=Â na
Â Â Â Â shortCapitalRiskRatioÂ :=Â naÂ 
//#endregionÂ ===========================================================================================================
//#regionÂ âš¡Â POSITIONÂ ORDERS
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ theÂ actualÂ executionÂ ofÂ theÂ strategyÂ orders
//Â Dependencies:Â TRACKÂ POSITION,Â STRATEGYÂ 1,Â ENTRY,Â STRATEGYÂ 2,Â EXIT,Â STOPÂ LOSS,Â TAKEÂ PROFITÂ 2,Â QUANTITYÂ MANAGEMENT,Â EXECUTIONÂ CONDITIONS,Â ALERTÂ MESSAGES
//Â Results:Â NONE
//Â LOGICÂ ===============================================================================================================
//Â CloseÂ allÂ positionsÂ atÂ theÂ endÂ ofÂ theÂ session
ifÂ (closeAllPositions)
Â Â Â Â strategy.close_all(commentÂ =Â showAlertsEnabledÂ ?Â msgClosedAllÂ :Â 'AğŸŸª',Â alert_messageÂ =Â msgClosedAll)
//Â CloseÂ onÂ validÂ closeÂ signalÂ whenÂ exitÂ withÂ marketÂ order
ifÂ (doCloseMarketLong)
Â Â Â Â strategy.close(idÂ =Â longOrderIdEntry,Â commentÂ =Â showAlertsEnabledÂ ?Â msgClosedMarketLongÂ :Â 'LğŸŸª',Â alert_messageÂ =Â msgClosedMarketLong)
//Â CloseÂ onÂ validÂ closeÂ signalÂ whenÂ exitÂ withÂ marketÂ order
ifÂ (doCloseMarketShort)
Â Â Â Â strategy.close(idÂ =Â shortOrderIdEntry,Â commentÂ =Â showAlertsEnabledÂ ?Â msgClosedMarketShortÂ :Â 'SğŸŸª',Â alert_messageÂ =Â msgClosedMarketShort)
//Â GettingÂ intoÂ LONGÂ position
ifÂ (doEnterMarketLong)
Â Â Â Â stringÂ msgAlertÂ =Â entryOrderTypeÂ ==Â 'MARKET'Â ?Â msgEnteredMarketLongÂ :Â msgEnteredLimitOrStopLong
Â Â Â Â ifÂ (notÂ na(shortStopLossPrice)Â andÂ notÂ na(longLimitOrStopEntryPrice)Â andÂ shortStopLossPriceÂ <Â longLimitOrStopEntryPrice)
Â Â Â Â Â Â Â Â strategy.order(idÂ =Â longOrderIdEntry,Â directionÂ =Â strategy.long,Â limitÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â longLimitOrStopEntryPriceÂ :Â entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â longStopLimitEntryPriceÂ :Â na,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â stopÂ =Â entryOrderTypeÂ ==Â 'STOP'Â orÂ entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â longLimitOrStopEntryPriceÂ :Â na,Â qtyÂ =Â longEntryBaseQuantity,Â commentÂ =Â showAlertsEnabledÂ ?Â msgAlertÂ :Â 'LğŸ”·',Â alert_messageÂ =Â msgAlert)
Â Â Â Â else
Â Â Â Â Â Â Â Â strategy.entry(idÂ =Â longOrderIdEntry,Â directionÂ =Â strategy.long,Â limitÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â longLimitOrStopEntryPriceÂ :Â entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â longStopLimitEntryPriceÂ :Â na,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â stopÂ =Â entryOrderTypeÂ ==Â 'STOP'Â orÂ entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â longLimitOrStopEntryPriceÂ :Â na,Â qtyÂ =Â longEntryBaseQuantity,Â commentÂ =Â showAlertsEnabledÂ ?Â msgAlertÂ :Â 'LğŸ”·',Â alert_messageÂ =Â msgAlert)
//Â CancelÂ existingÂ entryÂ limit,Â stopÂ orÂ stop-limitÂ ordersÂ (ifÂ any)Â whenÂ validÂ cancelÂ openÂ signalÂ occurs
ifÂ (doCnlLimitEntryLong)
Â Â Â Â strategy.cancel(idÂ =Â longOrderIdEntry)
Â Â Â Â ifÂ (msgCnlLimitOrStopEntryEnabled)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgCnlLimitOrStopEntryLongÂ =Â rawMsgCnlLimitOrStopEntryLong.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgCnlLimitOrStopEntryLong.replace(numberVariablePairsLong),Â freqÂ =Â alert.freq_once_per_bar_close)
//Â CalculateÂ theÂ tightestÂ stopÂ orderÂ byÂ combiningÂ theÂ stopÂ lossÂ andÂ limitÂ orÂ stopÂ exitÂ (ifÂ any)
floatÂ longEffectiveStopLossPriceÂ =Â stopLossWaitCloseConfirmÂ ?Â naÂ :Â longStopLossPrice
floatÂ longTightestStopÂ =Â exitOrderTypeÂ ==Â 'STOP'Â andÂ longLimitExitIsActiveÂ ?Â math.max(nz(longLimitOrStopExitPrice,Â minLimitFloat),Â nz(longEffectiveStopLossPrice,Â minLimitFloat))Â :Â longEffectiveStopLossPrice
boolÂ isLongLimitExitTighterThanStopLossÂ =Â stopLossWaitCloseConfirmÂ ?Â trueÂ :Â longLimitExitIsActiveÂ andÂ exitOrderTypeÂ ==Â 'STOP'Â andÂ longLimitOrStopExitPriceÂ >Â longStopLossPrice
//Â SubmitÂ exitÂ orderÂ forÂ trailingÂ takeÂ profitÂ priceÂ alsoÂ setÂ theÂ stopÂ lossÂ forÂ theÂ takeÂ profitÂ percentageÂ inÂ caseÂ thatÂ stopÂ lossÂ isÂ reachedÂ first
//Â SubmitÂ exitÂ orderÂ whenÂ exitÂ withÂ limitÂ orÂ stop
forÂ [i,Â longTakeProfitPrice]Â inÂ longTakeProfitPrices
Â Â Â Â ifÂ (longLimitExitIsActiveÂ orÂ (longIsActiveÂ andÂ notÂ longTrailTakeProfitExecuted.get(i)))
Â Â Â Â Â Â Â Â floatÂ longTightestLimitÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â andÂ longLimitExitIsActiveÂ ?Â math.min(nz(longLimitOrStopExitPrice,Â maxLimitFloat),Â nz(longTakeProfitPrice,Â maxLimitFloat))Â :Â takeProfitTrailEnabledÂ ?Â naÂ :Â longTakeProfitPrice
Â Â Â Â Â Â Â Â boolÂ isLongLimitExitTighterThanTakeProfitÂ =Â longLimitExitIsActiveÂ andÂ longLimitOrStopExitPriceÂ <Â longTakeProfitPrice
Â Â Â Â Â Â Â Â stringÂ msgAlertProfitÂ =Â isLongLimitExitTighterThanTakeProfitÂ ?Â msgExitedLimitOrStopLongÂ :Â msgRchTPLong.get(iÂ %Â numOfMaxTPAlerts)
Â Â Â Â Â Â Â Â stringÂ msgAlertLossÂ =Â iÂ ==Â takeProfitTargetsSizeÂ andÂ moonbagQuantityRatioÂ ==Â 0.0Â ?Â isLongLimitExitTighterThanStopLossÂ ?Â msgExitedLimitOrStopLongÂ :Â msgRchSLLongÂ :Â na
Â Â Â Â Â Â Â Â stringÂ msgCommentProfitÂ =Â str.format('{0}{1,Â number,Â integer}',Â exitOrderTypeÂ ==Â 'LIMIT'Â andÂ longLimitExitIsActiveÂ ?Â 'LLimğŸŸª'Â :Â 'LğŸ¯',Â iÂ +Â 1)
Â Â Â Â Â Â Â Â stringÂ msgCommentLossÂ =Â str.format('{0}{1,Â number,Â integer}',Â isLongLimitExitTighterThanStopLossÂ ?Â 'LLimğŸŸª'Â :Â 'LğŸ›‘',Â iÂ +Â 1)
Â Â Â Â Â Â Â Â strategy.exit(idÂ =Â str.format(exitOrderIdPattern1,Â longOrderIdPrefix,Â iÂ +Â 1),Â from_entryÂ =Â longOrderIdEntry,Â qtyÂ =Â longTakeProfitQuantity,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â limitÂ =Â longTightestLimit,Â stopÂ =Â longTightestStop,Â trail_priceÂ =Â takeProfitTrailEnabledÂ ?Â longTakeProfitPriceÂ :Â na,Â trail_offsetÂ =Â takeProfitTrailEnabledÂ ?Â longTrailTakeProfitOffsetTicks.get(i)Â :Â na,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â comment_profitÂ =Â showAlertsEnabledÂ ?Â msgAlertProfitÂ :Â msgCommentProfit,Â comment_lossÂ =Â showAlertsEnabledÂ ?Â msgAlertLossÂ :Â msgCommentLoss,Â comment_trailingÂ =Â showAlertsEnabledÂ ?Â msgAlertProfitÂ :Â msgCommentProfit,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â alert_profitÂ =Â msgAlertProfit,Â alert_lossÂ =Â msgAlertLoss,Â alert_trailingÂ =Â msgAlertProfit)
//Â SubmitÂ exitÂ orderÂ forÂ trailingÂ stopÂ lossÂ priceÂ forÂ theÂ remainingÂ percentÂ ofÂ theÂ quantityÂ notÂ reservedÂ byÂ theÂ takeÂ profitÂ order
//Â SubmitÂ exitÂ orderÂ whenÂ exitÂ withÂ limitÂ orÂ stop
ifÂ (doSLorExitLimitLong)
Â Â Â Â stringÂ msgAlertProfitÂ =Â isLongLimitExitTighterThanStopLossÂ ?Â msgExitedLimitOrStopLongÂ :Â na
Â Â Â Â stringÂ msgAlertLossÂ =Â isLongLimitExitTighterThanStopLossÂ ?Â msgExitedLimitOrStopLongÂ :Â msgRchSLLong
Â Â Â Â stringÂ msgCommentProfitÂ =Â isLongLimitExitTighterThanStopLossÂ ?Â 'LLimğŸŸª'Â :Â na
Â Â Â Â stringÂ msgCommentLossÂ =Â isLongLimitExitTighterThanStopLossÂ ?Â 'LLimğŸŸª'Â :Â 'LğŸ›‘'
Â Â Â Â strategy.exit(idÂ =Â str.format(exitOrderIdPattern2,Â longOrderIdPrefix),Â from_entryÂ =Â longOrderIdEntry,Â limitÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â ?Â longLimitOrStopExitPriceÂ :Â na,Â stopÂ =Â longTightestStop,
Â Â Â Â Â Â Â Â Â Â comment_profitÂ =Â showAlertsEnabledÂ ?Â msgAlertProfitÂ :Â msgCommentProfit,Â comment_lossÂ =Â showAlertsEnabledÂ ?Â msgAlertLossÂ :Â msgCommentLoss,
Â Â Â Â Â Â Â Â Â Â alert_profitÂ =Â msgAlertProfit,Â alert_lossÂ =Â msgAlertLoss)
//Â GettingÂ intoÂ SHORTÂ position
ifÂ (doEnterMarketShort)
Â Â Â Â stringÂ msgAlertÂ =Â entryOrderTypeÂ ==Â 'MARKET'Â ?Â msgEnteredMarketShortÂ :Â msgEnteredLimitOrStopShort
Â Â Â Â ifÂ (notÂ na(longStopLossPrice)Â andÂ notÂ na(shortLimitOrStopEntryPrice)Â andÂ longStopLossPriceÂ >Â shortLimitOrStopEntryPrice)
Â Â Â Â Â Â Â Â strategy.order(idÂ =Â shortOrderIdEntry,Â directionÂ =Â strategy.short,Â limitÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â shortLimitOrStopEntryPriceÂ :Â entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â shortStopLimitEntryPriceÂ :Â na,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â stopÂ =Â entryOrderTypeÂ ==Â 'STOP'Â orÂ entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â shortLimitOrStopEntryPriceÂ :Â na,Â qtyÂ =Â shortEntryBaseQuantity,Â commentÂ =Â showAlertsEnabledÂ ?Â msgAlertÂ :Â 'SğŸ”·',Â alert_messageÂ =Â msgAlert)
Â Â Â Â else
Â Â Â Â Â Â Â Â strategy.entry(idÂ =Â shortOrderIdEntry,Â directionÂ =Â strategy.short,Â limitÂ =Â entryOrderTypeÂ ==Â 'LIMIT'Â ?Â shortLimitOrStopEntryPriceÂ :Â entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â shortStopLimitEntryPriceÂ :Â na,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â stopÂ =Â entryOrderTypeÂ ==Â 'STOP'Â orÂ entryOrderTypeÂ ==Â 'STOP-LIMIT'Â ?Â shortLimitOrStopEntryPriceÂ :Â na,Â qtyÂ =Â shortEntryBaseQuantity,Â commentÂ =Â showAlertsEnabledÂ ?Â msgAlertÂ :Â 'SğŸ”·',Â alert_messageÂ =Â msgAlert)
//Â CancelÂ existingÂ entryÂ limit,Â stopÂ andÂ stop-limitÂ ordersÂ (ifÂ any)Â whenÂ validÂ cancelÂ openÂ signalÂ occurs
ifÂ (doCnlLimitEntryShort)
Â Â Â Â strategy.cancel(idÂ =Â shortOrderIdEntry)
Â Â Â Â ifÂ (msgCnlLimitOrStopEntryEnabled)
Â Â Â Â Â Â Â Â varÂ stringÂ varMsgCnlLimitOrStopEntryShortÂ =Â rawMsgCnlLimitOrStopEntryShort.replace_all(stringVariablePairs)
Â Â Â Â Â Â Â Â alert(messageÂ =Â varMsgCnlLimitOrStopEntryShort.replace(numberVariablePairsShort),Â freqÂ =Â alert.freq_once_per_bar_close)
//Â CalculateÂ theÂ tightestÂ stopÂ orderÂ byÂ combiningÂ theÂ stopÂ lossÂ andÂ limitÂ orÂ stopÂ exitÂ (ifÂ any)
floatÂ shortEffectiveStopLossPriceÂ =Â stopLossWaitCloseConfirmÂ ?Â naÂ :Â shortStopLossPrice
floatÂ shortTightestStopÂ =Â exitOrderTypeÂ ==Â 'STOP'Â andÂ shortLimitExitIsActiveÂ ?Â math.min(nz(shortLimitOrStopExitPrice,Â maxLimitFloat),Â nz(shortEffectiveStopLossPrice,Â maxLimitFloat))Â :Â shortEffectiveStopLossPrice
boolÂ isShortLimitExitTighterThanStopLossÂ =Â stopLossWaitCloseConfirmÂ ?Â trueÂ :Â shortLimitExitIsActiveÂ andÂ exitOrderTypeÂ ==Â 'STOP'Â andÂ shortLimitOrStopExitPriceÂ <Â shortStopLossPrice
//Â SubmitÂ exitÂ orderÂ forÂ trailingÂ takeÂ profitÂ priceÂ alsoÂ setÂ theÂ stopÂ lossÂ forÂ theÂ takeÂ profitÂ percentageÂ inÂ caseÂ thatÂ stopÂ lossÂ isÂ reachedÂ first
//Â SubmitÂ exitÂ orderÂ whenÂ exitÂ withÂ limitÂ orÂ stop
forÂ [i,Â shortTakeProfitPrice]Â inÂ shortTakeProfitPrices
Â Â Â Â ifÂ (shortLimitExitIsActiveÂ orÂ (shortIsActiveÂ andÂ notÂ shortTrailTakeProfitExecuted.get(i)))
Â Â Â Â Â Â Â Â floatÂ shortightestLimitÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â andÂ shortLimitExitIsActiveÂ ?Â math.max(nz(shortLimitOrStopExitPrice,Â minLimitFloat),Â nz(shortTakeProfitPrice,Â minLimitFloat))Â :Â takeProfitTrailEnabledÂ ?Â naÂ :Â shortTakeProfitPrice
Â Â Â Â Â Â Â Â boolÂ isShortLimitExitTighterThanTakeProfitÂ =Â shortLimitExitIsActiveÂ andÂ shortLimitOrStopExitPriceÂ >Â shortTakeProfitPrice
Â Â Â Â Â Â Â Â stringÂ msgAlertProfitÂ =Â isShortLimitExitTighterThanTakeProfitÂ ?Â msgExitedLimitOrStopShortÂ :Â msgRchTPShort.get(iÂ %Â numOfMaxTPAlerts)
Â Â Â Â Â Â Â Â stringÂ msgAlertLossÂ =Â iÂ ==Â takeProfitTargetsSizeÂ andÂ moonbagQuantityRatioÂ ==Â 0.0Â ?Â isShortLimitExitTighterThanStopLossÂ ?Â msgExitedLimitOrStopShortÂ :Â msgRchSLShortÂ :Â na
Â Â Â Â Â Â Â Â stringÂ msgCommentProfitÂ =Â str.format('{0}{1,Â number,Â integer}',Â exitOrderTypeÂ ==Â 'LIMIT'Â andÂ shortLimitExitIsActiveÂ ?Â 'SLimğŸŸª'Â :Â 'SğŸ¯',Â iÂ +Â 1)
Â Â Â Â Â Â Â Â stringÂ msgCommentLossÂ =Â str.format('{0}{1,Â number,Â integer}',Â isShortLimitExitTighterThanStopLossÂ ?Â 'SLimğŸŸª'Â :Â 'SğŸ›‘',Â iÂ +Â 1)
Â Â Â Â Â Â Â Â strategy.exit(idÂ =Â str.format(exitOrderIdPattern1,Â shortOrderIdPrefix,Â iÂ +Â 1),Â from_entryÂ =Â shortOrderIdEntry,Â qtyÂ =Â shortTakeProfitQuantity,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â limitÂ =Â shortightestLimit,Â stopÂ =Â shortTightestStop,Â trail_priceÂ =Â takeProfitTrailEnabledÂ ?Â shortTakeProfitPriceÂ :Â na,Â trail_offsetÂ =Â takeProfitTrailEnabledÂ ?Â shortTrailTakeProfitOffsetTicks.get(i)Â :Â na,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â comment_profitÂ =Â showAlertsEnabledÂ ?Â msgAlertProfitÂ :Â msgCommentProfit,Â comment_lossÂ =Â showAlertsEnabledÂ ?Â msgAlertLossÂ :Â msgCommentLoss,Â comment_trailingÂ =Â showAlertsEnabledÂ ?Â msgAlertProfitÂ :Â msgCommentProfit,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â alert_profitÂ =Â msgAlertProfit,Â alert_lossÂ =Â msgAlertLoss,Â alert_trailingÂ =Â msgAlertProfit)
//Â SubmitÂ exitÂ orderÂ forÂ trailingÂ stopÂ lossÂ priceÂ forÂ theÂ remainingÂ percentÂ ofÂ theÂ quantityÂ notÂ reservedÂ byÂ theÂ takeÂ profitÂ order
//Â SubmitÂ exitÂ orderÂ whenÂ exitÂ withÂ limitÂ orÂ stop
ifÂ (doSLorExitLimitShort)
Â Â Â Â stringÂ msgAlertProfitÂ =Â isShortLimitExitTighterThanStopLossÂ ?Â msgExitedLimitOrStopShortÂ :Â na
Â Â Â Â stringÂ msgAlertLossÂ =Â isShortLimitExitTighterThanStopLossÂ ?Â msgExitedLimitOrStopShortÂ :Â msgRchSLShort
Â Â Â Â stringÂ msgCommentProfitÂ =Â isShortLimitExitTighterThanStopLossÂ ?Â 'SLimğŸŸª'Â :Â na
Â Â Â Â stringÂ msgCommentLossÂ =Â isShortLimitExitTighterThanStopLossÂ ?Â 'SLimğŸŸª'Â :Â 'SğŸ›‘'
Â Â Â Â strategy.exit(idÂ =Â str.format(exitOrderIdPattern2,Â shortOrderIdPrefix),Â from_entryÂ =Â shortOrderIdEntry,Â limitÂ =Â exitOrderTypeÂ ==Â 'LIMIT'Â ?Â shortLimitOrStopExitPriceÂ :Â na,Â stopÂ =Â shortTightestStop,
Â Â Â Â Â Â Â Â Â Â comment_profitÂ =Â showAlertsEnabledÂ ?Â msgAlertProfitÂ :Â msgCommentProfit,Â comment_lossÂ =Â showAlertsEnabledÂ ?Â msgAlertLossÂ :Â msgCommentLoss,
Â Â Â Â Â Â Â Â Â Â alert_profitÂ =Â msgAlertProfit,Â alert_lossÂ =Â msgAlertLoss)
//Â LimitÂ theÂ maximumÂ drawdown
strategy.risk.max_drawdown(valueÂ =Â maxDrawdownEnabledÂ ?Â maxDrawdownPercÂ :Â 100.0,Â typeÂ =Â strategy.percent_of_equity,Â alert_messageÂ =Â msgMaxDrawdown)
//#endregionÂ ===========================================================================================================
//#regionÂ ğŸÂ DEBUG
//Â â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
//Â Description:Â ModuleÂ responsibleÂ forÂ plottingÂ additionalÂ informationÂ forÂ debugingÂ purposes
//Â Dependencies:Â ALL
//Â Results:Â showAlertsEnabled,Â debugModeEnabled
//Â INPUTÂ ===============================================================================================================
debugModeEnabledÂ =Â input.bool(defvalÂ =Â false,Â titleÂ =Â 'DebugÂ Mode',Â tooltipÂ =Â 'EnableÂ debugÂ mode.',Â groupÂ =Â 'ğŸÂ Debug')
//Â PLOTÂ ================================================================================================================
boolÂ showLongPlotsÂ =Â notÂ longLimitOrStopEntryIsActiveÂ orÂ debugModeEnabled
boolÂ showShortPlotsÂ =Â notÂ shortLimitOrStopEntryIsActiveÂ orÂ debugModeEnabled
varÂ colorÂ dbgPosColorÂ =Â color.new(posColor,Â 50)
plot(seriesÂ =Â showLongPlotsÂ ?Â longEntryPriceÂ :Â na,Â titleÂ =Â 'LongÂ PositionÂ Entry',Â colorÂ =Â longLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgPosColorÂ :Â naÂ :Â posColor,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1)
plot(seriesÂ =Â showShortPlotsÂ ?Â shortEntryPriceÂ :Â na,Â titleÂ =Â 'ShortÂ PositionÂ Entry',Â colorÂ =Â shortLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgPosColorÂ :Â naÂ :Â posColor,Â linewidthÂ =Â 1,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1)
varÂ colorÂ dbgStopLossColorÂ =Â color.new(stopLossColor,Â 50)
plot(seriesÂ =Â showLongPlotsÂ ?Â longStopLossPriceÂ :Â na,Â titleÂ =Â 'LongÂ StopÂ Loss',Â colorÂ =Â longLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgStopLossColorÂ :Â naÂ :Â stopLossColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1)
plot(seriesÂ =Â showShortPlotsÂ ?Â shortStopLossPriceÂ :Â na,Â titleÂ =Â 'ShortÂ StopÂ Loss',Â colorÂ =Â shortLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgStopLossColorÂ :Â naÂ :Â stopLossColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1)
varÂ colorÂ dbgTakeProfitColorÂ =Â color.new(takeProfitColor,Â 50)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 0Â andÂ showLongPlotsÂ andÂ (notÂ longIthTrailTakeProfitExecuted(1)Â orÂ debugModeEnabled)Â ?Â longTakeProfitPrices.get(0)Â :Â na,Â titleÂ =Â 'LongÂ TakeÂ ProfitÂ 1',Â colorÂ =Â longIthTrailTakeProfitExecuted(1)Â orÂ longLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 0Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 0Â andÂ showShortPlotsÂ andÂ (notÂ shortIthTrailTakeProfitExecuted(1)Â orÂ debugModeEnabled)Â ?Â shortTakeProfitPrices.get(0)Â :Â na,Â titleÂ =Â 'ShortÂ TakeÂ ProfitÂ 1',Â colorÂ =Â shortIthTrailTakeProfitExecuted(1)Â orÂ shortLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 0Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 1Â andÂ showLongPlotsÂ andÂ (notÂ longIthTrailTakeProfitExecuted(2)Â orÂ debugModeEnabled)Â ?Â longTakeProfitPrices.get(1)Â :Â na,Â titleÂ =Â 'LongÂ TakeÂ ProfitÂ 2',Â colorÂ =Â longIthTrailTakeProfitExecuted(2)Â orÂ longLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 1Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 1Â andÂ showShortPlotsÂ andÂ (notÂ shortIthTrailTakeProfitExecuted(2)Â orÂ debugModeEnabled)Â ?Â shortTakeProfitPrices.get(1)Â :Â na,Â titleÂ =Â 'ShortÂ TakeÂ ProfitÂ 2',Â colorÂ =Â shortIthTrailTakeProfitExecuted(2)Â orÂ shortLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 1Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 2Â andÂ showLongPlotsÂ andÂ (notÂ longIthTrailTakeProfitExecuted(3)Â orÂ debugModeEnabled)Â ?Â longTakeProfitPrices.get(2)Â :Â na,Â titleÂ =Â 'LongÂ TakeÂ ProfitÂ 3',Â colorÂ =Â longIthTrailTakeProfitExecuted(3)Â orÂ longLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 2Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 2Â andÂ showShortPlotsÂ andÂ (notÂ shortIthTrailTakeProfitExecuted(3)Â orÂ debugModeEnabled)Â ?Â shortTakeProfitPrices.get(2)Â :Â na,Â titleÂ =Â 'ShortÂ TakeÂ ProfitÂ 3',Â colorÂ =Â shortIthTrailTakeProfitExecuted(3)Â orÂ shortLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 2Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 3Â andÂ showLongPlotsÂ andÂ (notÂ longIthTrailTakeProfitExecuted(4)Â orÂ debugModeEnabled)Â ?Â longTakeProfitPrices.get(3)Â :Â na,Â titleÂ =Â 'LongÂ TakeÂ ProfitÂ 4',Â colorÂ =Â longIthTrailTakeProfitExecuted(4)Â orÂ longLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 3Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 3Â andÂ showShortPlotsÂ andÂ (notÂ shortIthTrailTakeProfitExecuted(4)Â orÂ debugModeEnabled)Â ?Â shortTakeProfitPrices.get(3)Â :Â na,Â titleÂ =Â 'ShortÂ TakeÂ ProfitÂ 4',Â colorÂ =Â shortIthTrailTakeProfitExecuted(4)Â orÂ shortLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 3Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 4Â andÂ showLongPlotsÂ andÂ (notÂ longIthTrailTakeProfitExecuted(5)Â orÂ debugModeEnabled)Â ?Â longTakeProfitPrices.get(4)Â :Â na,Â titleÂ =Â 'LongÂ TakeÂ ProfitÂ 5',Â colorÂ =Â longIthTrailTakeProfitExecuted(5)Â orÂ longLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 4Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â numOfTakeProfitTargetsÂ >Â 4Â andÂ showShortPlotsÂ andÂ (notÂ shortIthTrailTakeProfitExecuted(5)Â orÂ debugModeEnabled)Â ?Â shortTakeProfitPrices.get(4)Â :Â na,Â titleÂ =Â 'ShortÂ TakeÂ ProfitÂ 5',Â colorÂ =Â shortIthTrailTakeProfitExecuted(5)Â orÂ shortLimitOrStopEntryIsActiveÂ ?Â debugModeEnabledÂ ?Â dbgTakeProfitColorÂ :Â naÂ :Â takeProfitColor,Â linewidthÂ =Â 2,Â styleÂ =Â plot.style_linebr,Â offsetÂ =Â 1,Â displayÂ =Â numOfTakeProfitTargetsÂ >Â 4Â ?Â display.allÂ :Â display.none)
plot(seriesÂ =Â math.sign(currentPositionSize),Â titleÂ =Â 'ã€°ï¸PositionÂ Sign',Â colorÂ =Â color.olive,Â displayÂ =Â display.data_window)
//Â varÂ colorÂ dbgLongEntryColorÂ =Â color.new(longEntryColor,Â 50)
//Â varÂ colorÂ dbgShortEntryColorÂ =Â color.new(shortEntryColor,Â 50)
//Â varÂ colorÂ dbgLongExitColorÂ =Â color.new(longExitColor,Â 50)
//Â varÂ colorÂ dbgShortExitColorÂ =Â color.new(shortExitColor,Â 50)
//Â plotshape(seriesÂ =Â tryEnterLongPosition,Â titleÂ =Â 'DbgÂ TryÂ EnterÂ Long',Â styleÂ =Â shape.arrowup,Â locationÂ =Â location.belowbar,Â colorÂ =Â dbgLongEntryColor,Â sizeÂ =Â size.tiny,Â displayÂ =Â debugModeEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//Â plotshape(seriesÂ =Â tryEnterShortPosition,Â titleÂ =Â 'DbgÂ TryÂ EnterÂ Short',Â styleÂ =Â shape.arrowdown,Â locationÂ =Â location.abovebar,Â colorÂ =Â dbgShortEntryColor,Â sizeÂ =Â size.tiny,Â displayÂ =Â debugModeEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//Â plotshape(seriesÂ =Â enteredLongTrade,Â titleÂ =Â 'DbgÂ LongÂ Entred',Â styleÂ =Â shape.diamond,Â locationÂ =Â location.belowbar,Â colorÂ =Â dbgLongEntryColor,Â sizeÂ =Â size.small,Â displayÂ =Â debugModeEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//Â plotshape(seriesÂ =Â enteredShortTrade,Â titleÂ =Â 'DbgÂ ShortÂ Entred',Â styleÂ =Â shape.diamond,Â locationÂ =Â location.abovebar,Â colorÂ =Â dbgShortEntryColor,Â sizeÂ =Â size.small,Â displayÂ =Â debugModeEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//Â plotshape(seriesÂ =Â isLongPosition,Â titleÂ =Â 'DbgÂ ActiveÂ Long',Â styleÂ =Â shape.labelup,Â locationÂ =Â location.belowbar,Â colorÂ =Â dbgLongEntryColor,Â sizeÂ =Â size.small,Â displayÂ =Â debugModeEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//Â plotshape(seriesÂ =Â isShortPosition,Â titleÂ =Â 'DbgÂ ActiveÂ Short',Â styleÂ =Â shape.labeldown,Â locationÂ =Â location.abovebar,Â colorÂ =Â dbgShortEntryColor,Â sizeÂ =Â size.small,Â displayÂ =Â debugModeEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//Â plotshape(seriesÂ =Â completedLongTrade,Â titleÂ =Â 'DbgÂ LongÂ Completed',Â styleÂ =Â shape.square,Â locationÂ =Â location.belowbar,Â colorÂ =Â dbgLongExitColor,Â sizeÂ =Â size.small,Â displayÂ =Â debugModeEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//Â plotshape(seriesÂ =Â completedShortTrade,Â titleÂ =Â 'DbgÂ ShortÂ Completed',Â styleÂ =Â shape.square,Â locationÂ =Â location.abovebar,Â colorÂ =Â dbgShortExitColor,Â sizeÂ =Â size.small,Â displayÂ =Â debugModeEnabledÂ ?Â display.allÂ -Â display.status_lineÂ :Â display.none)
//#endregionÂ ===========================================================================================================
Expand (2047 lines)