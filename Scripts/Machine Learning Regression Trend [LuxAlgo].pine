Script Name: Machine Learning Regression Trend [LuxAlgo]
Author: LuxAlgo
Description: The Machine Learning Regression Trend tool uses random sample consensus (RANSAC) to fit and extrapolate a linear model by discarding potential outliers, resulting in a more robust fit.

ğŸ”¶  USAGE 

  

The proposed tool can be used like a regular linear regression, providing support/resistance as well as forecasting an estimated underlying trend.

Using RANSAC...
PineScript code:

Pine Scriptâ„¢ indicator
Machine Learning Regression Trend [LuxAlgo]
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
//Â ThisÂ workÂ isÂ licensedÂ underÂ aÂ Attribution-NonCommercial-ShareAlikeÂ 4.0Â InternationalÂ (CCÂ BY-NC-SAÂ 4.0)Â https://creativecommons.org/licenses/by-nc-sa/4.0/
//Â Â©Â LuxAlgo
//@version=5
indicator("MachineÂ LearningÂ RegressionÂ TrendÂ [LuxAlgo]",Â "LuxAlgoÂ -Â MachineÂ LearningÂ RegressionÂ Trend",Â overlayÂ =Â true,Â max_labels_countÂ =Â 500)
//------------------------------------------------------------------------------
//Settings
//-----------------------------------------------------------------------------{
lengthÂ =Â input.int(100,Â minvalÂ =Â 5)
widthMultÂ =Â input.float(2,Â 'ChannelÂ Width',Â minvalÂ =Â 0)Â 
srcÂ =Â input(close,Â 'Source')
//RANSAC
inlineNÂ =Â input.int(10,Â 'MinimumÂ Inliners',Â minvalÂ =Â 1,Â groupÂ =Â 'RANSAC')
errorTypeÂ =Â input.string('Auto',Â 'AllowedÂ Error',Â optionsÂ =Â ['Auto',Â 'Fixed'],Â inlineÂ =Â 'error',Â groupÂ =Â 'RANSAC')
minErrorÂ =Â input.float(1.,Â '',Â minvalÂ =Â 0,Â stepÂ =Â 0.5,Â inlineÂ =Â 'error',Â groupÂ =Â 'RANSAC')
maxIterÂ =Â input(10000,Â 'MaximumÂ IterationÂ Steps',Â groupÂ =Â 'RANSAC')
//Style
lineCssÂ =Â input(#2157f3,Â 'LineÂ Color',Â groupÂ =Â 'Style')
showMarginÂ =Â input(true,Â 'ShowÂ Margin',Â inlineÂ =Â 'margin',Â groupÂ =Â 'Style')
marginCssÂ =Â input(color.new(#2157f3,Â 80),Â '',Â inlineÂ =Â 'margin',Â groupÂ =Â 'Style')
showChannelÂ =Â input(true,Â 'ShowÂ Channel',Â inlineÂ =Â 'channel',Â groupÂ =Â 'Style')
channelCssÂ =Â input(color.new(color.gray,Â 90),Â '',Â inlineÂ =Â 'channel',Â groupÂ =Â 'Style')
showInlinersÂ =Â input(true,Â 'ShowÂ Inliners',Â inlineÂ =Â 'inliners',Â groupÂ =Â 'Style')
inlinersCssÂ =Â input(#2157f3,Â '',Â inlineÂ =Â 'inliners',Â groupÂ =Â 'Style')
showOutliersÂ =Â input(true,Â 'ShowÂ Outliers',Â inlineÂ =Â 'outliers',Â groupÂ =Â 'Style')
outliersCssÂ =Â input(#ff1100,Â '',Â inlineÂ =Â 'outliers',Â groupÂ =Â 'Style')
//-----------------------------------------------------------------------------}
//UDT
//-----------------------------------------------------------------------------{
typeÂ LinearRegression
Â Â Â Â array<float>Â y
Â Â Â Â array<int>Â x
Â Â Â Â array<float>Â inliners_y
Â Â Â Â array<int>Â inliners_x
Â Â Â Â floatÂ a
Â Â Â Â floatÂ b
//-----------------------------------------------------------------------------}
//Methods
//-----------------------------------------------------------------------------{
methodÂ fit(LinearRegressionÂ id)=>
Â Â Â Â aÂ =Â id.y.covariance(id.x)Â /Â id.x.variance()
Â Â Â Â bÂ =Â id.y.avg()Â -Â aÂ *Â id.x.avg()
Â Â Â Â id.aÂ :=Â a
Â Â Â Â id.bÂ :=Â b
methodÂ predict(LinearRegressionÂ id,Â x)=>
Â Â Â Â predictedÂ =Â id.aÂ *Â xÂ +Â id.bÂ 
methodÂ rmse(LinearRegressionÂ id)=>
Â Â Â Â iÂ =Â 0
Â Â Â Â rmseÂ =Â 0.
Â Â Â Â forÂ valueÂ inÂ id.y
Â Â Â Â Â Â Â Â rmseÂ +=Â math.pow(valueÂ -Â id.predict(id.x.get(i)),Â 2)
Â Â Â Â Â Â Â Â iÂ +=Â 1
Â Â Â Â 
Â Â Â Â math.sqrt(rmseÂ /Â i)
//-----------------------------------------------------------------------------}
//GetÂ data
//-----------------------------------------------------------------------------{
varÂ yÂ =Â array.new<float>(0)
varÂ xÂ =Â array.new<int>(0)
nÂ =Â bar_index
y.unshift(src)
x.unshift(n)
ifÂ y.size()Â >Â length
Â Â Â Â y.pop()
Â Â Â Â x.pop()
//Threshold
thresholdÂ =Â switchÂ errorType
Â Â Â Â 'Auto'Â =>Â ta.cum(math.abs(closeÂ -Â open))Â /Â (n+1)Â *Â minError
Â Â Â Â 'Fixed'Â =>Â minError
//-----------------------------------------------------------------------------}
//DisplayÂ linearÂ regression
//-----------------------------------------------------------------------------{
ifÂ barstate.islastconfirmedhistory
Â Â Â Â sizeÂ =Â inlineN
Â Â Â Â LinearRegressionÂ final_modelÂ =Â na
Â Â Â Â 
Â Â Â Â forÂ iÂ =Â 0Â toÂ maxIter-1
Â Â Â Â Â Â Â Â //PossibleÂ inliners
Â Â Â Â Â Â Â Â inliners_yÂ =Â array.new<float>(0)Â 
Â Â Â Â Â Â Â Â inliners_xÂ =Â array.new<int>(0)
Â Â Â Â Â Â Â Â //DetermineÂ randomÂ indices
Â Â Â Â Â Â Â Â forÂ jÂ =Â 0Â toÂ 1
Â Â Â Â Â Â Â Â Â Â Â Â idxÂ =Â int(math.random(0,Â length-1))
Â Â Â Â Â Â Â Â Â Â Â Â inliners_y.unshift(y.get(idx))
Â Â Â Â Â Â Â Â Â Â Â Â inliners_x.unshift(x.get(idx))
Â Â Â Â Â Â Â Â //GetÂ model
Â Â Â Â Â Â Â Â modelÂ =Â LinearRegression.new(inliners_y,Â inliners_x)
Â Â Â Â Â Â Â Â model.fit()
Â Â Â Â Â Â Â Â true_inliners_yÂ =Â array.new<float>(0)
Â Â Â Â Â Â Â Â true_inliners_xÂ =Â array.new<int>(0)
Â Â Â Â Â Â Â Â kÂ =Â 0
Â Â Â Â Â Â Â Â forÂ pointÂ inÂ y
Â Â Â Â Â Â Â Â Â Â Â Â predÂ =Â model.predict(x.get(k))
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ math.abs(pointÂ -Â pred)Â <Â threshold
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â true_inliners_y.unshift(point)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â true_inliners_x.unshift(x.get(k))
Â Â Â Â Â Â Â Â Â Â Â Â kÂ +=Â 1
Â Â Â Â Â Â Â Â ifÂ true_inliners_y.size()Â >=Â size
Â Â Â Â Â Â Â Â Â Â Â Â final_modelÂ :=Â LinearRegression.new(true_inliners_y,Â true_inliners_x
Â Â Â Â Â Â Â Â Â Â Â Â Â Â ,Â inliners_yÂ =Â true_inliners_y
Â Â Â Â Â Â Â Â Â Â Â Â Â Â ,Â inliners_xÂ =Â true_inliners_x)
Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â final_model.fit()
Â Â Â Â Â Â Â Â Â Â Â Â sizeÂ :=Â true_inliners_y.size()
Â Â Â Â 
Â Â Â Â //TetsÂ forÂ suitableÂ model
Â Â Â Â ifÂ na(final_model)
Â Â Â Â Â Â Â Â runtime.error('AÂ suitableÂ modelÂ couldÂ notÂ beÂ obtainedÂ fromÂ theÂ providedÂ data/hyperparameters')
Â Â Â Â 
Â Â Â Â //SetÂ line
Â Â Â Â y1Â =Â final_model.predict(n-length+1)
Â Â Â Â y2Â =Â final_model.predict(n)
Â Â Â Â line.new(n-length+1,Â y1,Â n,Â y2,Â colorÂ =Â lineCss,Â extendÂ =Â extend.right)
Â Â Â Â 
Â Â Â Â //ErrorÂ Margins
Â Â Â Â ifÂ showMargin
Â Â Â Â Â Â Â Â upperÂ =Â line.new(n-length+1,Â y1Â +Â threshold,Â n,Â y2Â +Â threshold,Â colorÂ =Â na)
Â Â Â Â Â Â Â Â lowerÂ =Â line.new(n-length+1,Â y1Â -Â threshold,Â n,Â y2Â -Â threshold,Â colorÂ =Â na)
Â Â Â Â Â Â Â Â linefill.new(upper,Â lower,Â marginCss)
Â Â Â Â 
Â Â Â Â //Channel
Â Â Â Â final_model.yÂ :=Â y
Â Â Â Â final_model.xÂ :=Â x
Â Â Â Â widthÂ =Â final_model.rmse()Â *Â widthMult
Â Â Â Â ifÂ showChannel
Â Â Â Â Â Â Â Â upperÂ =Â line.new(n-length+1,Â y1Â +Â width,Â n,Â y2Â +Â width,Â colorÂ =Â na,Â extendÂ =Â extend.right)
Â Â Â Â Â Â Â Â lowerÂ =Â line.new(n-length+1,Â y1Â -Â width,Â n,Â y2Â -Â width,Â colorÂ =Â na,Â extendÂ =Â extend.right)
Â Â Â Â Â Â Â Â linefill.new(upper,Â lower,Â channelCss)
Â Â Â Â //ShowÂ inliners/outliners
Â Â Â Â kÂ =Â 0
Â Â Â Â forÂ valueÂ inÂ y
Â Â Â Â Â Â Â Â ifÂ final_model.inliners_x.includes(n-k)
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ showInliners
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â label.new(n-k,Â value,Â 'â€¢'
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ,Â colorÂ =Â color(na)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ,Â textcolorÂ =Â inlinersCss
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ,Â styleÂ =Â label.style_label_center)
Â Â Â Â Â Â Â Â elseÂ ifÂ showOutliers
Â Â Â Â Â Â Â Â Â Â Â Â label.new(n-k,Â value,Â 'â€¢'
Â Â Â Â Â Â Â Â Â Â Â Â Â Â ,Â colorÂ =Â color(na)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â ,Â textcolorÂ =Â outliersCss
Â Â Â Â Â Â Â Â Â Â Â Â Â Â ,Â styleÂ =Â label.style_label_center)
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â kÂ +=Â 1
//-----------------------------------------------------------------------------}
Expand (169 lines)