Script Name: Fibonacci Zone DCA Strategy - R3c0nTrader
Author: R3c0nTrader
Description: Credits:
Thank you "eykpunter" for granting me permission to use "Fibonacci Zones" to create this strategy
Thank you "junyou0424" for granting me permission to use "DCA Bot with SuperTrend Emulator" which I used for adding bot inputs, calculations, and strategy

Pre-requisites:
You can use this script without a 3Commas account and see how 3Commas DCA Bot would...
PineScript code:

Pine Scriptâ„¢ strategy
Fibonacci Zone DCA Strategy - R3c0nTrader
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
//Â Â©Â FibonacciÂ ZoneÂ DCAÂ StrategyÂ -Â R3c0nTraderÂ verÂ 2022-07-09
//Â ForÂ backtestingÂ withÂ 3CommasÂ DCAÂ BotÂ settings
//Â ThankÂ youÂ "eykpunter"Â forÂ grantingÂ meÂ permissionÂ toÂ useÂ "FibonacciÂ Zones"Â toÂ createÂ thisÂ strategy
//Â ThankÂ youÂ "junyou0424"Â forÂ grantingÂ meÂ permissionÂ toÂ useÂ "DCAÂ BotÂ withÂ SuperTrendÂ Emulator"Â whichÂ IÂ usedÂ forÂ addingÂ botÂ inputs,Â calculations,Â andÂ strategy
//@version=5
strategy('FibonacciÂ ZoneÂ DCAÂ StrategyÂ -Â R3c0nTrader',Â shorttitle='FibonacciÂ ZoneÂ DCAÂ Strategy',Â overlay=true,Â pyramiding=999,Â default_qty_type=strategy.cash,Â initial_capital=10000,Â commission_value=0.0,Â use_bar_magnifier=true,Â process_orders_on_close=true)
//Â StrategyÂ Inputs
//Â StartÂ andÂ EndÂ Dates
i_startTimeÂ =Â input.time(defval=timestamp('01Â JanÂ 2015Â 00:00Â +0000'),Â title='StartÂ Time',Â group="DateÂ Range")
i_endTimeÂ =Â input.time(defval=timestamp('31Â DecÂ 2050Â 23:59Â +0000'),Â title='EndÂ Time',Â group="DateÂ Range")
inDateRangeÂ =Â timeÂ >=Â i_startTimeÂ andÂ timeÂ <=Â i_endTime
//Â Start:Â FibonacciÂ Settings----------------------------------------------------
sourceInputÂ =Â input.source(close,Â "Source",Â group="FibonacciÂ TradeÂ EntryÂ Settings")
perÂ =Â input(14,Â title='FibonacciÂ length',Â tooltip='NumberÂ ofÂ barsÂ toÂ lookÂ back.Â RecommendedÂ forÂ beginnersÂ toÂ setÂ ADXÂ SmoothingÂ andÂ DIÂ LengthÂ toÂ theÂ sameÂ valueÂ asÂ this.',Â group="FibonacciÂ TradeÂ EntryÂ Settings")
hlÂ =Â ta.highest(high,Â per)Â Â //Top-HighÂ FibÂ Border
llÂ =Â ta.lowest(low,Â per)Â Â Â Â //Top-LowÂ FibÂ Border
distÂ =Â hlÂ -Â llÂ Â Â Â Â Â Â Â Â Â Â Â Â Â //RangeÂ ofÂ theÂ channelÂ Â Â Â 
hfÂ =Â hlÂ -Â distÂ *Â 0.236Â Â Â Â Â Â //Bottom-HighÂ FibÂ Border
cfhÂ =Â hlÂ -Â distÂ *Â 0.382Â Â Â Â Â //Top-CenterÂ FibÂ Border
cflÂ =Â hlÂ -Â distÂ *Â 0.618Â Â Â Â Â //Bottom-CenterÂ FibÂ Border
lfÂ =Â hlÂ -Â distÂ *Â 0.764Â Â Â Â Â Â //Top-LowÂ FibÂ Border
//Â Start:Â ADXÂ Settings
lensigÂ =Â input.int(14,Â title="ADXÂ Smoothing",Â tooltip='FibonacciÂ signalsÂ workÂ bestÂ whenÂ marketÂ isÂ trending.Â ADXÂ isÂ usedÂ toÂ measureÂ trendÂ strength.Â DefaultÂ valueÂ isÂ 14.Â RecommendÂ forÂ beginnersÂ toÂ matchÂ thisÂ withÂ FibonacciÂ lengthÂ andÂ DIÂ Length',minval=1,Â maxval=50,Â group="FibonacciÂ TradeÂ EntryÂ Settings")
lenÂ =Â input.int(14,Â minval=1,Â title="DIÂ Length",Â tooltip='FibonacciÂ signalsÂ workÂ bestÂ whenÂ marketÂ isÂ trending.Â DIÂ LengthÂ isÂ usedÂ toÂ calculateÂ ADXÂ toÂ measureÂ trendÂ strength.Â DefaultÂ valueÂ isÂ 14.Â RecommendÂ forÂ beginnersÂ toÂ matchÂ thisÂ withÂ FibonacciÂ lengthÂ andÂ ADXÂ Smoothing.',Â group="FibonacciÂ TradeÂ EntryÂ Settings")
adx_minÂ =Â input.int(25,Â title='MinÂ ADXÂ valueÂ toÂ openÂ trade',Â tooltip='UseÂ thisÂ toÂ setÂ theÂ miniumÂ ADXÂ valueÂ (trendÂ strength)Â toÂ openÂ trade.Â 25Â orÂ higherÂ isÂ recommendedÂ forÂ beginners.Â 0Â toÂ 20Â isÂ aÂ weakÂ trend.Â 25Â toÂ 35Â isÂ aÂ strongÂ trend.Â 35Â toÂ 45Â isÂ aÂ veryÂ strongÂ trend.Â 45Â toÂ 100Â isÂ anÂ extremelyÂ strongÂ trend.',Â group="FibonacciÂ TradeÂ EntryÂ Settings")
adx_maxÂ =Â input.int(100,Â title='MaxÂ ADXÂ valueÂ toÂ openÂ trade',Â tooltip='UseÂ thisÂ toÂ setÂ theÂ maximumÂ ADXÂ valueÂ (trendÂ strength)Â toÂ openÂ trade.Â 100Â isÂ recommendedÂ forÂ beginners.Â 0Â toÂ 20Â isÂ aÂ weakÂ trend.Â 25Â toÂ 35Â isÂ aÂ strongÂ trend.Â 35Â toÂ 45Â isÂ aÂ veryÂ strongÂ trend.Â 45Â toÂ 100Â isÂ anÂ extremelyÂ strongÂ trend.',Â group="FibonacciÂ TradeÂ EntryÂ Settings")
upÂ =Â ta.change(high)
downÂ =Â -ta.change(low)
plusDMÂ =Â na(up)Â ?Â naÂ :Â (upÂ >Â downÂ andÂ upÂ >Â 0Â ?Â upÂ :Â 0)
minusDMÂ =Â na(down)Â ?Â naÂ :Â (downÂ >Â upÂ andÂ downÂ >Â 0Â ?Â downÂ :Â 0)
trurÂ =Â ta.rma(ta.tr,Â len)
di_plusÂ =Â fixnan(100Â *Â ta.rma(plusDM,Â len)Â /Â trur)
di_minusÂ =Â fixnan(100Â *Â ta.rma(minusDM,Â len)Â /Â trur)
sumÂ =Â di_plusÂ +Â di_minus
adxÂ =Â 100Â *Â ta.rma(math.abs(di_plusÂ -Â di_minus)Â /Â (sumÂ ==Â 0Â ?Â 1Â :Â sum),Â lensig)
adx_inrangeÂ =Â adxÂ >=Â adx_minÂ andÂ adxÂ <=Â adx_max
//Â End:Â ADXÂ Settings
//Â InputÂ toÂ setupÂ BuyÂ signalsÂ whenÂ theÂ sourceÂ crossesÂ aÂ fibÂ border
entry_triggerÂ =Â input.string("1-Crosses",Â title="BuyÂ signalsÂ whenÂ theÂ source:Â [cont.]",Â options=["1-Crosses",Â "2-CrossesÂ up",Â "3-CrossesÂ down"],Â tooltip="'Crosses'Â includesÂ upÂ andÂ downÂ movements.Â 'CrossesÂ Up'Â onlyÂ includesÂ upÂ movements.Â 'CrossesÂ Down'Â onlyÂ includesÂ downÂ movements"Â ,Â group="FibonacciÂ TradeÂ EntryÂ Settings")
e_trigÂ =Â 0
ifÂ entry_triggerÂ ==Â "1-Crosses"
Â Â Â Â e_trigÂ :=Â 1
elseÂ ifÂ entry_triggerÂ ==Â "2-CrossesÂ up"
Â Â Â Â e_trigÂ :=Â 2
elseÂ ifÂ entry_triggerÂ ==Â "3-CrossesÂ down"
Â Â Â Â e_trigÂ :=Â 3
entry_choiceÂ =Â input.string("6-Bottom-LowÂ FibÂ Border",Â title="...TheÂ FibÂ line:",Â options=["1-Top-HighÂ FibÂ Border",Â "2-Bottom-HighÂ FibÂ Border",Â "3-Top-CenterÂ FibÂ Border",Â "4-Bottom-CenterÂ FibÂ Border",Â "5-Top-LowÂ FibÂ Border",Â "6-Bottom-LowÂ FibÂ Border"],
Â Â Â tooltip='ThereÂ areÂ threeÂ fibÂ zonesÂ andÂ eachÂ zoneÂ hasÂ 2Â bordersÂ (TopÂ &Â Bottom).Â TheÂ optionsÂ areÂ listedÂ fromÂ theÂ topÂ zoneÂ toÂ theÂ bttomÂ zone.Â TheÂ bottomÂ zoneÂ isÂ theÂ DowntrendÂ zone;Â theÂ middleÂ zoneÂ isÂ theÂ RangingÂ zone;Â TheÂ topÂ fibÂ zoneÂ isÂ theÂ UptrendÂ zone;',
Â Â Â group="FibonacciÂ TradeÂ EntryÂ Settings")
fib_levelÂ =Â float(0)
ifÂ entry_choiceÂ ==Â "1-Top-HighÂ FibÂ Border"
Â Â Â Â fib_levelÂ :=Â hl
elseÂ ifÂ entry_choiceÂ ==Â "2-Bottom-HighÂ FibÂ Border"
Â Â Â Â fib_levelÂ :=Â hf
elseÂ ifÂ entry_choiceÂ ==Â "3-Top-CenterÂ FibÂ Border"
Â Â Â Â fib_levelÂ :=Â cfh
elseÂ ifÂ entry_choiceÂ ==Â "4-Bottom-CenterÂ FibÂ Border"
Â Â Â Â fib_levelÂ :=Â cfl
elseÂ ifÂ entry_choiceÂ ==Â "5-Top-LowÂ FibÂ Border"
Â Â Â Â fib_levelÂ :=Â lf
elseÂ ifÂ entry_choiceÂ ==Â "6-Bottom-LowÂ FibÂ Border"
Â Â Â Â fib_levelÂ :=Â ll
//Â Start:Â BullishÂ +DIÂ option
di_choiceÂ =Â input.bool(false,Â title="OnlyÂ openÂ tradesÂ onÂ bullishÂ +DIÂ (PositiveÂ DirectionalÂ Index)?Â (offÂ forÂ contrarianÂ traders)",Â 
Â Â tooltip='DefaultÂ isÂ disabled.Â IfÂ youÂ wantÂ toÂ beÂ moreÂ selectiveÂ (youÂ wantÂ aÂ bullishÂ confirmation),Â enableÂ thisÂ andÂ itÂ willÂ onlyÂ openÂ tradesÂ whenÂ theÂ +DIÂ (PositiveÂ DirectionalÂ Index)Â isÂ higherÂ thanÂ theÂ -DIÂ (NegativeÂ DirectionalÂ Index).Â ContrarianÂ tradersÂ (buyÂ theÂ dip)Â shouldÂ leaveÂ thisÂ disabled',Â 
Â Â group="FibonacciÂ TradeÂ EntryÂ Settings")
di_minÂ =Â input.int(0,Â title='MinÂ +DIÂ valueÂ toÂ openÂ trade',Â 
Â Â tooltip='DefaultÂ isÂ zero.Â UseÂ thisÂ toÂ setÂ theÂ miniumÂ +DIÂ valueÂ toÂ openÂ theÂ trade.Â TryÂ incrementingÂ thisÂ valueÂ ifÂ youÂ wantÂ toÂ beÂ moreÂ selectiveÂ andÂ filterÂ forÂ moreÂ bullishÂ movesÂ (e.g.Â 20-25).Â ForÂ ContrarianÂ traders,Â uncheckÂ "OnlyÂ openÂ tradesÂ onÂ bullishÂ DI"Â optionÂ andÂ setÂ MinÂ +DIÂ toÂ zero',Â 
Â Â group="FibonacciÂ TradeÂ EntryÂ Settings")
di_maxÂ =Â input.int(100,Â title='MaxÂ +DIÂ valueÂ toÂ openÂ trade',Â 
Â Â tooltip='DefaultÂ isÂ 100.Â UseÂ thisÂ toÂ setÂ theÂ maxiumÂ +DIÂ valueÂ toÂ openÂ trade.Â ForÂ ContrarianÂ traders,Â uncheckÂ "OnlyÂ openÂ tradesÂ onÂ bullishÂ DI"Â optionÂ andÂ tryÂ aÂ MaxÂ +DIÂ valueÂ noÂ higherÂ thanÂ 20Â orÂ 25',Â 
Â Â group="FibonacciÂ TradeÂ EntryÂ Settings")
di_neg_minÂ =Â input.int(0,Â title='MinÂ -DIÂ valueÂ toÂ openÂ trade',Â 
Â Â tooltip='DefaultÂ isÂ zero.Â UseÂ thisÂ toÂ setÂ theÂ miniumÂ -DIÂ valueÂ toÂ openÂ theÂ trade.Â TryÂ incrementingÂ thisÂ valueÂ ifÂ youÂ wantÂ toÂ beÂ moreÂ selectiveÂ andÂ filterÂ forÂ moreÂ bearishÂ movesÂ (e.g.Â 25Â orÂ higher).',Â 
Â Â group="FibonacciÂ TradeÂ EntryÂ Settings")
di_neg_maxÂ =Â input.int(100,Â title='MaxÂ -DIÂ valueÂ toÂ openÂ trade',Â 
Â Â tooltip='DefaultÂ isÂ 100.Â UseÂ thisÂ toÂ setÂ theÂ maximumÂ -DIÂ valueÂ toÂ openÂ trade.',Â 
Â Â group="FibonacciÂ TradeÂ EntryÂ Settings")
di_inrangeÂ =Â di_plusÂ >=Â di_minÂ andÂ di_plusÂ <=Â di_maxÂ andÂ di_minusÂ >=Â di_neg_minÂ andÂ di_minusÂ <=Â di_neg_max
//Â End:Â BullishÂ +DIÂ option
//Â End:Â FibonacciÂ Settings------------------------------------------------------
//Â Start:Â SafetyÂ OrderÂ Settings-------------------------------------------------
base_orderÂ =Â input(100.0,Â title='BaseÂ order',Â group="SafetyÂ OrderÂ Settings")
safe_orderÂ =Â input(200.0,Â title='SafetyÂ order',Â group="SafetyÂ OrderÂ Settings")
price_deviationÂ =Â input.float(6.0,Â title='PriceÂ deviationÂ toÂ openÂ safetyÂ ordersÂ (%)',Â step=0.25,Â minval=0.0,Â group="SafetyÂ OrderÂ Settings")Â /Â 100
safe_order_volume_scaleÂ =Â input.float(2.0,Â step=0.5,Â title='SafetyÂ orderÂ volumeÂ scale',Â group="SafetyÂ OrderÂ Settings")
safe_order_step_scaleÂ =Â input.float(1,Â step=0.1,Â title='SafetyÂ orderÂ stepÂ scale',Â group="SafetyÂ OrderÂ Settings")
max_safe_orderÂ =Â input(5,Â title='MaxÂ safetyÂ orders',Â group="SafetyÂ OrderÂ Settings")
//Â End:Â SafetyÂ OrderÂ Settings---------------------------------------------------
//Â End:Â TradeÂ EntryÂ Settings----------------------------------------------------
//Â Start:Â TradeÂ ExitÂ Settings---------------------------------------------------
//Â TruncateÂ function
truncate(number,Â decimals)Â =>
Â Â Â Â factorÂ =Â math.pow(10,Â decimals)
Â Â Â Â int(numberÂ *Â factor)Â /Â factor
//Â Start:Â TradeÂ ExitÂ Settings---------------------------------------------------
//Â Start:Â FibonacciÂ Exit--------------------------------------------------------
fib_tp_triggerÂ =Â input.string("1-Crosses",Â title="TakeÂ ProfitÂ whenÂ theÂ source:Â [cont.]",Â options=["1-Crosses",Â "2-CrossesÂ up",Â "3-CrossesÂ down",Â "4-ReachesÂ TargetÂ TakeÂ ProfitÂ (%)"],Â tooltip=
Â Â Â "'Crosses'Â includesÂ upÂ andÂ downÂ movements.Â 'CrossesÂ Up'Â onlyÂ includesÂ upÂ movements.Â 'CrossesÂ Down'Â onlyÂ includesÂ downÂ movements"Â ,Â group="FibonacciÂ TradeÂ ExitÂ Settings")
fib_tpÂ =Â 0
ifÂ fib_tp_triggerÂ ==Â "1-Crosses"
Â Â Â Â fib_tpÂ :=Â 1
elseÂ ifÂ fib_tp_triggerÂ ==Â "2-CrossesÂ up"
Â Â Â Â fib_tpÂ :=Â 2
elseÂ ifÂ fib_tp_triggerÂ ==Â "3-CrossesÂ down"
Â Â Â Â fib_tpÂ :=Â 3
elseÂ ifÂ fib_tp_triggerÂ ==Â "4-ReachesÂ TargetÂ TakeÂ ProfitÂ (%)"
Â Â Â Â fib_tpÂ :=Â 4
//Â TakeÂ ProfitÂ Drop-downÂ menuÂ option
//Â DeclareÂ take_profit
take_profitÂ =Â float(0.03)
tp_choiceÂ =Â input.string("1-Top-HighÂ FibÂ Border",Â title="...TheÂ FibÂ line:",Â options=["1-Top-HighÂ FibÂ Border",Â "2-Bottom-HighÂ FibÂ Border",Â "3-Top-CenterÂ FibÂ Border",Â "4-Bottom-CenterÂ FibÂ Border"],Â tooltip=
Â Â 'SelectÂ howÂ toÂ exitÂ yourÂ tradeÂ andÂ takeÂ profit.Â ThenÂ specifyÂ belowÂ thisÂ optionÂ theÂ conditionÂ toÂ exit.Â "Top-HighÂ FibÂ Border"Â isÂ theÂ top-mostÂ FibonacciÂ lineÂ inÂ theÂ greenÂ uptrendÂ zone.Â "Bottom-HighÂ FibÂ Border"Â isÂ theÂ bottomÂ FibonacciÂ lineÂ inÂ theÂ greenÂ uptrendÂ zone.Â YouÂ canÂ findÂ theseÂ linesÂ onÂ theÂ "Style"Â tabÂ andÂ toggleÂ themÂ off/onÂ toÂ locateÂ theseÂ linesÂ forÂ moreÂ clarity',Â 
Â Â group="FibonacciÂ TradeÂ ExitÂ Settings")
ifÂ tp_choiceÂ ==Â "1-Top-HighÂ FibÂ Border"
Â Â Â Â take_profitÂ :=Â float(hl)
elseÂ ifÂ tp_choiceÂ ==Â "2-Bottom-HighÂ FibÂ Border"
Â Â Â Â take_profitÂ :=Â float(hf)
elseÂ ifÂ tp_choiceÂ ==Â "3-Top-CenterÂ FibÂ Border"
Â Â Â Â take_profitÂ :=Â float(cfh)
elseÂ ifÂ tp_choiceÂ ==Â "4-Bottom-CenterÂ FibÂ Border"
Â Â Â Â take_profitÂ :=Â float(cfl)
//Â InputÂ forÂ TTPÂ %
ifÂ fib_tpÂ ==Â 4Â 
Â Â Â Â take_profitÂ :=Â input.float(3.0,Â title='TargetÂ TakeÂ ProfitÂ (%)',Â step=0.5,Â minval=0.0,Â tooltip='OnlyÂ usedÂ ifÂ "TargetÂ TakeÂ ProfitÂ (%)"Â isÂ selectedÂ above.',Â group="FibonacciÂ TradeÂ ExitÂ Settings")Â /Â 100
//Â End:Â FibonacciÂ Exit----------------------------------------------------------
//Â Trailing
trailingÂ =Â input.float(0.0,Â title='TrailingÂ deviation.Â Default=Â 0.0Â (%)',Â step=0.1,Â minval=0.0,Â group="FibonacciÂ TradeÂ ExitÂ Settings")Â /Â 100
//Â CalculateÂ ourÂ keyÂ levels
varÂ current_soÂ =Â 0
varÂ initial_orderÂ =Â 0.0
varÂ previous_high_valueÂ =Â 0.0
varÂ original_ttp_valueÂ =Â 0.0
//Â FibonacciÂ TakeÂ ProfitÂ Conditions
fb_tp_conditionÂ =Â false
ifÂ fib_tpÂ ==Â 1
Â Â Â Â fb_tp_conditionÂ :=Â ta.cross(sourceInput,Â take_profit)Â 
elseÂ ifÂ fib_tpÂ ==Â 2
Â Â Â Â fb_tp_conditionÂ :=Â ta.crossover(sourceInput,Â take_profit)Â 
elseÂ ifÂ fib_tpÂ ==Â 3
Â Â Â Â fb_tp_conditionÂ :=Â ta.crossunder(sourceInput,Â take_profit)Â 
//Â End:Â TradeÂ ExitÂ Settings-----------------------------------------------------
//Â Start:Â WHENÂ TOÂ BUYÂ LOGIC-----------------------------------------------------
//Â DetermineÂ ifÂ FibÂ EntryÂ TriggerÂ wasÂ met
e_trig_boolÂ =Â bool(false)
ifÂ e_trigÂ ==Â 1
Â Â Â Â e_trig_boolÂ :=Â ta.cross(sourceInput,Â fib_level)
elseÂ ifÂ e_trigÂ ==Â 2
Â Â Â Â e_trig_boolÂ :=Â ta.crossover(sourceInput,Â fib_level)
elseÂ ifÂ e_trigÂ ==Â 3
Â Â Â Â e_trig_boolÂ :=Â ta.crossunder(sourceInput,Â fib_level)
elseÂ 
Â Â Â Â e_trig_boolÂ :=Â false
//Â FirstÂ FibÂ EntryÂ CalculationÂ forÂ whenÂ toÂ buy
buyÂ =Â bool(false)
use_fibÂ =Â e_trig_boolÂ andÂ adx_inrange
//Â IfÂ optionÂ enabledÂ forÂ enterÂ tradesÂ onlyÂ whenÂ DIÂ isÂ positive,Â thenÂ openÂ tradeÂ basedÂ onÂ userÂ settings
ifÂ di_choiceÂ andÂ di_inrangeÂ andÂ inDateRangeÂ andÂ use_fib
Â Â Â Â buyÂ :=Â (di_plusÂ >Â di_minus)Â ?Â trueÂ :Â false
elseÂ ifÂ di_inrangeÂ andÂ inDateRangeÂ andÂ use_fib
Â Â Â Â buyÂ :=Â true
else
Â Â Â Â buy:=Â false
ifÂ buyÂ andÂ strategy.position_sizeÂ ==Â 0Â andÂ sourceInputÂ >Â 0
Â Â Â Â strategy.entry('LongÂ @'Â +Â str.tostring(sourceInput)+'ğŸ’âœ‹ğŸ¤š',Â strategy.long,Â qty=base_orderÂ /Â sourceInput)
Â Â Â Â initial_orderÂ :=Â sourceInput
Â Â Â Â current_soÂ :=Â 1
Â Â Â Â previous_high_valueÂ :=Â 0.0
Â Â Â Â original_ttp_valueÂ :=Â 0
//Â End:Â WHENÂ TOÂ BUYÂ LOGIC-------------------------------------------------------
//Â Start:Â FibÂ BasedÂ StopÂ Loss---------------------------------------------------
tp_choice_fibstoplossÂ =Â input.bool(false,Â title='UseÂ Fib-basedÂ StopÂ Loss?',Â tooltip='UseÂ thisÂ toÂ useÂ theÂ settingsÂ belowÂ toÂ exitÂ theÂ tradeÂ whenÂ theÂ sourceÂ crosseseÂ aÂ FibÂ Border',Â group="FibÂ BasedÂ StopÂ Loss")
fib_exit_triggerÂ =Â input.string("1-Crosses",Â title="FibÂ StopÂ LossÂ signalsÂ whenÂ theÂ source:Â [cont.]",Â options=["1-Crosses",Â "2-CrossesÂ up",Â "3-CrossesÂ down"],Â 
Â Â Â tooltip="IgnoredÂ ifÂ aboveÂ optionÂ forÂ Fib-basedÂ StopÂ LossÂ isÂ notÂ enabled.Â 'Crosses'Â includesÂ upÂ andÂ downÂ movements.Â 'CrossesÂ Up'Â onlyÂ includesÂ upÂ movements.Â 'CrossesÂ Down'Â onlyÂ includesÂ downÂ movements"Â ,Â group="FibÂ BasedÂ StopÂ Loss")
fib_exitÂ =Â 0
ifÂ fib_exit_triggerÂ ==Â "1-Crosses"
Â Â Â Â fib_exitÂ :=Â 1
elseÂ ifÂ fib_exit_triggerÂ ==Â "2-CrossesÂ up"
Â Â Â Â fib_exitÂ :=Â 2
elseÂ ifÂ fib_exit_triggerÂ ==Â "3-CrossesÂ down"
Â Â Â Â fib_exitÂ :=Â 3
fib_exit_choiceÂ =Â input.string("6-Bottom-LowÂ FibÂ Border",Â title="...TheÂ FibÂ line:",Â options=["1-Top-HighÂ FibÂ Border",Â "2-Bottom-HighÂ FibÂ Border",Â "3-Top-CenterÂ FibÂ Border",Â "4-Bottom-CenterÂ FibÂ Border",Â "5-Top-LowÂ FibÂ Border",Â "6-Bottom-LowÂ FibÂ Border"],
Â Â Â tooltip='ThereÂ areÂ threeÂ fibÂ zonesÂ andÂ eachÂ zoneÂ hasÂ 2Â bordersÂ (TopÂ &Â Bottom).Â TheÂ optionsÂ areÂ listedÂ fromÂ theÂ bottomÂ zoneÂ toÂ theÂ topÂ zone.Â TheÂ bottomÂ zoneÂ isÂ theÂ DowntrendÂ zone;Â theÂ middleÂ zoneÂ isÂ theÂ RangingÂ zone;Â TheÂ topÂ fibÂ zoneÂ isÂ theÂ UptrendÂ zone;',
Â Â Â group="FibÂ BasedÂ StopÂ Loss")
fib_exit_levelÂ =Â float(0)
ifÂ fib_exit_choiceÂ ==Â "1-Top-HighÂ FibÂ Border"
Â Â Â Â fib_exit_levelÂ :=Â hl
elseÂ ifÂ fib_exit_choiceÂ ==Â "2-Bottom-HighÂ FibÂ Border"
Â Â Â Â fib_exit_levelÂ :=Â hf
elseÂ ifÂ fib_exit_choiceÂ ==Â "3-Top-CenterÂ FibÂ Border"
Â Â Â Â fib_exit_levelÂ :=Â cfh
elseÂ ifÂ fib_exit_choiceÂ ==Â "4-Bottom-CenterÂ FibÂ Border"
Â Â Â Â fib_exit_levelÂ :=Â cfl
elseÂ ifÂ fib_exit_choiceÂ ==Â "5-Top-LowÂ FibÂ Border"
Â Â Â Â fib_exit_levelÂ :=Â lf
elseÂ ifÂ fib_exit_choiceÂ ==Â "6-Bottom-LowÂ FibÂ Border"
Â Â Â Â fib_exit_levelÂ :=Â ll
//Â DetermineÂ whichÂ FibÂ BasedÂ StopÂ LossÂ wasÂ selected
exit_trig_boolÂ =Â bool(false)
ifÂ fib_exitÂ ==Â 1
Â Â Â Â exit_trig_boolÂ :=Â ta.cross(sourceInput,Â fib_exit_level)
elseÂ ifÂ fib_exitÂ ==Â 2
Â Â Â Â exit_trig_boolÂ :=Â ta.crossover(sourceInput,Â fib_exit_level)
elseÂ ifÂ fib_exitÂ ==Â 3
Â Â Â Â exit_trig_boolÂ :=Â ta.crossunder(sourceInput,Â fib_exit_level)
elseÂ 
Â Â Â Â exit_trig_boolÂ :=Â false
//Â DetermineÂ ifÂ FibÂ StopÂ LossÂ conditionÂ isÂ met
ifÂ tp_choice_fibstoplossÂ andÂ exit_trig_bool
Â Â Â Â strategy.close_all(comment='FibÂ stopÂ lossÂ @'Â +Â str.tostring(strategy.position_avg_price))
Â Â Â Â current_soÂ :=Â 0
Â Â Â Â previous_high_valueÂ :=Â 0
Â Â Â Â original_ttp_valueÂ :=Â 0
Â Â Â Â //Â original_ttp_value
//Â End:Â FibÂ BasedÂ StopÂ Loss-----------------------------------------------------
//Â Start:Â TakeÂ ProfitÂ Level-----------------------------------------------------
//Â take_profitÂ =Â float(na)
take_profit_levelÂ =Â float(na)
//Â ConditionsÂ whenÂ toÂ takeÂ profitÂ andÂ whichÂ FibÂ strategyÂ isÂ theÂ activeÂ strategy
ifÂ fib_tpÂ ==Â 4Â Â andÂ strategy.position_sizeÂ >Â 0
Â Â Â Â take_profit_levelÂ :=Â strategy.position_avg_priceÂ *Â (1Â +Â take_profit)
else
Â Â Â Â take_profit_levelÂ :=Â take_profit
//Â End:Â TakeÂ ProfitÂ Level-------------------------------------------------------
//Â Start:Â SafetyÂ OrderÂ thresholdÂ logic------------------------------------------
thresholdÂ =Â 0.0
Â Â Â Â 
ifÂ safe_order_step_scaleÂ ==Â 1.0
Â Â Â Â thresholdÂ :=Â initial_orderÂ -Â initial_orderÂ *Â price_deviationÂ *Â safe_order_step_scaleÂ *Â current_so
elseÂ ifÂ current_soÂ <=Â max_safe_order
Â Â Â Â thresholdÂ :=Â initial_orderÂ -Â initial_orderÂ *Â ((price_deviationÂ *Â math.pow(safe_order_step_scale,Â current_so)Â -Â price_deviation)Â /Â (safe_order_step_scaleÂ -Â 1))
elseÂ ifÂ current_soÂ >Â max_safe_order
Â Â Â Â thresholdÂ :=Â initial_orderÂ -Â initial_orderÂ *Â ((price_deviationÂ *Â math.pow(safe_order_step_scale,Â max_safe_order)Â -Â price_deviation)Â /Â (safe_order_step_scaleÂ -Â 1))
Â Â Â Â 
//Â AverageÂ downÂ whenÂ lowestÂ candleÂ valueÂ crossesÂ belowÂ threshold
ifÂ current_soÂ >Â 0Â andÂ lowÂ <=Â thresholdÂ andÂ current_soÂ <=Â max_safe_orderÂ andÂ previous_high_valueÂ ==Â 0.0
Â Â Â Â //Â TriggerÂ aÂ safetyÂ orderÂ atÂ theÂ SafetyÂ OrderÂ "threshold"Â price
Â Â Â Â strategy.entry('ğŸ˜¨ğŸ™Â SOÂ 'Â +Â str.tostring(current_so)Â +Â '@'Â +Â str.tostring(threshold),Â direction=strategy.long,Â qty=safe_orderÂ *Â math.pow(safe_order_volume_scale,Â current_soÂ -Â 1)Â /Â threshold)
Â Â Â Â current_soÂ +=Â 1
//Â End:Â SafetyÂ OrderÂ thresholdÂ logic---------------------------------------------
//Â Start:Â TakeÂ Profit-----------------------------------------------------------
//Â TakeÂ profitÂ whenÂ takeÂ profitÂ levelÂ isÂ equalÂ toÂ orÂ higherÂ thanÂ theÂ highÂ ofÂ theÂ candle
varÂ trailing_priceÂ =Â float(0.0)
varÂ stopValueÂ =Â float(0.0)
ifÂ take_profit_levelÂ <=Â highÂ andÂ strategy.position_sizeÂ >Â 0Â orÂ previous_high_valueÂ >Â 0.0Â orÂ (fb_tp_conditionÂ andÂ strategy.position_sizeÂ >Â 0)
Â Â Â Â ifÂ trailingÂ >Â 0.0
Â Â Â Â Â Â Â Â //Â 'trailing_price'Â willÂ containÂ theÂ largestÂ percentage-basedÂ stopÂ value
Â Â Â Â Â Â Â Â trailing_priceÂ :=Â ifÂ (strategy.position_sizeÂ >Â 0)
Â Â Â Â Â Â Â Â Â Â Â Â //Â 'stopValue'Â willÂ updateÂ everyÂ candleÂ closeÂ andÂ containÂ aÂ percentage-basedÂ stopÂ value
Â Â Â Â Â Â Â Â Â Â Â Â stopValueÂ :=Â closeÂ *Â (1Â -Â trailing)
Â Â Â Â Â Â Â Â Â Â Â Â //Â TheÂ 'max'Â functionÂ isÂ whatÂ allowsÂ theÂ percentage-basedÂ stopÂ toÂ 'Trail'.
Â Â Â Â Â Â Â Â Â Â Â Â //Â IfÂ theÂ stopValueÂ isÂ higherÂ thanÂ theÂ previousÂ trailing_priceÂ (whichÂ wasÂ theÂ oldÂ stopValue)Â thenÂ weÂ keepÂ theÂ higherÂ value
Â Â Â Â Â Â Â Â Â Â Â Â //Â TheÂ trailing_priceÂ canÂ onlyÂ increaseÂ orÂ remainÂ theÂ same.
Â Â Â Â Â Â Â Â Â Â Â Â math.max(stopValue,Â trailing_price[1])
Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â 0
Â Â Â Â Â Â Â Â ifÂ previous_high_valueÂ >Â 0.0
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ highÂ >=Â previous_high_value
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â previous_high_valueÂ :=Â sourceInput
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ closeÂ <=Â trailing_price
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â previous_high_percentÂ =Â (previous_high_valueÂ -Â original_ttp_value)Â *Â 1.0Â /Â original_ttp_value
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â current_high_percentÂ =Â (closeÂ -Â original_ttp_value)Â *Â 1.0Â /Â original_ttp_value
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â strategy.close_all(comment='CloseÂ (trailing)Â @'Â +Â str.tostring(truncate(current_high_percentÂ *Â 100,Â 3))Â +Â '%')
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â current_soÂ :=Â 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â previous_high_valueÂ :=Â 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â original_ttp_valueÂ :=Â 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â trailing_priceÂ :=Â 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â stopValueÂ :=Â 0
Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â previous_high_valueÂ :=Â high
Â Â Â Â Â Â Â Â Â Â Â Â original_ttp_valueÂ :=Â high
Â Â Â Â else
Â Â Â Â Â Â Â Â strategy.close_all(comment='ğŸ’°Â CloseÂ @'Â +Â str.tostring(high))
Â Â Â Â Â Â Â Â current_soÂ :=Â 0
Â Â Â Â Â Â Â Â previous_high_valueÂ :=Â 0
Â Â Â Â Â Â Â Â original_ttp_valueÂ :=Â 0
Â Â Â Â Â Â Â Â trailing_priceÂ :=Â 0
Â Â Â Â Â Â Â Â stopValueÂ :=Â 0
//Â End:Â TakeÂ Profit-------------------------------------------------------------
//Â Start:Â Plots-----------------------------------------------------------------
//Â PlotÂ TrailingÂ StopÂ LossÂ andÂ associatedÂ originalÂ TTPÂ value
plot(original_ttp_valueÂ >Â 0Â ?Â original_ttp_valueÂ :Â na,Â style=plot.style_linebr,Â color=color.white,Â linewidth=4,Â title="OriginalÂ TTPÂ Value",Â editable=true)
plot(stopValueÂ >Â 0Â ?Â stopValueÂ :Â na,Â style=plot.style_linebr,Â color=color.red,Â linewidth=4,Â title="StopÂ Value",Â editable=true)
plot(trailing_priceÂ >Â 0Â ?Â trailing_priceÂ :Â na,Â style=plot.style_linebr,Â color=color.yellow,Â linewidth=4,Â title="TrailingÂ stopÂ loss",Â editable=true)
//Â PlotÂ FibonacciÂ Areas
fill(plot(hl,Â title='Top-HighÂ FibÂ Border',Â color=color.new(#00FFFF,Â 50),Â linewidth=1),Â plot(hf,Â title='Bottom-HighÂ FibÂ Border',Â color=color.new(#38761d,Â 50),Â linewidth=1),Â color=color.new(#00FFFF,Â 80),Â title='UptrendÂ FibonacciÂ ZoneÂ @Â 23.6%')Â Â //uptrendÂ zone
fill(plot(cfh,Â title='Top-CenterÂ FibÂ Border',Â color=color.new(#0589f4,Â 50),Â linewidth=1),Â plot(cfl,Â title='Bottom-CenterÂ FibÂ Border',Â color=color.new(#2018ff,Â 50),Â linewidth=1),Â color=color.new(color.blue,Â 80),Â title='RangingÂ FibonacciÂ ZoneÂ @Â 61.8%')Â Â //Â rangingÂ zone
fill(plot(lf,Â title='Top-LowÂ FibÂ Border',Â color=color.new(color.yellow,Â 50),Â linewidth=1),Â plot(ll,Â title='Bottom-LowÂ FibÂ Border',Â color=color.new(#bf00ff,Â 50),Â linewidth=1),Â color=color.new(color.orange,Â 80),Â title='DowntrendÂ FibonacciÂ ZoneÂ @Â 76.4%')Â Â //downÂ trendÂ zone
//Â PlotÂ TP
plot(strategy.position_sizeÂ >Â 0Â ?Â take_profit_levelÂ :Â na,Â style=plot.style_linebr,Â color=color.green,Â linewidth=3,Â title="TakeÂ Profit")
//Â PlotÂ AllÂ SafetyÂ OrderÂ linesÂ exceptÂ forÂ lastÂ oneÂ asÂ brightÂ blue
plot(strategy.position_sizeÂ >Â 0Â andÂ current_soÂ <=Â max_safe_orderÂ andÂ current_soÂ >Â 0Â ?Â thresholdÂ :Â na,Â style=plot.style_linebr,Â color=color.new(#00ffff,0),Â linewidth=3,Â title="SafetyÂ Order")
//Â PlotÂ LastÂ SafetyÂ OrderÂ LineÂ asÂ Red
plot(strategy.position_sizeÂ >Â 0Â andÂ current_soÂ >Â max_safe_orderÂ ?Â thresholdÂ :Â na,Â style=plot.style_linebr,Â color=color.red,Â linewidth=3,Â title="NoÂ SafetyÂ OrdersÂ Left")
//Â PlotÂ AverageÂ PositionÂ PriceÂ LineÂ asÂ Orange
plot(strategy.position_sizeÂ >Â 0Â ?Â strategy.position_avg_priceÂ :Â na,Â style=plot.style_linebr,Â color=color.orange,Â linewidth=3,Â title="AvgÂ PositionÂ Price")
//Â FillÂ TPÂ AreaÂ andÂ SOÂ Area
h1Â =Â plot(strategy.position_avg_price,Â color=color.new(#000000,100),Â title="AvgÂ PriceÂ PlotÂ Area",Â display=display.none,Â editable=false)
h2Â =Â plot(take_profit_level,Â color=color.new(#000000,100),Â title="TakeÂ ProfitÂ PlotÂ Area",Â display=display.none,Â editable=false)
h3Â =Â plot(threshold,Â color=color.new(#000000,100),Â title="SOÂ PlotÂ Area",Â display=display.none,Â editable=false)
//Â FillÂ TPÂ AreaÂ andÂ SOÂ Area
fill(h1,h2,color=color.new(#38761d,80),Â title="TakeÂ ProfitÂ PlotÂ Area")
//Â CurrentÂ SOÂ Area
fill(h1,h3,color=color.new(#3d85c6,80),Â title="SOÂ PlotÂ Area")
Expand (344 lines)