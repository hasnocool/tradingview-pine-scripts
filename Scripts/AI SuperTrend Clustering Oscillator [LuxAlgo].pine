Script Name: AI SuperTrend Clustering Oscillator [LuxAlgo]
Author: LuxAlgo
Description: The AI SuperTrend Clustering Oscillator is an oscillator returning the most bullish/average/bearish centroids given by multiple instances of the difference between SuperTrend indicators.

This script is an extension of our previously posted SuperTrend AI indicator that makes use of k-means clustering. If you want to learn more about it see:



ğŸ”¶  USAGE 

  

The...
PineScript code:

Pine Scriptâ„¢ indicator
AI SuperTrend Clustering Oscillator [LuxAlgo]
Copy code
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
//Â ThisÂ workÂ isÂ licensedÂ underÂ aÂ Attribution-NonCommercial-ShareAlikeÂ 4.0Â InternationalÂ (CCÂ BY-NC-SAÂ 4.0)Â https://creativecommons.org/licenses/by-nc-sa/4.0/
//Â Â©Â LuxAlgo
//@version=5
indicator("AIÂ SuperTrendÂ ClusteringÂ OscillatorÂ [LuxAlgo]",Â "LuxAlgoÂ -Â AIÂ SuperTrendÂ ClusteringÂ Oscillator")
//------------------------------------------------------------------------------
//Settings
//-----------------------------------------------------------------------------{
lengthÂ =Â input(10,Â 'ATRÂ Length')
minMultÂ =Â input.int(1,Â 'FactorÂ Range',Â minvalÂ =Â 0,Â inlineÂ =Â 'factor')
maxMultÂ =Â input.int(5,Â '',Â minvalÂ =Â 0,Â inlineÂ =Â 'factor')
stepÂ Â Â Â =Â input.float(.5,Â 'Step',Â minvalÂ =Â 0,Â stepÂ =Â 0.1)
smoothÂ =Â input.float(1,Â minvalÂ =Â 1)
//TriggerÂ error
ifÂ minMultÂ >Â maxMult
Â Â Â Â runtime.error('MinimumÂ factorÂ isÂ greaterÂ thanÂ maximumÂ factorÂ inÂ theÂ range')
//Optimization
maxIterÂ =Â input.int(1000,Â 'MaximumÂ IterationÂ Steps',Â minvalÂ =Â 0,Â groupÂ =Â 'Optimization')
maxDataÂ =Â input.int(10000,Â 'HistoricalÂ BarsÂ Calculation',Â minvalÂ =Â 0,Â groupÂ =Â 'Optimization')
//Style
bullCssÂ =Â input(color.new(#5b9cf6,Â 50),Â 'Bullish',Â inlineÂ =Â 'bull',Â groupÂ =Â 'Style')
strongBullCssÂ =Â input(color.new(#5b9cf6,Â 28),Â 'Strong',Â inlineÂ =Â 'bull',Â groupÂ =Â 'Style')
neutCssÂ =Â input(#9598a1,Â 'Neutral',Â inlineÂ =Â 'neut',Â groupÂ =Â 'Style')
bearCssÂ =Â input(color.new(#f77c80,Â 50),Â 'Bearish',Â inlineÂ =Â 'bear',Â groupÂ =Â 'Style')
strongBearCssÂ =Â input(color.new(#f77c80,Â 28),Â 'Strong',Â inlineÂ =Â 'bear',Â groupÂ =Â 'Style')
//-----------------------------------------------------------------------------}
//UDT's
//-----------------------------------------------------------------------------{
typeÂ supertrend
Â Â Â Â floatÂ upperÂ =Â hl2
Â Â Â Â floatÂ lowerÂ =Â hl2
Â Â Â Â floatÂ output
Â Â Â Â intÂ trend
typeÂ vector
Â Â Â Â array<float>Â out
//-----------------------------------------------------------------------------}
//Supertrend
//-----------------------------------------------------------------------------{
varÂ holderÂ =Â array.new<supertrend>(0)
varÂ factorsÂ =Â array.new<float>(0)
//PopulateÂ supertrendÂ typeÂ array
ifÂ barstate.isfirst
Â Â Â Â forÂ iÂ =Â 0Â toÂ int((maxMultÂ -Â minMult)Â /Â step)
Â Â Â Â Â Â Â Â factors.push(minMultÂ +Â iÂ *Â step)
Â Â Â Â Â Â Â Â holder.push(supertrend.new())
atrÂ =Â ta.atr(length)
//ComputeÂ SupertrendÂ forÂ multipleÂ factors
kÂ =Â 0
forÂ factorÂ inÂ factors
Â Â Â Â get_sptÂ =Â holder.get(k)
Â Â Â Â upÂ =Â hl2Â +Â atrÂ *Â factor
Â Â Â Â dnÂ =Â hl2Â -Â atrÂ *Â factor
Â Â Â Â 
Â Â Â Â get_spt.upperÂ :=Â close[1]Â <Â get_spt.upperÂ ?Â math.min(up,Â get_spt.upper)Â :Â up
Â Â Â Â get_spt.lowerÂ :=Â close[1]Â >Â get_spt.lowerÂ ?Â math.max(dn,Â get_spt.lower)Â :Â dn
Â Â Â Â get_spt.trendÂ :=Â closeÂ >Â get_spt.upperÂ ?Â 1Â :Â closeÂ <Â get_spt.lowerÂ ?Â 0Â :Â get_spt.trend
Â Â Â Â get_spt.outputÂ :=Â get_spt.trendÂ ==Â 1Â ?Â get_spt.lowerÂ :Â get_spt.upper
Â Â Â Â kÂ +=Â 1
//-----------------------------------------------------------------------------}
//K-meansÂ clustering
//-----------------------------------------------------------------------------{
dataÂ =Â array.new<float>(0)
//PopulateÂ dataÂ arrays
ifÂ last_bar_indexÂ -Â bar_indexÂ <=Â maxData
Â Â Â Â forÂ elementÂ inÂ holder
Â Â Â Â Â Â Â Â data.push(closeÂ -Â element.output)
//IntitalizeÂ centroidsÂ usingÂ quartiles
centroidsÂ =Â array.new<float>(0)
centroids.push(data.percentile_linear_interpolation(25))
centroids.push(data.percentile_linear_interpolation(50))
centroids.push(data.percentile_linear_interpolation(75))
//IntializeÂ clusters
varÂ array<vector>Â clustersÂ =Â na
ifÂ last_bar_indexÂ -Â bar_indexÂ <=Â maxData
Â Â Â Â forÂ _Â =Â 0Â toÂ maxIter
Â Â Â Â Â Â Â Â clustersÂ :=Â array.from(vector.new(array.new<float>(0)),Â vector.new(array.new<float>(0)),Â vector.new(array.new<float>(0)))
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â //AssignÂ valueÂ toÂ cluster
Â Â Â Â Â Â Â Â forÂ valueÂ inÂ data
Â Â Â Â Â Â Â Â Â Â Â Â distÂ =Â array.new<float>(0)
Â Â Â Â Â Â Â Â Â Â Â Â forÂ centroidÂ inÂ centroids
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â dist.push(math.abs(valueÂ -Â centroid))
Â Â Â Â Â Â Â Â Â Â Â Â idxÂ =Â dist.indexof(dist.min())
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ idxÂ !=Â -1
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clusters.get(idx).out.push(value)
Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â //UpdateÂ centroids
Â Â Â Â Â Â Â Â new_centroidsÂ =Â array.new<float>(0)
Â Â Â Â Â Â Â Â forÂ cluster_Â inÂ clusters
Â Â Â Â Â Â Â Â Â Â Â Â new_centroids.push(cluster_.out.avg())
Â Â Â Â Â Â Â Â //TestÂ ifÂ centroidÂ changed
Â Â Â Â Â Â Â Â ifÂ new_centroids.get(0)Â ==Â centroids.get(0)Â andÂ new_centroids.get(1)Â ==Â centroids.get(1)Â andÂ new_centroids.get(2)Â ==Â centroids.get(2)
Â Â Â Â Â Â Â Â Â Â Â Â break
Â Â Â Â Â Â Â Â centroidsÂ :=Â new_centroids
//-----------------------------------------------------------------------------}
//GetÂ centroids
//-----------------------------------------------------------------------------{
//GetÂ associatedÂ supertrend
varÂ floatÂ bullÂ =Â 0
varÂ floatÂ neutÂ =Â 0
varÂ floatÂ bearÂ =Â 0
varÂ denÂ =Â 0
ifÂ notÂ na(clusters)
Â Â Â Â bullÂ +=Â 2/(smooth+1)Â *Â nz(centroids.get(2)Â -Â bull)
Â Â Â Â neutÂ +=Â 2/(smooth+1)Â *Â nz(centroids.get(1)Â -Â neut)
Â Â Â Â bearÂ +=Â 2/(smooth+1)Â *Â nz(centroids.get(0)Â -Â bear)
Â Â Â Â denÂ +=Â 1
//-----------------------------------------------------------------------------}
//Plots
//-----------------------------------------------------------------------------{
plot_bullÂ =Â plot(math.max(bull,Â 0),Â colorÂ =Â na,Â editableÂ =Â false)
plot_bull_extÂ =Â plot(math.max(bear,Â 0),Â 'StrongÂ Bullish'
Â Â ,Â bearÂ >Â 0Â ?Â strongBullCssÂ :Â na
Â Â ,Â styleÂ =Â plot.style_circles)
plot_bearÂ =Â plot(math.min(bear,Â 0),Â colorÂ =Â na,Â editableÂ =Â false)
plot_bear_extÂ =Â plot(math.min(bull,Â 0),Â 'StrongÂ Bearish'
Â Â ,Â bullÂ <Â 0Â ?Â strongBearCssÂ :Â na
Â Â ,Â styleÂ =Â plot.style_circles)
plot(neut,Â 'Consensus',Â neutCss)
fill(plot_bull,Â plot_bull_ext,Â bull,Â math.max(bear,Â 0),Â bullCss,Â color.new(chart.bg_color,Â 100))
fill(plot_bear_ext,Â plot_bear,Â math.min(bull,Â 0),Â bear,Â color.new(chart.bg_color,Â 100),Â bearCss)
hline(0,Â linestyleÂ =Â hline.style_solid)
//-----------------------------------------------------------------------------}
Expand (152 lines)